<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Niji Trip 2026 (v2.2)</title>

<style>
:root{
  --bg-main:#ffe4b8;
  --bg-card:#fff7e8;
  --brown:#7a4a26;
  --radius:20px;
  --btn:#ffd89a;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
  background:var(--bg-main);
  color:#3b2a1b;
}
header{
  padding:16px;
  background:#fff3da;
  border-radius:0 0 var(--radius) var(--radius);
}
h1{
  margin:0 0 8px;
  color:var(--brown);
  font-size:34px;
  font-weight:900;
  letter-spacing:.5px;
}
.subtitle{
  background:#fff7e8;
  padding:10px 12px;
  border-radius:14px;
  font-weight:800;
}
.btn-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:12px;
  align-items:center;
}
button{
  border:none;
  padding:10px 14px;
  border-radius:999px;
  background:var(--btn);
  color:#5c3a1c;
  font-weight:900;
  cursor:pointer;
}
button:disabled{
  opacity:.55;
  cursor:not-allowed;
}
.badge{
  display:inline-block;
  padding:10px 12px;
  border-radius:999px;
  background:#fff3c5;
  color:#5c3a1c;
  font-weight:900;
}
.small{
  font-size:12px;
  opacity:.9;
}
main{ padding:16px; }

.day{
  background:#eaf6ff;
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 2px 0 rgba(0,0,0,.04);
}
.day-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.day-title{
  font-size:22px;
  font-weight:900;
}
.del{
  background:#ffd1c7;
}
.card{
  background:var(--bg-card);
  border-radius:16px;
  padding:12px;
  margin-top:10px;
  min-height:54px;
  white-space:pre-wrap;
  word-break:break-word;
}
[contenteditable]{ outline:none; }

.panel{
  margin-top:14px;
  background:#fff7e8;
  border-radius:18px;
  padding:14px;
  box-shadow:0 2px 0 rgba(0,0,0,.04);
}
.panel h2{
  margin:0 0 8px;
  font-size:18px;
  color:#5c3a1c;
}
.form-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
input{
  width:100%;
  max-width:360px;
  padding:10px 12px;
  border-radius:14px;
  border:2px solid rgba(0,0,0,.08);
  background:#fff;
  font-size:15px;
}
.footer-links{
  margin-top:12px;
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
.footer-links a{
  color:#3a59c9;
  font-weight:800;
  text-decoration:underline;
}
.diag{
  margin-top:10px;
  font-size:12px;
  line-height:1.5;
  color:#6b4a2c;
  white-space:pre-wrap;
  word-break:break-word;
  background:rgba(255,255,255,.65);
  padding:10px 12px;
  border-radius:14px;
}
</style>
</head>

<body>

<header>
  <h1>Niji Trip 2026 ğŸŒˆ <span class="small">(v2.2)</span></h1>

  <div id="subtitleEl" class="subtitle" contenteditable="true">æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚</div>

  <div class="btn-row">
    <button id="addDayBtn">ï¼‹ æ–°å¢ä¸€å¤©</button>
    <button id="clearBtn">æ¸…é™¤å„²å­˜</button>
    <span id="saveStatus" class="badge">å·²è¼‰å…¥ âœ…</span>
  </div>

  <div class="panel" id="authPanel">
    <h2>ç¶²ç«™å¸³è™Ÿç™»å…¥ï¼ˆEmail / å¯†ç¢¼ï¼‰</h2>
    <div class="small">ç™»å…¥å¾Œå¯æŠŠè¡Œç¨‹åŒæ­¥åˆ°é›²ç«¯ï¼ˆFirestoreï¼‰ï¼Œä¸åŒè£ç½®ç™»å…¥åŒå¸³è™Ÿå³å¯è¼‰å…¥ã€‚</div>
    <div class="form-row" style="margin-top:10px;">
      <input id="emailEl" type="email" placeholder="Emailï¼ˆä¾‹å¦‚ ygfamily895@gmail.comï¼‰" autocomplete="email" />
      <input id="passwordEl" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" autocomplete="current-password" />
    </div>

    <div class="btn-row" style="margin-top:10px;">
      <button id="btnSignup">è¨»å†Š</button>
      <button id="btnLogin">ç™»å…¥</button>
      <button id="btnLogout" class="del" style="display:none;">ç™»å‡º</button>
      <span id="authStatus" class="badge">æœªç™»å…¥</span>
    </div>

    <div class="btn-row" style="margin-top:10px;">
      <button id="btnLoadCloud">å¾é›²ç«¯è¼‰å…¥</button>
      <button id="btnSyncCloud">åŒæ­¥åˆ°é›²ç«¯</button>
      <span class="small">å»ºè­°ç¬¬ä¸€æ¬¡ç™»å…¥ï¼šå…ˆæŒ‰ã€Œå¾é›²ç«¯è¼‰å…¥ã€ç¢ºèªé›²ç«¯æ˜¯å¦å·²æœ‰è³‡æ–™ï¼›æ²’æœ‰å†æŒ‰ã€ŒåŒæ­¥åˆ°é›²ç«¯ã€ã€‚</span>
    </div>

    <div class="footer-links">
      <a id="privacyLink" href="./privacy.html" target="_blank" rel="noopener">éš±ç§æ¬Šæ”¿ç­–</a>
      <a id="tosLink" href="./terms.html" target="_blank" rel="noopener">æœå‹™æ¢æ¬¾</a>
    </div>

    <div id="diag" class="diag">ï¼ˆè¨ºæ–·å€ï¼‰</div>
  </div>
</header>

<main id="days"></main>

<script>
/* -----------------------------
   LocalStorage: keys
----------------------------- */
const KEY_DAYS = "days";
const KEY_SUB  = "subtitle";

/* -----------------------------
   UI elements
----------------------------- */
const daysEl = document.getElementById("days");
const addDayBtn = document.getElementById("addDayBtn");
const clearBtn = document.getElementById("clearBtn");
const saveStatus = document.getElementById("saveStatus");
const subtitleEl = document.getElementById("subtitleEl");

const emailEl = document.getElementById("emailEl");
const passwordEl = document.getElementById("passwordEl");
const btnSignup = document.getElementById("btnSignup");
const btnLogin = document.getElementById("btnLogin");
const btnLogout = document.getElementById("btnLogout");
const btnLoadCloud = document.getElementById("btnLoadCloud");
const btnSyncCloud = document.getElementById("btnSyncCloud");
const authStatus = document.getElementById("authStatus");
const diag = document.getElementById("diag");

/* -----------------------------
   Helpers
----------------------------- */
function log(msg){
  diag.textContent += msg + "\n";
}
function setStatus(text){
  saveStatus.textContent = text;
}

function loadLocal(){
  const sub = localStorage.getItem(KEY_SUB);
  if (sub !== null && sub !== undefined && sub !== "") subtitleEl.textContent = sub;

  const raw = localStorage.getItem(KEY_DAYS);
  try{
    return raw ? JSON.parse(raw) : [];
  }catch{
    return [];
  }
}
function saveLocal(days){
  localStorage.setItem(KEY_DAYS, JSON.stringify(days));
  localStorage.setItem(KEY_SUB, subtitleEl.textContent || "");
}

/* -----------------------------
   Render days
----------------------------- */
let days = loadLocal();

function render(){
  daysEl.innerHTML = "";
  days.forEach((d,i)=>{
    const wrap = document.createElement("div");
    wrap.className = "day";
    wrap.innerHTML = `
      <div class="day-head">
        <div class="day-title">Day ${i+1}</div>
        <button class="del">åˆªé™¤</button>
      </div>
      <div class="card" contenteditable="true"></div>
    `;
    const card = wrap.querySelector(".card");
    const delBtn = wrap.querySelector(".del");
    card.textContent = d?.text || "";
    card.addEventListener("input", ()=>{
      days[i].text = card.textContent;
      saveLocal(days);
      setStatus("å·²å„²å­˜ âœ…");
    });
    delBtn.addEventListener("click", ()=>{
      if(confirm(`ç¢ºå®šåˆªé™¤ Day ${i+1}ï¼Ÿ`)){
        days.splice(i,1);
        saveLocal(days);
        render();
        setStatus("å·²å„²å­˜ âœ…");
      }
    });
    daysEl.appendChild(wrap);
  });
}

subtitleEl.addEventListener("input", ()=>{
  saveLocal(days);
  setStatus("å·²å„²å­˜ âœ…");
});

addDayBtn.addEventListener("click", ()=>{
  days.push({ text:"æ–°å¢è¡Œç¨‹å…§å®¹â€¦" });
  saveLocal(days);
  render();
  setStatus("å·²å„²å­˜ âœ…");
});

clearBtn.addEventListener("click", ()=>{
  if(confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿè³‡æ–™ï¼ˆlocalStorageï¼‰ï¼Ÿ\nï¼ˆä¸æœƒåˆªæ‰é›²ç«¯ï¼‰")){
    localStorage.removeItem(KEY_DAYS);
    localStorage.removeItem(KEY_SUB);
    days = [];
    subtitleEl.textContent = "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚";
    render();
    setStatus("å·²æ¸…é™¤ âœ…");
  }
});

render();
setStatus("å·²è¼‰å…¥ âœ…");
</script>

<!-- Firebase (Auth + Firestore) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // âœ… ä½ çš„ Firebase è¨­å®šï¼ˆç…§ä½ çµ¦çš„ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // è®“å¤–å±¤ script ä¹Ÿèƒ½ç”¨ logï¼ˆç°¡å–®åšæ³•ï¼šæŠ“ DOMï¼‰
  const diag = document.getElementById("diag");
  const log = (msg)=>{ diag.textContent += msg + "\n"; };

  const authStatus = document.getElementById("authStatus");
  const btnSignup = document.getElementById("btnSignup");
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const btnLoadCloud = document.getElementById("btnLoadCloud");
  const btnSyncCloud = document.getElementById("btnSyncCloud");
  const emailEl = document.getElementById("emailEl");
  const passwordEl = document.getElementById("passwordEl");

  const subtitleEl = document.getElementById("subtitleEl");
  const saveStatus = document.getElementById("saveStatus");

  const KEY_DAYS = "days";
  const KEY_SUB  = "subtitle";

  function setSaveStatus(t){ saveStatus.textContent = t; }
  function getLocalPayload(){
    let days = [];
    try{ days = JSON.parse(localStorage.getItem(KEY_DAYS) || "[]"); }catch{ days = []; }
    const subtitle = localStorage.getItem(KEY_SUB) ?? subtitleEl.textContent ?? "";
    return { subtitle, days };
  }
  function setLocalPayload(payload){
    const subtitle = payload?.subtitle ?? "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚";
    const days = Array.isArray(payload?.days) ? payload.days : [];
    localStorage.setItem(KEY_SUB, subtitle);
    localStorage.setItem(KEY_DAYS, JSON.stringify(days));
    subtitleEl.textContent = subtitle;

    // è§¸ç™¼é‡æ–° renderï¼šæœ€ç°¡å–®æ˜¯ reloadï¼ˆé¿å…ä½ ç¾æœ‰ render è®Šæ•¸ä½œç”¨åŸŸï¼‰
    // ä½†æˆ‘å€‘ç”¨ã€Œå°æŠ€å·§ã€ï¼šç›´æ¥ location.reload() è®“ UI 100% åŒæ­¥
    setSaveStatus("å·²è¼‰å…¥ âœ…ï¼ˆå°‡é‡æ–°æ•´ç†ï¼‰");
    setTimeout(()=>location.reload(), 250);
  }

  let currentUser = null;

  log(`Firebase init OK : ${app?.options?.projectId || "(unknown)"}`);

  // --- Auth UI state ---
  function setLoggedOutUI(){
    authStatus.textContent = "æœªç™»å…¥";
    btnLogout.style.display = "none";
    btnSignup.disabled = false;
    btnLogin.disabled = false;
    btnLoadCloud.disabled = true;
    btnSyncCloud.disabled = true;
  }
  function setLoggedInUI(user){
    const name = user.email || user.uid;
    authStatus.textContent = "å·²ç™»å…¥ï¼š" + name;
    btnLogout.style.display = "inline-block";
    btnSignup.disabled = true;
    btnLogin.disabled = true;
    btnLoadCloud.disabled = false;
    btnSyncCloud.disabled = false;
  }

  // --- Firestore path (å›ºå®šä¸€å€‹ä¸»æª”æ¡ˆ) ---
  function getMainDocRef(uid){
    // users/{uid}/trip/main
    return doc(db, "users", uid, "trip", "main");
  }

  // --- Buttons ---
  btnSignup.addEventListener("click", async ()=>{
    const email = (emailEl.value || "").trim();
    const pass  = (passwordEl.value || "").trim();
    if(!email || !pass){ log("è¨»å†Šï¼šè«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼"); return; }
    try{
      log("è¨»å†Šä¸­...");
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      log("è¨»å†ŠæˆåŠŸ âœ… " + (cred.user.email || ""));
    }catch(e){
      log("è¨»å†ŠéŒ¯èª¤ âŒ");
      log("code: " + (e?.code || "(none)"));
      log("message: " + (e?.message || "(none)"));
      alert("è¨»å†Šå¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  btnLogin.addEventListener("click", async ()=>{
    const email = (emailEl.value || "").trim();
    const pass  = (passwordEl.value || "").trim();
    if(!email || !pass){ log("ç™»å…¥ï¼šè«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼"); return; }
    try{
      log("ç™»å…¥ä¸­...");
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      log("ç™»å…¥æˆåŠŸ âœ… " + (cred.user.email || ""));
    }catch(e){
      log("ç™»å…¥éŒ¯èª¤ âŒ");
      log("code: " + (e?.code || "(none)"));
      log("message: " + (e?.message || "(none)"));
      alert("ç™»å…¥å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  btnLogout.addEventListener("click", async ()=>{
    try{
      log("ç™»å‡ºä¸­...");
      await signOut(auth);
      log("å·²ç™»å‡º âœ…");
    }catch(e){
      log("ç™»å‡ºéŒ¯èª¤ âŒ " + (e?.message || e));
    }
  });

  btnSyncCloud.addEventListener("click", async ()=>{
    if(!currentUser){ alert("è«‹å…ˆç™»å…¥"); return; }
    try{
      const ref = getMainDocRef(currentUser.uid);
      const payload = getLocalPayload();
      log("åŒæ­¥åˆ°é›²ç«¯... (setDoc)");
      await setDoc(ref, {
        subtitle: payload.subtitle,
        days: payload.days,
        updatedAt: serverTimestamp(),
        schema: "niji-trip-v2"
      }, { merge: true });
      log("åŒæ­¥æˆåŠŸ âœ…");
      setSaveStatus("å·²åŒæ­¥åˆ°é›²ç«¯ âœ…");
      alert("å·²åŒæ­¥åˆ°é›²ç«¯ âœ…\n\nB è£ç½®è«‹ç™»å…¥å¾ŒæŒ‰ã€Œå¾é›²ç«¯è¼‰å…¥ã€ã€‚");
    }catch(e){
      log("åŒæ­¥éŒ¯èª¤ âŒ");
      log("code: " + (e?.code || "(none)"));
      log("message: " + (e?.message || "(none)"));
      alert("åŒæ­¥å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  btnLoadCloud.addEventListener("click", async ()=>{
    if(!currentUser){ alert("è«‹å…ˆç™»å…¥"); return; }
    try{
      const ref = getMainDocRef(currentUser.uid);
      log("å¾é›²ç«¯è¼‰å…¥... (getDoc)");
      const snap = await getDoc(ref);
      if(!snap.exists()){
        log("é›²ç«¯æ²’æœ‰è³‡æ–™ï¼ˆdoc ä¸å­˜åœ¨ï¼‰");
        alert("é›²ç«¯ç›®å‰æ²’æœ‰è³‡æ–™ã€‚\n\nå¦‚æœ A è£ç½®æœ‰è³‡æ–™ï¼šè«‹åœ¨ A è£ç½®æŒ‰ã€ŒåŒæ­¥åˆ°é›²ç«¯ã€ã€‚");
        return;
      }
      const data = snap.data() || {};
      log("é›²ç«¯è®€å–æˆåŠŸ âœ…");
      // è¦†è“‹æœ¬æ©Ÿ
      setLocalPayload({
        subtitle: data.subtitle ?? "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚",
        days: Array.isArray(data.days) ? data.days : []
      });
    }catch(e){
      log("è¼‰å…¥éŒ¯èª¤ âŒ");
      log("code: " + (e?.code || "(none)"));
      log("message: " + (e?.message || "(none)"));
      alert("è¼‰å…¥å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  // --- Auth state ---
  onAuthStateChanged(auth, (user)=>{
    if(user){
      currentUser = user;
      log("onAuthStateChanged: logged IN âœ…");
      setLoggedInUI(user);
      // å°æé†’ï¼šç™»å…¥ä¸æœƒè‡ªå‹•è¦†è“‹æœ¬æ©Ÿï¼Œé¿å…èª¤è“‹
      log("æç¤ºï¼šè¦è·¨è£ç½®åŒæ­¥ -> A å…ˆã€åŒæ­¥åˆ°é›²ç«¯ã€ï¼ŒB å†ã€å¾é›²ç«¯è¼‰å…¥ã€");
    }else{
      currentUser = null;
      log("onAuthStateChanged: logged OUT âŒ");
      setLoggedOutUI();
    }
  });
</script>

</body>
</html>

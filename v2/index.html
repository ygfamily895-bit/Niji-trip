<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Niji Trip 2026 ğŸŒˆ</title>
  <meta name="theme-color" content="#ffcf8f"/>

  <style>
    :root{
      --bg-main:#fce0b3; --bg-card:#fff7e8; --bg-soft:#e5f4ff;
      --chip:#fff6e5; --chip-active:#ffffff;
      --brown:#7a4a26; --brown-soft:#a26b3a;
      --border:rgba(186,140,91,.40); --shadow:0 2px 6px rgba(0,0,0,.08);
      --r-big:24px; --r-card:18px; --r-pill:999px;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",sans-serif;background:var(--bg-main);color:var(--brown);}
    body{min-height:100vh;}
    .page{max-width:920px;margin:0 auto;padding:14px 12px 90px;}
    header{background:var(--bg-card);border-radius:26px;padding:18px 16px 14px;box-shadow:var(--shadow);margin-bottom:12px;}
    .title-row{display:flex;align-items:center;gap:8px;}
    .title-row h1{margin:0;font-size:26px;font-weight:900;letter-spacing:.03em;}
    .title-row .emoji{font-size:24px;}
    .desc{margin:8px 0 10px;font-size:14px;color:var(--brown-soft);line-height:1.65;}
    .desc[contenteditable]{outline:none;border-bottom:1px dashed rgba(122,74,38,.2);}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px;}
    .btn{border:none;border-radius:var(--r-pill);padding:8px 14px;font-size:14px;background:#ffd59a;color:#5a351e;box-shadow:var(--shadow);cursor:pointer;white-space:nowrap;font-weight:700;}
    .btn.primary{background:#ffb85c;}
    .btn.danger{background:#ffb0a6;color:#7a221b;}
    .btn.ghost{background:#fff3da;}
    .btn.small{padding:6px 10px;font-size:13px;}
    .btn:active{transform:translateY(1px);box-shadow:0 1px 3px rgba(0,0,0,.16);}
    .badge{display:inline-block;padding:7px 11px;border-radius:var(--r-pill);background:#fff3c5;color:#5c3a1c;font-weight:800;font-size:13px;border:1px solid rgba(122,74,38,.10);}

    .hint{margin-top:10px;font-size:13px;color:var(--brown-soft);line-height:1.55;}
    .drag-hint{font-size:12px;color:var(--brown-soft);margin-top:6px;opacity:.9;}

    .sticky-wrap{position:sticky;top:0;z-index:20;padding-top:10px;background:linear-gradient(to bottom, rgba(252,224,179,.96), rgba(252,224,179,.70), rgba(252,224,179,0));backdrop-filter:blur(6px);}
    .day-nav{background:#e3f2ff;border-radius:24px;padding:10px 8px;overflow-x:auto;display:flex;gap:10px;box-shadow:var(--shadow);}
    .day-chip{flex:0 0 auto;min-width:92px;background:var(--chip);border-radius:var(--r-big);padding:7px 10px 6px;text-align:center;box-shadow:var(--shadow);cursor:pointer;border:1px solid transparent;user-select:none;position:relative;}
    .day-chip.active{background:var(--chip-active);border-color:rgba(122,74,38,.22);}
    .day-chip.dragging{opacity:.55;}
    .chip-main{font-weight:900;font-size:15px;display:block;}
    .chip-sub{font-size:12px;color:var(--brown-soft);display:block;margin-top:2px;}
    .chip-main[contenteditable], .chip-sub[contenteditable]{outline:none;}

    .day-section{margin-top:12px;margin-bottom:16px;}
    .day-card{background:var(--bg-soft);border-radius:28px;padding:12px 10px 14px;box-shadow:var(--shadow);}
    .day-header{display:flex;flex-wrap:wrap;align-items:baseline;gap:10px;padding:2px 6px 0;margin-bottom:6px;}
    .day-pill{background:#fff;border-radius:var(--r-pill);padding:7px 14px;box-shadow:var(--shadow);font-size:18px;font-weight:900;}
    .day-pill span[contenteditable]{outline:none;}
    .day-subtitle{color:var(--brown-soft);font-size:15px;}
    .day-subtitle span[contenteditable]{outline:none;border-bottom:1px dashed rgba(122,74,38,.22);}

    .day-meta{margin:6px 6px 10px;font-size:13px;color:var(--brown-soft);display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .day-meta .datebox{background:#fff;border-radius:var(--r-pill);padding:6px 12px;box-shadow:var(--shadow);font-weight:900;color:#5c3a1c;}
    .day-meta .datebox span[contenteditable]{outline:none;border-bottom:1px dashed rgba(122,74,38,.22);}
    .day-meta .budget{background:#fff;border-radius:var(--r-pill);padding:6px 10px;box-shadow:var(--shadow);border:1px solid rgba(122,74,38,.12);display:flex;gap:6px;align-items:center;}
    .day-meta input{width:92px;border:none;outline:none;background:transparent;color:#5c3a1c;font-weight:900;font-size:13px;}

    .sections{display:grid;grid-template-columns:1fr;gap:10px;padding:0 6px 6px;}
    .sec{background:rgba(255,255,255,.55);border-radius:18px;padding:10px 10px 12px;border:1px solid rgba(122,74,38,.10);}
    .sec-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;}
    .sec-title{font-weight:1000;font-size:14px;color:#5c3a1c;display:flex;align-items:center;gap:6px;}
    .sec-title .dot{width:9px;height:9px;border-radius:50%;background:#ffb85c;box-shadow:var(--shadow);}
    .sec-actions{display:flex;gap:6px;flex-wrap:wrap;}
    .sec-actions .btn{box-shadow:none;background:#ffe7bf;}

    .spot-card{background:var(--bg-card);border-radius:var(--r-card);padding:12px 12px 10px;box-shadow:var(--shadow);margin:0 0 10px;user-select:none;position:relative;touch-action:pan-y;}
    .spot-card.dragging{opacity:.60;}
    .spot-top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px;}
    .spot-title{font-weight:1000;font-size:16px;margin:0 0 4px;line-height:1.25;}
    .spot-title[contenteditable]{outline:none;border-bottom:1px dashed rgba(122,74,38,.18);}
    .spot-tag{font-size:12px;font-weight:900;padding:4px 10px;border-radius:var(--r-pill);background:#fff3da;border:1px solid rgba(122,74,38,.10);color:#5c3a1c;white-space:nowrap;}
    .spot-ja{font-size:13px;color:var(--brown-soft);margin:0 0 4px;}
    .spot-ja[contenteditable]{outline:none;border-bottom:1px dashed rgba(122,74,38,.18);}
    .spot-meta{font-size:13px;color:var(--brown-soft);margin:0 0 8px;}
    .spot-meta[contenteditable]{outline:none;border-bottom:1px dashed rgba(122,74,38,.18);}

    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0;}

    .loc-box{display:grid;grid-template-columns:1fr;gap:8px;padding:8px 9px;border-radius:14px;border:1px dashed var(--border);background:#fffdf6;}
    .loc-line{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .loc-label{font-size:12px;font-weight:1000;color:var(--brown-soft);width:54px;}
    .loc-input{flex:1 1 180px;border:none;outline:none;padding:8px 10px;border-radius:999px;background:#fff3da;color:#5a351e;font-weight:800;}
    .loc-mini{font-size:12px;color:var(--brown-soft);}

    .note{border-radius:14px;border:1px dashed var(--border);background:#fffdf6;padding:8px 9px;margin-top:8px;}
    .note-head{display:flex;justify-content:space-between;align-items:center;gap:10px;font-size:12px;font-weight:1000;color:var(--brown-soft);margin-bottom:6px;}
    .note-body{white-space:pre-wrap;min-height:18px;font-size:13px;color:#5c3a1c;outline:none;}
    .note-photos{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
    .thumb{width:66px;height:66px;border-radius:12px;object-fit:cover;box-shadow:var(--shadow);cursor:pointer;border:1px solid rgba(122,74,38,.10);}
    .thumb:active{transform:scale(.98);}

    .expense{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px;padding:8px 9px;border-radius:14px;background:#fff3da;border:1px solid rgba(122,74,38,.10);}
    .expense .lab{font-size:12px;font-weight:1000;color:var(--brown-soft);}
    .expense input{width:120px;border:none;outline:none;background:#fff;border-radius:999px;padding:7px 10px;font-weight:1000;color:#5c3a1c;box-shadow:var(--shadow);}
    .expense .calc{font-size:12px;font-weight:1000;color:#5c3a1c;}

    .day-note-card{background:var(--bg-card);border-radius:var(--r-card);padding:12px 12px 10px;box-shadow:var(--shadow);margin:12px 0 0;}
    .day-note-head{display:flex;justify-content:space-between;align-items:center;gap:10px;font-size:15px;font-weight:1000;margin-bottom:8px;}
    .day-note-box{border-radius:14px;border:1px dashed var(--border);background:#fffdf6;padding:9px 10px;font-size:13px;min-height:34px;white-space:pre-wrap;outline:none;}
    .day-note-photos{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}

    .tickets{background:rgba(255,255,255,.70);border-radius:14px;padding:10px 10px 8px;border:1px solid rgba(122,74,38,.10);margin-top:10px;}
    .tickets-head{display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:1000;color:#5c3a1c;margin-bottom:8px;}
    .tickets-grid{display:flex;flex-wrap:wrap;gap:6px;}

    .modal{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;}
    .modal.show{display:flex;}
    .modal-card{width:min(860px,100%);height:min(560px,80vh);background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.22);overflow:hidden;display:flex;flex-direction:column;}
    .modal-bar{padding:10px 12px;background:#fff3da;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .modal-bar .t{font-weight:1000;color:#5c3a1c;}
    .modal-bar .btn{box-shadow:none;padding:7px 12px;}
    .modal-body{flex:1;}
    .modal-body iframe{width:100%;height:100%;border:0;}

    .menu{position:fixed;z-index:120;min-width:220px;background:#fff;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.22);padding:8px;display:none;}
    .menu.show{display:block;}
    .menu .m-title{font-size:12px;color:var(--brown-soft);padding:6px 8px 4px;font-weight:1000;}
    .menu button{width:100%;text-align:left;border:none;border-radius:12px;padding:10px 10px;background:#fff3da;font-weight:1000;color:#5c3a1c;cursor:pointer;margin:4px 0;}
    .menu button.danger{background:#ffb0a6;color:#7a221b;}
    .menu button.secondary{background:#eaf6ff;}

    .floating{position:fixed;right:10px;bottom:12px;z-index:50;display:flex;flex-direction:column;gap:8px;align-items:flex-end;}
    .floating .fab{border:none;border-radius:999px;padding:10px 12px;background:#ffcf8f;box-shadow:var(--shadow);font-weight:1000;cursor:pointer;}
    .floating .fab:disabled{opacity:.55;cursor:default;}
    .save-toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);z-index:60;background:rgba(90,53,30,.92);color:#fff;padding:7px 12px;border-radius:999px;font-size:12px;opacity:0;transition:opacity .22s ease;pointer-events:none;}
    .save-toast.show{opacity:1;}

    .search-panel{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px;padding-top:10px;border-top:1px dashed rgba(122,74,38,.20);}
    .search-panel input{flex:1 1 220px;border:none;outline:none;padding:10px 12px;border-radius:999px;background:#fff;box-shadow:var(--shadow);font-weight:800;color:#5c3a1c;}
    .search-panel .badge{background:#eaf6ff;}

    /* login card */
    .login-card{
      margin-top:10px;background:#fff; border-radius:18px; padding:12px;
      border:1px solid rgba(122,74,38,.12); box-shadow:var(--shadow);
    }
    .login-title{font-weight:1000;color:#5c3a1c;margin-bottom:8px;}
    .login-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .login-row input{
      flex:1 1 170px;border:none;outline:none;
      padding:10px 12px;border-radius:999px;background:#fff3da;
      font-weight:900;color:#5c3a1c;
    }
    .login-meta{margin-top:8px;font-size:13px;color:var(--brown-soft);}

    @media (max-width:600px){
      .title-row h1{font-size:22px;}
      .day-card{border-radius:24px;}
      .day-chip{min-width:84px;}
    }
  </style>
</head>

<body>
  <div class="page" id="appRoot">
    <header>
      <div class="title-row">
        <h1 id="appTitle" contenteditable="true">Niji Trip 2026</h1>
        <span class="emoji">ğŸŒˆ</span>
      </div>

      <div class="desc" id="appDesc" contenteditable="true">
        æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚æ”¯æ´æ‹–æ‹‰æ’åºã€å¡ç‰‡æ¨¡æ¿ã€å¤šåœ°é»è·¯ç·šã€ä¸€éµå°èˆªã€åœ–ç‰‡/ç¥¨åˆ¸æ”¶ç´ã€æ—¥å¹£æ›ç®—ã€é ç®—æé†’ã€æœå°‹ã€Undoï¼ˆ10æ­¥ï¼‰ã€‚
      </div>

      <div class="toolbar">
        <button class="btn" id="btnAddDay" type="button">ï¼‹ æ–°å¢ä¸€å¤©</button>
        <button class="btn danger" id="btnRemoveDay" type="button">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
        <button class="btn" id="btnExport" type="button">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
        <button class="btn" id="btnImport" type="button">åŒ¯å…¥å‚™ä»½</button>
        <button class="btn ghost" id="btnClear" type="button">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
        <span class="badge" id="syncBadge">é›¢ç·šå¯ç”¨ï¼šå·²è‡ªå‹•ä¿å­˜</span>
      </div>

      <!-- âœ… Email/Password Login -->
      <div class="login-card">
        <div class="login-title">ç¶²ç«™å¸³è™Ÿç™»å…¥ï¼ˆEmail / å¯†ç¢¼ï¼‰</div>
        <div class="login-row">
          <input id="loginEmail" type="email" placeholder="Email" autocomplete="email" />
          <input id="loginPass" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" autocomplete="current-password" />
          <button class="btn" id="btnSignUp" type="button">è¨»å†Š</button>
          <button class="btn primary" id="btnSignIn" type="button">ç™»å…¥</button>
          <button class="btn danger" id="btnSignOut" type="button" style="display:none;">ç™»å‡º</button>
        </div>
        <div class="login-meta" id="loginInfo">æœªç™»å…¥ï¼ˆå¯é›¢ç·šä½¿ç”¨ï¼›ç™»å…¥å¾Œè‡ªå‹•å¾é›²ç«¯è¼‰å…¥/åŒæ­¥ï¼‰</div>
      </div>

      <div class="search-panel">
        <input id="searchInput" placeholder="ğŸ” æœå°‹ï¼šæ™¯é»/å‚™è¨»/ç¥¨åˆ¸æ–‡å­—ï¼ˆè¼¸å…¥å¾ŒæŒ‰ Enterï¼‰" />
        <button class="btn" id="btnSearch" type="button">æœå°‹</button>
        <span class="badge" id="searchResult">å°šæœªæœå°‹</span>
      </div>

      <div class="hint">
        âœ… Day1 æ—¥æœŸå¯ç·¨è¼¯ï¼›æ–°å¢å¤©æ•¸æœƒè‡ªå‹•æ¥çºŒæ—¥æœŸã€‚<br/>
        âœ… é•·æŒ‰å¡ç‰‡å¯åˆªé™¤/è¤‡è£½/ç½®é ‚/ç§»å‹•/æ‹–æ‹‰ã€‚æ‹–æ‹‰æ™‚æœƒè‡ªå‹•æ»¾å‹•ã€‚<br/>
        âœ… åœ–ç‰‡ã€Œé»ä¸€ä¸‹ç›´æ¥åˆªé™¤ã€ã€‚ç¥¨åˆ¸/QR ä¹Ÿå¯æ”¾åœ¨ã€Œç¥¨åˆ¸æ”¶ç´ã€ã€‚<br/>
      </div>

      <div class="drag-hint">
        å°æç¤ºï¼šè‹¥æ‰‹æ©Ÿæ‹–æ‹‰ä¸å¥½æŠ“ï¼Œè«‹ã€Œé•·æŒ‰å¡ç‰‡ â†’ é¸ã€é€²å…¥æ‹–æ‹‰æ¨¡å¼ã€ã€å†æ‹–ã€‚
      </div>
    </header>

    <div class="sticky-wrap">
      <div class="day-nav" id="dayNav"></div>
    </div>

    <div id="daysContainer"></div>
  </div>

  <!-- modal map preview -->
  <div class="modal" id="mapModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-bar">
        <div class="t" id="modalTitle">åœ°åœ–é è¦½</div>
        <button class="btn" id="btnCloseModal" type="button">é—œé–‰</button>
      </div>
      <div class="modal-body">
        <iframe id="modalFrame" title="map"></iframe>
      </div>
    </div>
  </div>

  <!-- long press menu -->
  <div class="menu" id="ctxMenu">
    <div class="m-title" id="ctxTitle">å¡ç‰‡æ“ä½œ</div>
    <button id="mDrag" class="secondary" type="button">ğŸŸ¦ é€²å…¥æ‹–æ‹‰æ¨¡å¼</button>
    <button id="mCopy" type="button">ğŸ“„ è¤‡è£½æ­¤å¡ç‰‡</button>
    <button id="mPin" type="button">ğŸ“Œ ç½®é ‚ï¼ˆæœ¬åˆ†å€ï¼‰</button>
    <button id="mMove" type="button">â¡ï¸ ç§»åˆ°å…¶ä»–å¤©â€¦</button>
    <button id="mDelete" class="danger" type="button">ğŸ—‘ï¸ åˆªé™¤</button>
  </div>

  <!-- floating -->
  <div class="floating">
    <button class="fab" id="btnUndo" type="button" disabled>â†© Undo</button>
    <button class="fab" id="btnJumpActive" type="button">â¬† å›åˆ°ç›®å‰ Day</button>
  </div>
  <div class="save-toast" id="saveToast">å·²å„²å­˜</div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />
  <input type="file" id="photoPicker" accept="image/*" style="display:none" />

<script>
(() => {
  const STORAGE_KEY = "niji_trip_2026_full_v2";
  const UNDO_LIMIT = 10;

  let state = null;
  let undoStack = [];
  let activeDayId = null;

  // Cloud state
  let cloudUnsub = null;
  let _autoLoaded = false;

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function setStatus(text){
    const b = $("#syncBadge");
    if (b) b.textContent = text;
  }

  function toastSaved(){
    const t = $("#saveToast");
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 700);
  }

  function pushUndo(){
    const snap = JSON.stringify(state);
    undoStack.push(snap);
    if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    $("#btnUndo").disabled = undoStack.length <= 1;
  }

  // âœ… å–®ä¸€ç‰ˆæœ¬ saveNowï¼ˆæ”¯æ´ pushCloudï¼‰
  function saveNow(pushCloud=true){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){
      console.warn("local save failed", e);
    }

    if (pushCloud && window.CloudSync){
      window.CloudSync.save(state)
        .then(()=> setStatus("å·²åŒæ­¥åˆ°é›²ç«¯ âœ…"))
        .catch(err => { console.warn("cloud save failed", err); setStatus("é›²ç«¯åŒæ­¥å¤±æ•—ï¼ˆå…ˆç”¨æœ¬æ©Ÿè³‡æ–™ï¼‰"); });
    }
    toastSaved();
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }

  function clearLocal(){
    localStorage.removeItem(STORAGE_KEY);
  }

  function parseMD(s){
    const m = String(s||"").match(/(\d{1,2})\s*\/\s*(\d{1,2})/);
    if (!m) return null;
    const mm = parseInt(m[1],10), dd = parseInt(m[2],10);
    if (!mm || !dd) return null;
    return { mm, dd };
  }
  function toMD(dateObj){
    const mm = dateObj.getMonth()+1;
    const dd = dateObj.getDate();
    return `${mm}/${dd}`;
  }
  function ensureDatesFromDay1(){
    const first = state.days[0];
    const md = parseMD(first.dateText);
    let base = md ? new Date(state.settings.year, md.mm-1, md.dd) : new Date(state.settings.year, 4, 8);
    state.days.forEach((d, idx) => {
      const dt = new Date(base);
      dt.setDate(dt.getDate() + idx);
      d.dateText = toMD(dt);
      if (d.autoDayLabel) d.dayLabel = `Day ${idx+1}`;
    });
  }

  function newCardTemplate(type="spot"){
    const id = `c_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    return {
      id, type,
      title: type==="lodging" ? "ä½å®¿" : type==="restaurant" ? "é¤å»³" : type==="transport" ? "äº¤é€š" : type==="shopping" ? "è³¼ç‰©" : "æ™¯é»",
      tag:   type==="lodging" ? "ä½å®¿" : type==="restaurant" ? "é¤å»³" : type==="transport" ? "äº¤é€š" : type==="shopping" ? "è³¼ç‰©" : "æ™¯é»",
      ja:"", meta:"",
      origin:"", destination:"", vias:[],
      note:"", photos:[],
      jpy:"", twd:"",
      pinned:false
    };
  }

  function makeDefaultDays(){
    const days = [];
    for (let i=1;i<=3;i++){
      const id = `d_${Date.now()}_${i}_${Math.random().toString(16).slice(2)}`;
      days.push({
        id,
        autoDayLabel:true,
        dayLabel:`Day ${i}`,
        subtitle:i===1?"ï¼ˆç¯„ä¾‹ï¼‰æˆç”°æ©Ÿå ´ãƒ»å…¥ä½ä¸Šé‡":i===2?"ï¼ˆç¯„ä¾‹ï¼‰ä¸Šé‡ãƒ»æ·ºè‰æ•£æ­¥":"ï¼ˆç¯„ä¾‹ï¼‰è‡ªç”±æ´»å‹•æ—¥",
        dateText:i===1?"5/8":i===2?"5/9":"5/10",
        budgetJPY:"",
        tickets:{ text:"ï¼ˆå¯æ”¾ç¥¨åˆ¸/QR/è¨‚ä½è³‡è¨Šï¼‰", photos:[] },
        sections:{ morning:[], noon:[], night:[], transport:[], shopping:[] },
        dayNote:{ text:"ä¾‹ï¼šé¤é£² xxxã€äº¤é€š xxxã€è³¼ç‰© xxxã€å¿ƒå¾—â€¦", photos:[] }
      });
    }
    const c1 = newCardTemplate("spot");
    c1.title="ç¯„ä¾‹æ™¯é»";
    c1.ja="æ—¥æ–‡åç¨±æˆ–åœ°å€";
    c1.meta="åœ°å€ãƒ»èªªæ˜ï¼šä¸Šé‡ãƒ»è»Šç«™é™„è¿‘â€¦";
    c1.note="å¯åœ¨é€™è£¡å¯«æ’éšŠã€æ³¨æ„äº‹é …ã€é †éŠâ€¦";
    c1.destination="æ—¥æ–‡åç¨±æˆ–åœ°å€";
    days[0].sections.morning.push(c1);

    // lodging
    days.forEach(d=>{
      const lod = newCardTemplate("lodging");
      lod.title = `ä½å®¿ï¼š${state?.settings?.hotelName || "ä½å®¿"}`;
      lod.ja = state?.settings?.hotelNameJP || "";
      lod.meta="ä½å®¿åœ°é»ï¼ˆå›ºå®šåœ¨ç•¶æ—¥å‚™è¨»ä¸Šæ–¹ï¼‰";
      lod.pinned = true;
      d.sections.night.push(lod);
    });
    return days;
  }

  function initState(){
    const s = loadLocal();
    if (s){
      state = s;
      state._rev = state._rev || 0; // âœ… ç‰ˆæœ¬è™Ÿï¼ˆé˜²æ­¢æ‰“å­—è·³æ‰ï¼‰
      if (!state.settings) state.settings = {};
      if (!state.settings.rate) state.settings.rate = 0.22;
      if (!state.settings.year) state.settings.year = 2026;
      if (!state.settings.hotelName) state.settings.hotelName = "VESSEL INN ä¸Šé‡å…¥è°·ç«™ é£¯åº—";
      if (!state.settings.hotelNameJP) state.settings.hotelNameJP = "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰";
      if (!Array.isArray(state.days)) state.days = [];
      if (state.days.length === 0) state.days = makeDefaultDays();
      ensureDatesFromDay1();
      return;
    }

    state = {
      _rev: 0,
      settings:{
        year:2026,
        rate:0.22,
        hotelName:"VESSEL INN ä¸Šé‡å…¥è°·ç«™ é£¯åº—",
        hotelNameJP:"ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰"
      },
      appTitle:"Niji Trip 2026",
      appDesc:"æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚æ”¯æ´æ‹–æ‹‰æ’åºã€å¡ç‰‡æ¨¡æ¿ã€å¤šåœ°é»è·¯ç·šã€ä¸€éµå°èˆªã€åœ–ç‰‡/ç¥¨åˆ¸æ”¶ç´ã€æ—¥å¹£æ›ç®—ã€é ç®—æé†’ã€æœå°‹ã€Undoï¼ˆ10æ­¥ï¼‰ã€‚",
      days:[]
    };
    state.days = makeDefaultDays();
    ensureDatesFromDay1();
    pushUndo();
    saveNow(false);
  }

  /* ========= Render ========= */
  function render(){
    $("#appTitle").textContent = state.appTitle || "Niji Trip 2026";
    $("#appDesc").textContent  = state.appDesc || "";

    renderDayNav();
    renderDays();

    if (!activeDayId && state.days[0]) activeDayId = state.days[0].id;
    setActiveChip(activeDayId);

    recalcTotals();
  }

  function renderDayNav(){
    const nav = $("#dayNav");
    nav.innerHTML = "";
    state.days.forEach((d, idx) => {
      const chip = document.createElement("div");
      chip.className = "day-chip";
      chip.dataset.id = d.id;
      chip.innerHTML = `
        <span class="chip-main" contenteditable="true"></span>
        <span class="chip-sub" contenteditable="true"></span>
      `;
      const main = $(".chip-main", chip);
      const sub  = $(".chip-sub", chip);

      main.textContent = d.dayLabel || `Day ${idx+1}`;
      sub.textContent  = d.dateText || "";

      main.addEventListener("input", () => {
        d.dayLabel = main.textContent.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;
        scheduleSave();
        const sec = document.querySelector(`.day-section[data-id="${d.id}"]`);
        if (sec){
          const h = sec.querySelector(".day-pill span");
          if (h) h.textContent = d.dayLabel;
        }
      });

      sub.addEventListener("input", () => {
        d.dateText = sub.textContent.trim() || d.dateText;
        if (idx === 0){
          ensureDatesFromDay1();
          scheduleSave();
          render();
        }else{
          scheduleSave();
        }
      });

      chip.addEventListener("click", () => {
        activeDayId = d.id;
        setActiveChip(d.id);
        const sec = document.querySelector(`.day-section[data-id="${d.id}"]`);
        if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
      });

      enableChipDrag(chip);
      nav.appendChild(chip);
    });
  }

  function setActiveChip(id){
    $$(".day-chip").forEach(c=>c.classList.toggle("active", c.dataset.id===id));
  }

  function renderSectionHTML(key, title){
    const dotColor = key==="morning" ? "#ffb85c" :
                     key==="noon" ? "#ffd59a" :
                     key==="night" ? "#a9e2ff" :
                     key==="transport" ? "#b7f2d4" : "#ffb0a6";
    return `
      <div class="sec" data-sec="${key}">
        <div class="sec-head">
          <div class="sec-title">
            <span class="dot" style="background:${dotColor}"></span>
            <span>${title}</span>
          </div>
          <div class="sec-actions">
            <button class="btn small" data-add="${key}" data-tpl="spot" type="button">ï¼‹ æ™¯é»</button>
            <button class="btn small" data-add="${key}" data-tpl="restaurant" type="button">ï¼‹ é¤å»³</button>
            <button class="btn small" data-add="${key}" data-tpl="transport" type="button">ï¼‹ äº¤é€š</button>
            <button class="btn small" data-add="${key}" data-tpl="shopping" type="button">ï¼‹ è³¼ç‰©</button>
          </div>
        </div>
        <div class="sec-body" data-dropzone="true"></div>
      </div>
    `;
  }

  function renderDays(){
    const wrap = $("#daysContainer");
    wrap.innerHTML = "";

    state.days.forEach((d, idx) => {
      const sec = document.createElement("section");
      sec.className = "day-section";
      sec.dataset.id = d.id;

      sec.innerHTML = `
        <div class="day-card">
          <div class="day-header">
            <div class="day-pill"><span contenteditable="true"></span></div>
            <div class="day-subtitle"><span contenteditable="true"></span></div>
          </div>

          <div class="day-meta">
            <div class="datebox">æ—¥æœŸï¼š<span contenteditable="true"></span></div>

            <div class="budget" title="é ç®—ï¼ˆJPYï¼‰ï¼Œè¶…éæœƒæé†’">
              <span style="font-weight:1000;color:var(--brown-soft);font-size:12px;">é ç®—JPY</span>
              <input class="budgetInput" inputmode="numeric" placeholder="ä¾‹å¦‚ 12000"/>
            </div>

            <div class="budget" title="åŒ¯ç‡è¨­å®šï¼ˆJPYâ†’TWDï¼‰">
              <span style="font-weight:1000;color:var(--brown-soft);font-size:12px;">åŒ¯ç‡</span>
              <input class="rateInput" inputmode="decimal" />
              <span class="loc-mini">ï¼ˆ1 JPY = ? TWDï¼‰</span>
            </div>

            <span class="badge dayTotalBadge">ç•¶æ—¥åˆè¨ˆï¼š0 JPY / 0 TWD</span>
            <button class="btn small btnDayRoute" type="button">ğŸ§­ ç•¶å¤©è·¯ç·šç¸½è¦½</button>
          </div>

          <div class="tickets">
            <div class="tickets-head">
              <div>ğŸ« ç¥¨åˆ¸ / QR æ”¶ç´ï¼ˆå¯è²¼æ–‡å­—ï¼‹åŠ åœ–ç‰‡ï¼‰</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn small btnTicketPhoto" type="button">ğŸ“· åŠ åœ–ç‰‡</button>
              </div>
            </div>
            <div class="day-note-box ticketText" contenteditable="true"></div>
            <div class="tickets-grid ticketPhotos"></div>
          </div>

          <div class="sections">
            ${renderSectionHTML("morning","â˜€ï¸ æ—©ä¸Š")}
            ${renderSectionHTML("noon","ğŸŒ¤ï¸ ä¸‹åˆ")}
            ${renderSectionHTML("night","ğŸŒ™ æ™šä¸Š")}
            ${renderSectionHTML("transport","ğŸš‡ äº¤é€š")}
            ${renderSectionHTML("shopping","ğŸ›ï¸ è³¼ç‰©")}
          </div>

          <div class="day-note-card">
            <div class="day-note-head">
              <div>ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»ï¼ˆå›ºå®šåœ¨æœ€ä¸‹æ–¹ï¼‰</div>
              <button class="btn small btnDayNotePhoto" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
            </div>
            <div class="day-note-box dayNoteText" contenteditable="true"></div>
            <div class="day-note-photos dayNotePhotos"></div>
          </div>
        </div>
      `;

      // bind header
      const dayLabelEl = sec.querySelector(".day-pill span");
      dayLabelEl.textContent = d.dayLabel || `Day ${idx+1}`;
      dayLabelEl.addEventListener("input", () => {
        d.dayLabel = dayLabelEl.textContent.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;
        const chip = document.querySelector(`.day-chip[data-id="${d.id}"] .chip-main`);
        if (chip) chip.textContent = d.dayLabel;
        scheduleSave();
      });

      const subEl = sec.querySelector(".day-subtitle span");
      subEl.textContent = d.subtitle || "";
      subEl.addEventListener("input", () => { d.subtitle = subEl.textContent; scheduleSave(); });

      const dateEl = sec.querySelector(".datebox span");
      dateEl.textContent = d.dateText || "";
      dateEl.addEventListener("input", () => {
        d.dateText = dateEl.textContent.trim() || d.dateText;
        if (idx === 0){ ensureDatesFromDay1(); scheduleSave(); render(); }
        else scheduleSave();
      });

      const budgetInput = sec.querySelector(".budgetInput");
      budgetInput.value = d.budgetJPY || "";
      budgetInput.addEventListener("input", () => { d.budgetJPY = budgetInput.value; scheduleSave(); recalcTotals(); });

      const rateInput = sec.querySelector(".rateInput");
      rateInput.value = String(state.settings.rate ?? 0.22);
      rateInput.addEventListener("input", () => {
        const v = parseFloat(rateInput.value);
        if (!isNaN(v) && v > 0){ state.settings.rate = v; scheduleSave(); recalcTotals(); }
      });

      // tickets
      const ticketText = sec.querySelector(".ticketText");
      ticketText.textContent = d.tickets?.text || "";
      ticketText.addEventListener("input", () => { d.tickets.text = ticketText.textContent; scheduleSave(); });

      const ticketPhotos = sec.querySelector(".ticketPhotos");
      renderPhotoStrip(ticketPhotos, d.tickets.photos, () => scheduleSave());

      sec.querySelector(".btnTicketPhoto").addEventListener("click", async () => {
        const url = await pickPhoto();
        if (!url) return;
        d.tickets.photos.push(url);
        renderPhotoStrip(ticketPhotos, d.tickets.photos, () => scheduleSave());
        scheduleSave();
      });

      // day note
      const dayNoteText = sec.querySelector(".dayNoteText");
      dayNoteText.textContent = d.dayNote?.text || "";
      dayNoteText.addEventListener("input", () => { d.dayNote.text = dayNoteText.textContent; scheduleSave(); });

      const dayNotePhotos = sec.querySelector(".dayNotePhotos");
      renderPhotoStrip(dayNotePhotos, d.dayNote.photos, () => scheduleSave());

      sec.querySelector(".btnDayNotePhoto").addEventListener("click", async () => {
        const url = await pickPhoto();
        if (!url) return;
        d.dayNote.photos.push(url);
        renderPhotoStrip(dayNotePhotos, d.dayNote.photos, () => scheduleSave());
        scheduleSave();
      });

      // day route
      sec.querySelector(".btnDayRoute").addEventListener("click", () => openDayRoute(d));

      wrap.appendChild(sec);
      renderCardsForDay(sec, d);
    });
  }

  function escapeHTML(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  /* ===== Cards ===== */
  function renderCardsForDay(daySectionEl, dayObj){
    $$("[data-add]", daySectionEl).forEach(btn=>{
      btn.addEventListener("click", () => addCard(dayObj.id, btn.dataset.add, btn.dataset.tpl));
    });

    Object.entries(dayObj.sections).forEach(([secKey, list])=>{
      const secEl = daySectionEl.querySelector(`.sec[data-sec="${secKey}"] .sec-body`);
      secEl.innerHTML = "";

      // keep lodging at end of night
      if (list && list.length){
        const lodIdx = list.findIndex(x => x && x.type==="lodging");
        if (lodIdx >= 0 && lodIdx !== list.length-1){
          const [lod] = list.splice(lodIdx,1);
          list.push(lod);
        }
      }

      (list||[]).forEach(card=>{
        const cardEl = renderCard(card, dayObj);
        secEl.appendChild(cardEl);
      });

      enableDropZone(secEl);
    });
  }

  function renderCard(card, dayObj){
    const el = document.createElement("article");
    el.className = "spot-card";
    el.dataset.cardId = card.id;
    el.dataset.dayId  = dayObj.id;
    el.draggable = true;

    const tag = card.tag || "æ™¯é»";
    const rate = Number(state.settings.rate||0.22);
    const jpyVal = parseFloat(card.jpy||"");
    const twdCalc = (!isNaN(jpyVal) ? (jpyVal*rate) : null);

    el.innerHTML = `
      <div class="spot-top">
        <div style="flex:1;min-width:0;">
          <div class="spot-title" contenteditable="true"></div>
          <div class="spot-ja" contenteditable="true"></div>
          <div class="spot-meta" contenteditable="true"></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
          <div class="spot-tag">${escapeHTML(tag)}</div>
          ${card.type==="lodging" ? `<div class="badge" style="background:#eaf6ff;">ä½å®¿å¡</div>` : ``}
        </div>
      </div>

      <div class="row">
        <button class="btn small btnPreview" type="button">åœ°åœ–é è¦½</button>
        <button class="btn small btnSearch" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
        <button class="btn small btnRoute" type="button">ä¸€éµå°èˆªè·¯ç·š</button>
        <button class="btn small btnNearby" type="button">é™„è¿‘æœå°‹</button>
      </div>

      <div class="loc-box">
        <div class="loc-line">
          <div class="loc-label">å‡ºç™¼</div>
          <input class="loc-input origin" placeholder="å‡ºç™¼åœ°ï¼ˆå¯ç©ºï¼‰" />
        </div>
        <div class="loc-line">
          <div class="loc-label">ç›®çš„</div>
          <input class="loc-input dest" placeholder="ç›®çš„åœ° / åœ°å€ï¼ˆå»ºè­°å¡«æ—¥æ–‡æˆ–åœ°å€ï¼‰" />
        </div>
        <div class="loc-line viasRow">
          <div class="loc-label">é€”ç¶“</div>
          <div style="flex:1;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
            <span class="loc-mini">ï¼ˆå¯åŠ å¤šå€‹ï¼‰</span>
            <button class="btn small btnAddVia" type="button">ï¼‹ é€”ç¶“</button>
          </div>
        </div>
        <div class="viasList"></div>
      </div>

      <div class="expense">
        <span class="lab">èŠ±è²» JPY</span>
        <input class="inJPY" inputmode="numeric" placeholder="ä¾‹å¦‚ 1200" />
        <span class="calc">â†’ TWDï¼š<span class="twdText">${twdCalc!==null ? Math.round(twdCalc) : 0}</span></span>
      </div>

      <div class="note">
        <div class="note-head">
          <span>å‚™è¨»</span>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn small btnNotePhoto" type="button">ğŸ“·</button>
          </div>
        </div>
        <div class="note-body" contenteditable="true"></div>
        <div class="note-photos"></div>
      </div>
    `;

    const titleEl = $(".spot-title", el);
    const jaEl    = $(".spot-ja", el);
    const metaEl  = $(".spot-meta", el);
    const noteEl  = $(".note-body", el);

    titleEl.textContent = card.title || "";
    jaEl.textContent    = card.ja || "";
    metaEl.textContent  = card.meta || "";
    noteEl.textContent  = card.note || "";

    const origin = $(".origin", el);
    const dest   = $(".dest", el);
    const inJPY  = $(".inJPY", el);

    origin.value = card.origin || "";
    dest.value   = card.destination || card.ja || "";
    inJPY.value  = card.jpy || "";

    const viasList = $(".viasList", el);
    renderVias(viasList, card);

    // edits
    titleEl.addEventListener("input", () => { card.title = titleEl.textContent; scheduleSave(); });
    jaEl.addEventListener("input", () => {
      card.ja = jaEl.textContent;
      if (!card.destination){ card.destination = jaEl.textContent; dest.value = card.destination; }
      scheduleSave();
    });
    metaEl.addEventListener("input", () => { card.meta = metaEl.textContent; scheduleSave(); });
    noteEl.addEventListener("input", () => { card.note = noteEl.textContent; scheduleSave(); });

    origin.addEventListener("input", () => { card.origin = origin.value; scheduleSave(); });
    dest.addEventListener("input", () => { card.destination = dest.value; scheduleSave(); });

    inJPY.addEventListener("input", () => {
      card.jpy = inJPY.value;
      const rate = Number(state.settings.rate||0.22);
      const j = parseFloat(inJPY.value||"");
      const t = (!isNaN(j) ? Math.round(j*rate) : 0);
      $(".twdText", el).textContent = String(t);
      card.twd = String(t);
      scheduleSave();
      recalcTotals();
    });

    // photos
    const notePhotos = $(".note-photos", el);
    renderPhotoStrip(notePhotos, card.photos, () => scheduleSave());
    $(".btnNotePhoto", el).addEventListener("click", async () => {
      const url = await pickPhoto();
      if (!url) return;
      card.photos.push(url);
      renderPhotoStrip(notePhotos, card.photos, () => scheduleSave());
      scheduleSave();
    });

    // map buttons
    $(".btnPreview", el).addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      openMapPreview(q);
    });
    $(".btnSearch", el).addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, "_blank");
    });
    $(".btnRoute", el).addEventListener("click", () => openCardRoute(card));
    $(".btnNearby", el).addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      openNearbyMenu(q);
    });

    $(".btnAddVia", el).addEventListener("click", () => {
      card.vias = card.vias || [];
      card.vias.push("");
      renderVias(viasList, card);
      scheduleSave();
    });

    enableCardDrag(el);
    attachLongPress(el);
    return el;
  }

  function renderVias(container, card){
    container.innerHTML = "";
    const vias = card.vias || [];
    vias.forEach((v, idx) => {
      const line = document.createElement("div");
      line.className = "loc-line";
      line.innerHTML = `
        <div class="loc-label">é€”ç¶“${idx+1}</div>
        <input class="loc-input via" placeholder="é€”ç¶“åœ°é»/åœ°å€" />
        <button class="btn small btnDelVia" type="button">åˆª</button>
      `;
      const input = $(".via", line);
      input.value = v || "";
      input.addEventListener("input", () => { card.vias[idx] = input.value; scheduleSave(); });
      $(".btnDelVia", line).addEventListener("click", () => {
        card.vias.splice(idx,1);
        renderVias(container, card);
        scheduleSave();
      });
      container.appendChild(line);
    });
  }

  function addCard(dayId, secKey, tpl){
    const d = state.days.find(x=>x.id===dayId);
    if (!d) return;

    pushUndo();
    const c = newCardTemplate(tpl==="spot" ? "spot" : tpl);
    c.title = tpl==="restaurant" ? "æ–°é¤å»³" : tpl==="transport" ? "æ–°äº¤é€š" : tpl==="shopping" ? "æ–°è³¼ç‰©" : "æ–°æ™¯é»";
    c.tag   = tpl==="restaurant" ? "é¤å»³" : tpl==="transport" ? "äº¤é€š" : tpl==="shopping" ? "è³¼ç‰©" : "æ™¯é»";

    if (tpl==="lodging") return;

    d.sections[secKey] = d.sections[secKey] || [];
    if (secKey==="night"){
      const lodIdx = d.sections.night.findIndex(x=>x.type==="lodging");
      if (lodIdx >= 0) d.sections.night.splice(lodIdx,0,c);
      else d.sections.night.push(c);
    }else{
      d.sections[secKey].push(c);
    }
    scheduleSave();
    render();
  }

  /* ===== Photos ===== */
  const photoPicker = $("#photoPicker");
  let photoResolve = null;

  function pickPhoto(){
    return new Promise((resolve) => {
      photoResolve = resolve;
      photoPicker.value = "";
      photoPicker.click();
    });
  }

  photoPicker.addEventListener("change", () => {
    const file = photoPicker.files && photoPicker.files[0];
    if (!file){
      if (photoResolve) photoResolve(null);
      photoResolve = null;
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      if (photoResolve) photoResolve(String(e.target.result || ""));
      photoResolve = null;
    };
    reader.readAsDataURL(file);
  });

  function renderPhotoStrip(container, list, onChanged){
    container.innerHTML = "";
    (list||[]).forEach((url, idx) => {
      const img = document.createElement("img");
      img.className = "thumb";
      img.src = url;
      img.alt = "photo";
      img.title = "é»ä¸€ä¸‹ç›´æ¥åˆªé™¤";
      img.addEventListener("click", () => {
        list.splice(idx,1);
        renderPhotoStrip(container, list, onChanged);
        onChanged && onChanged();
        scheduleSave();
      });
      container.appendChild(img);
    });
  }

  /* ===== Map modal ===== */
  const modal = $("#mapModal");
  const modalFrame = $("#modalFrame");
  $("#btnCloseModal").addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if (e.target===modal) closeModal(); });

  function openMapPreview(query){
    $("#modalTitle").textContent = `åœ°åœ–é è¦½ï¼š${query}`;
    modalFrame.src = `https://www.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
    modalFrame.src = "about:blank";
  }

  function openCardRoute(card){
    const origin = (card.origin||"").trim();
    const dest = (card.destination || card.ja || card.title || "").trim();
    if (!dest) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€");
    const vias = (card.vias||[]).map(x=>String(x||"").trim()).filter(Boolean);
    const ori = origin || state.settings.hotelNameJP || state.settings.hotelName || "ä¸Šé‡";
    let url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(ori)}&destination=${encodeURIComponent(dest)}`;
    if (vias.length) url += `&waypoints=${encodeURIComponent(vias.join("|"))}`;
    window.open(url, "_blank");
  }

  const SEC_ORDER = ["morning","noon","night","transport","shopping"];
  function flattenDayCards(dayObj){
    const arr = [];
    SEC_ORDER.forEach(k => (dayObj.sections[k]||[]).forEach(c=>arr.push(c)));
    return arr;
  }

  function openDayRoute(dayObj){
    const cards = flattenDayCards(dayObj).filter(c=>c.type!=="lodging");
    const points = [];
    cards.forEach(c=>{
      const q = (c.destination || c.ja || c.title || "").trim();
      if (q) points.push(q);
    });
    if (!points.length) return alert("é€™å¤©æ²’æœ‰å¯å°èˆªçš„ç›®çš„åœ°ï¼ˆè«‹å¡«ç›®çš„åœ°/åœ°å€ï¼‰");

    const origin = state.settings.hotelNameJP || state.settings.hotelName || "ä¸Šé‡";
    const destination = points[points.length-1];
    const mids = points.slice(0, points.length-1).slice(0,9);
    let url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
    if (mids.length) url += `&waypoints=${encodeURIComponent(mids.join("|"))}`;
    window.open(url, "_blank");
  }

  function openNearbyMenu(baseQuery){
    const options = [
      {k:"è¶…å•†", q:`${baseQuery} é™„è¿‘ ä¾¿åˆ©å•†åº—`},
      {k:"è—¥å¦", q:`${baseQuery} é™„è¿‘ è—¥å¦åº—`},
      {k:"è»Šç«™", q:`${baseQuery} é™„è¿‘ è»Šç«™`},
      {k:"å»æ‰€", q:`${baseQuery} é™„è¿‘ ãƒˆã‚¤ãƒ¬`},
      {k:"é¤å»³", q:`${baseQuery} é™„è¿‘ é¤å»³`},
    ];
    const pick = prompt("é™„è¿‘æœå°‹ï¼šè¼¸å…¥ 1-5\n1 è¶…å•†\n2 è—¥å¦\n3 è»Šç«™\n4 å»æ‰€\n5 é¤å»³", "2");
    const n = parseInt(pick||"", 10);
    if (!n || n<1 || n>5) return;
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(options[n-1].q)}`, "_blank");
  }

  /* ===== Totals ===== */
  function recalcTotals(){
    const rate = Number(state.settings.rate||0.22);
    let tripJPY = 0, tripTWD = 0;

    state.days.forEach(d=>{
      let dayJPY = 0, dayTWD = 0;
      flattenDayCards(d).forEach(c=>{
        const j = parseFloat(c.jpy||"");
        let t = parseFloat(c.twd||"");
        if (!isNaN(j)){
          dayJPY += j;
          if (isNaN(t) || !c.twd){
            t = Math.round(j*rate);
            c.twd = String(t);
          }
        }
        if (!isNaN(t)) dayTWD += t;
      });

      tripJPY += dayJPY;
      tripTWD += dayTWD;

      const sec = document.querySelector(`.day-section[data-id="${d.id}"]`);
      if (sec){
        const badge = sec.querySelector(".dayTotalBadge");
        if (badge){
          badge.textContent = `ç•¶æ—¥åˆè¨ˆï¼š${Math.round(dayJPY)} JPY / ${Math.round(dayTWD)} TWD`;
          const bud = parseFloat(d.budgetJPY||"");
          if (!isNaN(bud) && bud>0 && dayJPY>bud){
            badge.style.background = "#ffb0a6";
            badge.style.color = "#7a221b";
            badge.textContent += "ï¼ˆè¶…å‡ºé ç®—âš ï¸ï¼‰";
          }else{
            badge.style.background = "";
            badge.style.color = "";
          }
        }
      }
    });

    // ä¸è¦ä¸€ç›´è¦†è“‹ç™»å…¥ç‹€æ…‹æç¤ºï¼Œé€™è£¡åªåŠ åˆè¨ˆè³‡è¨Š
    const base = (window.CloudSync ? "é›²ç«¯åŒæ­¥å¯ç”¨" : "é›¢ç·šå¯ç”¨");
    $("#syncBadge").textContent = `å…¨æ—…ç¨‹åˆè¨ˆï¼š${Math.round(tripJPY)} JPY / ${Math.round(tripTWD)} TWDï¼ˆ${base}ï¼‰`;
  }

  /* ===== Day add/remove ===== */
  function addDay(){
    pushUndo();
    const idx = state.days.length + 1;
    const id = `d_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    const day = {
      id, autoDayLabel:true, dayLabel:`Day ${idx}`,
      subtitle:"ï¼ˆæ–°çš„ä¸€å¤©è¡Œç¨‹ï¼‰", dateText:"",
      budgetJPY:"",
      tickets:{ text:"", photos:[] },
      sections:{ morning:[], noon:[], night:[], transport:[], shopping:[] },
      dayNote:{ text:"", photos:[] }
    };
    const lod = newCardTemplate("lodging");
    lod.title = `ä½å®¿ï¼š${state.settings.hotelName}`;
    lod.ja = state.settings.hotelNameJP;
    lod.meta = "ä½å®¿åœ°é»ï¼ˆå›ºå®šåœ¨ç•¶æ—¥å‚™è¨»ä¸Šæ–¹ï¼‰";
    lod.pinned = true;
    day.sections.night.push(lod);

    state.days.push(day);
    ensureDatesFromDay1();
    scheduleSave();
    render();
  }

  function removeLastDay(){
    if (state.days.length <= 1) return alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©");
    pushUndo();
    state.days.pop();
    ensureDatesFromDay1();
    scheduleSave();
    render();
  }

  /* ===== Import/Export ===== */
  $("#btnExport").addEventListener("click", () => {
    const data = { savedAt:new Date().toISOString(), state };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "NijiTrip2026_backup.json";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  $("#btnImport").addEventListener("click", () => $("#importFile").click());
  $("#importFile").addEventListener("change", () => {
    const file = $("#importFile").files && $("#importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try{
        const data = JSON.parse(String(e.target.result||"{}"));
        if (data && data.state){
          pushUndo();
          state = data.state;
          state._rev = state._rev || 0;
          ensureDatesFromDay1();
          saveNow(true);
          render();
        }else alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸å°");
      }catch(err){
        alert("åŒ¯å…¥å¤±æ•—ï¼šJSON è§£æéŒ¯èª¤");
      }
    };
    reader.readAsText(file, "utf-8");
    $("#importFile").value = "";
  });

  $("#btnClear").addEventListener("click", () => {
    if (!confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰")) return;
    clearLocal();
    undoStack = [];
    initState();
    render();
  });

  /* ===== Undo ===== */
  $("#btnUndo").addEventListener("click", () => {
    if (undoStack.length <= 1) return;
    undoStack.pop();
    const prev = undoStack[undoStack.length-1];
    if (!prev) return;
    try{
      state = JSON.parse(prev);
      state._rev = state._rev || 0;
      saveNow(true);
      render();
      $("#btnUndo").disabled = undoStack.length <= 1;
    }catch(e){}
  });

  $("#btnJumpActive").addEventListener("click", () => {
    if (!activeDayId) return;
    const sec = document.querySelector(`.day-section[data-id="${activeDayId}"]`);
    if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
  });

  /* ===== Search ===== */
  function doSearch(){
    const q = $("#searchInput").value.trim();
    if (!q){ $("#searchResult").textContent = "è«‹è¼¸å…¥é—œéµå­—"; return; }
    const hits = [];
    state.days.forEach(d=>{
      if ((d.tickets?.text||"").includes(q)) hits.push({day:d, where:"ç¥¨åˆ¸æ–‡å­—"});
      if ((d.dayNote?.text||"").includes(q)) hits.push({day:d, where:"ç•¶æ—¥å‚™è¨»"});
      flattenDayCards(d).forEach(c=>{
        const blob = `${c.title||""} ${c.ja||""} ${c.meta||""} ${c.note||""} ${c.origin||""} ${c.destination||""} ${(c.vias||[]).join(" ")}`;
        if (blob.includes(q)) hits.push({day:d, card:c, where:"è¡Œç¨‹å¡"});
      });
    });
    $("#searchResult").textContent = hits.length ? `æ‰¾åˆ° ${hits.length} ç­†` : "æ‰¾ä¸åˆ°";
    if (!hits.length) return;

    const first = hits[0];
    activeDayId = first.day.id;
    setActiveChip(activeDayId);
    const sec = document.querySelector(`.day-section[data-id="${first.day.id}"]`);
    if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
    if (first.card){
      setTimeout(()=>{
        const cardEl = sec.querySelector(`.spot-card[data-card-id="${first.card.id}"]`) || sec.querySelector(`.spot-card[data-cardid="${first.card.id}"]`);
        if (cardEl){
          cardEl.style.outline = "3px solid rgba(255,184,92,.9)";
          cardEl.style.outlineOffset = "3px";
          setTimeout(()=>{ cardEl.style.outline=""; cardEl.style.outlineOffset=""; }, 1600);
        }
      }, 350);
    }
  }
  $("#btnSearch").addEventListener("click", doSearch);
  $("#searchInput").addEventListener("keydown", (e) => {
    if (e.key==="Enter"){ e.preventDefault(); doSearch(); }
  });

  /* ===== title/desc save ===== */
  $("#appTitle").addEventListener("input", () => { state.appTitle = $("#appTitle").textContent.trim(); scheduleSave(); });
  $("#appDesc").addEventListener("input", () => { state.appDesc = $("#appDesc").textContent; scheduleSave(); });

  $("#btnAddDay").addEventListener("click", addDay);
  $("#btnRemoveDay").addEventListener("click", removeLastDay);

  /* ===== âœ… scheduleSaveï¼šåŠ  _rev é˜²æ­¢æ‰“å­—è·³æ‰ ===== */
  let saveTimer = null;
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      // âœ… ç‰ˆæœ¬è™Ÿéå¢ï¼šé›²ç«¯ snapshot å›ä¾†å¦‚æœä¸æ˜¯æ›´å¤§ç‰ˆæœ¬ï¼Œå°±ä¸å¥—ç”¨ï¼Œä¸æœƒ re-render æ‰ç„¦é»
      state._rev = (state._rev || 0) + 1;

      saveNow(true);
      pushUndo();
      recalcTotals();
    }, 250);
  }

  /* ===== Drag reorder (days) ===== */
  let draggingChip = null;
  function enableChipDrag(chip){
    chip.draggable = true;
    chip.addEventListener("dragstart", (e) => { draggingChip = chip; chip.classList.add("dragging"); e.dataTransfer.effectAllowed = "move"; });
    chip.addEventListener("dragend", () => {
      if (!draggingChip) return;
      draggingChip.classList.remove("dragging");
      draggingChip = null;

      const ids = $$(".day-chip").map(x=>x.dataset.id);
      const newDays = [];
      ids.forEach(id=>{
        const d = state.days.find(x=>x.id===id);
        if (d) newDays.push(d);
      });
      state.days = newDays;
      state.days.forEach((d, idx) => { if (d.autoDayLabel) d.dayLabel = `Day ${idx+1}`; });
      ensureDatesFromDay1();

      scheduleSave();
      render();
    });
  }

  $("#dayNav").addEventListener("dragover", (e) => {
    if (!draggingChip) return;
    e.preventDefault();
    const after = getChipAfterX($("#dayNav"), e.clientX);
    if (!after) $("#dayNav").appendChild(draggingChip);
    else $("#dayNav").insertBefore(draggingChip, after);
  });

  function getChipAfterX(container, x){
    const chips = [...container.querySelectorAll(".day-chip:not(.dragging)")];
    let closest = { offset: Number.NEGATIVE_INFINITY, el:null };
    chips.forEach(c=>{
      const box = c.getBoundingClientRect();
      const offset = x - (box.left + box.width/2);
      if (offset < 0 && offset > closest.offset) closest = { offset, el:c };
    });
    return closest.el;
  }

  /* ===== Card drag/drop ===== */
  let draggingCardEl = null;

  function enableCardDrag(cardEl){
    cardEl.addEventListener("dragstart", (e) => {
      draggingCardEl = cardEl;
      cardEl.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    cardEl.addEventListener("dragend", () => {
      if (!draggingCardEl) return;
      draggingCardEl.classList.remove("dragging");
      draggingCardEl = null;
      syncCardsFromDOM();
      scheduleSave();
    });
  }

  function enableDropZone(zoneEl){
    zoneEl.addEventListener("dragover", (e) => {
      if (!draggingCardEl) return;
      e.preventDefault();
      autoScrollWhileDragging(e.clientY);
      const after = getCardAfterY(zoneEl, e.clientY);
      if (!after) zoneEl.appendChild(draggingCardEl);
      else zoneEl.insertBefore(draggingCardEl, after);
    });
  }

  function getCardAfterY(container, y){
    const els = [...container.querySelectorAll(".spot-card:not(.dragging)")];
    let closest = { offset:Number.NEGATIVE_INFINITY, el:null };
    els.forEach(el=>{
      const box = el.getBoundingClientRect();
      const offset = y - (box.top + box.height/2);
      if (offset < 0 && offset > closest.offset) closest = { offset, el };
    });
    return closest.el;
  }

  function autoScrollWhileDragging(clientY){
    const margin = 80, speed = 18;
    const top = margin, bottom = window.innerHeight - margin;
    if (clientY < top) window.scrollBy(0, -speed);
    else if (clientY > bottom) window.scrollBy(0, speed);
  }

  function findCardById(cid){
    for (const d of state.days){
      for (const k of Object.keys(d.sections)){
        for (const c of (d.sections[k]||[])){
          if (c.id===cid) return c;
        }
      }
    }
    return null;
  }

  function syncCardsFromDOM(){
    state.days.forEach(d=>{
      Object.keys(d.sections).forEach(k=>d.sections[k]=[]);
      const daySec = document.querySelector(`.day-section[data-id="${d.id}"]`);
      if (!daySec) return;
      daySec.querySelectorAll(".sec").forEach(secEl=>{
        const secKey = secEl.dataset.sec;
        [...secEl.querySelectorAll(".spot-card")].forEach(cardEl=>{
          const cid = cardEl.dataset.cardId;
          const card = findCardById(cid);
          if (card) d.sections[secKey].push(card);
        });
      });

      const night = d.sections.night || [];
      const lodIdx = night.findIndex(x=>x.type==="lodging");
      if (lodIdx>=0 && lodIdx !== night.length-1){
        const [lod] = night.splice(lodIdx,1);
        night.push(lod);
      }
    });
  }

  /* ===== Long press menu ===== */
  const menu = $("#ctxMenu");
  let menuCardInfo = null;
  let pressTimer = null;
  let pressStart = null;

  function attachLongPress(cardEl){
    const onDown = (e) => {
      if (e.type==="mousedown" && e.button !== 0) return;
      pressStart = { x: e.clientX, y: e.clientY };
      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => openMenuForCard(cardEl, e.clientX, e.clientY), 520);
    };
    const onMove = (e) => {
      if (!pressStart) return;
      const dx = Math.abs(e.clientX - pressStart.x);
      const dy = Math.abs(e.clientY - pressStart.y);
      if (dx > 12 || dy > 12) clearTimeout(pressTimer);
    };
    const onUp = () => { clearTimeout(pressTimer); pressStart = null; };

    cardEl.addEventListener("touchstart", (e) => { const t = e.touches[0]; onDown({type:"touchstart", clientX:t.clientX, clientY:t.clientY}); }, {passive:true});
    cardEl.addEventListener("touchmove",  (e) => { const t = e.touches[0]; onMove({clientX:t.clientX, clientY:t.clientY}); }, {passive:true});
    cardEl.addEventListener("touchend", onUp);

    cardEl.addEventListener("mousedown", onDown);
    cardEl.addEventListener("mousemove", onMove);
    cardEl.addEventListener("mouseup", onUp);
    cardEl.addEventListener("mouseleave", onUp);
  }

  function openMenuForCard(cardEl, x, y){
    const dayId = cardEl.dataset.dayId;
    const cardId = cardEl.dataset.cardId;
    const secEl = cardEl.closest(".sec");
    const secKey = secEl ? secEl.dataset.sec : "morning";

    const card = findCardById(cardId);
    if (!card) return;

    menuCardInfo = { dayId, secKey, cardId };
    $("#ctxTitle").textContent = `å¡ç‰‡ï¼š${(card.title||"")}`.slice(0, 28);

    menu.style.left = Math.min(x, window.innerWidth - 240) + "px";
    menu.style.top  = Math.min(y, window.innerHeight - 260) + "px";
    menu.classList.add("show");
  }

  function closeMenu(){ menu.classList.remove("show"); menuCardInfo = null; }

  document.addEventListener("click", (e) => {
    if (menu.classList.contains("show") && !menu.contains(e.target)) closeMenu();
  });

  $("#mDrag").addEventListener("click", () => { alert("å·²é€²å…¥æ‹–æ‹‰æ¨¡å¼ï¼šè«‹ç›´æ¥æ‹–æ‹‰å¡ç‰‡ï¼ˆæ‹–æ‹‰æ™‚æœƒè‡ªå‹•æ»¾å‹•ï¼‰"); closeMenu(); });

  $("#mDelete").addEventListener("click", () => {
    if (!menuCardInfo) return;
    const { dayId, secKey, cardId } = menuCardInfo;
    const d = state.days.find(x=>x.id===dayId);
    if (!d) return;
    const list = d.sections[secKey]||[];
    const idx = list.findIndex(c=>c.id===cardId);
    if (idx<0) return;

    const card = list[idx];
    if (card.type==="lodging"){ alert("ä½å®¿å¡æ˜¯å›ºå®šçš„ï¼ˆä¸èƒ½åˆªé™¤ï¼‰ã€‚"); closeMenu(); return; }

    pushUndo();
    list.splice(idx,1);
    scheduleSave();
    render();
    closeMenu();
  });

  $("#mCopy").addEventListener("click", () => {
    if (!menuCardInfo) return;
    const { dayId, secKey, cardId } = menuCardInfo;
    const d = state.days.find(x=>x.id===dayId);
    if (!d) return;
    const list = d.sections[secKey]||[];
    const idx = list.findIndex(c=>c.id===cardId);
    if (idx<0) return;

    pushUndo();
    const src = list[idx];
    const clone = JSON.parse(JSON.stringify(src));
    clone.id = `c_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    list.splice(idx+1, 0, clone);
    scheduleSave();
    render();
    closeMenu();
  });

  $("#mPin").addEventListener("click", () => {
    if (!menuCardInfo) return;
    const { dayId, secKey, cardId } = menuCardInfo;
    const d = state.days.find(x=>x.id===dayId);
    if (!d) return;
    const list = d.sections[secKey]||[];
    const idx = list.findIndex(c=>c.id===cardId);
    if (idx<0) return;

    const card = list[idx];
    if (card.type==="lodging"){ alert("ä½å®¿å¡å·²å›ºå®šåœ¨åº•éƒ¨ã€‚"); closeMenu(); return; }

    pushUndo();
    list.splice(idx,1);
    list.unshift(card);
    scheduleSave();
    render();
    closeMenu();
  });

  $("#mMove").addEventListener("click", () => {
    if (!menuCardInfo) return;
    const { dayId, secKey, cardId } = menuCardInfo;
    const fromDay = state.days.find(x=>x.id===dayId);
    if (!fromDay) return;

    const labels = state.days.map((d,i)=> `${i+1}. ${d.dayLabel} (${d.dateText})`).join("\n");
    const pick = prompt("ç§»åˆ°å“ªä¸€å¤©ï¼Ÿè¼¸å…¥åºè™Ÿï¼š\n" + labels, "2");
    const n = parseInt(pick||"", 10);
    if (!n || n<1 || n>state.days.length){ closeMenu(); return; }
    const toDay = state.days[n-1];

    const secPick = prompt("ç§»åˆ°å“ªå€‹åˆ†å€ï¼Ÿè¼¸å…¥ï¼šmorning / noon / night / transport / shopping", "morning");
    const targetSec = ["morning","noon","night","transport","shopping"].includes(secPick) ? secPick : "morning";

    const list = fromDay.sections[secKey]||[];
    const idx = list.findIndex(c=>c.id===cardId);
    if (idx<0) return;

    const card = list[idx];
    if (card.type==="lodging"){ alert("ä½å®¿å¡æ˜¯å›ºå®šçš„ï¼Œä¸æ”¯æ´ç§»å‹•ã€‚"); closeMenu(); return; }

    pushUndo();
    list.splice(idx,1);
    toDay.sections[targetSec] = toDay.sections[targetSec] || [];
    if (targetSec==="night"){
      const lodIdx = toDay.sections.night.findIndex(x=>x.type==="lodging");
      if (lodIdx>=0) toDay.sections.night.splice(lodIdx,0,card);
      else toDay.sections.night.push(card);
    }else{
      toDay.sections[targetSec].push(card);
    }
    scheduleSave();
    render();
    closeMenu();
  });

  /* ===== âœ… Cloud: auto load + subscribe (rev-based) ===== */
  async function waitCloudSyncReady(timeoutMs=8000){
    const start = Date.now();
    while(!window.CloudSync){
      if (Date.now() - start > timeoutMs) return false;
      await new Promise(r=>setTimeout(r,120));
    }
    return true;
  }

  async function autoLoadFromCloudOnce(){
    if (_autoLoaded) return;
    if (!window.CloudSync) return;
    try{
      setStatus("é›²ç«¯è¼‰å…¥ä¸­â€¦");
      const remoteState = await window.CloudSync.load();
      if (remoteState && typeof remoteState === "object"){
        state = remoteState;
        state._rev = state._rev || 0;
        ensureDatesFromDay1();
        saveNow(false); // åªå­˜æœ¬æ©Ÿ
        render();
        setStatus("å·²å¾é›²ç«¯è¼‰å…¥ âœ…");
      }else{
        setStatus("é›²ç«¯å°šç„¡è³‡æ–™ï¼ˆç¶­æŒæœ¬æ©Ÿï¼‰");
      }
      subscribeCloud();
      _autoLoaded = true;
    }catch(e){
      console.warn(e);
      setStatus("é›²ç«¯è¼‰å…¥å¤±æ•—ï¼ˆå…ˆç”¨æœ¬æ©Ÿè³‡æ–™ï¼‰");
    }
  }

  function subscribeCloud(){
    if (!window.CloudSync) return;
    if (cloudUnsub) { try{ cloudUnsub(); }catch(e){} cloudUnsub=null; }

    cloudUnsub = window.CloudSync.subscribe((remoteState) => {
      const localRev  = state?._rev || 0;
      const remoteRev = remoteState?._rev || 0;

      // âœ… åªå¥—ç”¨ã€Œæ›´å¤§çš„ç‰ˆæœ¬ã€ï¼šé¿å…ä½ æ‰“å­—æ™‚ snapshot é€ æˆ render -> æ¸¸æ¨™è·³æ‰
      if (remoteRev <= localRev) return;

      state = remoteState;
      state._rev = state._rev || 0;
      ensureDatesFromDay1();
      saveNow(false);
      render();
      setStatus("é›²ç«¯åŒæ­¥æ›´æ–° âœ…");
    });
  }

  /* ===== Init ===== */
  initState();
  render();

  if (undoStack.length === 0){
    pushUndo();
    $("#btnUndo").disabled = true;
  }

  // æš´éœ²çµ¦ auth module ä½¿ç”¨
  window.__NijiTrip = {
    onCloudReady: async () => {
      const ok = await waitCloudSyncReady();
      if (!ok) return;
      await autoLoadFromCloudOnce();
    },
    onCloudOff: () => {
      if (cloudUnsub) { try{ cloudUnsub(); }catch(e){} }
      cloudUnsub = null;
      window.CloudSync = null;
      _autoLoaded = false;
      setStatus("é›¢ç·šæ¨¡å¼ï¼ˆæœªç™»å…¥æˆ–é›²ç«¯ä¸å¯ç”¨ï¼‰");
    }
  };

})();
</script>

<!-- âœ… Firebase Auth + Firestore CloudSync (Email/Password only) -->
<script type="module">
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const TRIP_ID = "main"; // æ¯å€‹å¸³è™Ÿå„è‡ªä¸€ä»½ main

  // UI refs
  const $ = (s)=>document.querySelector(s);
  const emailEl = $("#loginEmail");
  const passEl  = $("#loginPass");
  const infoEl  = $("#loginInfo");
  const btnUp   = $("#btnSignUp");
  const btnIn   = $("#btnSignIn");
  const btnOut  = $("#btnSignOut");

  function setLoginUI(user){
    if (user){
      infoEl.textContent = `å·²ç™»å…¥ï¼š${user.email}ï¼ˆç™»å…¥å¾Œè‡ªå‹•é›²ç«¯è¼‰å…¥/åŒæ­¥ï¼‰`;
      btnOut.style.display = "";
      btnIn.style.display  = "none";
      btnUp.style.display  = "none";
    }else{
      infoEl.textContent = "æœªç™»å…¥ï¼ˆå¯é›¢ç·šä½¿ç”¨ï¼›ç™»å…¥å¾Œè‡ªå‹•å¾é›²ç«¯è¼‰å…¥/åŒæ­¥ï¼‰";
      btnOut.style.display = "none";
      btnIn.style.display  = "";
      btnUp.style.display  = "";
    }
  }

  btnUp.addEventListener("click", async () => {
    const email = (emailEl.value||"").trim();
    const pass  = (passEl.value||"").trim();
    if (!email || !pass) return alert("è«‹è¼¸å…¥ Email èˆ‡ å¯†ç¢¼");
    if (pass.length < 6) return alert("å¯†ç¢¼è‡³å°‘ 6 ç¢¼");
    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      alert("è¨»å†ŠæˆåŠŸ âœ…");
    }catch(e){
      alert("è¨»å†Šå¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  btnIn.addEventListener("click", async () => {
    const email = (emailEl.value||"").trim();
    const pass  = (passEl.value||"").trim();
    if (!email || !pass) return alert("è«‹è¼¸å…¥ Email èˆ‡ å¯†ç¢¼");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      alert("ç™»å…¥å¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  btnOut.addEventListener("click", async () => {
    try{
      await signOut(auth);
    }catch(e){
      alert("ç™»å‡ºå¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  // When auth changes: create CloudSync adapter bound to uid
  onAuthStateChanged(auth, async (user) => {
    setLoginUI(user);

    if (!user){
      // turn off CloudSync
      if (window.__NijiTrip) window.__NijiTrip.onCloudOff();
      return;
    }

    // âœ… per-user doc: users/{uid}/trips/main
    const tripRef = doc(db, "users", user.uid, "trips", TRIP_ID);

    window.CloudSync = {
      async load(){
        const snap = await getDoc(tripRef);
        return snap.exists() ? (snap.data()?.state ?? null) : null;
      },
      async save(state){
        await setDoc(tripRef, { state, updatedAt: serverTimestamp() }, { merge:true });
      },
      subscribe(onState){
        return onSnapshot(tripRef, (snap) => {
          if (!snap.exists()) return;
          const remote = snap.data()?.state ?? null;
          if (remote) onState(remote);
        });
      }
    };

    // âœ… ç™»å…¥å¾Œè‡ªå‹•é›²ç«¯è¼‰å…¥ï¼ˆåªè·‘ä¸€æ¬¡ï¼‰
    if (window.__NijiTrip) await window.__NijiTrip.onCloudReady();
  });
</script>

</body>
</html>

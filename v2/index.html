<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Niji Trip 2026 ğŸŒˆ</title>
  <meta name="theme-color" content="#ffcf8f"/>

  <style>
    :root{
      --bg-main:#fce0b3;
      --bg-card:#fff7e8;
      --bg-soft:#e5f4ff;
      --chip:#fff6e5;
      --chip-active:#ffffff;
      --brown:#7a4a26;
      --brown-soft:#a26b3a;
      --border:rgba(186, 140, 91, 0.40);
      --shadow:0 2px 6px rgba(0,0,0,0.08);
      --r-big:24px;
      --r-card:18px;
      --r-pill:999px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",sans-serif; background:var(--bg-main); color:var(--brown); }
    body{ min-height:100vh; }

    .page{ max-width:920px; margin:0 auto; padding:14px 12px 110px; }

    header{
      background:var(--bg-card);
      border-radius:26px;
      padding:18px 16px 14px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .title-row{ display:flex; align-items:center; gap:8px; }
    .title-row h1{ margin:0; font-size:26px; font-weight:900; letter-spacing:0.03em; }
    .title-row .emoji{ font-size:24px; }
    .desc{ margin:8px 0 10px; font-size:14px; color:var(--brown-soft); line-height:1.65; }
    .desc[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.2); }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      margin-top:10px;
    }
    .btn{
      border:none; border-radius:var(--r-pill);
      padding:8px 14px; font-size:14px;
      background:#ffd59a; color:#5a351e;
      box-shadow:var(--shadow); cursor:pointer; white-space:nowrap;
      font-weight:800;
    }
    .btn.primary{ background:#ffb85c; }
    .btn.danger{ background:#ffb0a6; color:#7a221b; }
    .btn.ghost{ background:#fff3da; }
    .btn.small{ padding:6px 10px; font-size:13px; box-shadow:none; }
    .btn:active{ transform:translateY(1px); box-shadow:0 1px 3px rgba(0,0,0,0.16); }

    .badge{
      display:inline-block; padding:7px 11px; border-radius:var(--r-pill);
      background:#fff3c5; color:#5c3a1c; font-weight:900; font-size:13px;
      border:1px solid rgba(122,74,38,0.10);
    }
    .hint{
      margin-top:10px; font-size:13px; color:var(--brown-soft); line-height:1.55;
    }

    /* Sticky day nav */
    .sticky-wrap{
      position:sticky; top:0; z-index:20;
      padding-top:10px;
      background:linear-gradient(to bottom, rgba(252,224,179,0.96), rgba(252,224,179,0.70), rgba(252,224,179,0.0));
      backdrop-filter: blur(6px);
    }
    .day-nav{
      background:#e3f2ff;
      border-radius:24px;
      padding:10px 8px;
      overflow-x:auto;
      display:flex; gap:10px;
      box-shadow:var(--shadow);
    }
    .day-chip{
      flex:0 0 auto;
      min-width:92px;
      background:var(--chip);
      border-radius:var(--r-big);
      padding:7px 10px 6px;
      text-align:center;
      box-shadow:var(--shadow);
      cursor:pointer;
      border:1px solid transparent;
      user-select:none;
      position:relative;
    }
    .day-chip.active{ background:var(--chip-active); border-color:rgba(122,74,38,0.22); }
    .day-chip.dragging{ opacity:0.55; }
    .chip-main{ font-weight:1000; font-size:15px; display:block; }
    .chip-sub{ font-size:12px; color:var(--brown-soft); display:block; margin-top:2px; }
    .chip-main[contenteditable], .chip-sub[contenteditable]{ outline:none; }

    /* Filter tabs */
    .filters{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:10px; padding-top:10px;
      border-top:1px dashed rgba(122,74,38,0.20);
    }
    .tab{
      border:none;
      border-radius:999px;
      padding:7px 12px;
      background:#fff3da;
      color:#5a351e;
      font-weight:1000;
      cursor:pointer;
    }
    .tab.active{
      background:#ffffff;
      box-shadow:var(--shadow);
      border:1px solid rgba(122,74,38,0.18);
    }

    /* Day section */
    .day-section{ margin-top:12px; margin-bottom:16px; }
    .day-card{
      background:var(--bg-soft);
      border-radius:28px;
      padding:12px 10px 14px;
      box-shadow:var(--shadow);
    }
    .day-header{
      display:flex; flex-wrap:wrap; align-items:baseline; gap:10px;
      padding:2px 6px 0;
      margin-bottom:6px;
    }
    .day-pill{
      background:#fff;
      border-radius:var(--r-pill);
      padding:7px 14px;
      box-shadow:var(--shadow);
      font-size:18px; font-weight:1000;
    }
    .day-pill span[contenteditable]{ outline:none; }
    .day-subtitle{ color:var(--brown-soft); font-size:15px; }
    .day-subtitle span[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.22); }

    .day-meta{
      margin:6px 6px 10px;
      font-size:13px; color:var(--brown-soft);
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .day-meta .datebox{
      background:#fff; border-radius:var(--r-pill);
      padding:6px 12px; box-shadow:var(--shadow);
      font-weight:1000; color:#5c3a1c;
    }
    .day-meta .datebox span[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.22); }
    .day-meta .budget{
      background:#fff; border-radius:var(--r-pill);
      padding:6px 10px; box-shadow:var(--shadow);
      border:1px solid rgba(122,74,38,0.12);
      display:flex; gap:6px; align-items:center;
    }
    .day-meta input{
      width:92px; border:none; outline:none;
      background:transparent; color:#5c3a1c; font-weight:1000;
      font-size:13px;
    }

    .sections{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding:0 6px 6px;
    }
    .sec{
      background:rgba(255,255,255,0.55);
      border-radius:18px;
      padding:10px 10px 12px;
      border:1px solid rgba(122,74,38,0.10);
    }
    .sec-head{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      margin-bottom:8px;
    }
    .sec-title{
      font-weight:1000;
      font-size:14px;
      color:#5c3a1c;
      display:flex; align-items:center; gap:6px;
    }
    .sec-title .dot{
      width:9px; height:9px; border-radius:50%;
      background:#ffb85c;
      box-shadow:var(--shadow);
    }
    .sec-actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .sec-actions .btn{ background:#ffe7bf; }

    /* Spot card */
    .spot-card{
      background:var(--bg-card);
      border-radius:var(--r-card);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      margin:0 0 10px;
      user-select:none;
      position:relative;
      touch-action: pan-y;
    }
    .spot-card.dragging{ opacity:0.60; }
    .spot-top{
      display:flex; justify-content:space-between; align-items:flex-start; gap:8px;
    }
    .spot-title{
      font-weight:1000; font-size:16px; margin:0 0 4px;
      line-height:1.25;
    }
    .spot-title[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.18); }
    .spot-tag{
      font-size:12px; font-weight:1000;
      padding:4px 10px; border-radius:var(--r-pill);
      background:#fff3da;
      border:1px solid rgba(122,74,38,0.10);
      color:#5c3a1c;
      white-space:nowrap;
    }
    .spot-ja{ font-size:13px; color:var(--brown-soft); margin:0 0 4px; }
    .spot-ja[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.18); }
    .spot-meta{ font-size:13px; color:var(--brown-soft); margin:0 0 8px; }
    .spot-meta[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.18); }

    .row{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      margin:8px 0;
    }

    .loc-box{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      padding:8px 9px;
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
    }
    .loc-line{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .loc-label{
      font-size:12px; font-weight:1000; color:var(--brown-soft);
      width:54px;
    }
    .loc-input{
      flex:1 1 180px;
      border:none; outline:none;
      padding:8px 10px;
      border-radius:999px;
      background:#fff3da;
      color:#5a351e;
      font-weight:900;
    }
    .loc-mini{
      font-size:12px; color:var(--brown-soft);
    }

    .note{
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
      padding:8px 9px;
      margin-top:8px;
    }
    .note-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-size:12px; font-weight:1000; color:var(--brown-soft);
      margin-bottom:6px;
    }
    .note-body{
      white-space:pre-wrap;
      min-height:18px;
      font-size:13px;
      color:#5c3a1c;
      outline:none;
    }
    .note-photos{
      display:flex; flex-wrap:wrap; gap:6px;
      margin-top:8px;
    }
    .thumb{
      width:66px; height:66px;
      border-radius:12px;
      object-fit:cover;
      box-shadow:var(--shadow);
      cursor:pointer;
      border:1px solid rgba(122,74,38,0.10);
    }

    .expense{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:8px;
      padding:8px 9px;
      border-radius:14px;
      background:#fff3da;
      border:1px solid rgba(122,74,38,0.10);
    }
    .expense .lab{ font-size:12px; font-weight:1000; color:var(--brown-soft); }
    .expense input{
      width:120px;
      border:none; outline:none;
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-weight:1000;
      color:#5c3a1c;
      box-shadow:var(--shadow);
    }
    .expense .calc{ font-size:12px; font-weight:1000; color:#5c3a1c; }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:100;
      background:rgba(0,0,0,0.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width:min(560px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.22);
      overflow:hidden;
    }
    .modal-bar{
      padding:10px 12px;
      background:#fff3da;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:1000; color:#5c3a1c;
    }
    .modal-body{ padding:12px; }
    .frow{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
    .frow label{ font-size:12px; font-weight:1000; color:var(--brown-soft); width:100%; }
    .frow input, .frow select, .frow textarea{
      width:100%;
      border:none;
      outline:none;
      background:#fff3da;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      color:#5c3a1c;
    }
    textarea{ min-height:90px; resize:vertical; font-weight:800; line-height:1.5; }

    .modal-actions{
      display:flex; gap:10px; justify-content:flex-end;
      padding:12px;
      border-top:1px solid rgba(122,74,38,0.10);
      background:#fff;
    }

    /* Floating + toast */
    .floating{
      position:fixed; right:10px; bottom:12px;
      z-index:50;
      display:flex; flex-direction:column; gap:8px;
      align-items:flex-end;
    }
    .floating .fab{
      border:none;
      border-radius:999px;
      padding:10px 12px;
      background:#ffcf8f;
      box-shadow:var(--shadow);
      font-weight:1000;
      cursor:pointer;
    }
    .floating .fab:disabled{ opacity:0.55; cursor:default; }

    .save-toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      z-index:60;
      background:rgba(90,53,30,0.92);
      color:#fff;
      padding:7px 12px;
      border-radius:999px;
      font-size:12px;
      opacity:0;
      transition:opacity .22s ease;
      pointer-events:none;
    }
    .save-toast.show{ opacity:1; }

    @media (max-width:600px){
      .title-row h1{ font-size:22px; }
      .day-card{ border-radius:24px; }
      .day-chip{ min-width:84px; }
    }
  </style>
</head>

<body>
  <div class="page" id="appRoot">
    <header>
      <div class="title-row">
        <h1 id="appTitle" contenteditable="true">Niji Trip 2026</h1>
        <span class="emoji">ğŸŒˆ</span>
      </div>

      <div class="desc" id="appDesc" contenteditable="true">
        æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚æ”¯æ´æ‹–æ‹‰æ’åºã€åˆ†é¡ç¯©é¸ã€è¡¨å–®æ–°å¢è¡Œç¨‹ã€åœ–ç‰‡æ”¶ç´ã€æ—¥å¹£æ›ç®—ã€é ç®—æé†’ã€åŒ¯å‡º/åŒ¯å…¥ã€Undoï¼ˆ10æ­¥ï¼‰ã€‚
      </div>

      <div class="toolbar">
        <button class="btn primary" id="btnQuickAdd" type="button">ï¼‹ æ–°å¢è¡Œç¨‹ï¼ˆè¡¨å–®ï¼‰</button>
        <button class="btn" id="btnAddDay" type="button">ï¼‹ æ–°å¢ä¸€å¤©</button>
        <button class="btn danger" id="btnRemoveDay" type="button">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
        <button class="btn" id="btnExport" type="button">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
        <button class="btn" id="btnImport" type="button">åŒ¯å…¥å‚™ä»½</button>
        <button class="btn ghost" id="btnClear" type="button">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
        <span class="badge" id="syncBadge">é›¢ç·šå¯ç”¨ï¼šå·²è‡ªå‹•ä¿å­˜</span>
      </div>

      <div class="filters" id="filterTabs"></div>

      <div class="hint">
        âœ… ã€Œåˆ†é¡ç¯©é¸ã€æœƒå¥—ç”¨åœ¨ç•«é¢é¡¯ç¤ºï¼ˆä¸å½±éŸ¿è³‡æ–™ï¼‰ã€‚<br/>
        âœ… æ‰“å­—ä¸æœƒè·³ï¼šè¼¸å…¥æ™‚ä¸é‡ç¹ªæ•´é ï¼Œåªè‡ªå‹•å­˜æª”ã€‚<br/>
        âœ… ã€Œäº¤é€š/è³¼ç‰©ã€ä¹Ÿæ˜¯åŒä¸€ç¨®è¡Œç¨‹å¡ï¼Œä¸æœƒå†è·³å‡ºå¦ä¸€å¼µå¡ã€‚
      </div>
    </header>

    <div class="sticky-wrap">
      <div class="day-nav" id="dayNav"></div>
    </div>

    <div id="daysContainer"></div>
  </div>

  <!-- Add Item Modal -->
  <div class="modal" id="addModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-bar">
        <div>æ–°å¢è¡Œç¨‹</div>
        <button class="btn small" id="btnCloseAdd" type="button">é—œé–‰</button>
      </div>
      <div class="modal-body">
        <div class="frow">
          <label>æ™‚é–“ï¼ˆå¯ç©ºï¼‰</label>
          <input id="fTime" placeholder="ä¾‹å¦‚ 09:30" />
        </div>
        <div class="frow">
          <label>é¡åˆ¥</label>
          <select id="fCat">
            <option value="æ™¯é»">æ™¯é»</option>
            <option value="é¤é£²">é¤é£²</option>
            <option value="ä½å®¿">ä½å®¿</option>
            <option value="äº¤é€š">äº¤é€š</option>
            <option value="è³¼ç‰©">è³¼ç‰©</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div class="frow">
          <label>æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰</label>
          <input id="fTitle" placeholder="ä¾‹å¦‚ï¼šæ·ºè‰å¯º / è½‰è»Šåˆ°ä¸Šé‡" />
        </div>
        <div class="frow">
          <label>åœ°é» / åœ°å€ï¼ˆå¯ç©ºï¼‰</label>
          <input id="fPlace" placeholder="å¡«äº†å°±å¯ä¸€éµé–‹åœ°åœ– / å°èˆª" />
        </div>
        <div class="frow">
          <label>é ç®— JPYï¼ˆå¯ç©ºï¼‰</label>
          <input id="fJPY" inputmode="numeric" placeholder="ä¾‹å¦‚ 1200" />
        </div>
        <div class="frow">
          <label>å‚™è¨»</label>
          <textarea id="fNote" placeholder="æ’éšŠã€è¨‚ä½ã€æ³¨æ„äº‹é …â€¦"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="btnCancelAdd" type="button">å–æ¶ˆ</button>
        <button class="btn primary" id="btnSaveAdd" type="button">å„²å­˜</button>
      </div>
    </div>
  </div>

  <div class="floating">
    <button class="fab" id="btnUndo" type="button" disabled>â†© Undo</button>
    <button class="fab" id="btnJumpActive" type="button">â¬† å›åˆ°ç›®å‰ Day</button>
  </div>
  <div class="save-toast" id="saveToast">å·²å„²å­˜</div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />
  <input type="file" id="photoPicker" accept="image/*" style="display:none" />

<script>
(() => {
  /* =========================
     Storage + Undo (ä¿®å¥½æ‰“å­—è·³ï¼šè¼¸å…¥æ™‚ä¸ render)
  ========================== */
  const STORAGE_KEY = "niji_trip_2026_full_v2_fixed";
  const UNDO_LIMIT = 10;

  let state = null;
  let undoStack = [];
  let activeDayId = null;

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // UI filter (åƒè€ƒèˆŠç‰ˆåˆ†é¡)
  const FILTERS = ["å…¨éƒ¨","æ™¯é»","é¤é£²","ä½å®¿","äº¤é€š","è³¼ç‰©","å…¶ä»–"];
  let activeFilter = "å…¨éƒ¨";

  function toastSaved(){
    const t = $("#saveToast");
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 650);
  }

  function pushUndo(){
    const snap = JSON.stringify(state);
    undoStack.push(snap);
    if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    $("#btnUndo").disabled = undoStack.length <= 1;
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }

  function saveLocal(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
  }

  // âœ… åªåšå­˜æª” + æ›´æ–°åˆè¨ˆï¼Œä¸åšæ•´é  renderï¼ˆé¿å…æ¸¸æ¨™è·³ï¼‰
  let saveTimer = null;
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      saveLocal();
      toastSaved();
      recalcTotals();
      // å¦‚æœä½ æœ‰ CloudSyncï¼šé€™è£¡å¯ä»¥åŠ  window.CloudSync.save(state)
      // if (window.CloudSync) window.CloudSync.save(state).catch(()=>{});
    }, 250);
  }

  /* =========================
     Date helpers
  ========================== */
  function parseMD(s){
    const m = String(s||"").match(/(\d{1,2})\s*\/\s*(\d{1,2})/);
    if (!m) return null;
    const mm = parseInt(m[1],10), dd = parseInt(m[2],10);
    if (!mm || !dd) return null;
    return { mm, dd };
  }
  function toMD(dateObj){
    const mm = dateObj.getMonth()+1;
    const dd = dateObj.getDate();
    return `${mm}/${dd}`;
  }
  function ensureDatesFromDay1(){
    const first = state.days[0];
    const md = parseMD(first.dateText);
    let base = md ? new Date(state.settings.year, md.mm-1, md.dd) : new Date(state.settings.year, 4, 8);
    state.days.forEach((d, idx) => {
      const dt = new Date(base);
      dt.setDate(dt.getDate() + idx);
      d.dateText = toMD(dt);
      if (d.autoDayLabel) d.dayLabel = `Day ${idx+1}`;
    });
  }

  /* =========================
     State
  ========================== */
  function newCard(tag="æ™¯é»"){
    const id = `c_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    return {
      id,
      tag,              // âœ… åˆ†é¡ï¼šæ™¯é»/é¤é£²/ä½å®¿/äº¤é€š/è³¼ç‰©/å…¶ä»–
      time: "",
      title: "æ–°è¡Œç¨‹",
      ja: "",
      meta: "",
      origin: "",
      destination: "",
      vias: [],
      note: "",
      photos: [],
      jpy: "",
      twd: ""
    };
  }

  function makeDefaultDays(){
    const days = [];
    for (let i=1;i<=3;i++){
      days.push({
        id:`d_${Date.now()}_${i}_${Math.random().toString(16).slice(2)}`,
        autoDayLabel:true,
        dayLabel:`Day ${i}`,
        subtitle: i===1 ? "ï¼ˆç¯„ä¾‹ï¼‰æˆç”°æ©Ÿå ´ãƒ»å…¥ä½ä¸Šé‡" : i===2 ? "ï¼ˆç¯„ä¾‹ï¼‰ä¸Šé‡ãƒ»æ·ºè‰æ•£æ­¥" : "ï¼ˆç¯„ä¾‹ï¼‰è‡ªç”±æ´»å‹•æ—¥",
        dateText: i===1 ? "5/8" : i===2 ? "5/9" : "5/10",
        budgetJPY:"",
        sections:{ morning:[], noon:[], night:[] }
      });
    }
    const c = newCard("æ™¯é»");
    c.title="ç¯„ä¾‹æ™¯é»";
    c.destination="ä¸Šé‡é§…";
    c.note="å¯å¯«æ’éšŠã€æ³¨æ„äº‹é …ã€é †éŠâ€¦";
    days[0].sections.morning.push(c);
    return days;
  }

  function initState(){
    const s = loadLocal();
    if (s){
      state = s;
      if (!state.settings) state.settings = {};
      if (!state.settings.rate) state.settings.rate = 0.22;
      if (!state.settings.year) state.settings.year = 2026;
      if (!Array.isArray(state.days)) state.days = makeDefaultDays();
      if (state.days.length === 0) state.days = makeDefaultDays();
      ensureDatesFromDay1();
      return;
    }

    state = {
      settings:{ year:2026, rate:0.22 },
      appTitle:"Niji Trip 2026",
      appDesc:"æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚æ”¯æ´æ‹–æ‹‰æ’åºã€åˆ†é¡ç¯©é¸ã€è¡¨å–®æ–°å¢è¡Œç¨‹ã€åœ–ç‰‡æ”¶ç´ã€æ—¥å¹£æ›ç®—ã€é ç®—æé†’ã€åŒ¯å‡º/åŒ¯å…¥ã€Undoï¼ˆ10æ­¥ï¼‰ã€‚",
      days: makeDefaultDays()
    };
    ensureDatesFromDay1();
    pushUndo();
    saveLocal();
  }

  /* =========================
     Render helpers
  ========================== */
  function escapeHTML(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function renderFilterTabs(){
    const wrap = $("#filterTabs");
    wrap.innerHTML = "";
    FILTERS.forEach(f=>{
      const b = document.createElement("button");
      b.className = "tab" + (f===activeFilter ? " active" : "");
      b.type = "button";
      b.textContent = f;
      b.addEventListener("click", ()=>{
        activeFilter = f;
        renderFilterTabs();
        applyFilterToDOM();
      });
      wrap.appendChild(b);
    });
  }

  function renderDayNav(){
    const nav = $("#dayNav");
    nav.innerHTML = "";
    state.days.forEach((d, idx) => {
      const chip = document.createElement("div");
      chip.className = "day-chip";
      chip.dataset.id = d.id;
      chip.innerHTML = `
        <span class="chip-main" contenteditable="true"></span>
        <span class="chip-sub" contenteditable="true"></span>
      `;
      const main = chip.querySelector(".chip-main");
      const sub  = chip.querySelector(".chip-sub");

      main.textContent = d.dayLabel || `Day ${idx+1}`;
      sub.textContent  = d.dateText || "";

      // âœ… è¼¸å…¥æ™‚ä¸ renderï¼Œåªå¯« state + å­˜æª”
      main.addEventListener("input", () => {
        d.dayLabel = main.textContent.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;
        const sec = document.querySelector(`.day-section[data-id="${d.id}"] .day-pill span`);
        if (sec) sec.textContent = d.dayLabel;
        scheduleSave();
      });

      sub.addEventListener("input", () => {
        d.dateText = sub.textContent.trim() || d.dateText;
        if (idx === 0){
          ensureDatesFromDay1();
          // çµæ§‹æ€§æ›´æ–° â†’ éœ€è¦ renderï¼ˆæ—¥æœŸæœƒé€£å‹•ï¼‰
          scheduleSave();
          render();
        }else{
          scheduleSave();
        }
      });

      chip.addEventListener("click", () => {
        activeDayId = d.id;
        setActiveChip(d.id);
        const sec = document.querySelector(`.day-section[data-id="${d.id}"]`);
        if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
      });

      enableChipDrag(chip);
      nav.appendChild(chip);
    });
  }

  function setActiveChip(id){
    $$(".day-chip").forEach(c=>c.classList.toggle("active", c.dataset.id===id));
  }

  function render(){
    $("#appTitle").textContent = state.appTitle || "Niji Trip 2026";
    $("#appDesc").textContent = state.appDesc || "";

    renderFilterTabs();
    renderDayNav();
    renderDays();

    if (!activeDayId && state.days[0]) activeDayId = state.days[0].id;
    setActiveChip(activeDayId);

    applyFilterToDOM();
    recalcTotals();
  }

  function renderDays(){
    const wrap = $("#daysContainer");
    wrap.innerHTML = "";

    state.days.forEach((d, idx) => {
      const sec = document.createElement("section");
      sec.className = "day-section";
      sec.dataset.id = d.id;

      sec.innerHTML = `
        <div class="day-card">
          <div class="day-header">
            <div class="day-pill"><span contenteditable="true"></span></div>
            <div class="day-subtitle"><span contenteditable="true"></span></div>
          </div>

          <div class="day-meta">
            <div class="datebox">æ—¥æœŸï¼š<span contenteditable="true"></span></div>

            <div class="budget" title="é ç®—ï¼ˆJPYï¼‰ï¼Œè¶…éæœƒæé†’">
              <span style="font-weight:1000;color:var(--brown-soft);font-size:12px;">é ç®—JPY</span>
              <input class="budgetInput" inputmode="numeric" placeholder="ä¾‹å¦‚ 12000"/>
            </div>

            <div class="budget" title="åŒ¯ç‡è¨­å®šï¼ˆJPYâ†’TWDï¼‰">
              <span style="font-weight:1000;color:var(--brown-soft);font-size:12px;">åŒ¯ç‡</span>
              <input class="rateInput" inputmode="decimal" />
              <span class="loc-mini">ï¼ˆ1 JPY = ? TWDï¼‰</span>
            </div>

            <span class="badge dayTotalBadge">ç•¶æ—¥åˆè¨ˆï¼š0 JPY / 0 TWD</span>
          </div>

          <div class="sections">
            ${renderSectionHTML("morning","â˜€ï¸ æ—©ä¸Š")}
            ${renderSectionHTML("noon","ğŸŒ¤ï¸ ä¸‹åˆ")}
            ${renderSectionHTML("night","ğŸŒ™ æ™šä¸Š")}
          </div>
        </div>
      `;

      // header fields (ä¸ renderï¼Œåªæ›´æ–° state)
      const dayLabelEl = sec.querySelector(".day-pill span");
      dayLabelEl.textContent = d.dayLabel || `Day ${idx+1}`;
      dayLabelEl.addEventListener("input", () => {
        d.dayLabel = dayLabelEl.textContent.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;
        const chipMain = document.querySelector(`.day-chip[data-id="${d.id}"] .chip-main`);
        if (chipMain) chipMain.textContent = d.dayLabel;
        scheduleSave();
      });

      const subEl = sec.querySelector(".day-subtitle span");
      subEl.textContent = d.subtitle || "";
      subEl.addEventListener("input", () => { d.subtitle = subEl.textContent; scheduleSave(); });

      const dateEl = sec.querySelector(".datebox span");
      dateEl.textContent = d.dateText || "";
      dateEl.addEventListener("input", () => {
        d.dateText = dateEl.textContent.trim() || d.dateText;
        if (idx === 0){
          ensureDatesFromDay1();
          scheduleSave();
          render();
        }else{
          scheduleSave();
        }
      });

      const budgetInput = sec.querySelector(".budgetInput");
      budgetInput.value = d.budgetJPY || "";
      budgetInput.addEventListener("input", () => { d.budgetJPY = budgetInput.value; scheduleSave(); recalcTotals(); });

      const rateInput = sec.querySelector(".rateInput");
      rateInput.value = String(state.settings.rate ?? 0.22);
      rateInput.addEventListener("input", () => {
        const v = parseFloat(rateInput.value);
        if (!isNaN(v) && v > 0){ state.settings.rate = v; scheduleSave(); recalcTotals(); }
      });

      wrap.appendChild(sec);

      // Render cards
      ["morning","noon","night"].forEach(k=>{
        const body = sec.querySelector(`.sec[data-sec="${k}"] .sec-body`);
        body.innerHTML = "";
        (d.sections[k]||[]).forEach(card=>{
          body.appendChild(renderCard(card, d));
        });
        enableDropZone(body);
      });
    });
  }

  function renderSectionHTML(key, title){
    const dotColor = key==="morning" ? "#ffb85c" : key==="noon" ? "#ffd59a" : "#a9e2ff";
    return `
      <div class="sec" data-sec="${key}">
        <div class="sec-head">
          <div class="sec-title">
            <span class="dot" style="background:${dotColor}"></span>
            <span>${title}</span>
          </div>
          <div class="sec-actions">
            <button class="btn small" data-add="${key}" data-tag="æ™¯é»" type="button">ï¼‹ æ™¯é»</button>
            <button class="btn small" data-add="${key}" data-tag="é¤é£²" type="button">ï¼‹ é¤é£²</button>
            <button class="btn small" data-add="${key}" data-tag="ä½å®¿" type="button">ï¼‹ ä½å®¿</button>
            <button class="btn small" data-add="${key}" data-tag="äº¤é€š" type="button">ï¼‹ äº¤é€š</button>
            <button class="btn small" data-add="${key}" data-tag="è³¼ç‰©" type="button">ï¼‹ è³¼ç‰©</button>
            <button class="btn small" data-add="${key}" data-tag="å…¶ä»–" type="button">ï¼‹ å…¶ä»–</button>
          </div>
        </div>
        <div class="sec-body" data-dropzone="true"></div>
      </div>
    `;
  }

  function renderCard(card, dayObj){
    const el = document.createElement("article");
    el.className = "spot-card";
    el.dataset.cardId = card.id;
    el.dataset.dayId  = dayObj.id;
    el.draggable = true;

    const rate = Number(state.settings.rate||0.22);
    const jpyVal = parseFloat(card.jpy||"");
    const twdCalc = (!isNaN(jpyVal) ? Math.round(jpyVal*rate) : 0);

    el.innerHTML = `
      <div class="spot-top">
        <div style="flex:1;min-width:0;">
          <div class="spot-title" contenteditable="true"></div>
          <div class="spot-ja" contenteditable="true"></div>
          <div class="spot-meta" contenteditable="true"></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
          <div class="spot-tag">${escapeHTML(card.tag||"æ™¯é»")}</div>
        </div>
      </div>

      <div class="row">
        <button class="btn small btnSearch" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
        <button class="btn small btnRoute" type="button">ä¸€éµå°èˆª</button>
      </div>

      <div class="loc-box">
        <div class="loc-line">
          <div class="loc-label">å‡ºç™¼</div>
          <input class="loc-input origin" placeholder="å‡ºç™¼åœ°ï¼ˆå¯ç©ºï¼‰" />
        </div>
        <div class="loc-line">
          <div class="loc-label">ç›®çš„</div>
          <input class="loc-input dest" placeholder="ç›®çš„åœ° / åœ°å€ï¼ˆå»ºè­°å¡«æ—¥æ–‡æˆ–åœ°å€ï¼‰" />
        </div>
      </div>

      <div class="expense">
        <span class="lab">èŠ±è²» JPY</span>
        <input class="inJPY" inputmode="numeric" placeholder="ä¾‹å¦‚ 1200" />
        <span class="calc">â†’ TWDï¼š<span class="twdText">${twdCalc}</span></span>
      </div>

      <div class="note">
        <div class="note-head">
          <span>å‚™è¨»</span>
        </div>
        <div class="note-body" contenteditable="true"></div>
      </div>
    `;

    const titleEl = el.querySelector(".spot-title");
    const jaEl    = el.querySelector(".spot-ja");
    const metaEl  = el.querySelector(".spot-meta");
    const noteEl  = el.querySelector(".note-body");

    titleEl.textContent = card.title || "";
    jaEl.textContent = card.ja || "";
    metaEl.textContent = card.meta || "";
    noteEl.textContent = card.note || "";

    const origin = el.querySelector(".origin");
    const dest   = el.querySelector(".dest");
    const inJPY  = el.querySelector(".inJPY");

    origin.value = card.origin || "";
    dest.value   = card.destination || "";
    inJPY.value  = card.jpy || "";

    // âœ… è¼¸å…¥åªæ›´æ–° state + scheduleSaveï¼ˆä¸ renderï¼‰
    titleEl.addEventListener("input", () => { card.title = titleEl.textContent; scheduleSave(); });
    jaEl.addEventListener("input", () => { card.ja = jaEl.textContent; scheduleSave(); });
    metaEl.addEventListener("input", () => { card.meta = metaEl.textContent; scheduleSave(); });
    noteEl.addEventListener("input", () => { card.note = noteEl.textContent; scheduleSave(); });

    origin.addEventListener("input", () => { card.origin = origin.value; scheduleSave(); });
    dest.addEventListener("input", () => { card.destination = dest.value; scheduleSave(); });

    inJPY.addEventListener("input", () => {
      card.jpy = inJPY.value;
      const rate = Number(state.settings.rate||0.22);
      const j = parseFloat(inJPY.value||"");
      const t = (!isNaN(j) ? Math.round(j*rate) : 0);
      el.querySelector(".twdText").textContent = String(t);
      card.twd = String(t);
      scheduleSave();
      recalcTotals();
    });

    // Maps
    el.querySelector(".btnSearch").addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ¨™é¡Œã€");
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, "_blank");
    });

    el.querySelector(".btnRoute").addEventListener("click", () => {
      const destQ = (card.destination || card.ja || card.title || "").trim();
      if (!destQ) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ¨™é¡Œã€");
      const oriQ = (card.origin || "").trim();
      let url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destQ)}`;
      if (oriQ) url += `&origin=${encodeURIComponent(oriQ)}`;
      window.open(url, "_blank");
    });

    enableCardDrag(el);
    return el;
  }

  /* =========================
     Filter apply (ä¸é‡ç¹ªï¼šç›´æ¥éš±è—/é¡¯ç¤ºå¡ç‰‡)
  ========================== */
  function applyFilterToDOM(){
    $$(".spot-card").forEach(cardEl=>{
      const cid = cardEl.dataset.cardId;
      const card = findCardById(cid);
      if (!card) return;
      const show = (activeFilter==="å…¨éƒ¨") ? true : (String(card.tag||"")===activeFilter);
      cardEl.style.display = show ? "" : "none";
    });
  }

  function findCardById(cid){
    for (const d of state.days){
      for (const k of Object.keys(d.sections)){
        for (const c of (d.sections[k]||[])){
          if (c.id===cid) return c;
        }
      }
    }
    return null;
  }

  /* =========================
     Totals + budget warning
  ========================== */
  function recalcTotals(){
    const rate = Number(state.settings.rate||0.22);
    let tripJPY = 0, tripTWD = 0;

    state.days.forEach(d=>{
      let dayJPY = 0, dayTWD = 0;
      ["morning","noon","night"].forEach(k=>{
        (d.sections[k]||[]).forEach(c=>{
          const j = parseFloat(c.jpy||"");
          const t = parseFloat(c.twd||"");
          if (!isNaN(j)) dayJPY += j;
          if (!isNaN(t)) dayTWD += t;
          if (!isNaN(j) && (isNaN(t) || !c.twd)){
            c.twd = String(Math.round(j*rate));
          }
        });
      });

      tripJPY += dayJPY;
      tripTWD += dayTWD;

      const sec = document.querySelector(`.day-section[data-id="${d.id}"]`);
      if (sec){
        const badge = sec.querySelector(".dayTotalBadge");
        if (badge){
          badge.textContent = `ç•¶æ—¥åˆè¨ˆï¼š${Math.round(dayJPY)} JPY / ${Math.round(dayTWD)} TWD`;
          const bud = parseFloat(d.budgetJPY||"");
          if (!isNaN(bud) && bud>0 && dayJPY>bud){
            badge.style.background = "#ffb0a6";
            badge.style.color = "#7a221b";
            badge.textContent += "ï¼ˆè¶…å‡ºé ç®—âš ï¸ï¼‰";
          }else{
            badge.style.background = "";
            badge.style.color = "";
          }
        }
      }
    });

    $("#syncBadge").textContent = `å…¨æ—…ç¨‹åˆè¨ˆï¼š${Math.round(tripJPY)} JPY / ${Math.round(tripTWD)} TWDï¼ˆé›¢ç·šå¯ç”¨ï¼šå·²è‡ªå‹•ä¿å­˜ï¼‰`;
  }

  /* =========================
     Add/Remove day
  ========================== */
  function addDay(){
    pushUndo();
    const idx = state.days.length + 1;
    state.days.push({
      id:`d_${Date.now()}_${Math.random().toString(16).slice(2)}`,
      autoDayLabel:true,
      dayLabel:`Day ${idx}`,
      subtitle:"ï¼ˆæ–°çš„ä¸€å¤©è¡Œç¨‹ï¼‰",
      dateText:"",
      budgetJPY:"",
      sections:{ morning:[], noon:[], night:[] }
    });
    ensureDatesFromDay1();
    saveLocal();
    render();
  }

  function removeLastDay(){
    if (state.days.length <= 1) return alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©");
    pushUndo();
    state.days.pop();
    ensureDatesFromDay1();
    saveLocal();
    render();
  }

  /* =========================
     Export/Import/Clear
  ========================== */
  $("#btnExport").addEventListener("click", () => {
    const data = { savedAt:new Date().toISOString(), state };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "NijiTrip_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("#btnImport").addEventListener("click", () => $("#importFile").click());
  $("#importFile").addEventListener("change", () => {
    const file = $("#importFile").files && $("#importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try{
        const data = JSON.parse(String(e.target.result||"{}"));
        if (data && data.state){
          pushUndo();
          state = data.state;
          ensureDatesFromDay1();
          saveLocal();
          render();
        }else{
          alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸å°");
        }
      }catch(err){
        alert("åŒ¯å…¥å¤±æ•—ï¼šJSON è§£æéŒ¯èª¤");
      }
    };
    reader.readAsText(file, "utf-8");
    $("#importFile").value = "";
  });

  $("#btnClear").addEventListener("click", () => {
    if (!confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰")) return;
    localStorage.removeItem(STORAGE_KEY);
    undoStack = [];
    initState();
    render();
  });

  /* =========================
     Undo
  ========================== */
  $("#btnUndo").addEventListener("click", () => {
    if (undoStack.length <= 1) return;
    undoStack.pop();
    const prev = undoStack[undoStack.length-1];
    if (!prev) return;
    try{
      state = JSON.parse(prev);
      saveLocal();
      render();
      $("#btnUndo").disabled = undoStack.length <= 1;
    }catch(e){}
  });

  $("#btnJumpActive").addEventListener("click", () => {
    if (!activeDayId) return;
    const sec = document.querySelector(`.day-section[data-id="${activeDayId}"]`);
    if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
  });

  /* =========================
     Day chip drag reorder
  ========================== */
  let draggingChip = null;

  function enableChipDrag(chip){
    chip.draggable = true;
    chip.addEventListener("dragstart", (e) => {
      draggingChip = chip;
      chip.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    chip.addEventListener("dragend", () => {
      if (!draggingChip) return;
      draggingChip.classList.remove("dragging");
      draggingChip = null;

      const ids = $$(".day-chip").map(x=>x.dataset.id);
      const newDays = [];
      ids.forEach(id=>{
        const d = state.days.find(x=>x.id===id);
        if (d) newDays.push(d);
      });
      state.days = newDays;
      state.days.forEach((d, idx)=>{ if (d.autoDayLabel) d.dayLabel = `Day ${idx+1}`; });
      ensureDatesFromDay1();
      saveLocal();
      render();
    });
  }

  $("#dayNav").addEventListener("dragover", (e) => {
    if (!draggingChip) return;
    e.preventDefault();
    const after = getChipAfterX($("#dayNav"), e.clientX);
    if (!after) $("#dayNav").appendChild(draggingChip);
    else $("#dayNav").insertBefore(draggingChip, after);
  });

  function getChipAfterX(container, x){
    const chips = [...container.querySelectorAll(".day-chip:not(.dragging)")];
    let closest = { offset: Number.NEGATIVE_INFINITY, el:null };
    chips.forEach(c=>{
      const box = c.getBoundingClientRect();
      const offset = x - (box.left + box.width/2);
      if (offset < 0 && offset > closest.offset) closest = { offset, el:c };
    });
    return closest.el;
  }

  /* =========================
     Card drag reorder (åŒåˆ†å€)
  ========================== */
  let draggingCardEl = null;

  function enableCardDrag(cardEl){
    cardEl.addEventListener("dragstart", (e) => {
      draggingCardEl = cardEl;
      cardEl.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    cardEl.addEventListener("dragend", () => {
      if (!draggingCardEl) return;
      draggingCardEl.classList.remove("dragging");
      draggingCardEl = null;
      syncCardsFromDOM();
      saveLocal();
      recalcTotals();
    });
  }

  function enableDropZone(zoneEl){
    zoneEl.addEventListener("dragover", (e) => {
      if (!draggingCardEl) return;
      e.preventDefault();
      const after = getCardAfterY(zoneEl, e.clientY);
      if (!after) zoneEl.appendChild(draggingCardEl);
      else zoneEl.insertBefore(draggingCardEl, after);
    });
  }

  function getCardAfterY(container, y){
    const els = [...container.querySelectorAll(".spot-card:not(.dragging)")];
    let closest = { offset:Number.NEGATIVE_INFINITY, el:null };
    els.forEach(el=>{
      const box = el.getBoundingClientRect();
      const offset = y - (box.top + box.height/2);
      if (offset < 0 && offset > closest.offset) closest = { offset, el };
    });
    return closest.el;
  }

  function syncCardsFromDOM(){
    state.days.forEach(d=>{
      Object.keys(d.sections).forEach(k=>d.sections[k]=[]);
      const daySec = document.querySelector(`.day-section[data-id="${d.id}"]`);
      if (!daySec) return;
      ["morning","noon","night"].forEach(k=>{
        const body = daySec.querySelector(`.sec[data-sec="${k}"] .sec-body`);
        const cards = [...body.querySelectorAll(".spot-card")];
        cards.forEach(cardEl=>{
          const cid = cardEl.dataset.cardId;
          const card = findCardById(cid);
          if (card) d.sections[k].push(card);
        });
      });
    });
  }

  /* =========================
     Quick add modal (åƒè€ƒèˆŠç‰ˆæ–°å¢è¡Œç¨‹)
  ========================== */
  const addModal = $("#addModal");
  const openAdd = ()=>{ addModal.classList.add("show"); addModal.setAttribute("aria-hidden","false"); $("#fTitle").focus(); };
  const closeAdd = ()=>{ addModal.classList.remove("show"); addModal.setAttribute("aria-hidden","true"); };

  $("#btnQuickAdd").addEventListener("click", openAdd);
  $("#btnCloseAdd").addEventListener("click", closeAdd);
  $("#btnCancelAdd").addEventListener("click", closeAdd);
  addModal.addEventListener("click", (e)=>{ if (e.target===addModal) closeAdd(); });

  function pickSectionByTimeOrCat(cat, timeStr){
    if (cat==="äº¤é€š" || cat==="è³¼ç‰©") return "noon"; // æ”¾åœ¨ä¸­é–“è¦–è¦ºè¼ƒå¥½ï¼ˆä½ ä¹Ÿå¯æ”¹ morningï¼‰
    if (cat==="ä½å®¿") return "night";
    const t = String(timeStr||"").trim();
    const m = t.match(/^(\d{1,2})\s*:/);
    if (!m) return "morning";
    const hh = parseInt(m[1],10);
    if (hh < 11) return "morning";
    if (hh < 17) return "noon";
    return "night";
  }

  $("#btnSaveAdd").addEventListener("click", () => {
    const title = $("#fTitle").value.trim();
    if (!title) return alert("æ¨™é¡Œæ˜¯å¿…å¡«çš„");

    const cat = $("#fCat").value;
    const time = $("#fTime").value.trim();
    const place = $("#fPlace").value.trim();
    const jpy = $("#fJPY").value.trim();
    const note = $("#fNote").value;

    const day = state.days.find(d=>d.id===activeDayId) || state.days[0];
    if (!day) return alert("è«‹å…ˆå»ºç«‹ä¸€å¤©");

    pushUndo();

    const c = newCard(cat);
    c.title = title;
    c.time = time;
    c.meta = time ? `æ™‚é–“ï¼š${time}` : "";
    c.destination = place;
    c.jpy = jpy;
    c.note = note;

    const rate = Number(state.settings.rate||0.22);
    const j = parseFloat(jpy||"");
    if (!isNaN(j)) c.twd = String(Math.round(j*rate));

    const secKey = pickSectionByTimeOrCat(cat, time);
    day.sections[secKey].push(c);

    // reset form
    $("#fTime").value = "";
    $("#fCat").value = "æ™¯é»";
    $("#fTitle").value = "";
    $("#fPlace").value = "";
    $("#fJPY").value = "";
    $("#fNote").value = "";

    saveLocal();
    render();       // âœ… æ–°å¢å¡ç‰‡å±¬æ–¼çµæ§‹è®Šæ›´ï¼Œéœ€è¦ render
    closeAdd();
  });

  /* =========================
     Buttons day add/remove
  ========================== */
  $("#btnAddDay").addEventListener("click", addDay);
  $("#btnRemoveDay").addEventListener("click", removeLastDay);

  /* =========================
     Title/Desc save (ä¸ render)
  ========================== */
  $("#appTitle").addEventListener("input", () => { state.appTitle = $("#appTitle").textContent.trim(); scheduleSave(); });
  $("#appDesc").addEventListener("input", () => { state.appDesc = $("#appDesc").textContent; scheduleSave(); });

  /* =========================
     Bind add buttons per section after render
  ========================== */
  function bindSectionAddButtons(){
    $$("[data-add]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const secKey = btn.dataset.add;
        const tag = btn.dataset.tag;
        const day = state.days.find(d=>d.id===activeDayId) || state.days[0];
        if (!day) return;

        pushUndo();
        const c = newCard(tag);
        c.title = `æ–°${tag}`;
        day.sections[secKey].push(c);

        saveLocal();
        render();
      }, { once:true });
    });
  }

  /* =========================
     Patch render to bind section buttons
  ========================== */
  const _render = render;
  render = function(){
    _render();
    // render å®Œå¾Œå†ç¶ä¸€æ¬¡ï¼ˆæ¯æ¬¡çµæ§‹è®Šæ›´æœƒé‡å»º DOMï¼‰
    bindSectionAddButtons();
  };

  /* =========================
     Init
  ========================== */
  initState();
  render();
  if (undoStack.length === 0){
    pushUndo();
    $("#btnUndo").disabled = true;
  }

})();
</script>

</body>
</html>

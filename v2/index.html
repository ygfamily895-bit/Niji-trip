<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Niji Trip 2026 (v2)</title>
  <style>
    :root{
      --bg-main:#ffe4b8;
      --bg-card:#fff7e8;
      --brown:#7a4a26;
      --radius:20px;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      background:var(--bg-main);
    }
    header{
      padding:16px;
      background:#fff3da;
      border-radius:0 0 var(--radius) var(--radius);
    }
    h1{margin:0 0 6px;color:var(--brown)}
    .sub{opacity:.85;color:#5c3a1c}
    .btn-row{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center;
    }
    button{
      border:none;
      padding:8px 14px;
      border-radius:999px;
      background:#ffd89a;
      color:#5c3a1c;
      font-weight:700;
    }
    .badge{
      display:inline-block;
      padding:8px 12px;
      border-radius:999px;
      background:#fff3c5;
      color:#5c3a1c;
      font-weight:700;
    }
    main{padding:16px}
    .day{
      background:#eaf6ff;
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:14px;
    }
    .card{
      background:var(--bg-card);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
      white-space:pre-wrap;
      word-break:break-word;
      min-height:44px;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .del{
      background:#ffd1c7;
    }
    [contenteditable]{outline:none}
    .hint{margin-top:10px;font-size:13px;color:#6b4a2c;opacity:.9}
  </style>
</head>

<body>
  <header>
    <h1>Niji Trip 2026 ğŸŒˆ <small style="font-size:14px;opacity:.75">(v2)</small></h1>
    <div class="sub" contenteditable="true" id="subtitle">æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚</div>

    <div class="btn-row">
  <button id="addDayBtn" type="button">ï¼‹ æ–°å¢ä¸€å¤©</button>
  <button id="clearBtn" type="button">æ¸…é™¤å„²å­˜</button>

  <button id="btnGoogleLogin" type="button">Google ç™»å…¥</button>
  <span class="badge" id="authStatus">æœªç™»å…¥</span>

  <span class="badge" id="saveStatus">å·²è¼‰å…¥ âœ…</span>
    </div>
    <div class="hint">ç›®å‰ç‰ˆæœ¬ï¼šåªä½¿ç”¨æœ¬æ©Ÿ localStorageï¼ˆä¸å« Firebaseï¼‰ã€‚</div>
  </header>

  <main id="days"></main>

  <script>
    // ====== localStorage keysï¼ˆv2 å°ˆç”¨ï¼Œé¿å…è·ŸèˆŠç‰ˆæ‰“æ¶ï¼‰======
    const KEY_DAYS = "niji_v2_days";
    const KEY_SUB  = "niji_v2_subtitle";

    const daysEl = document.getElementById("days");
    const addDayBtn = document.getElementById("addDayBtn");
    const clearBtn = document.getElementById("clearBtn");
    const saveStatus = document.getElementById("saveStatus");
    const subtitleEl = document.getElementById("subtitle");

    let days = safeParse(localStorage.getItem(KEY_DAYS), []);
    subtitleEl.textContent = localStorage.getItem(KEY_SUB) || subtitleEl.textContent;

    function safeParse(raw, fallback){
      try { return raw ? JSON.parse(raw) : fallback; }
      catch { return fallback; }
    }

    function setStatus(text){
      saveStatus.textContent = text;
      window.clearTimeout(setStatus._t);
      setStatus._t = window.setTimeout(()=> saveStatus.textContent = "å·²å„²å­˜ âœ…", 800);
    }

    function save(){
      localStorage.setItem(KEY_DAYS, JSON.stringify(days));
      setStatus("å„²å­˜ä¸­â€¦");
    }

    function render(){
      daysEl.innerHTML = "";
      days.forEach((d, i) => {
        const wrap = document.createElement("div");
        wrap.className = "day";

        wrap.innerHTML = `
          <div class="row">
            <strong>Day ${i + 1}</strong>
            <button class="del" type="button" data-del="${i}">åˆªé™¤</button>
          </div>
          <div class="card" contenteditable="true" data-idx="${i}"></div>
        `;

        const card = wrap.querySelector(".card");
        card.textContent = d.text || "";

        card.addEventListener("input", () => {
          days[i].text = card.innerText;
          save();
        });

        wrap.querySelector("[data-del]").addEventListener("click", () => {
          if (confirm(`ç¢ºå®šåˆªé™¤ Day ${i+1}ï¼Ÿ`)) {
            days.splice(i, 1);
            save();
            render();
          }
        });

        daysEl.appendChild(wrap);
      });

      if (days.length === 0) {
        const empty = document.createElement("div");
        empty.className = "day";
        empty.innerHTML = `<strong>é‚„æ²’æœ‰è¡Œç¨‹</strong><div class="card">æŒ‰ã€Œï¼‹ æ–°å¢ä¸€å¤©ã€é–‹å§‹ã€‚</div>`;
        daysEl.appendChild(empty);
      }
    }

    addDayBtn.addEventListener("click", () => {
      days.push({ text: "æ–°å¢è¡Œç¨‹å…§å®¹â€¦" });
      save();
      render();
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("ç¢ºå®šæ¸…é™¤ v2 çš„æ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆä¸å½±éŸ¿èˆŠç‰ˆï¼‰")) {
        localStorage.removeItem(KEY_DAYS);
        localStorage.removeItem(KEY_SUB);
        days = [];
        subtitleEl.textContent = "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚";
        setStatus("å·²æ¸…é™¤ âœ…");
        render();
      }
    });

    subtitleEl.addEventListener("input", () => {
      localStorage.setItem(KEY_SUB, subtitleEl.innerText);
      setStatus("å„²å­˜ä¸­â€¦");
    });

    render();
    setStatus("å·²è¼‰å…¥ âœ…");
  </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged,
    setPersistence,
    browserLocalPersistence,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ä½ çš„ Firebase configï¼ˆç…§ä½ æä¾›çš„ï¼‰
  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const btn = document.getElementById("btnGoogleLogin");
  const statusEl = document.getElementById("authStatus");

  // å°è¨ºæ–·å€ï¼ˆä½ ä¹‹å‰é‚£å€‹å¾ˆå¥½ç”¨ï¼Œæˆ‘ä¿ç•™ç°¡åŒ–ç‰ˆï¼‰
  const diag = document.createElement("div");
  diag.style.marginTop = "10px";
  diag.style.fontSize = "12px";
  diag.style.lineHeight = "1.4";
  diag.style.color = "#6b4a2c";
  diag.style.whiteSpace = "pre-wrap";
  diag.style.wordBreak = "break-word";
  diag.textContent = `Firebase init OK: ${app.options.projectId}\n`;
  document.querySelector("header")?.appendChild(diag);

  const log = (m) => (diag.textContent += m + "\n");

  // âœ… é‡è¦ï¼šæ‰‹æ©Ÿ Chrome / WebView å¸¸éœ€è¦ persistence
  await setPersistence(auth, browserLocalPersistence);

  // âœ… 1) å›ä¾†å…ˆåƒ redirect çµæœï¼ˆæˆåŠŸæœƒæ‹¿åˆ° userï¼‰
  try {
    log("getRedirectResult() ...");
    const res = await getRedirectResult(auth);
    if (res?.user) {
      log("RedirectResult: SUCCESS âœ… " + (res.user.email || res.user.displayName || ""));
    } else {
      log("RedirectResult: (no user returned)");
    }
  } catch (e) {
    log("RedirectResult: ERROR âŒ");
    log("code: " + (e?.code || "(none)"));
    log("message: " + (e?.message || "(none)"));
  }

  // âœ… 2) çœŸç›¸ï¼šçœ‹ auth state
  onAuthStateChanged(auth, (user) => {
    if (user) {
      const name = user.email || user.displayName || "Google ä½¿ç”¨è€…";
      statusEl.textContent = "å·²ç™»å…¥";
      btn.textContent = "ç™»å‡º";
      btn.onclick = async () => {
        log("Click logout -> signOut()");
        await signOut(auth);
      };
      log("onAuthStateChanged: logged IN âœ… " + name);
    } else {
      statusEl.textContent = "æœªç™»å…¥";
      btn.textContent = "Google ç™»å…¥";
      btn.onclick = async () => {
        log("Click login -> signInWithRedirect()");
        await signInWithRedirect(auth, provider);
      };
      log("onAuthStateChanged: logged OUT âŒ");
    }
  });
</script>
</body>
</html>

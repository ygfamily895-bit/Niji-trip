<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Niji Trip 2026 ğŸŒˆ</title>

  <style>
    body{
      margin:0;
      padding:20px;
      font-family:"Noto Sans TC",system-ui,sans-serif;
      background:#fde7c4;
      color:#4b2f1b;
    }
    h1{margin-bottom:4px}
    h2{
      margin-top:0;
      font-size:16px;
      color:#6b4a2b;
    }
    button{
      border:none;
      border-radius:14px;
      padding:8px 14px;
      background:#ffd79a;
      font-weight:700;
      margin:4px;
    }
    .card{
      background:#e9f6ff;
      border-radius:16px;
      padding:12px;
      margin-top:12px;
    }
    .remove{
      float:right;
      background:#ffb3a3;
      padding:4px 10px;
      border-radius:12px;
      font-size:13px;
    }
    .box{
      background:#fff3df;
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      font-size:14px;
      line-height:1.6;
    }
    [contenteditable]{
      background:#fffbe8;
      border-radius:8px;
      padding:6px;
      outline:none;
    }
    input{
      padding:8px;
      border-radius:10px;
      border:none;
      margin:4px 0;
      width:100%;
    }
  </style>
</head>

<body>

<h1>Niji Trip 2026 ğŸŒˆ <small>(v2)</small></h1>
<h2 id="subtitle" contenteditable="true">æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚</h2>

<button id="addDay">ï¼‹ æ–°å¢ä¸€å¤©</button>
<button id="clearAll">æ¸…é™¤å„²å­˜</button>

<div class="box">
  <b>ç¶²ç«™å¸³è™Ÿç™»å…¥ï¼ˆEmail / å¯†ç¢¼ï¼‰</b><br>
  <input id="email" placeholder="Email">
  <input id="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" type="password">
  <button id="signup">è¨»å†Š</button>
  <button id="login">ç™»å…¥</button>
  <button id="logout" style="display:none;">ç™»å‡º</button>
</div>

<div id="status" class="box">æœªç™»å…¥</div>

<div id="days"></div>

<div id="debug" class="box"></div>

<p style="margin-top:30px;">
  <a href="#">éš±ç§æ¬Šæ”¿ç­–</a>ï½œ<a href="#">æœå‹™æ¢æ¬¾</a>
</p>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,doc,getDoc,setDoc,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===== Firebase è¨­å®šï¼ˆä½ çš„ï¼‰ ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
  authDomain: "trip-db86d.firebaseapp.com",
  projectId: "trip-db86d",
  storageBucket: "trip-db86d.firebasestorage.app",
  messagingSenderId: "709795426974",
  appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
  measurementId: "G-FD0411E3XH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== DOM ===== */
const subtitleEl = document.getElementById("subtitle");
const daysEl = document.getElementById("days");
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");

const emailEl = document.getElementById("email");
const passEl = document.getElementById("password");
const btnSignup = document.getElementById("signup");
const btnLogin = document.getElementById("login");
const btnLogout = document.getElementById("logout");

const btnAdd = document.getElementById("addDay");
const btnClear = document.getElementById("clearAll");

/* ===== Storage Key ===== */
const KEY_DAYS = "days";
const KEY_SUB = "subtitle";

let days = JSON.parse(localStorage.getItem(KEY_DAYS) || "[]");
let currentUID = null;
let syncTimer = null;

/* ===== å·¥å…· ===== */
const log = (t)=> debugEl.innerHTML += t + "<br>";

const saveLocal = ()=>{
  localStorage.setItem(KEY_DAYS, JSON.stringify(days));
  localStorage.setItem(KEY_SUB, subtitleEl.innerText);
};

const render = ()=>{
  daysEl.innerHTML="";
  days.forEach((d,i)=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>Day ${i+1}</b>
      <button class="remove" data-i="${i}">åˆªé™¤</button>
      <div contenteditable="true" data-i="${i}">${d.text}</div>
    `;
    daysEl.appendChild(div);
  });
};

const userDoc = uid => doc(db,"users",uid,"planner","main");

const saveCloud = async ()=>{
  if(!currentUID) return;
  await setDoc(userDoc(currentUID),{
    days,
    subtitle: subtitleEl.innerText,
    updatedAt: serverTimestamp()
  },{merge:true});
  log("â˜ å·²åŒæ­¥åˆ°é›²ç«¯");
};

const scheduleSync = ()=>{
  if(!currentUID) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(saveCloud,800);
};

const loadCloud = async(uid)=>{
  const snap = await getDoc(userDoc(uid));
  if(snap.exists()){
    days = snap.data().days || [];
    subtitleEl.innerText = snap.data().subtitle || "";
    saveLocal();
    render();
    log("â˜ å¾é›²ç«¯è¼‰å…¥å®Œæˆ");
  }else{
    await saveCloud();
  }
};

/* ===== äº‹ä»¶ ===== */
btnAdd.onclick=()=>{
  days.push({text:"æ–°å¢è¡Œç¨‹å…§å®¹â€¦"});
  saveLocal(); render(); scheduleSync();
};

btnClear.onclick=()=>{
  if(confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")){
    days=[]; subtitleEl.innerText="";
    saveLocal(); render(); scheduleSync();
  }
};

daysEl.oninput = e=>{
  if(e.target.dataset.i!==undefined){
    days[e.target.dataset.i].text = e.target.innerText;
    saveLocal(); scheduleSync();
  }
};

daysEl.onclick = e=>{
  if(e.target.classList.contains("remove")){
    days.splice(e.target.dataset.i,1);
    saveLocal(); render(); scheduleSync();
  }
};

subtitleEl.oninput=()=>{ saveLocal(); scheduleSync(); };

/* ===== Auth ===== */
btnSignup.onclick=async()=>{
  try{
    await createUserWithEmailAndPassword(auth,emailEl.value,passEl.value);
    log("âœ… è¨»å†ŠæˆåŠŸ");
  }catch(e){ log("âŒ "+e.message); }
};

btnLogin.onclick=async()=>{
  try{
    await signInWithEmailAndPassword(auth,emailEl.value,passEl.value);
    log("âœ… ç™»å…¥æˆåŠŸ");
  }catch(e){ log("âŒ "+e.message); }
};

btnLogout.onclick=async()=>{
  await signOut(auth);
  log("ğŸšª å·²ç™»å‡º");
};

onAuthStateChanged(auth,async(user)=>{
  if(user){
    currentUID = user.uid;
    statusEl.innerHTML = `å·²ç™»å…¥ï¼š${user.email}`;
    btnLogout.style.display="inline";
    await loadCloud(user.uid);
  }else{
    currentUID = null;
    statusEl.innerHTML = "æœªç™»å…¥ï¼ˆåƒ…æœ¬æ©Ÿå„²å­˜ï¼‰";
    btnLogout.style.display="none";
  }
});

/* ===== Init ===== */
subtitleEl.innerText = localStorage.getItem(KEY_SUB) || subtitleEl.innerText;
render();
log("Firebase init OK : trip-db86d");
</script>

</body>
</html>

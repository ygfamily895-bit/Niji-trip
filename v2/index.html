<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Niji Trip 2026 (v2)</title>

<style>
:root{
  --bg-main:#ffe4b8;
  --bg-card:#fff7e8;
  --brown:#7a4a26;
  --radius:20px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
  background:var(--bg-main);
}
header{
  padding:16px;
  background:#fff3da;
  border-radius:0 0 var(--radius) var(--radius);
}
h1{ margin:0 0 6px; color:var(--brown); }
.subtitle{
  color:#6b4a2c;
  opacity:.9;
}
.btn-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
  align-items:center;
}
button{
  border:none;
  padding:8px 14px;
  border-radius:999px;
  background:#ffd89a;
  color:#5c3a1c;
  font-weight:800;
}
button.secondary{
  background:#ffe8bd;
}
button.danger{
  background:#ffd0c8;
}
.badge{
  display:inline-block;
  padding:8px 12px;
  border-radius:999px;
  background:#fff3c5;
  color:#5c3a1c;
  font-weight:800;
}
.hint{
  margin-top:10px;
  font-size:13px;
  color:#6b4a2c;
  opacity:.95;
  line-height:1.5;
}
main{ padding:16px; }

.day{
  background:#eaf6ff;
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
}
.day-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.card{
  background:var(--bg-card);
  border-radius:16px;
  padding:12px;
  margin-top:10px;
  min-height:60px;
}
[contenteditable]{ outline:none; }

/* Auth card */
.auth-wrap{
  margin-top:12px;
  background:#fff7e8;
  border-radius:18px;
  padding:12px;
}
.auth-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.auth-grid input{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.08);
  font-size:14px;
}
.auth-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.small{
  font-size:12px;
  opacity:.85;
}
hr.sep{
  border:none;
  border-top:1px solid rgba(0,0,0,.07);
  margin:10px 0;
}
.footer-links a{
  color:#6b4a2c;
  text-decoration:underline;
  margin-right:10px;
}
</style>
</head>

<body>

<header>
  <h1>Niji Trip 2026 ğŸŒˆ <span style="font-size:14px;opacity:.7;">(v2)</span></h1>
  <div id="subtitle" class="subtitle" contenteditable="true">æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚</div>

  <div class="btn-row">
    <button id="addDayBtn">ï¼‹ æ–°å¢ä¸€å¤©</button>
    <button id="clearBtn" class="secondary">æ¸…é™¤å„²å­˜</button>
    <span id="saveStatus" class="badge">å·²è¼‰å…¥ âœ…</span>
    <span id="authStatus" class="badge">æœªç™»å…¥</span>
  </div>

  <div class="auth-wrap">
    <div style="font-weight:800;color:#5c3a1c;">ç¶²ç«™å¸³è™Ÿç™»å…¥ï¼ˆEmail / å¯†ç¢¼ï¼‰</div>
    <div class="small">ç™»å…¥å¾ŒæœƒæŠŠè¡Œç¨‹åŒæ­¥åˆ°é›²ç«¯ï¼ˆFirestoreï¼‰ï¼Œä¸åŒè£ç½®ç™»å…¥åŒä¸€å¸³è™Ÿå°±æœƒåŒæ­¥ã€‚</div>

    <div class="auth-grid">
      <input id="email" type="email" placeholder="Emailï¼ˆä¾‹å¦‚ ygfamily895@gmail.comï¼‰" autocomplete="email"/>
      <input id="password" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" autocomplete="current-password"/>
    </div>

    <div class="auth-actions">
      <button id="btnSignUp" type="button">è¨»å†Š</button>
      <button id="btnSignIn" type="button">ç™»å…¥</button>
      <button id="btnSignOut" type="button" class="danger" style="display:none;">ç™»å‡º</button>
      <button id="btnSyncDown" type="button" class="secondary" disabled>å¾é›²ç«¯è¼‰å…¥</button>
      <button id="btnSyncUp" type="button" class="secondary" disabled>åŒæ­¥åˆ°é›²ç«¯</button>
    </div>

    <hr class="sep"/>

    <div class="hint">
      âœ… ç›®å‰ç‰ˆæœ¬ï¼šlocalStorage +ï¼ˆç™»å…¥å¾Œï¼‰Firestore åŒæ­¥ã€‚<br/>
      å¦‚æœé‚„æ²’ç™»å…¥ï¼Œä½ çš„è³‡æ–™åªæœƒåœ¨æœ¬æ©Ÿå„²å­˜ï¼Œä¸æœƒä¸Šé›²ç«¯ã€‚<br/>
      <span class="small">ï¼ˆç¬¬ä¸€æ¬¡ç™»å…¥å»ºè­°å…ˆæŒ‰ã€Œå¾é›²ç«¯è¼‰å…¥ã€ç¢ºèªé›²ç«¯æ˜¯å¦æœ‰è³‡æ–™ï¼›æ²’æœ‰å°±æŒ‰ã€ŒåŒæ­¥åˆ°é›²ç«¯ã€ã€‚ï¼‰</span>
    </div>

    <div id="diag" class="small" style="margin-top:8px;white-space:pre-wrap;word-break:break-word;"></div>

    <div class="footer-links" style="margin-top:10px;">
      <!-- ä½ éœ€è¦çš„ï¼šéš±ç§æ¬Šæ”¿ç­– / æœå‹™æ¢æ¬¾ï¼ˆå…ˆç”¨ç«™å…§é é¢ä¹Ÿå¯ä»¥ï¼‰ -->
      <a href="./privacy.html">éš±ç§æ¬Šæ”¿ç­–</a>
      <a href="./terms.html">æœå‹™æ¢æ¬¾</a>
    </div>
  </div>
</header>

<main id="days"></main>

<script>
/** -------- Local UI + localStorage (ä¿ç•™) -------- */
const KEY_DAYS = "days_v2";
const KEY_SUB  = "subtitle_v2";

const daysEl = document.getElementById("days");
const addDayBtn = document.getElementById("addDayBtn");
const clearBtn = document.getElementById("clearBtn");
const subtitleEl = document.getElementById("subtitle");
const saveStatusEl = document.getElementById("saveStatus");

let days = JSON.parse(localStorage.getItem(KEY_DAYS) || "[]");
subtitleEl.textContent = localStorage.getItem(KEY_SUB) || subtitleEl.textContent;

function setSaveStatus(txt){ saveStatusEl.textContent = txt; }

function saveLocal(){
  localStorage.setItem(KEY_DAYS, JSON.stringify(days));
  setSaveStatus("å·²å„²å­˜ âœ…");
}

function render(){
  daysEl.innerHTML = "";
  days.forEach((d,i)=>{
    const el = document.createElement("div");
    el.className = "day";
    el.innerHTML = `
      <div class="day-head">
        <div style="font-weight:900;">Day ${i+1}</div>
        <button class="danger" type="button" data-del="${i}">åˆªé™¤</button>
      </div>
      <div class="card" contenteditable="true">${(d.text || "").replaceAll("<","&lt;")}</div>
    `;

    el.querySelector(".card").addEventListener("input", (e)=>{
      days[i].text = e.target.innerText;
      saveLocal();
      // ç™»å…¥ç‹€æ…‹ä¸‹ï¼šæ¨™è¨˜éœ€è¦åŒæ­¥ï¼ˆä¸è‡ªå‹•æ¯æ‰“å­—å°±ä¸Šå‚³ï¼Œé¿å…å¤ªé »ç¹ï¼‰
      window.__NEED_SYNC__ = true;
    });

    el.querySelector("[data-del]").addEventListener("click", ()=>{
      days.splice(i,1);
      saveLocal();
      render();
      window.__NEED_SYNC__ = true;
    });

    daysEl.appendChild(el);
  });
}

addDayBtn.addEventListener("click", ()=>{
  days.push({ text:"æ–°å¢è¡Œç¨‹å…§å®¹â€¦" });
  saveLocal();
  render();
  window.__NEED_SYNC__ = true;
});

clearBtn.addEventListener("click", ()=>{
  if(confirm("ç¢ºå®šæ¸…é™¤ v2 çš„æ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆæœ¬æ©Ÿ + ç•«é¢ï¼‰")){
    localStorage.removeItem(KEY_DAYS);
    localStorage.removeItem(KEY_SUB);
    days = [];
    subtitleEl.textContent = "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚";
    setSaveStatus("å·²æ¸…é™¤ âœ…");
    render();
    window.__NEED_SYNC__ = true;
  }
});

subtitleEl.addEventListener("input", ()=>{
  localStorage.setItem(KEY_SUB, subtitleEl.textContent);
  setSaveStatus("å·²å„²å­˜ âœ…");
  window.__NEED_SYNC__ = true;
});

render();
</script>

<!-- âœ… Firebaseï¼ˆEmail/Password + Firestoreï¼‰ -->
<script type="module">
  // Firebase SDK (v10 modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ä½ çš„ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  // DOM
  const authStatusEl = document.getElementById("authStatus");
  const diag = document.getElementById("diag");
  const emailEl = document.getElementById("email");
  const pwEl = document.getElementById("password");
  const btnSignUp = document.getElementById("btnSignUp");
  const btnSignIn = document.getElementById("btnSignIn");
  const btnSignOut = document.getElementById("btnSignOut");
  const btnSyncDown = document.getElementById("btnSyncDown");
  const btnSyncUp = document.getElementById("btnSyncUp");

  const log = (m)=>{ diag.textContent += m + "\n"; };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  log(`Firebase init OK: ${firebaseConfig.projectId}`);

  // Cloud doc path: users/{uid}/trip/main
  const getUserDocRef = (uid) => doc(db, "users", uid, "trip", "main");

  // --- Sync functions ---
  async function syncDown(user){
    const ref = getUserDocRef(user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      log("é›²ç«¯æ²’æœ‰è³‡æ–™ï¼ˆç¬¬ä¸€æ¬¡ç™»å…¥æ­£å¸¸ï¼‰");
      return false;
    }
    const data = snap.data();
    // åªæ¥å—æˆ‘å€‘å®šç¾©çš„æ¬„ä½
    const cloudDays = Array.isArray(data.days) ? data.days : [];
    const cloudSubtitle = typeof data.subtitle === "string" ? data.subtitle : "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚";

    // å¥—ç”¨åˆ°ç•«é¢ + localStorage
    window.days = cloudDays.map(x => ({ text: String(x?.text ?? "") }));
    document.getElementById("subtitle").textContent = cloudSubtitle;

    localStorage.setItem("days_v2", JSON.stringify(window.days));
    localStorage.setItem("subtitle_v2", cloudSubtitle);

    // é‡æ–°æ¸²æŸ“ï¼ˆå‘¼å«å…¨åŸŸ renderï¼‰
    window.__NEED_SYNC__ = false;
    // render() åœ¨ä¸Šä¸€æ®µ script scopeï¼›é€™è£¡ç”¨ç°¡å–®æ–¹å¼è§¸ç™¼ï¼šreload page UI
    location.reload();
    return true;
  }

  async function syncUp(user){
    const ref = getUserDocRef(user.uid);
    const payload = {
      subtitle: localStorage.getItem("subtitle_v2") || "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚",
      days: JSON.parse(localStorage.getItem("days_v2") || "[]").map(x=>({ text: String(x?.text ?? "") })),
      updatedAt: serverTimestamp(),
      version: "v2"
    };
    await setDoc(ref, payload, { merge: true });
    window.__NEED_SYNC__ = false;
    log("å·²åŒæ­¥åˆ°é›²ç«¯ âœ…");
    return true;
  }

  // --- Auth UI ---
  function setLoggedOutUI(){
    authStatusEl.textContent = "æœªç™»å…¥";
    btnSignOut.style.display = "none";
    btnSyncDown.disabled = true;
    btnSyncUp.disabled = true;
  }

  function setLoggedInUI(user){
    authStatusEl.textContent = "å·²ç™»å…¥ï¼š" + (user.email || "ä½¿ç”¨è€…");
    btnSignOut.style.display = "inline-block";
    btnSyncDown.disabled = false;
    btnSyncUp.disabled = false;
  }

  // Events
  btnSignUp.addEventListener("click", async ()=>{
    try{
      const email = emailEl.value.trim();
      const pw = pwEl.value;
      if(!email || !pw) return alert("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼");
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      log("è¨»å†ŠæˆåŠŸ âœ… " + cred.user.email);
      alert("è¨»å†ŠæˆåŠŸï¼\nå»ºè­°ä¸‹ä¸€æ­¥æŒ‰ï¼šå¾é›²ç«¯è¼‰å…¥ï¼ˆé€šå¸¸æ˜¯ç©ºï¼‰â†’ åŒæ­¥åˆ°é›²ç«¯");
    }catch(e){
      log("è¨»å†Šå¤±æ•— âŒ " + (e?.code || "") + " " + (e?.message || ""));
      alert("è¨»å†Šå¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  btnSignIn.addEventListener("click", async ()=>{
    try{
      const email = emailEl.value.trim();
      const pw = pwEl.value;
      if(!email || !pw) return alert("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼");
      const cred = await signInWithEmailAndPassword(auth, email, pw);
      log("ç™»å…¥æˆåŠŸ âœ… " + cred.user.email);
    }catch(e){
      log("ç™»å…¥å¤±æ•— âŒ " + (e?.code || "") + " " + (e?.message || ""));
      alert("ç™»å…¥å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  btnSignOut.addEventListener("click", async ()=>{
    try{
      await signOut(auth);
      log("å·²ç™»å‡º âœ…");
    }catch(e){
      log("ç™»å‡ºå¤±æ•— âŒ " + (e?.message || ""));
      alert("ç™»å‡ºå¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  btnSyncDown.addEventListener("click", async ()=>{
    const user = auth.currentUser;
    if(!user) return alert("è«‹å…ˆç™»å…¥");
    try{
      log("å¾é›²ç«¯è¼‰å…¥ä¸­...");
      await syncDown(user);
    }catch(e){
      log("å¾é›²ç«¯è¼‰å…¥å¤±æ•— âŒ " + (e?.message || ""));
      alert("å¾é›²ç«¯è¼‰å…¥å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  btnSyncUp.addEventListener("click", async ()=>{
    const user = auth.currentUser;
    if(!user) return alert("è«‹å…ˆç™»å…¥");
    try{
      log("åŒæ­¥åˆ°é›²ç«¯ä¸­...");
      await syncUp(user);
    }catch(e){
      log("åŒæ­¥å¤±æ•— âŒ " + (e?.message || ""));
      alert("åŒæ­¥å¤±æ•—ï¼š\n" + (e?.message || e));
    }
  });

  // Auth state
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      log("onAuthStateChanged: logged IN âœ…");
      setLoggedInUI(user);
    }else{
      log("onAuthStateChanged: logged OUT âŒ");
      setLoggedOutUI();
    }
  });
</script>

</body>
</html>

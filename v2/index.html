<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Niji Trip 2026 ğŸŒˆ</title>
  <meta name="theme-color" content="#ffcf8f"/>

  <style>
    :root{
      --bg-main:#fce0b3;
      --bg-card:#fff7e8;
      --bg-soft:#e5f4ff;
      --chip:#fff6e5;
      --chip-active:#ffffff;
      --brown:#7a4a26;
      --brown-soft:#a26b3a;
      --border:rgba(186, 140, 91, 0.40);
      --shadow:0 2px 6px rgba(0,0,0,0.08);
      --r-big:24px;
      --r-card:18px;
      --r-pill:999px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",sans-serif; background:var(--bg-main); color:var(--brown); }
    body{ min-height:100vh; }

    .page{ max-width:920px; margin:0 auto; padding:14px 12px 90px; }

    header{
      background:var(--bg-card);
      border-radius:26px;
      padding:18px 16px 14px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .title-row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .title-row h1{ margin:0; font-size:26px; font-weight:900; letter-spacing:0.03em; }
    .title-row .emoji{ font-size:24px; }
    .desc{ margin:8px 0 10px; font-size:14px; color:var(--brown-soft); line-height:1.65; }
    .desc[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.2); }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      margin-top:10px;
    }
    .btn{
      border:none; border-radius:var(--r-pill);
      padding:8px 14px; font-size:14px;
      background:#ffd59a; color:#5a351e;
      box-shadow:var(--shadow); cursor:pointer; white-space:nowrap;
      font-weight:800;
    }
    .btn.primary{ background:#ffb85c; }
    .btn.danger{ background:#ffb0a6; color:#7a221b; }
    .btn.ghost{ background:#fff3da; }
    .btn.small{ padding:6px 10px; font-size:13px; }
    .btn:active{ transform:translateY(1px); box-shadow:0 1px 3px rgba(0,0,0,0.16); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .badge{
      display:inline-block; padding:7px 11px; border-radius:var(--r-pill);
      background:#fff3c5; color:#5c3a1c; font-weight:900; font-size:13px;
      border:1px solid rgba(122,74,38,0.10);
    }

    .hint{
      margin-top:10px; font-size:13px; color:var(--brown-soft); line-height:1.55;
    }

    /* Auth bar */
    .authbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      margin-top:10px; padding-top:10px;
      border-top:1px dashed rgba(122,74,38,0.20);
    }
    .authbar input{
      border:none; outline:none;
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      box-shadow:var(--shadow);
      font-weight:800;
      color:#5c3a1c;
      width:min(220px, 42vw);
    }

    /* Sticky day nav */
    .sticky-wrap{
      position:sticky; top:0; z-index:20;
      padding-top:10px;
      background:linear-gradient(to bottom, rgba(252,224,179,0.96), rgba(252,224,179,0.70), rgba(252,224,179,0.0));
      backdrop-filter: blur(6px);
    }
    .day-nav{
      background:#e3f2ff;
      border-radius:24px;
      padding:10px 8px;
      overflow-x:auto;
      display:flex; gap:10px;
      box-shadow:var(--shadow);
    }
    .day-chip{
      flex:0 0 auto;
      min-width:92px;
      background:var(--chip);
      border-radius:var(--r-big);
      padding:7px 10px 6px;
      text-align:center;
      box-shadow:var(--shadow);
      cursor:pointer;
      border:1px solid transparent;
      user-select:none;
      position:relative;
    }
    .day-chip.active{ background:var(--chip-active); border-color:rgba(122,74,38,0.22); }
    .day-chip.dragging{ opacity:0.55; }
    .chip-main{ font-weight:1000; font-size:15px; display:block; }
    .chip-sub{ font-size:12px; color:var(--brown-soft); display:block; margin-top:2px; }
    .chip-main[contenteditable], .chip-sub[contenteditable]{ outline:none; }

    /* Day section */
    .day-section{ margin-top:12px; margin-bottom:16px; }
    .day-card{
      background:var(--bg-soft);
      border-radius:28px;
      padding:12px 10px 14px;
      box-shadow:var(--shadow);
    }
    .day-header{
      display:flex; flex-wrap:wrap; align-items:baseline; gap:10px;
      padding:2px 6px 0;
      margin-bottom:6px;
    }
    .day-pill{
      background:#fff;
      border-radius:var(--r-pill);
      padding:7px 14px;
      box-shadow:var(--shadow);
      font-size:18px; font-weight:1000;
    }
    .day-pill span[contenteditable]{ outline:none; }
    .day-subtitle{ color:var(--brown-soft); font-size:15px; }
    .day-subtitle span[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.22); }

    .day-meta{
      margin:6px 6px 10px;
      font-size:13px; color:var(--brown-soft);
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .day-meta .datebox{
      background:#fff; border-radius:var(--r-pill);
      padding:6px 12px; box-shadow:var(--shadow);
      font-weight:1000; color:#5c3a1c;
    }
    .day-meta .datebox span[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.22); }

    .day-meta .budget{
      background:#fff; border-radius:var(--r-pill);
      padding:6px 10px; box-shadow:var(--shadow);
      border:1px solid rgba(122,74,38,0.12);
      display:flex; gap:6px; align-items:center;
    }
    .day-meta input{
      width:92px; border:none; outline:none;
      background:transparent; color:#5c3a1c; font-weight:1000;
      font-size:13px;
    }

    /* Sections */
    .sections{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding:0 6px 6px;
    }
    .sec{
      background:rgba(255,255,255,0.55);
      border-radius:18px;
      padding:10px 10px 12px;
      border:1px solid rgba(122,74,38,0.10);
    }
    .sec-head{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .sec-title{
      font-weight:1000;
      font-size:14px;
      color:#5c3a1c;
      display:flex; align-items:center; gap:6px;
    }
    .sec-title .dot{
      width:9px; height:9px; border-radius:50%;
      background:#ffb85c;
      box-shadow:var(--shadow);
    }
    .sec-actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .sec-actions .btn{ box-shadow:none; background:#ffe7bf; }

    /* Spot card */
    .spot-card{
      background:var(--bg-card);
      border-radius:var(--r-card);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      margin:0 0 10px;
      user-select:none;
      position:relative;
      touch-action: pan-y;
    }
    .spot-card.dragging{ opacity:0.60; }
    .spot-top{
      display:flex; justify-content:space-between; align-items:flex-start; gap:8px;
    }
    .spot-title{
      font-weight:1000; font-size:16px; margin:0 0 4px;
      line-height:1.25;
    }
    .spot-title[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.18); }
    .spot-tag{
      font-size:12px; font-weight:1000;
      padding:4px 10px; border-radius:var(--r-pill);
      background:#fff3da;
      border:1px solid rgba(122,74,38,0.10);
      color:#5c3a1c;
      white-space:nowrap;
    }
    .spot-ja{ font-size:13px; color:var(--brown-soft); margin:0 0 4px; }
    .spot-ja[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.18); }
    .spot-meta{ font-size:13px; color:var(--brown-soft); margin:0 0 8px; }
    .spot-meta[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,0.18); }

    .row{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      margin:8px 0;
    }

    .loc-box{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      padding:8px 9px;
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
    }
    .loc-line{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .loc-label{
      font-size:12px; font-weight:1000; color:var(--brown-soft);
      width:54px;
    }
    .loc-input{
      flex:1 1 180px;
      border:none; outline:none;
      padding:8px 10px;
      border-radius:999px;
      background:#fff3da;
      color:#5a351e;
      font-weight:900;
    }
    .loc-mini{
      font-size:12px; color:var(--brown-soft);
    }

    .note{
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
      padding:8px 9px;
      margin-top:8px;
    }
    .note-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-size:12px; font-weight:1000; color:var(--brown-soft);
      margin-bottom:6px;
    }
    .note-body{
      white-space:pre-wrap;
      min-height:18px;
      font-size:13px;
      color:#5c3a1c;
      outline:none;
    }
    .note-photos{
      display:flex; flex-wrap:wrap; gap:6px;
      margin-top:8px;
    }
    .thumb{
      width:66px; height:66px;
      border-radius:12px;
      object-fit:cover;
      box-shadow:var(--shadow);
      cursor:pointer;
      border:1px solid rgba(122,74,38,0.10);
    }
    .thumb:active{ transform:scale(0.98); }

    /* Expense */
    .expense{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:8px;
      padding:8px 9px;
      border-radius:14px;
      background:#fff3da;
      border:1px solid rgba(122,74,38,0.10);
    }
    .expense .lab{ font-size:12px; font-weight:1000; color:var(--brown-soft); }
    .expense input{
      width:120px;
      border:none; outline:none;
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      font-weight:1000;
      color:#5c3a1c;
      box-shadow:var(--shadow);
    }
    .expense .calc{ font-size:12px; font-weight:1000; color:#5c3a1c; }

    /* Day note card (fixed bottom) */
    .day-note-card{
      background:var(--bg-card);
      border-radius:var(--r-card);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      margin:12px 0 0;
    }
    .day-note-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-size:15px; font-weight:1000;
      margin-bottom:8px;
    }
    .day-note-box{
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
      padding:9px 10px;
      font-size:13px;
      min-height:34px;
      white-space:pre-wrap;
      outline:none;
    }
    .day-note-photos{
      display:flex; flex-wrap:wrap; gap:6px; margin-top:8px;
    }

    /* Tickets */
    .tickets{
      background:rgba(255,255,255,0.70);
      border-radius:14px;
      padding:10px 10px 8px;
      border:1px solid rgba(122,74,38,0.10);
      margin-top:10px;
    }
    .tickets-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-weight:1000; color:#5c3a1c; margin-bottom:8px;
      flex-wrap:wrap;
    }
    .tickets-grid{
      display:flex; flex-wrap:wrap; gap:6px;
    }

    /* Modal map preview */
    .modal{
      position:fixed; inset:0; z-index:100;
      background:rgba(0,0,0,0.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width:min(860px, 100%);
      height:min(560px, 80vh);
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.22);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modal-bar{
      padding:10px 12px;
      background:#fff3da;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal-bar .t{ font-weight:1000; color:#5c3a1c; }
    .modal-bar .btn{ box-shadow:none; padding:7px 12px; }
    .modal-body{ flex:1; }
    .modal-body iframe{ width:100%; height:100%; border:0; }

    /* Context menu (long-press) */
    .menu{
      position:fixed; z-index:120;
      min-width:230px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,0.22);
      padding:8px;
      display:none;
    }
    .menu.show{ display:block; }
    .menu .m-title{
      font-size:12px; color:var(--brown-soft);
      padding:6px 8px 4px;
      font-weight:1000;
    }
    .menu button{
      width:100%;
      text-align:left;
      border:none;
      border-radius:12px;
      padding:10px 10px;
      background:#fff3da;
      font-weight:1000;
      color:#5c3a1c;
      cursor:pointer;
      margin:4px 0;
    }
    .menu button.danger{ background:#ffb0a6; color:#7a221b; }
    .menu button.secondary{ background:#eaf6ff; }

    /* Floating */
    .floating{
      position:fixed; right:10px; bottom:12px;
      z-index:50;
      display:flex; flex-direction:column; gap:8px;
      align-items:flex-end;
    }
    .floating .fab{
      border:none;
      border-radius:999px;
      padding:10px 12px;
      background:#ffcf8f;
      box-shadow:var(--shadow);
      font-weight:1000;
      cursor:pointer;
    }
    .floating .fab:disabled{ opacity:0.55; cursor:default; }

    .save-toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      z-index:60;
      background:rgba(90,53,30,0.92);
      color:#fff;
      padding:7px 12px;
      border-radius:999px;
      font-size:12px;
      opacity:0;
      transition:opacity .22s ease;
      pointer-events:none;
    }
    .save-toast.show{ opacity:1; }

    @media (max-width:600px){
      .title-row h1{ font-size:22px; }
      .day-card{ border-radius:24px; }
      .day-chip{ min-width:84px; }
      .authbar input{ width: min(46vw, 220px); }
    }
  </style>
</head>

<body>
  <div class="page" id="appRoot">
    <header>
      <div class="title-row">
        <h1 id="appTitle" contenteditable="true">Niji Trip 2026</h1>
        <span class="emoji">ğŸŒˆ</span>
        <span class="badge" id="authBadge">æœªç™»å…¥ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰</span>
      </div>

      <div class="desc" id="appDesc" contenteditable="true">
        æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚æ”¯æ´ï¼šå¤šå¤©æ‹–æ‹‰æ’åºã€åˆ†å€è¡Œç¨‹å¡ã€å¤šåœ°é»è·¯ç·šã€ä¸€éµå°èˆªã€åœ–ç‰‡/ç¥¨åˆ¸æ”¶ç´ã€æ—¥å¹£æ›ç®—ã€é ç®—æé†’ã€Undoï¼ˆ10æ­¥ï¼‰ã€Emailç™»å…¥é›²ç«¯åŒæ­¥ã€‚
      </div>

      <div class="toolbar">
        <button class="btn" id="btnAddDay" type="button">ï¼‹ æ–°å¢ä¸€å¤©</button>
        <button class="btn danger" id="btnRemoveDay" type="button">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
        <button class="btn" id="btnExport" type="button">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
        <button class="btn" id="btnImport" type="button">åŒ¯å…¥å‚™ä»½</button>
        <button class="btn ghost" id="btnClearLocal" type="button">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
        <button class="btn ghost" id="btnForceCloudLoad" type="button" disabled>å¾é›²ç«¯è¦†è“‹è¼‰å…¥</button>
        <span class="badge" id="syncBadge">é›¢ç·šå¯ç”¨ï¼šå·²è‡ªå‹•ä¿å­˜</span>
      </div>

      <div class="authbar">
        <input id="emailInput" type="email" autocomplete="email" placeholder="Emailï¼ˆç™»å…¥/è¨»å†Šï¼‰">
        <input id="pwInput" type="password" autocomplete="current-password" placeholder="Password">
        <button class="btn primary" id="btnLogin" type="button">Email ç™»å…¥</button>
        <button class="btn" id="btnSignup" type="button">è¨»å†Šå¸³è™Ÿ</button>
        <button class="btn danger" id="btnLogout" type="button" disabled>ç™»å‡º</button>
        <span class="badge" id="cloudStatus">é›²ç«¯ï¼šå°šæœªé€£ç·š</span>
      </div>

      <div class="hint">
        âœ… æ‰“å­—ä¸æœƒè·³æ‰ï¼ˆè¼¸å…¥ä¸æœƒæ•´é åˆ·æ–°ï¼‰ã€‚<br/>
        âœ… Day1 æ—¥æœŸå¯ç·¨è¼¯ï¼›æ–°å¢å¤©æ•¸æœƒè‡ªå‹•æ¥çºŒæ—¥æœŸã€‚<br/>
        âœ… æ‰‹æ©Ÿæ‹–æ‹‰è¼ƒé›£ï¼šè«‹ã€Œé•·æŒ‰å¡ç‰‡ã€é–‹å•Ÿé¸å–®ï¼Œå¯è¤‡è£½/åˆªé™¤/ç§»å‹•åˆ°å…¶ä»–å¤©/ä¸Šç§»ä¸‹ç§»ã€‚<br/>
        âœ… åœ–ç‰‡ã€Œé»ä¸€ä¸‹ç›´æ¥åˆªé™¤ã€ã€‚ä½å®¿å¡å›ºå®šï¼ˆä¸å¯åˆªï¼‰ã€‚<br/>
      </div>
    </header>

    <div class="sticky-wrap">
      <div class="day-nav" id="dayNav"></div>
    </div>

    <div id="daysContainer"></div>
  </div>

  <!-- modal map preview -->
  <div class="modal" id="mapModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-bar">
        <div class="t" id="modalTitle">åœ°åœ–é è¦½</div>
        <button class="btn" id="btnCloseModal" type="button">é—œé–‰</button>
      </div>
      <div class="modal-body">
        <iframe id="modalFrame" title="map"></iframe>
      </div>
    </div>
  </div>

  <!-- long press menu -->
  <div class="menu" id="ctxMenu">
    <div class="m-title" id="ctxTitle">å¡ç‰‡æ“ä½œ</div>
    <button id="mCopy" type="button">ğŸ“„ è¤‡è£½æ­¤å¡ç‰‡</button>
    <button id="mMove" class="secondary" type="button">â¡ï¸ ç§»åˆ°å…¶ä»–å¤© / åˆ†å€</button>
    <button id="mUp" class="secondary" type="button">â¬†ï¸ ä¸Šç§»</button>
    <button id="mDown" class="secondary" type="button">â¬‡ï¸ ä¸‹ç§»</button>
    <button id="mDelete" class="danger" type="button">ğŸ—‘ï¸ åˆªé™¤</button>
  </div>

  <!-- floating -->
  <div class="floating">
    <button class="fab" id="btnUndo" type="button" disabled>â†© Undo</button>
    <button class="fab" id="btnJumpActive" type="button">â¬† å›åˆ°ç›®å‰ Day</button>
  </div>
  <div class="save-toast" id="saveToast">å·²å„²å­˜</div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />
  <input type="file" id="photoPicker" accept="image/*" style="display:none" />

<script>
(() => {
  /* =========================================================
     0) Helpers
  ========================================================= */
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const nowId = (p) => `${p}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
  const deepClone = (o) => JSON.parse(JSON.stringify(o));

  function toast(msg="å·²å„²å­˜"){
    const t = $("#saveToast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 700);
  }

  function parseMD(s){
    const m = String(s||"").match(/(\d{1,2})\s*\/\s*(\d{1,2})/);
    if (!m) return null;
    const mm = parseInt(m[1],10), dd = parseInt(m[2],10);
    if (!mm || !dd) return null;
    return {mm, dd};
  }
  function toMD(d){
    return `${d.getMonth()+1}/${d.getDate()}`;
  }

  function escapeHTML(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  /* =========================================================
     1) Storage / Undo / State
  ========================================================= */
  const LOCAL_KEY = "niji_trip_v2_clean_state";
  const UNDO_LIMIT = 10;

  let state = null;
  let undoStack = [];
  let activeDayId = null;

  let saveTimer = null;
  let isApplyingRemote = false;     // avoid echo loop
  let lastPushedLocalHash = "";     // quick loop guard for cloud saves

  function hashState(s){
    // light hash for loop guard
    try{
      const str = JSON.stringify(s);
      let h=0;
      for (let i=0;i<str.length;i++) h = ((h<<5)-h) + str.charCodeAt(i) | 0;
      return String(h);
    }catch(e){ return String(Math.random()); }
  }

  function pushUndo(){
    const snap = JSON.stringify(state);
    undoStack.push(snap);
    if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    $("#btnUndo").disabled = undoStack.length <= 1;
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(LOCAL_KEY);
      if (raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveLocal(){
    try{ localStorage.setItem(LOCAL_KEY, JSON.stringify(state)); }catch(e){}
  }
  function clearLocal(){
    try{ localStorage.removeItem(LOCAL_KEY); }catch(e){}
  }

  function ensureDatesFromDay1(){
    if (!state.days?.length) return;
    const md = parseMD(state.days[0].dateText);
    const base = md ? new Date(state.settings.year, md.mm-1, md.dd) : new Date(state.settings.year, 4, 8);
    state.days.forEach((d, idx) => {
      const dt = new Date(base);
      dt.setDate(dt.getDate()+idx);
      d.dateText = toMD(dt);
      if (d.autoDayLabel) d.dayLabel = `Day ${idx+1}`;
    });
  }

  function newCard(type="spot"){
    return {
      id: nowId("c"),
      type,                 // spot/restaurant/transport/shopping/lodging
      tag: type==="lodging" ? "ä½å®¿" :
           type==="restaurant" ? "é¤å»³" :
           type==="transport" ? "äº¤é€š" :
           type==="shopping" ? "è³¼ç‰©" : "æ™¯é»",
      title: type==="lodging" ? "ä½å®¿" :
             type==="restaurant" ? "æ–°é¤å»³" :
             type==="transport" ? "æ–°äº¤é€š" :
             type==="shopping" ? "æ–°è³¼ç‰©" : "æ–°æ™¯é»",
      ja: "",
      meta: "",
      origin: "",
      destination: "",
      vias: [],
      note: "",
      photos: [],
      jpy: "",
      twd: ""
    };
  }

  function ensureLodgingCard(day){
    day.sections.night = day.sections.night || [];
    const idx = day.sections.night.findIndex(c=>c.type==="lodging");
    if (idx >= 0){
      // force last
      const [lod] = day.sections.night.splice(idx,1);
      day.sections.night.push(lod);
      return;
    }
    const lod = newCard("lodging");
    lod.title = `ä½å®¿ï¼š${state.settings.hotelName}`;
    lod.ja = state.settings.hotelNameJP;
    lod.meta = "ä½å®¿åœ°é»ï¼ˆå›ºå®šåœ¨ç•¶æ—¥å‚™è¨»ä¸Šæ–¹ï¼‰";
    day.sections.night.push(lod);
  }

  function defaultState(){
    const s = {
      version: 2,
      appTitle: "Niji Trip 2026",
      appDesc: "æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚æ”¯æ´ï¼šå¤šå¤©æ‹–æ‹‰æ’åºã€åˆ†å€è¡Œç¨‹å¡ã€å¤šåœ°é»è·¯ç·šã€ä¸€éµå°èˆªã€åœ–ç‰‡/ç¥¨åˆ¸æ”¶ç´ã€æ—¥å¹£æ›ç®—ã€é ç®—æé†’ã€Undoï¼ˆ10æ­¥ï¼‰ã€Emailç™»å…¥é›²ç«¯åŒæ­¥ã€‚",
      settings:{
        year: 2026,
        rate: 0.22,
        hotelName: "VESSEL INN ä¸Šé‡å…¥è°·ç«™ é£¯åº—",
        hotelNameJP: "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰",
      },
      days: []
    };

    for (let i=1;i<=3;i++){
      const d = {
        id: nowId("d"),
        autoDayLabel: true,
        dayLabel: `Day ${i}`,
        subtitle: i===1 ? "ï¼ˆç¯„ä¾‹ï¼‰æˆç”°æ©Ÿå ´ãƒ»å…¥ä½ä¸Šé‡" : i===2 ? "ï¼ˆç¯„ä¾‹ï¼‰ä¸Šé‡ãƒ»æ·ºè‰æ•£æ­¥" : "ï¼ˆç¯„ä¾‹ï¼‰è‡ªç”±æ´»å‹•æ—¥",
        dateText: i===1 ? "5/8" : i===2 ? "5/9" : "5/10",
        budgetJPY: "",
        tickets: { text:"ï¼ˆå¯æ”¾ç¥¨åˆ¸/QR/è¨‚ä½è³‡è¨Šï¼‰", photos:[] },
        sections: { morning:[], noon:[], night:[], transport:[], shopping:[] },
        dayNote: { text:"ä¾‹ï¼šé¤é£² xxxã€äº¤é€š xxxã€è³¼ç‰© xxxã€å¿ƒå¾—â€¦", photos:[] }
      };
      s.days.push(d);
    }

    // sample card
    const c = newCard("spot");
    c.title="ç¯„ä¾‹æ™¯é»";
    c.ja="æ—¥æ–‡åç¨±æˆ–åœ°å€";
    c.meta="åœ°å€ãƒ»èªªæ˜ï¼šä¸Šé‡ãƒ»è»Šç«™é™„è¿‘â€¦";
    c.note="å¯åœ¨é€™è£¡å¯«æ’éšŠã€æ³¨æ„äº‹é …ã€é †éŠâ€¦";
    c.destination="æ—¥æ–‡åç¨±æˆ–åœ°å€";
    s.days[0].sections.morning.push(c);

    s.days.forEach(d=>{
      // lodging fixed
      ensureLodgingCard(d);
      // keep transport/shopping sections empty by default
    });

    return s;
  }

  function init(){
    const local = loadLocal();
    state = local || defaultState();

    // patch missing fields
    state.settings ||= {};
    if (!state.settings.year) state.settings.year = 2026;
    if (!state.settings.rate) state.settings.rate = 0.22;
    if (!state.settings.hotelName) state.settings.hotelName = "VESSEL INN ä¸Šé‡å…¥è°·ç«™ é£¯åº—";
    if (!state.settings.hotelNameJP) state.settings.hotelNameJP = "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰";
    state.days ||= [];
    state.days.forEach(d=>{
      d.sections ||= { morning:[], noon:[], night:[], transport:[], shopping:[] };
      d.tickets ||= { text:"", photos:[] };
      d.dayNote ||= { text:"", photos:[] };
      ensureLodgingCard(d);
    });

    ensureDatesFromDay1();

    // initial undo snapshot
    undoStack = [];
    pushUndo();
    $("#btnUndo").disabled = true;

    // initial local save
    saveLocal();

    // initial render
    renderAll();

    // bind app title/desc (NO rerender on typing)
    $("#appTitle").textContent = state.appTitle || "Niji Trip 2026";
    $("#appDesc").textContent = state.appDesc || "";
    $("#appTitle").addEventListener("input", () => {
      state.appTitle = $("#appTitle").textContent.trim();
      scheduleSave("å·²å„²å­˜ï¼ˆæœ¬æ©Ÿ/é›²ç«¯ï¼‰");
    });
    $("#appDesc").addEventListener("input", () => {
      state.appDesc = $("#appDesc").textContent;
      scheduleSave("å·²å„²å­˜ï¼ˆæœ¬æ©Ÿ/é›²ç«¯ï¼‰");
    });

    // buttons
    $("#btnAddDay").addEventListener("click", () => {
      pushUndo();
      addDay();
    });
    $("#btnRemoveDay").addEventListener("click", () => {
      pushUndo();
      removeLastDay();
    });
    $("#btnUndo").addEventListener("click", undo);
    $("#btnJumpActive").addEventListener("click", () => {
      if (!activeDayId) return;
      const sec = document.querySelector(`.day-section[data-id="${activeDayId}"]`);
      if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
    });

    // export/import/clear
    $("#btnExport").addEventListener("click", exportJson);
    $("#btnImport").addEventListener("click", ()=>$("#importFile").click());
    $("#importFile").addEventListener("change", importJson);
    $("#btnClearLocal").addEventListener("click", () => {
      if (!confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆé›²ç«¯ä¸æœƒåˆªï¼‰")) return;
      clearLocal();
      state = defaultState();
      ensureDatesFromDay1();
      undoStack = [];
      pushUndo();
      $("#btnUndo").disabled = true;
      renderAll();
      saveLocal();
      scheduleSave("å·²æ¸…é™¤æœ¬æ©Ÿè³‡æ–™");
    });

    // map modal close
    $("#btnCloseModal").addEventListener("click", closeModal);
    $("#mapModal").addEventListener("click", (e)=>{ if (e.target===$("#mapModal")) closeModal(); });

    // day chip drag reorder (desktop)
    enableDayNavDrag();

    // long-press menu
    bindContextMenu();

    // photo picker
    bindPhotoPicker();
  }

  function scheduleSave(msg="å·²å„²å­˜"){
    // NO rerender here
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      // always keep lodging correct
      state.days.forEach(ensureLodgingCard);
      ensureDatesFromDay1();

      saveLocal();
      toast(msg);
      updateHeaderTotals();

      // cloud save (if logged in & available)
      if (window.CloudSync && window.CloudSync.isReady()){
        const h = hashState(state);
        if (!isApplyingRemote && h !== lastPushedLocalHash){
          lastPushedLocalHash = h;
          window.CloudSync.save(state).catch(()=>{});
        }
      }
    }, 450);
  }

  function undo(){
    if (undoStack.length <= 1) return;
    undoStack.pop();
    const prev = undoStack[undoStack.length-1];
    if (!prev) return;
    try{
      state = JSON.parse(prev);
      saveLocal();
      renderAll();
      $("#btnUndo").disabled = undoStack.length <= 1;
      scheduleSave("å·²å¾©åŸ");
    }catch(e){}
  }

  /* =========================================================
     2) Render (structural changes only)
     - typing does NOT call renderAll()
  ========================================================= */
  const SEC_ORDER = ["morning","noon","night","transport","shopping"];
  const SEC_INFO = {
    morning: {title:"â˜€ï¸ æ—©ä¸Š", dot:"#ffb85c"},
    noon: {title:"ğŸŒ¤ï¸ ä¸‹åˆ", dot:"#ffd59a"},
    night: {title:"ğŸŒ™ æ™šä¸Š", dot:"#a9e2ff"},
    transport: {title:"ğŸš‡ äº¤é€š", dot:"#b7f2d4"},
    shopping: {title:"ğŸ›ï¸ è³¼ç‰©", dot:"#ffb0a6"}
  };

  function renderAll(){
    renderDayNav();
    renderDays();
    updateHeaderTotals();

    if (!activeDayId && state.days[0]) activeDayId = state.days[0].id;
    setActiveChip(activeDayId);
  }

  function renderDayNav(){
    const nav = $("#dayNav");
    nav.innerHTML = "";

    state.days.forEach((d, idx) => {
      const chip = document.createElement("div");
      chip.className = "day-chip";
      chip.dataset.id = d.id;
      chip.draggable = true;

      chip.innerHTML = `
        <span class="chip-main" contenteditable="true"></span>
        <span class="chip-sub" contenteditable="true"></span>
      `;

      const main = $(".chip-main", chip);
      const sub  = $(".chip-sub", chip);
      main.textContent = d.dayLabel || `Day ${idx+1}`;
      sub.textContent  = d.dateText || "";

      // click -> jump
      chip.addEventListener("click", () => {
        activeDayId = d.id;
        setActiveChip(d.id);
        const sec = document.querySelector(`.day-section[data-id="${d.id}"]`);
        if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
      });

      // editable label (NO rerender)
      main.addEventListener("input", () => {
        d.dayLabel = main.textContent.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;
        // sync day header in view (only if exists)
        const sec = document.querySelector(`.day-section[data-id="${d.id}"]`);
        const hdr = sec?.querySelector(".day-pill span");
        if (hdr) hdr.textContent = d.dayLabel;
        scheduleSave();
      });

      // editable date (Day1 cascades)
      sub.addEventListener("input", () => {
        d.dateText = sub.textContent.trim() || d.dateText;
        if (idx === 0){
          ensureDatesFromDay1();
          // update other chips/subtexts without full render
          state.days.forEach((dd, i2) => {
            const c2 = document.querySelector(`.day-chip[data-id="${dd.id}"] .chip-sub`);
            if (c2) c2.textContent = dd.dateText;
            const dateSpan = document.querySelector(`.day-section[data-id="${dd.id}"] .datebox span`);
            if (dateSpan) dateSpan.textContent = dd.dateText;
          });
        }
        scheduleSave();
      });

      // drag events (desktop)
      chip.addEventListener("dragstart", (e) => {
        chip.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      });
      chip.addEventListener("dragend", () => {
        chip.classList.remove("dragging");
        // reorder state.days according to DOM
        const ids = $$(".day-chip").map(x=>x.dataset.id);
        const newDays = [];
        ids.forEach(id=>{
          const found = state.days.find(x=>x.id===id);
          if (found) newDays.push(found);
        });
        state.days = newDays;
        state.days.forEach((dd, i2)=>{ if (dd.autoDayLabel) dd.dayLabel = `Day ${i2+1}`; });
        ensureDatesFromDay1();
        pushUndo();
        renderAll();
        scheduleSave("å·²æ›´æ–°å¤©æ•¸é †åº");
      });

      nav.appendChild(chip);
    });
  }

  function setActiveChip(id){
    $$(".day-chip").forEach(c=>c.classList.toggle("active", c.dataset.id===id));
  }

  function renderDays(){
    const wrap = $("#daysContainer");
    wrap.innerHTML = "";

    state.days.forEach((d, idx) => {
      ensureLodgingCard(d);

      const sec = document.createElement("section");
      sec.className = "day-section";
      sec.dataset.id = d.id;

      sec.innerHTML = `
        <div class="day-card">
          <div class="day-header">
            <div class="day-pill"><span contenteditable="true"></span></div>
            <div class="day-subtitle"><span contenteditable="true"></span></div>
          </div>

          <div class="day-meta">
            <div class="datebox">æ—¥æœŸï¼š<span contenteditable="true"></span></div>

            <div class="budget" title="é ç®—ï¼ˆJPYï¼‰ï¼Œè¶…éæœƒæé†’">
              <span style="font-weight:1000;color:var(--brown-soft);font-size:12px;">é ç®—JPY</span>
              <input class="budgetInput" inputmode="numeric" placeholder="ä¾‹å¦‚ 12000"/>
            </div>

            <div class="budget" title="åŒ¯ç‡è¨­å®šï¼ˆJPYâ†’TWDï¼‰">
              <span style="font-weight:1000;color:var(--brown-soft);font-size:12px;">åŒ¯ç‡</span>
              <input class="rateInput" inputmode="decimal" />
              <span class="loc-mini">ï¼ˆ1 JPY = ? TWDï¼‰</span>
            </div>

            <span class="badge dayTotalBadge">ç•¶æ—¥åˆè¨ˆï¼š0 JPY / 0 TWD</span>
            <button class="btn small btnDayRoute" type="button">ğŸ§­ ç•¶å¤©è·¯ç·šç¸½è¦½</button>
          </div>

          <div class="tickets">
            <div class="tickets-head">
              <div>ğŸ« ç¥¨åˆ¸ / QR æ”¶ç´ï¼ˆå¯è²¼æ–‡å­—ï¼‹åŠ åœ–ç‰‡ï¼‰</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn small btnTicketPhoto" type="button">ğŸ“· åŠ åœ–ç‰‡</button>
              </div>
            </div>
            <div class="day-note-box ticketText" contenteditable="true"></div>
            <div class="tickets-grid ticketPhotos"></div>
          </div>

          <div class="sections">
            ${SEC_ORDER.map(k => sectionHTML(k)).join("")}
          </div>

          <div class="day-note-card">
            <div class="day-note-head">
              <div>ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»ï¼ˆå›ºå®šåœ¨æœ€ä¸‹æ–¹ï¼‰</div>
              <button class="btn small btnDayNotePhoto" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
            </div>
            <div class="day-note-box dayNoteText" contenteditable="true"></div>
            <div class="day-note-photos dayNotePhotos"></div>
          </div>
        </div>
      `;

      // header bindings (NO rerender on typing)
      const dayLabelEl = sec.querySelector(".day-pill span");
      const subtitleEl = sec.querySelector(".day-subtitle span");
      const dateEl = sec.querySelector(".datebox span");

      dayLabelEl.textContent = d.dayLabel || `Day ${idx+1}`;
      subtitleEl.textContent = d.subtitle || "";
      dateEl.textContent = d.dateText || "";

      dayLabelEl.addEventListener("input", () => {
        d.dayLabel = dayLabelEl.textContent.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;
        // sync nav chip main
        const chip = document.querySelector(`.day-chip[data-id="${d.id}"] .chip-main`);
        if (chip) chip.textContent = d.dayLabel;
        scheduleSave();
      });

      subtitleEl.addEventListener("input", () => {
        d.subtitle = subtitleEl.textContent;
        scheduleSave();
      });

      dateEl.addEventListener("input", () => {
        d.dateText = dateEl.textContent.trim() || d.dateText;
        if (idx === 0){
          ensureDatesFromDay1();
          // update other date displays without full render
          state.days.forEach((dd) => {
            const c2 = document.querySelector(`.day-chip[data-id="${dd.id}"] .chip-sub`);
            if (c2) c2.textContent = dd.dateText;
            const dateSpan = document.querySelector(`.day-section[data-id="${dd.id}"] .datebox span`);
            if (dateSpan) dateSpan.textContent = dd.dateText;
          });
        }
        scheduleSave();
      });

      // budget
      const budgetInput = sec.querySelector(".budgetInput");
      budgetInput.value = d.budgetJPY || "";
      budgetInput.addEventListener("input", () => {
        d.budgetJPY = budgetInput.value;
        scheduleSave();
        updateDayTotalsDOM(d.id);
      });

      // rate
      const rateInput = sec.querySelector(".rateInput");
      rateInput.value = String(state.settings.rate ?? 0.22);
      rateInput.addEventListener("input", () => {
        const v = parseFloat(rateInput.value);
        if (!isNaN(v) && v > 0){
          state.settings.rate = v;
          // update all card TWD display without full render
          updateAllTwdDisplays();
          scheduleSave();
          updateHeaderTotals();
        }
      });

      // tickets
      const ticketText = sec.querySelector(".ticketText");
      ticketText.textContent = d.tickets?.text || "";
      ticketText.addEventListener("input", () => {
        d.tickets.text = ticketText.textContent;
        scheduleSave();
      });
      const ticketPhotos = sec.querySelector(".ticketPhotos");
      renderPhotoStrip(ticketPhotos, d.tickets.photos, () => scheduleSave());

      sec.querySelector(".btnTicketPhoto").addEventListener("click", async () => {
        const url = await pickPhoto();
        if (!url) return;
        d.tickets.photos.push(url);
        renderPhotoStrip(ticketPhotos, d.tickets.photos, () => scheduleSave());
        scheduleSave();
      });

      // day note
      const dayNoteText = sec.querySelector(".dayNoteText");
      dayNoteText.textContent = d.dayNote?.text || "";
      dayNoteText.addEventListener("input", () => {
        d.dayNote.text = dayNoteText.textContent;
        scheduleSave();
      });
      const dayNotePhotos = sec.querySelector(".dayNotePhotos");
      renderPhotoStrip(dayNotePhotos, d.dayNote.photos, () => scheduleSave());

      sec.querySelector(".btnDayNotePhoto").addEventListener("click", async () => {
        const url = await pickPhoto();
        if (!url) return;
        d.dayNote.photos.push(url);
        renderPhotoStrip(dayNotePhotos, d.dayNote.photos, () => scheduleSave());
        scheduleSave();
      });

      // day route
      sec.querySelector(".btnDayRoute").addEventListener("click", () => openDayRoute(d));

      // add buttons per section
      SEC_ORDER.forEach(k => {
        const addSpot = sec.querySelector(`button[data-add="${k}"][data-tpl="spot"]`);
        const addRes  = sec.querySelector(`button[data-add="${k}"][data-tpl="restaurant"]`);
        const addTra  = sec.querySelector(`button[data-add="${k}"][data-tpl="transport"]`);
        const addSho  = sec.querySelector(`button[data-add="${k}"][data-tpl="shopping"]`);

        // âœ… äº¤é€š/è³¼ç‰©ä¸æœƒè·³å‡ºã€Œå¦ä¸€å¼µå¡ã€ï¼šå°±æ˜¯ç›´æ¥åŠ ä¸€å¼µåŒæ¨£æ ¼å¼çš„è¡Œç¨‹å¡ï¼ˆtagä¸åŒï¼‰
        addSpot?.addEventListener("click", () => { pushUndo(); addCard(d.id, k, "spot"); });
        addRes ?.addEventListener("click", () => { pushUndo(); addCard(d.id, k, "restaurant"); });
        addTra ?.addEventListener("click", () => { pushUndo(); addCard(d.id, k, "transport"); });
        addSho ?.addEventListener("click", () => { pushUndo(); addCard(d.id, k, "shopping"); });
      });

      // render cards per section
      SEC_ORDER.forEach(k=>{
        const body = sec.querySelector(`.sec[data-sec="${k}"] .sec-body`);
        body.innerHTML = "";
        (d.sections[k]||[]).forEach(card=>{
          body.appendChild(renderCard(d, k, card));
        });
        enableDropZone(body);
      });

      wrap.appendChild(sec);
    });

    // after rendering days update totals
    state.days.forEach(d => updateDayTotalsDOM(d.id));
  }

  function sectionHTML(key){
    const info = SEC_INFO[key];
    return `
      <div class="sec" data-sec="${key}">
        <div class="sec-head">
          <div class="sec-title">
            <span class="dot" style="background:${info.dot}"></span>
            <span>${info.title}</span>
          </div>
          <div class="sec-actions">
            <button class="btn small" data-add="${key}" data-tpl="spot" type="button">ï¼‹ æ™¯é»</button>
            <button class="btn small" data-add="${key}" data-tpl="restaurant" type="button">ï¼‹ é¤å»³</button>
            <button class="btn small" data-add="${key}" data-tpl="transport" type="button">ï¼‹ äº¤é€š</button>
            <button class="btn small" data-add="${key}" data-tpl="shopping" type="button">ï¼‹ è³¼ç‰©</button>
          </div>
        </div>
        <div class="sec-body" data-dropzone="true"></div>
      </div>
    `;
  }

  function renderCard(day, secKey, card){
    const el = document.createElement("article");
    el.className = "spot-card";
    el.dataset.dayId = day.id;
    el.dataset.secKey = secKey;
    el.dataset.cardId = card.id;
    el.draggable = true;

    const rate = Number(state.settings.rate || 0.22);
    const jpyVal = parseFloat(card.jpy || "");
    const twdCalc = (!isNaN(jpyVal) ? Math.round(jpyVal * rate) : 0);

    // lodging lock label
    const lodgingBadge = card.type==="lodging"
      ? `<div class="badge" style="background:#eaf6ff;">ä½å®¿å¡ï¼ˆå›ºå®šï¼‰</div>`
      : ``;

    el.innerHTML = `
      <div class="spot-top">
        <div style="flex:1;min-width:0;">
          <div class="spot-title" contenteditable="true"></div>
          <div class="spot-ja" contenteditable="true"></div>
          <div class="spot-meta" contenteditable="true"></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
          <div class="spot-tag">${escapeHTML(card.tag || "æ™¯é»")}</div>
          ${lodgingBadge}
        </div>
      </div>

      <div class="row">
        <button class="btn small btnPreview" type="button">åœ°åœ–é è¦½</button>
        <button class="btn small btnSearch" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
        <button class="btn small btnRoute" type="button">ä¸€éµå°èˆªè·¯ç·š</button>
        <button class="btn small btnNearby" type="button">é™„è¿‘æœå°‹</button>
      </div>

      <div class="loc-box">
        <div class="loc-line">
          <div class="loc-label">å‡ºç™¼</div>
          <input class="loc-input origin" placeholder="å‡ºç™¼åœ°ï¼ˆå¯ç©ºï¼‰" />
        </div>
        <div class="loc-line">
          <div class="loc-label">ç›®çš„</div>
          <input class="loc-input dest" placeholder="ç›®çš„åœ° / åœ°å€ï¼ˆå»ºè­°å¡«æ—¥æ–‡æˆ–åœ°å€ï¼‰" />
        </div>
        <div class="loc-line">
          <div class="loc-label">é€”ç¶“</div>
          <div style="flex:1;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
            <span class="loc-mini">ï¼ˆå¯åŠ å¤šå€‹ï¼‰</span>
            <button class="btn small btnAddVia" type="button">ï¼‹ é€”ç¶“</button>
          </div>
        </div>
        <div class="viasList"></div>
      </div>

      <div class="expense">
        <span class="lab">èŠ±è²» JPY</span>
        <input class="inJPY" inputmode="numeric" placeholder="ä¾‹å¦‚ 1200" />
        <span class="calc">â†’ TWDï¼š<span class="twdText">${twdCalc}</span></span>
      </div>

      <div class="note">
        <div class="note-head">
          <span>å‚™è¨»ï¼ˆé•·æŒ‰å¡ç‰‡å¯åˆª/è¤‡è£½/ç§»å‹•ï¼‰</span>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn small btnNotePhoto" type="button">ğŸ“·</button>
          </div>
        </div>
        <div class="note-body" contenteditable="true"></div>
        <div class="note-photos"></div>
      </div>
    `;

    // fill
    const titleEl = $(".spot-title", el);
    const jaEl    = $(".spot-ja", el);
    const metaEl  = $(".spot-meta", el);
    const noteEl  = $(".note-body", el);

    titleEl.textContent = card.title || "";
    jaEl.textContent = card.ja || "";
    metaEl.textContent = card.meta || "";
    noteEl.textContent = card.note || "";

    const origin = $(".origin", el);
    const dest   = $(".dest", el);
    const inJPY  = $(".inJPY", el);
    origin.value = card.origin || "";
    dest.value   = card.destination || card.ja || "";
    inJPY.value  = card.jpy || "";

    const viasList = $(".viasList", el);
    renderVias(viasList, card);

    // typing -> update state only, no rerender
    titleEl.addEventListener("input", () => { card.title = titleEl.textContent; scheduleSave(); });
    jaEl.addEventListener("input", () => {
      card.ja = jaEl.textContent;
      if (!card.destination){
        card.destination = card.ja;
        dest.value = card.destination;
      }
      scheduleSave();
    });
    metaEl.addEventListener("input", () => { card.meta = metaEl.textContent; scheduleSave(); });
    noteEl.addEventListener("input", () => { card.note = noteEl.textContent; scheduleSave(); });

    origin.addEventListener("input", () => { card.origin = origin.value; scheduleSave(); });
    dest.addEventListener("input", () => { card.destination = dest.value; scheduleSave(); });

    inJPY.addEventListener("input", () => {
      card.jpy = inJPY.value;
      const rate = Number(state.settings.rate || 0.22);
      const j = parseFloat(inJPY.value || "");
      const t = (!isNaN(j) ? Math.round(j * rate) : 0);
      $(".twdText", el).textContent = String(t);
      card.twd = String(t);
      scheduleSave();
      updateDayTotalsDOM(day.id);
      updateHeaderTotals();
    });

    // photos
    const notePhotos = $(".note-photos", el);
    renderPhotoStrip(notePhotos, card.photos, () => scheduleSave());
    $(".btnNotePhoto", el).addEventListener("click", async () => {
      const url = await pickPhoto();
      if (!url) return;
      card.photos.push(url);
      renderPhotoStrip(notePhotos, card.photos, () => scheduleSave());
      scheduleSave();
    });

    // map buttons
    $(".btnPreview", el).addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      openMapPreview(q);
    });
    $(".btnSearch", el).addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, "_blank");
    });
    $(".btnRoute", el).addEventListener("click", () => openCardRoute(card));
    $(".btnNearby", el).addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      openNearbyMenu(q);
    });

    $(".btnAddVia", el).addEventListener("click", () => {
      card.vias ||= [];
      card.vias.push("");
      renderVias(viasList, card);
      scheduleSave();
    });

    // drag desktop
    enableCardDrag(el);

    // long press menu (mobile/desktop)
    attachLongPress(el);

    return el;
  }

  function renderVias(container, card){
    container.innerHTML = "";
    const vias = card.vias || [];
    vias.forEach((v, idx) => {
      const line = document.createElement("div");
      line.className = "loc-line";
      line.innerHTML = `
        <div class="loc-label">é€”ç¶“${idx+1}</div>
        <input class="loc-input via" placeholder="é€”ç¶“åœ°é»/åœ°å€" />
        <button class="btn small btnDelVia" type="button">åˆª</button>
      `;
      const input = $(".via", line);
      input.value = v || "";
      input.addEventListener("input", () => {
        card.vias[idx] = input.value;
        scheduleSave();
      });
      $(".btnDelVia", line).addEventListener("click", () => {
        card.vias.splice(idx,1);
        renderVias(container, card);
        scheduleSave();
      });
      container.appendChild(line);
    });
  }

  /* =========================================================
     3) Actions (add/remove/move cards, days)
  ========================================================= */
  function addDay(){
    const idx = state.days.length + 1;
    const d = {
      id: nowId("d"),
      autoDayLabel: true,
      dayLabel: `Day ${idx}`,
      subtitle: "ï¼ˆæ–°çš„ä¸€å¤©è¡Œç¨‹ï¼‰",
      dateText: "",
      budgetJPY: "",
      tickets: { text:"", photos:[] },
      sections: { morning:[], noon:[], night:[], transport:[], shopping:[] },
      dayNote: { text:"", photos:[] }
    };
    state.days.push(d);
    ensureDatesFromDay1();
    ensureLodgingCard(d);
    renderAll();
    scheduleSave("å·²æ–°å¢ä¸€å¤©");
  }

  function removeLastDay(){
    if (state.days.length <= 1) return alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©");
    state.days.pop();
    ensureDatesFromDay1();
    renderAll();
    scheduleSave("å·²åˆªé™¤æœ€å¾Œä¸€å¤©");
  }

  function addCard(dayId, secKey, type){
    const day = state.days.find(d=>d.id===dayId);
    if (!day) return;

    if (type === "lodging") return; // prevent manual lodging

    const c = newCard(type);
    if (type==="spot") c.title="æ–°æ™¯é»";
    if (type==="restaurant") c.title="æ–°é¤å»³";
    if (type==="transport") c.title="æ–°äº¤é€š";
    if (type==="shopping") c.title="æ–°è³¼ç‰©";

    day.sections[secKey] ||= [];
    // if adding into night, keep lodging last
    if (secKey==="night"){
      const lodIdx = day.sections.night.findIndex(x=>x.type==="lodging");
      if (lodIdx>=0) day.sections.night.splice(lodIdx, 0, c);
      else day.sections.night.push(c);
    }else{
      day.sections[secKey].push(c);
    }

    renderAll(); // structural change OK
    scheduleSave("å·²æ–°å¢å¡ç‰‡");
  }

  function findCard(dayId, cardId){
    const day = state.days.find(d=>d.id===dayId);
    if (!day) return null;
    for (const k of Object.keys(day.sections)){
      const list = day.sections[k] || [];
      const idx = list.findIndex(c=>c.id===cardId);
      if (idx >= 0) return {day, secKey:k, idx, card:list[idx]};
    }
    return null;
  }

  function deleteCard(dayId, cardId){
    const info = findCard(dayId, cardId);
    if (!info) return;
    if (info.card.type==="lodging"){
      alert("ä½å®¿å¡æ˜¯å›ºå®šçš„ï¼ˆä¸èƒ½åˆªé™¤ï¼‰ã€‚");
      return;
    }
    info.day.sections[info.secKey].splice(info.idx,1);
    renderAll();
    scheduleSave("å·²åˆªé™¤å¡ç‰‡");
  }

  function copyCard(dayId, cardId){
    const info = findCard(dayId, cardId);
    if (!info) return;
    if (info.card.type==="lodging"){
      alert("ä½å®¿å¡ä¸éœ€è¦è¤‡è£½ã€‚");
      return;
    }
    const clone = deepClone(info.card);
    clone.id = nowId("c");
    info.day.sections[info.secKey].splice(info.idx+1, 0, clone);
    renderAll();
    scheduleSave("å·²è¤‡è£½å¡ç‰‡");
  }

  function moveCardWithin(dayId, cardId, dir){
    const info = findCard(dayId, cardId);
    if (!info) return;
    if (info.card.type==="lodging"){
      alert("ä½å®¿å¡å›ºå®šåœ¨åº•éƒ¨ï¼Œä¸èƒ½ç§»å‹•ã€‚");
      return;
    }
    const list = info.day.sections[info.secKey];
    const newIdx = info.idx + dir;
    if (newIdx < 0 || newIdx >= list.length) return;

    // don't move past lodging if night section
    if (info.secKey==="night"){
      const lodIdx = list.findIndex(c=>c.type==="lodging");
      if (lodIdx>=0){
        if (newIdx >= lodIdx) return; // keep lodging last
      }
    }

    const [c] = list.splice(info.idx,1);
    list.splice(newIdx,0,c);
    renderAll();
    scheduleSave("å·²ç§»å‹•å¡ç‰‡");
  }

  function moveCardToOther(dayId, cardId){
    const info = findCard(dayId, cardId);
    if (!info) return;
    if (info.card.type==="lodging"){
      alert("ä½å®¿å¡å›ºå®šï¼Œä¸èƒ½ç§»å‹•ã€‚");
      return;
    }

    const labels = state.days.map((d,i)=> `${i+1}. ${d.dayLabel} (${d.dateText})`).join("\n");
    const pickDay = prompt("ç§»åˆ°å“ªä¸€å¤©ï¼Ÿè¼¸å…¥åºè™Ÿï¼š\n" + labels, "2");
    const n = parseInt(pickDay||"", 10);
    if (!n || n<1 || n>state.days.length) return;
    const toDay = state.days[n-1];

    const pickSec = prompt("ç§»åˆ°å“ªå€‹åˆ†å€ï¼Ÿè¼¸å…¥ï¼šmorning / noon / night / transport / shopping", "morning");
    const targetSec = SEC_ORDER.includes(pickSec) ? pickSec : "morning";

    // remove from original
    info.day.sections[info.secKey].splice(info.idx,1);

    toDay.sections[targetSec] ||= [];
    if (targetSec==="night"){
      const lodIdx = toDay.sections.night.findIndex(c=>c.type==="lodging");
      if (lodIdx>=0) toDay.sections.night.splice(lodIdx,0,info.card);
      else toDay.sections.night.push(info.card);
    }else{
      toDay.sections[targetSec].push(info.card);
    }

    renderAll();
    scheduleSave("å·²ç§»å‹•åˆ°å…¶ä»–å¤©");
  }

  /* =========================================================
     4) Photos
  ========================================================= */
  const photoPicker = $("#photoPicker");
  let photoResolve = null;

  function bindPhotoPicker(){
    photoPicker.addEventListener("change", () => {
      const file = photoPicker.files && photoPicker.files[0];
      if (!file){
        if (photoResolve) photoResolve(null);
        photoResolve = null;
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        if (photoResolve) photoResolve(String(e.target.result || ""));
        photoResolve = null;
      };
      reader.readAsDataURL(file);
    });
  }

  function pickPhoto(){
    return new Promise((resolve) => {
      photoResolve = resolve;
      photoPicker.value = "";
      photoPicker.click();
    });
  }

  function renderPhotoStrip(container, list, onChanged){
    container.innerHTML = "";
    (list||[]).forEach((url, idx) => {
      const img = document.createElement("img");
      img.className = "thumb";
      img.src = url;
      img.alt = "photo";
      img.title = "é»ä¸€ä¸‹ç›´æ¥åˆªé™¤";
      img.addEventListener("click", () => {
        list.splice(idx,1);
        renderPhotoStrip(container, list, onChanged);
        onChanged && onChanged();
        scheduleSave();
      });
      container.appendChild(img);
    });
  }

  /* =========================================================
     5) Map modal + routes
  ========================================================= */
  const modal = $("#mapModal");
  const modalFrame = $("#modalFrame");

  function openMapPreview(query){
    $("#modalTitle").textContent = `åœ°åœ–é è¦½ï¼š${query}`;
    modalFrame.src = `https://www.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
    modalFrame.src = "about:blank";
  }

  function openCardRoute(card){
    const origin = (card.origin||"").trim();
    const dest = (card.destination || card.ja || card.title || "").trim();
    if (!dest) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€");

    const vias = (card.vias||[]).map(x=>String(x||"").trim()).filter(Boolean);
    const ori = origin || state.settings.hotelNameJP || state.settings.hotelName || "ä¸Šé‡";

    let url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(ori)}&destination=${encodeURIComponent(dest)}`;
    if (vias.length) url += `&waypoints=${encodeURIComponent(vias.join("|"))}`;
    window.open(url, "_blank");
  }

  function flattenDayCards(day){
    const arr = [];
    SEC_ORDER.forEach(k => (day.sections[k]||[]).forEach(c => arr.push(c)));
    return arr;
  }

  function openDayRoute(day){
    const cards = flattenDayCards(day).filter(c=>c.type!=="lodging");
    const points = [];
    cards.forEach(c=>{
      const q = (c.destination || c.ja || c.title || "").trim();
      if (q) points.push(q);
    });
    if (!points.length) return alert("é€™å¤©æ²’æœ‰å¯å°èˆªçš„ç›®çš„åœ°ï¼ˆè«‹å¡«ç›®çš„åœ°/åœ°å€ï¼‰");

    const origin = state.settings.hotelNameJP || state.settings.hotelName || "ä¸Šé‡";
    const destination = points[points.length-1];
    const mids = points.slice(0, points.length-1).slice(0, 9);

    let url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
    if (mids.length) url += `&waypoints=${encodeURIComponent(mids.join("|"))}`;
    window.open(url, "_blank");
  }

  function openNearbyMenu(baseQuery){
    const options = [
      {k:"è¶…å•†", q:`${baseQuery} é™„è¿‘ ä¾¿åˆ©å•†åº—`},
      {k:"è—¥å¦", q:`${baseQuery} é™„è¿‘ è—¥å¦åº—`},
      {k:"è»Šç«™", q:`${baseQuery} é™„è¿‘ è»Šç«™`},
      {k:"å»æ‰€", q:`${baseQuery} é™„è¿‘ ãƒˆã‚¤ãƒ¬`},
      {k:"é¤å»³", q:`${baseQuery} é™„è¿‘ é¤å»³`},
    ];
    const pick = prompt("é™„è¿‘æœå°‹ï¼šè¼¸å…¥ 1-5\n1 è¶…å•†\n2 è—¥å¦\n3 è»Šç«™\n4 å»æ‰€\n5 é¤å»³", "2");
    const n = parseInt(pick||"", 10);
    if (!n || n<1 || n>5) return;
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(options[n-1].q)}`, "_blank");
  }

  /* =========================================================
     6) Totals / Budget
  ========================================================= */
  function updateAllTwdDisplays(){
    const rate = Number(state.settings.rate || 0.22);
    state.days.forEach(d=>{
      SEC_ORDER.forEach(k=>{
        (d.sections[k]||[]).forEach(c=>{
          const j = parseFloat(c.jpy||"");
          if (!isNaN(j)){
            const t = Math.round(j*rate);
            c.twd = String(t);
            // update DOM if present
            const cardEl = document.querySelector(`.spot-card[data-card-id="${c.id}"]`) ||
                           document.querySelector(`.spot-card[data-cardid="${c.id}"]`);
            const twdEl = cardEl?.querySelector(".twdText");
            if (twdEl) twdEl.textContent = String(t);
          }
        });
      });
    });
  }

  function updateDayTotalsDOM(dayId){
    const day = state.days.find(d=>d.id===dayId);
    if (!day) return;

    const rate = Number(state.settings.rate || 0.22);
    let dayJPY = 0;
    let dayTWD = 0;

    flattenDayCards(day).forEach(c=>{
      const j = parseFloat(c.jpy||"");
      if (!isNaN(j)) dayJPY += j;
      // compute twd from jpy
      if (!isNaN(j)){
        const t = Math.round(j*rate);
        dayTWD += t;
        c.twd = String(t);
      }
    });

    const sec = document.querySelector(`.day-section[data-id="${dayId}"]`);
    const badge = sec?.querySelector(".dayTotalBadge");
    if (badge){
      badge.textContent = `ç•¶æ—¥åˆè¨ˆï¼š${Math.round(dayJPY)} JPY / ${Math.round(dayTWD)} TWD`;
      const bud = parseFloat(day.budgetJPY||"");
      if (!isNaN(bud) && bud>0 && dayJPY>bud){
        badge.style.background = "#ffb0a6";
        badge.style.color = "#7a221b";
        badge.textContent += "ï¼ˆè¶…å‡ºé ç®—âš ï¸ï¼‰";
      }else{
        badge.style.background = "";
        badge.style.color = "";
      }
    }
  }

  function updateHeaderTotals(){
    const rate = Number(state.settings.rate || 0.22);
    let tripJPY=0, tripTWD=0;

    state.days.forEach(d=>{
      let dayJPY=0;
      flattenDayCards(d).forEach(c=>{
        const j = parseFloat(c.jpy||"");
        if (!isNaN(j)) dayJPY += j;
      });
      tripJPY += dayJPY;
      tripTWD += Math.round(dayJPY * rate);
    });

    $("#syncBadge").textContent = `å…¨æ—…ç¨‹åˆè¨ˆï¼š${Math.round(tripJPY)} JPY / ${Math.round(tripTWD)} TWDï¼ˆé›¢ç·šå¯ç”¨ï¼šå·²è‡ªå‹•ä¿å­˜ï¼‰`;
  }

  /* =========================================================
     7) Desktop Drag & Drop
  ========================================================= */
  let draggingChip = null;

  function enableDayNavDrag(){
    const nav = $("#dayNav");
    nav.addEventListener("dragover", (e) => {
      const dragging = document.querySelector(".day-chip.dragging");
      if (!dragging) return;
      e.preventDefault();
      const after = getAfterX(nav, e.clientX);
      if (!after) nav.appendChild(dragging);
      else nav.insertBefore(dragging, after);
    });
  }
  function getAfterX(container, x){
    const chips = [...container.querySelectorAll(".day-chip:not(.dragging)")];
    let closest = { offset:Number.NEGATIVE_INFINITY, el:null };
    chips.forEach(c=>{
      const box = c.getBoundingClientRect();
      const offset = x - (box.left + box.width/2);
      if (offset < 0 && offset > closest.offset) closest = { offset, el:c };
    });
    return closest.el;
  }

  let draggingCardEl = null;

  function enableCardDrag(cardEl){
    cardEl.addEventListener("dragstart", (e) => {
      draggingCardEl = cardEl;
      cardEl.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    cardEl.addEventListener("dragend", () => {
      if (!draggingCardEl) return;
      cardEl.classList.remove("dragging");
      draggingCardEl = null;

      // sync from DOM
      syncCardsFromDOM();
      pushUndo();
      renderAll();
      scheduleSave("å·²æ›´æ–°å¡ç‰‡é †åº");
    });
  }

  function enableDropZone(zoneEl){
    zoneEl.addEventListener("dragover", (e) => {
      if (!draggingCardEl) return;
      e.preventDefault();
      autoScrollWhileDragging(e.clientY);
      const after = getAfterY(zoneEl, e.clientY);
      if (!after) zoneEl.appendChild(draggingCardEl);
      else zoneEl.insertBefore(draggingCardEl, after);
    });
  }
  function getAfterY(container, y){
    const els = [...container.querySelectorAll(".spot-card:not(.dragging)")];
    let closest = { offset:Number.NEGATIVE_INFINITY, el:null };
    els.forEach(el=>{
      const box = el.getBoundingClientRect();
      const offset = y - (box.top + box.height/2);
      if (offset < 0 && offset > closest.offset) closest = { offset, el };
    });
    return closest.el;
  }
  function autoScrollWhileDragging(clientY){
    const margin = 80;
    const speed = 18;
    if (clientY < margin) window.scrollBy(0, -speed);
    else if (clientY > window.innerHeight - margin) window.scrollBy(0, speed);
  }

  function syncCardsFromDOM(){
    // rebuild section arrays by DOM order for each day
    state.days.forEach(d=>{
      const daySec = document.querySelector(`.day-section[data-id="${d.id}"]`);
      if (!daySec) return;

      const newSections = { morning:[], noon:[], night:[], transport:[], shopping:[] };
      const secEls = daySec.querySelectorAll(".sec");
      secEls.forEach(secEl=>{
        const key = secEl.dataset.sec;
        const ids = [...secEl.querySelectorAll(".spot-card")].map(x=>x.dataset.cardId);
        ids.forEach(cid=>{
          const found = findCardAnywhere(cid);
          if (found) newSections[key].push(found);
        });
      });

      d.sections = newSections;
      ensureLodgingCard(d);
    });
  }

  function findCardAnywhere(cardId){
    for (const d of state.days){
      for (const k of Object.keys(d.sections)){
        for (const c of (d.sections[k]||[])){
          if (c.id === cardId) return c;
        }
      }
    }
    return null;
  }

  /* =========================================================
     8) Long-press Context Menu (mobile-friendly actions)
  ========================================================= */
  const menu = $("#ctxMenu");
  let menuInfo = null; // {dayId, cardId}

  function bindContextMenu(){
    document.addEventListener("click", (e) => {
      if (menu.classList.contains("show") && !menu.contains(e.target)) closeMenu();
    });

    $("#mDelete").addEventListener("click", () => {
      if (!menuInfo) return;
      pushUndo();
      deleteCard(menuInfo.dayId, menuInfo.cardId);
      closeMenu();
    });

    $("#mCopy").addEventListener("click", () => {
      if (!menuInfo) return;
      pushUndo();
      copyCard(menuInfo.dayId, menuInfo.cardId);
      closeMenu();
    });

    $("#mMove").addEventListener("click", () => {
      if (!menuInfo) return;
      pushUndo();
      moveCardToOther(menuInfo.dayId, menuInfo.cardId);
      closeMenu();
    });

    $("#mUp").addEventListener("click", () => {
      if (!menuInfo) return;
      pushUndo();
      moveCardWithin(menuInfo.dayId, menuInfo.cardId, -1);
      closeMenu();
    });

    $("#mDown").addEventListener("click", () => {
      if (!menuInfo) return;
      pushUndo();
      moveCardWithin(menuInfo.dayId, menuInfo.cardId, +1);
      closeMenu();
    });
  }

  function openMenuForCard(cardEl, x, y){
    const dayId = cardEl.dataset.dayId;
    const cardId = cardEl.dataset.cardId;

    const info = findCard(dayId, cardId);
    if (!info) return;

    menuInfo = {dayId, cardId};
    $("#ctxTitle").textContent = `å¡ç‰‡ï¼š${(info.card.title||"").slice(0, 26)}`;

    // lodging: disable delete/move/up/down
    const isLod = info.card.type==="lodging";
    $("#mDelete").disabled = isLod;
    $("#mMove").disabled = isLod;
    $("#mUp").disabled = isLod;
    $("#mDown").disabled = isLod;

    menu.style.left = Math.min(x, window.innerWidth - 250) + "px";
    menu.style.top  = Math.min(y, window.innerHeight - 280) + "px";
    menu.classList.add("show");
  }

  function closeMenu(){
    menu.classList.remove("show");
    menuInfo = null;
  }

  function attachLongPress(cardEl){
    let pressTimer = null;
    let start = null;

    const startPress = (x, y) => {
      start = {x,y};
      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => openMenuForCard(cardEl, x, y), 520);
    };
    const movePress = (x, y) => {
      if (!start) return;
      if (Math.abs(x-start.x) > 12 || Math.abs(y-start.y) > 12){
        clearTimeout(pressTimer);
      }
    };
    const endPress = () => {
      clearTimeout(pressTimer);
      start = null;
    };

    cardEl.addEventListener("touchstart", (e) => {
      const t = e.touches[0];
      startPress(t.clientX, t.clientY);
    }, {passive:true});
    cardEl.addEventListener("touchmove", (e) => {
      const t = e.touches[0];
      movePress(t.clientX, t.clientY);
    }, {passive:true});
    cardEl.addEventListener("touchend", endPress);

    cardEl.addEventListener("mousedown", (e) => {
      if (e.button !== 0) return;
      startPress(e.clientX, e.clientY);
    });
    cardEl.addEventListener("mousemove", (e) => movePress(e.clientX, e.clientY));
    cardEl.addEventListener("mouseup", endPress);
    cardEl.addEventListener("mouseleave", endPress);
  }

  /* =========================================================
     9) Import / Export
  ========================================================= */
  function exportJson(){
    const data = { savedAt: new Date().toISOString(), state };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "NijiTrip_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importJson(){
    const file = $("#importFile").files && $("#importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try{
        const data = JSON.parse(String(e.target.result||"{}"));
        if (data?.state){
          pushUndo();
          state = data.state;
          // patch
          state.settings ||= {};
          state.days ||= [];
          state.days.forEach(d=>{
            d.sections ||= { morning:[], noon:[], night:[], transport:[], shopping:[] };
            d.tickets ||= { text:"", photos:[] };
            d.dayNote ||= { text:"", photos:[] };
            ensureLodgingCard(d);
          });
          ensureDatesFromDay1();
          renderAll();
          scheduleSave("å·²åŒ¯å…¥å‚™ä»½");
        }else{
          alert("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸å°");
        }
      }catch(err){
        alert("åŒ¯å…¥å¤±æ•—ï¼šJSON è§£æéŒ¯èª¤");
      }
    };
    reader.readAsText(file, "utf-8");
    $("#importFile").value = "";
  }

  /* =========================================================
     10) Cloud hooks (will be attached by module script)
  ========================================================= */
  window.AppBridge = {
    // called by CloudSync on login state
    applyRemoteState(remoteState){
      if (!remoteState || typeof remoteState !== "object") return;

      isApplyingRemote = true;
      try{
        state = remoteState;
        // patch fields
        state.settings ||= {};
        state.days ||= [];
        state.days.forEach(d=>{
          d.sections ||= { morning:[], noon:[], night:[], transport:[], shopping:[] };
          d.tickets ||= { text:"", photos:[] };
          d.dayNote ||= { text:"", photos:[] };
          ensureLodgingCard(d);
        });
        ensureDatesFromDay1();

        // reset undo baseline on remote load
        undoStack = [];
        pushUndo();
        $("#btnUndo").disabled = true;

        // render
        renderAll();
        saveLocal(); // cache locally
        toast("å·²å¾é›²ç«¯è¼‰å…¥ âœ…");
      }finally{
        setTimeout(()=>{ isApplyingRemote = false; }, 50);
      }
    },
    getState(){ return state; },
    setCloudStatus(text){ $("#cloudStatus").textContent = text; },
    setAuthBadge(text){ $("#authBadge").textContent = text; },
    setButtons({loggedIn}){
      $("#btnLogout").disabled = !loggedIn;
      $("#btnLogin").disabled = loggedIn;
      $("#btnSignup").disabled = loggedIn;
      $("#btnForceCloudLoad").disabled = !loggedIn;
    }
  };

  $("#btnForceCloudLoad").addEventListener("click", async () => {
    if (!window.CloudSync || !window.CloudSync.isReady()) return;
    if (!confirm("ç¢ºå®šè¦ç”¨ã€é›²ç«¯è³‡æ–™ã€è¦†è“‹æ­¤è£ç½®ç›®å‰ç•«é¢ï¼Ÿ")) return;
    try{
      $("#cloudStatus").textContent = "é›²ç«¯ï¼šè¼‰å…¥ä¸­â€¦";
      const remote = await window.CloudSync.load();
      if (remote){
        window.AppBridge.applyRemoteState(remote);
        $("#cloudStatus").textContent = "é›²ç«¯ï¼šå·²è¼‰å…¥ âœ…";
      }else{
        $("#cloudStatus").textContent = "é›²ç«¯ï¼šæ²’æœ‰è³‡æ–™ï¼ˆç¶­æŒæœ¬æ©Ÿï¼‰";
      }
    }catch(e){
      $("#cloudStatus").textContent = "é›²ç«¯ï¼šè¼‰å…¥å¤±æ•— âŒ";
      alert("é›²ç«¯è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
  });

  /* =========================================================
     11) Start
  ========================================================= */
  init();

})();
</script>

<script type="module">
/* =========================================================
   Firebase Email+Password + Firestore CloudSync
   - Doc path: users/{uid}/trips/main
   - Auto load on login + realtime sync
========================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  setPersistence,
  browserLocalPersistence,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
  authDomain: "trip-db86d.firebaseapp.com",
  projectId: "trip-db86d",
  storageBucket: "trip-db86d.firebasestorage.app",
  messagingSenderId: "709795426974",
  appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
  measurementId: "G-FD0411E3XH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

await setPersistence(auth, browserLocalPersistence);

let uid = null;
let unsub = null;
let ready = false;

function tripRef(userId){
  return doc(db, "users", userId, "trips", "main");
}

window.CloudSync = {
  isReady(){ return ready && !!uid; },
  async load(){
    if (!uid) return null;
    const snap = await getDoc(tripRef(uid));
    if (!snap.exists()) return null;
    return snap.data()?.state ?? null;
  },
  async save(state){
    if (!uid) return;
    await setDoc(tripRef(uid), { state, updatedAt: serverTimestamp() }, { merge:true });
  },
  subscribe(cb){
    if (!uid) return null;
    if (unsub) unsub();
    unsub = onSnapshot(tripRef(uid), (snap) => {
      if (!snap.exists()) return;
      const remote = snap.data()?.state ?? null;
      if (remote) cb(remote);
    });
    return unsub;
  }
};

const emailInput = document.getElementById("emailInput");
const pwInput = document.getElementById("pwInput");
const btnLogin = document.getElementById("btnLogin");
const btnSignup = document.getElementById("btnSignup");
const btnLogout = document.getElementById("btnLogout");

btnSignup.addEventListener("click", async () => {
  const email = (emailInput.value || "").trim();
  const pw = (pwInput.value || "").trim();
  if (!email || !pw) return alert("è«‹è¼¸å…¥ Email + Password");
  try{
    await createUserWithEmailAndPassword(auth, email, pw);
  }catch(e){
    alert("è¨»å†Šå¤±æ•—ï¼š\n" + (e?.message || e));
  }
});

btnLogin.addEventListener("click", async () => {
  const email = (emailInput.value || "").trim();
  const pw = (pwInput.value || "").trim();
  if (!email || !pw) return alert("è«‹è¼¸å…¥ Email + Password");
  try{
    await signInWithEmailAndPassword(auth, email, pw);
  }catch(e){
    alert("ç™»å…¥å¤±æ•—ï¼š\n" + (e?.message || e));
  }
});

btnLogout.addEventListener("click", async () => {
  try{
    await signOut(auth);
  }catch(e){}
});

onAuthStateChanged(auth, async (user) => {
  if (!user){
    uid = null;
    ready = true;
    if (unsub){ unsub(); unsub = null; }
    window.AppBridge?.setAuthBadge("æœªç™»å…¥ï¼ˆé›¢ç·šæ¨¡å¼ï¼‰");
    window.AppBridge?.setCloudStatus("é›²ç«¯ï¼šæœªç™»å…¥");
    window.AppBridge?.setButtons({loggedIn:false});
    return;
  }

  uid = user.uid;
  ready = true;

  window.AppBridge?.setAuthBadge(`å·²ç™»å…¥ï¼š${user.email || "Email ä½¿ç”¨è€…"}`);
  window.AppBridge?.setButtons({loggedIn:true});
  window.AppBridge?.setCloudStatus("é›²ç«¯ï¼šè¼‰å…¥ä¸­â€¦");

  // 1) auto load once
  try{
    const remote = await window.CloudSync.load();
    if (remote){
      window.AppBridge?.applyRemoteState(remote);
      window.AppBridge?.setCloudStatus("é›²ç«¯ï¼šå·²è¼‰å…¥ âœ…ï¼ˆåŒæ­¥ä¸­ï¼‰");
    }else{
      // if no remote data yet, write local state up as initial
      const local = window.AppBridge?.getState?.();
      if (local){
        await window.CloudSync.save(local);
        window.AppBridge?.setCloudStatus("é›²ç«¯ï¼šå·²å»ºç«‹åˆå§‹è³‡æ–™ âœ…ï¼ˆåŒæ­¥ä¸­ï¼‰");
      }else{
        window.AppBridge?.setCloudStatus("é›²ç«¯ï¼šç„¡è³‡æ–™ï¼ˆåŒæ­¥ä¸­ï¼‰");
      }
    }
  }catch(e){
    window.AppBridge?.setCloudStatus("é›²ç«¯ï¼šè¼‰å…¥å¤±æ•— âŒï¼ˆä»å¯é›¢ç·šï¼‰");
  }

  // 2) subscribe realtime
  window.CloudSync.subscribe((remoteState) => {
    // é€™è£¡äº¤çµ¦ AppBridge åšé˜²æŠ–/é¿å…å›éŸ³è¦†è“‹
    window.AppBridge?.applyRemoteState(remoteState);
    window.AppBridge?.setCloudStatus("é›²ç«¯ï¼šåŒæ­¥ä¸­ âœ…");
  });
});

</script>

</body>
</html>

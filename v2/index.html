<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Niji Trip 2026 (v2)</title>

<style>
:root{
  --bg-main:#ffe4b8;
  --bg-card:#fff7e8;
  --brown:#7a4a26;
  --radius:20px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
  background:var(--bg-main);
}
header{
  padding:16px;
  background:#fff3da;
  border-radius:0 0 var(--radius) var(--radius);
}
h1{ margin:0 0 6px; color:var(--brown); }
.subtitle{
  color:#6b4a2c;
  opacity:.9;
}
.btn-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
  align-items:center;
}
button{
  border:none;
  padding:8px 14px;i
  border-radius:999px;
  background:#ffd89a;
  color:#5c3a1c;
  font-weight:800;
}
button.secondary{
  background:#ffe8bd;
}
button.danger{
  background:#ffd0c8;
}
.badge{
  display:inline-block;
  padding:8px 12px;
  border-radius:999px;
  background:#fff3c5;
  color:#5c3a1c;
  font-weight:800;
}
.hint{
  margin-top:10px;
  font-size:13px;
  color:#6b4a2c;
  opacity:.95;
  line-height:1.5;
}
main{ padding:16px; }

.day{
  background:#eaf6ff;
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
}
.day-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.card{
  background:var(--bg-card);
  border-radius:16px;
  padding:12px;
  margin-top:10px;
  min-height:60px;
}
[contenteditable]{ outline:none; }

/* Auth card */
.auth-wrap{
  margin-top:12px;
  background:#fff7e8;
  border-radius:18px;
  padding:12px;
}
.auth-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.auth-grid input{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(0,0,0,.08);
  font-size:14px;
}
.auth-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.small{
  font-size:12px;
  opacity:.85;
}
hr.sep{
  border:none;
  border-top:1px solid rgba(0,0,0,.07);
  margin:10px 0;
}
.footer-links a{
  color:#6b4a2c;
  text-decoration:underline;
  margin-right:10px;
}
</style>
</head>

<body>

<header>
  <h1>Niji Trip 2026 ğŸŒˆ <span style="font-size:14px;opacity:.7;">(v2)</span></h1>
  <div id="subtitle" class="subtitle" contenteditable="true">æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚</div>

  <div class="btn-row">
    <button id="addDayBtn">ï¼‹ æ–°å¢ä¸€å¤©</button>
    <button id="clearBtn" class="secondary">æ¸…é™¤å„²å­˜</button>
    <span id="saveStatus" class="badge">å·²è¼‰å…¥ âœ…</span>
    <span id="authStatus" class="badge">æœªç™»å…¥</span>
  </div>

  <div class="auth-wrap">
    <div style="font-weight:800;color:#5c3a1c;">ç¶²ç«™å¸³è™Ÿç™»å…¥ï¼ˆEmail / å¯†ç¢¼ï¼‰</div>
    <div class="small">ç™»å…¥å¾ŒæœƒæŠŠè¡Œç¨‹åŒæ­¥åˆ°é›²ç«¯ï¼ˆFirestoreï¼‰ï¼Œä¸åŒè£ç½®ç™»å…¥åŒä¸€å¸³è™Ÿå°±æœƒåŒæ­¥ã€‚</div>

    <div class="auth-grid">
      <input id="email" type="email" placeholder="Emailï¼ˆä¾‹å¦‚ ygfamily895@gmail.comï¼‰" autocomplete="email"/>
      <input id="password" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" autocomplete="current-password"/>
    </div>

    <div class="auth-actions"><button id="btnSignup" type="button">è¨»å†Š</button>
<button id="btnLogin" type="button">ç™»å…¥</button>
<button id="btnLogout" type="button" style="display:none;">ç™»å‡º</button>
<button id="btnLoadCloud" type="button">å¾é›²ç«¯è¼‰å…¥</button>
<button id="btnSyncCloud" type="button">åŒæ­¥åˆ°é›²ç«¯</button>
    </div>

    <hr class="sep"/>

    <div class="hint">
      âœ… ç›®å‰ç‰ˆæœ¬ï¼šlocalStorage +ï¼ˆç™»å…¥å¾Œï¼‰Firestore åŒæ­¥ã€‚<br/>
      å¦‚æœé‚„æ²’ç™»å…¥ï¼Œä½ çš„è³‡æ–™åªæœƒåœ¨æœ¬æ©Ÿå„²å­˜ï¼Œä¸æœƒä¸Šé›²ç«¯ã€‚<br/>
      <span class="small">ï¼ˆç¬¬ä¸€æ¬¡ç™»å…¥å»ºè­°å…ˆæŒ‰ã€Œå¾é›²ç«¯è¼‰å…¥ã€ç¢ºèªé›²ç«¯æ˜¯å¦æœ‰è³‡æ–™ï¼›æ²’æœ‰å°±æŒ‰ã€ŒåŒæ­¥åˆ°é›²ç«¯ã€ã€‚ï¼‰</span>
    </div>

    <div id="diag" class="small" style="margin-top:8px;white-space:pre-wrap;word-break:break-word;"></div>

    <div class="footer-links" style="margin-top:10px;">
      <!-- ä½ éœ€è¦çš„ï¼šéš±ç§æ¬Šæ”¿ç­– / æœå‹™æ¢æ¬¾ï¼ˆå…ˆç”¨ç«™å…§é é¢ä¹Ÿå¯ä»¥ï¼‰ -->
      <a href="./privacy.html">éš±ç§æ¬Šæ”¿ç­–</a>
      <a href="./terms.html">æœå‹™æ¢æ¬¾</a>
    </div>
  </div>
</header>

<main id="days"></main>

<script>
/** -------- Local UI + localStorage (ä¿ç•™) -------- */
const KEY_DAYS = "days_v2";
const KEY_SUB  = "subtitle_v2";

const daysEl = document.getElementById("days");
const addDayBtn = document.getElementById("addDayBtn");
const clearBtn = document.getElementById("clearBtn");
const subtitleEl = document.getElementById("subtitle");
const saveStatusEl = document.getElementById("saveStatus");

let days = JSON.parse(localStorage.getItem(KEY_DAYS) || "[]");
subtitleEl.textContent = localStorage.getItem(KEY_SUB) || subtitleEl.textContent;

function setSaveStatus(txt){ saveStatusEl.textContent = txt; }

function saveLocal(){
  localStorage.setItem(KEY_DAYS, JSON.stringify(days));
  setSaveStatus("å·²å„²å­˜ âœ…");
}

function render(){
  daysEl.innerHTML = "";
  days.forEach((d,i)=>{
    const el = document.createElement("div");
    el.className = "day";
    el.innerHTML = `
      <div class="day-head">
        <div style="font-weight:900;">Day ${i+1}</div>
        <button class="danger" type="button" data-del="${i}">åˆªé™¤</button>
      </div>
      <div class="card" contenteditable="true">${(d.text || "").replaceAll("<","&lt;")}</div>
    `;

    el.querySelector(".card").addEventListener("input", (e)=>{
    days[i].text = e.target.innerText;
save();          // ä½ çš„ save() æœƒå¯« localStorage
scheduleAutoSync();
render();
      saveLocal();
      // ç™»å…¥ç‹€æ…‹ä¸‹ï¼šæ¨™è¨˜éœ€è¦åŒæ­¥ï¼ˆä¸è‡ªå‹•æ¯æ‰“å­—å°±ä¸Šå‚³ï¼Œé¿å…å¤ªé »ç¹ï¼‰
      window.__NEED_SYNC__ = true;
    });

    el.querySelector("[data-del]").addEventListener("click", ()=>{
      days.splice(i,1);
      saveLocal();
      render();
      window.__NEED_SYNC__ = true;
    });

    daysEl.appendChild(el);
  });
}

addDayBtn.addEventListener("click", ()=>{
  days.push({ text:"æ–°å¢è¡Œç¨‹å…§å®¹â€¦" });
  saveLocal();
  render();
  window.__NEED_SYNC__ = true;
});

clearBtn.addEventListener("click", ()=>{
  if(confirm("ç¢ºå®šæ¸…é™¤ v2 çš„æ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆæœ¬æ©Ÿ + ç•«é¢ï¼‰")){
    localStorage.removeItem(KEY_DAYS);
    localStorage.removeItem(KEY_SUB);
    days = [];
    subtitleEl.textContent = "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚";
    setSaveStatus("å·²æ¸…é™¤ âœ…");
    render();
    window.__NEED_SYNC__ = true;
  }
});

subtitleEl.addEventListener("input", ()=>{
  localStorage.setItem(KEY_SUB, subtitleEl.textContent);
  setSaveStatus("å·²å„²å­˜ âœ…");
  window.__NEED_SYNC__ = true;
});

render();
</script>

<!-- âœ… Firebaseï¼ˆEmail/Password + Firestoreï¼‰ -->
<script type="module">
  // =========================
  // Firebase (Auth + Firestore) å®Œæ•´ç‰ˆ
  // =========================

  // 1) Firebase æ ¸å¿ƒ
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import {
  getAuth,
  onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUid = user.uid;

    // âœ… ç™»å…¥å¾Œè‡ªå‹•å¾é›²ç«¯è¼‰å…¥
    try {
      await loadFromCloud(user.uid);
      // setStatus?.("å·²å¾é›²ç«¯è¼‰å…¥ âœ…");
    } catch (e) {
      console.error("loadFromCloud error:", e);
    }

  } else {
    currentUid = null;
  }
});
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  // =========================
  // ä½ çš„ Firebase Configï¼ˆä½ æä¾›çš„ï¼‰
  // =========================
  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  // =========================
  // åˆå§‹åŒ–
  // =========================
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  // ====== localStorage keysï¼ˆä½ å·²ç¢ºèªæ˜¯ days + subtitleï¼‰======
const KEY_DAYS = "days";
const KEY_SUB  = "subtitle";

// è®€/å¯«æœ¬æ©Ÿ
function loadLocal() {
  const days = JSON.parse(localStorage.getItem(KEY_DAYS) || "[]");
  const subtitle = localStorage.getItem(KEY_SUB) || "";
  return { days, subtitle };
}
function saveLocal(days, subtitle) {
  localStorage.setItem(KEY_DAYS, JSON.stringify(days || []));
  localStorage.setItem(KEY_SUB, subtitle || "");
}

// ====== Firestore ======
const db = getFirestore(app);

// å–å¾—ç›®å‰ç™»å…¥è€…çš„æ–‡ä»¶åƒè€ƒ
function userDocRef(uid) {
  return doc(db, "users", uid, "planner", "main");
}

// å¾é›²ç«¯è¼‰å…¥ -> è¦†è“‹æœ¬æ©Ÿ + é‡ç•«
async function loadFromCloud(uid) {
  const ref = userDocRef(uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    // é›²ç«¯é‚„æ²’æœ‰è³‡æ–™ï¼šç¬¬ä¸€æ¬¡ç™»å…¥å°±æŠŠæœ¬æ©Ÿæ¨ä¸Šå»ï¼ˆé¿å…ç©ºç™½ï¼‰
    const local = loadLocal();
    await saveToCloud(uid, local.days, local.subtitle);
    return { loaded: false, reason: "cloud_empty_uploaded_local" };
  }

  const data = snap.data() || {};
  const cloudDays = Array.isArray(data.days) ? data.days : [];
  const cloudSubtitle = typeof data.subtitle === "string" ? data.subtitle : "";

  // è¦†è“‹æœ¬æ©Ÿ
  saveLocal(cloudDays, cloudSubtitle);

  // ä½ åŸæœ¬çš„ render éœ€è¦ç”¨åˆ°å…¨åŸŸ days/subtitle çš„è©±ï¼š
  // é€™è£¡æŠŠå®ƒå€‘æ›´æ–°æ‰ï¼ˆä¾ä½ çš„ç¨‹å¼æ¶æ§‹èª¿æ•´ï¼‰
  if (window.days !== undefined) window.days = cloudDays;
  const subtitleEl = document.querySelector('[contenteditable="true"]');
  if (subtitleEl) subtitleEl.innerText = cloudSubtitle;

  // é‡æ–° renderï¼ˆå¦‚æœä½ çš„ render æ˜¯å…¨åŸŸ functionï¼‰
  if (typeof window.render === "function") window.render();

  return { loaded: true, reason: "cloud_loaded" };
}

// å­˜åˆ°é›²ç«¯
async function saveToCloud(uid, days, subtitle) {
  const ref = userDocRef(uid);
  await setDoc(ref, {
    days: Array.isArray(days) ? days : [],
    subtitle: subtitle || "",
    updatedAt: serverTimestamp()
  }, { merge: true });
}

// ====== è‡ªå‹•åŒæ­¥ï¼ˆé˜²æŠ–ï¼Œé¿å…ä½ æ‰“å­—æ™‚ç‹‚å¯«é›²ç«¯ï¼‰======
let currentUid = null;
let syncTimer = null;

function scheduleAutoSync() {
  if (!currentUid) return;
  clearTimeout(syncTimer);
  syncTimer = setTimeout(async () => {
    const local = loadLocal();
    try {
      await saveToCloud(currentUid, local.days, local.subtitle);
      // ä½ è‹¥æœ‰ç‹€æ…‹æ¬„å¯é¡¯ç¤ºï¼šå·²åŒæ­¥âœ…
      // setStatus?.("å·²åŒæ­¥åˆ°é›²ç«¯ âœ…");
    } catch (e) {
      // setStatus?.("åŒæ­¥å¤±æ•— âŒ");
      console.error("AutoSync failed:", e);
    }
  }, 700);
}
  const db = getFirestore(app);

  // å»ºè­°ï¼šæ‰‹æ©Ÿ/è·¨é ç©©å®š
  await setPersistence(auth, browserLocalPersistence);

  // =========================
  // è®€å–ä½ é é¢ä¸Šçš„å…ƒä»¶
  // =========================
  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");

  const btnSignup = document.getElementById("btnSignup");
  const btnLogin = document.getElementById("btnLogin");
  const btnLogout = document.getElementById("btnLogout");
  const btnLoadCloud = document.getElementById("btnLoadCloud");
  const btnSyncCloud = document.getElementById("btnSyncCloud");

  const authStatus = document.getElementById("authStatus");

  // =========================
  // è¨ºæ–·å€ï¼ˆé¡¯ç¤ºåœ¨é é¢åº•ä¸‹ï¼‰
  // =========================
  const diag = document.createElement("div");
  diag.style.marginTop = "10px";
  diag.style.fontSize = "12px";
  diag.style.lineHeight = "1.5";
  diag.style.color = "#6b4a2c";
  diag.style.whiteSpace = "pre-wrap";
  diag.style.wordBreak = "break-word";
  diag.textContent = `Firebase init OK: ${app.options?.projectId || "(unknown)"}\n`;
  document.querySelector("header")?.appendChild(diag);

  const log = (msg) => {
    diag.textContent += msg + "\n";
  };

  // =========================
  // localStorage Keyï¼ˆä½ å·²ç¢ºèªï¼‰
  // =========================
  const KEY_DAYS = "days";
  const KEY_SUBTITLE = "subtitle";

  // =========================
  // Firestore è·¯å¾‘ï¼šusers/{uid}/trip/main
  // =========================
  function docRefForUser(user) {
    return doc(db, "users", user.uid, "trip", "main");
  }

  // =========================
  // å¾é›²ç«¯è¼‰å…¥ â†’ local
  // =========================
  async function loadFromCloud(user) {
    const ref = docRefForUser(user);
    log("getDoc(users/{uid}/trip/main) ...");

    const snap = await getDoc(ref);
    if (!snap.exists()) {
      log("Cloud: no document yet.");
      alert("é›²ç«¯å°šç„¡è³‡æ–™ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨è«‹å…ˆã€ŒåŒæ­¥åˆ°é›²ç«¯ã€ï¼‰");
      return;
    }

    const data = snap.data() || {};
    localStorage.setItem(KEY_DAYS, JSON.stringify(data.days || []));
    localStorage.setItem(KEY_SUBTITLE, data.subtitle || "");

    // å¦‚æœä½ åŸæœ¬é é¢æœ‰ render()ï¼Œå°±æœƒæ›´æ–°ç•«é¢
    if (typeof window.render === "function") window.render();

    log("Cloud -> Local: OK âœ…");
    alert("å·²å¾é›²ç«¯è¼‰å…¥ âœ…");
  }

  // =========================
  // åŒæ­¥ local â†’ é›²ç«¯
  // =========================
  async function syncToCloud(user) {
    const ref = docRefForUser(user);

    const days = JSON.parse(localStorage.getItem(KEY_DAYS) || "[]");
    const subtitle = localStorage.getItem(KEY_SUBTITLE) || "";

    log("setDoc(users/{uid}/trip/main) ...");
    await setDoc(ref, {
      days,
      subtitle,
      updatedAt: serverTimestamp()
    }, { merge: true });

    log("Local -> Cloud: OK âœ…");
    alert("å·²åŒæ­¥åˆ°é›²ç«¯ âœ…");
  }

  // =========================
  // UI ç‹€æ…‹åˆ‡æ›
  // =========================
  function setLoggedOutUI() {
    if (authStatus) authStatus.textContent = "æœªç™»å…¥";
    if (btnLogout) btnLogout.style.display = "none";
    if (btnLogin) btnLogin.style.display = "inline-block";
    if (btnSignup) btnSignup.style.display = "inline-block";
  }

  function setLoggedInUI(user) {
    const name = user.email || "ä½¿ç”¨è€…";
    if (authStatus) authStatus.textContent = "å·²ç™»å…¥ï¼š" + name;
    if (btnLogout) btnLogout.style.display = "inline-block";
    if (btnLogin) btnLogin.style.display = "none";
    if (btnSignup) btnSignup.style.display = "none";
  }

  // =========================
  // ç¶å®šæŒ‰éˆ•ï¼šè¨»å†Š/ç™»å…¥/ç™»å‡º/è¼‰å…¥/åŒæ­¥
  // =========================
  btnSignup?.addEventListener("click", async () => {
    try {
      const email = emailEl?.value?.trim();
      const pw = passwordEl?.value;
      if (!email || !pw) return alert("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼");

      log("createUserWithEmailAndPassword() ...");
      await createUserWithEmailAndPassword(auth, email, pw);
      log("Signup OK âœ…");
      alert("è¨»å†ŠæˆåŠŸ âœ…");
    } catch (e) {
      log("Signup ERROR âŒ " + (e?.code || "") + " " + (e?.message || ""));
      alert("è¨»å†Šå¤±æ•—ï¼š" + (e?.code || e?.message || "æœªçŸ¥éŒ¯èª¤"));
    }
  });

  btnLogin?.addEventListener("click", async () => {
    try {
      const email = emailEl?.value?.trim();
      const pw = passwordEl?.value;
      if (!email || !pw) return alert("è«‹è¼¸å…¥ Email èˆ‡å¯†ç¢¼");

      log("signInWithEmailAndPassword() ...");
      await signInWithEmailAndPassword(auth, email, pw);
      log("Login OK âœ…");
      alert("ç™»å…¥æˆåŠŸ âœ…");
    } catch (e) {
      log("Login ERROR âŒ " + (e?.code || "") + " " + (e?.message || ""));
      alert("ç™»å…¥å¤±æ•—ï¼š" + (e?.code || e?.message || "æœªçŸ¥éŒ¯èª¤"));
    }
  });

  btnLogout?.addEventListener("click", async () => {
    try {
      log("signOut() ...");
      await signOut(auth);
      log("Logout OK âœ…");
      alert("å·²ç™»å‡º");
    } catch (e) {
      log("Logout ERROR âŒ " + (e?.code || "") + " " + (e?.message || ""));
      alert("ç™»å‡ºå¤±æ•—ï¼š" + (e?.code || e?.message || "æœªçŸ¥éŒ¯èª¤"));
    }
  });

  btnLoadCloud?.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return alert("è«‹å…ˆç™»å…¥");
    await loadFromCloud(user);
  });

  btnSyncCloud?.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return alert("è«‹å…ˆç™»å…¥");
    await syncToCloud(user);
  });

  // =========================
  // ç›£è½ç™»å…¥ç‹€æ…‹ï¼ˆæœ€é‡è¦ï¼‰
  // =========================
  onAuthStateChanged(auth, (user) => {
    if (user) {
      log("onAuthStateChanged: logged IN âœ…");
      setLoggedInUI(user);
    } else {
      log("onAuthStateChanged: logged OUT âŒ");
      setLoggedOutUI();
    }
  });
  log("=== DOM æª¢æŸ¥ ===");
log("emailEl: " + !!emailEl);
log("passwordEl: " + !!passwordEl);
log("btnSignup: " + !!btnSignup);
log("btnLogin: " + !!btnLogin);
log("btnLogout: " + !!btnLogout);
log("btnLoadCloud: " + !!btnLoadCloud);
log("btnSyncCloud: " + !!btnSyncCloud);
log("authStatus: " + !!authStatus);
</script>

</body>
</html>

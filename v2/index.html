<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Niji Trip 2026 Â· è¡Œç¨‹è¡¨</title>

  <style>
    :root{
      --bg-main:#ffe4b8;
      --bg-card:#fff7e8;
      --bg-chip:#fff6e5;
      --bg-chip-active:#ffffff;
      --blue-soft:#e5f4ff;
      --brown:#7a4a26;
      --brown-soft:#a26b3a;
      --border: rgba(186,140,91,.35);
      --shadow: 0 2px 4px rgba(0,0,0,.08);
      --r-big: 26px;
      --r-card: 20px;
      --r-small: 14px;
    }
    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",sans-serif; background:#fce0b3; color:var(--brown); }
    .page{ max-width:920px; margin:0 auto; padding:18px 14px 60px; }

    header{
      background:var(--bg-card);
      border-radius: var(--r-big);
      padding:18px 16px 14px;
      box-shadow:var(--shadow);
      margin-bottom:14px;
    }
    .title-row{ display:flex; align-items:center; gap:10px; }
    h1{ margin:0; font-size:28px; font-weight:900; letter-spacing:.04em; }
    .emoji{ font-size:26px; }
    .desc{ margin:8px 0 10px; line-height:1.6; font-size:14px; color:var(--brown-soft); }
    .desc[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,.2); }

    .btn-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    .btn{
      border:none; border-radius:999px; padding:8px 14px;
      background:#ffd59a; color:#5a351e; font-weight:800;
      box-shadow:var(--shadow); cursor:pointer; white-space:nowrap;
    }
    .btn.primary{ background:#ffb85c; }
    .btn.danger{ background:#ffb0a6; color:#7a221b; }
    .btn.ghost{ background:#fff3da; }
    .btn:active{ transform:translateY(1px); box-shadow:0 1px 2px rgba(0,0,0,.15); }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 12px; border-radius:999px;
      background:#fff3c5; color:#5c3a1c; font-weight:800;
    }

    /* Auth panel */
    .auth-panel{
      margin-top:10px;
      border-top:1px dashed var(--border);
      padding-top:10px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    .auth-panel input{
      flex:1 1 160px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fffdf6;
      font-size:14px;
      outline:none;
      color:var(--brown);
    }
    .auth-hint{
      font-size:12px; color:var(--brown-soft); opacity:.95; line-height:1.4;
      flex: 1 1 100%;
    }

    /* Day nav chips */
    .day-nav{
      background:#e3f2ff;
      border-radius: 24px 24px 18px 18px;
      padding:10px 8px;
      margin: 0 -6px 12px;
      overflow-x:auto;
      display:flex;
      gap:10px;
      scroll-behavior:smooth;
    }
    .day-chip{
      flex:0 0 auto;
      min-width:92px;
      background:var(--bg-chip);
      border-radius:999px;
      padding:8px 12px 7px;
      text-align:center;
      box-shadow:var(--shadow);
      cursor:grab;
      border:1px solid transparent;
      user-select:none;
    }
    .day-chip.active{ background:var(--bg-chip-active); border-color:rgba(122,74,38,.18); }
    .day-chip.dragging{ opacity:.6; cursor:grabbing; }
    .day-chip-main{ font-weight:900; font-size:14px; display:block; }
    .day-chip-sub{ font-size:12px; color:var(--brown-soft); display:block; margin-top:2px; }
    .day-chip-main[contenteditable], .day-chip-sub[contenteditable]{ outline:none; }

    /* Day section */
    .day-section{ margin-bottom:14px; }
    .day-card{
      background:var(--blue-soft);
      border-radius:28px;
      padding:14px 10px 16px;
      box-shadow:var(--shadow);
    }
    .day-header{
      display:flex; flex-wrap:wrap; align-items:baseline; gap:8px;
      margin-bottom:8px; padding:0 6px;
    }
    .day-header-main{
      background:#fff; border-radius:999px;
      padding:7px 14px; font-size:18px; font-weight:900; box-shadow:var(--shadow);
    }
    .day-header-main span[contenteditable]{ outline:none; }
    .day-header-sub{ font-size:15px; color:var(--brown-soft); }
    .day-header-sub span[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,.2); }
    .day-hint{
      font-size:12px; color:var(--brown-soft);
      margin:2px 6px 10px;
    }
    .day-hint span[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,.2); }

    /* Spot card */
    .spot-card{
      background:var(--bg-card);
      border-radius:var(--r-card);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      margin:0 4px 10px;
      cursor:grab;
      user-select:none;
    }
    .spot-card.dragging{ opacity:.65; cursor:grabbing; }
    .spot-title{ font-weight:900; font-size:16px; margin-bottom:6px; }
    .spot-title[contenteditable]{ outline:none; border-bottom:1px dashed rgba(122,74,38,.18); }

    .form-row{
      display:flex; flex-wrap:wrap; gap:8px; margin:8px 0;
      align-items:center;
    }
    .field{
      flex:1 1 160px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fffdf6;
      font-size:14px;
      color:var(--brown);
      outline:none;
    }
    .field.small{ flex:0 1 130px; max-width:160px; }
    .field.wide{ flex: 2 1 280px; }

    textarea.note{
      width:100%;
      min-height:56px;
      resize:vertical;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
      outline:none;
      font-size:14px;
      color:var(--brown);
      line-height:1.45;
    }

    .chip-actions{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;
      justify-content:flex-end;
    }
    .btn-mini{
      border:none; border-radius:999px;
      padding:6px 11px;
      font-size:13px;
      background:#ffe1a8;
      color:var(--brown);
      box-shadow:var(--shadow);
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-mini.del{ background:#ffb0a6; color:#7a221b; font-weight:900; }
    .btn-mini:active{ transform:translateY(1px); box-shadow:0 1px 2px rgba(0,0,0,.15); }

    .add-spot-row{
      margin: 4px 6px 0;
      padding: 0 8px 4px;
      display:flex;
      justify-content:flex-start;
    }

    .day-note-card{
      background:var(--bg-card);
      border-radius:var(--r-card);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      margin:10px 4px 0;
    }
    .day-note-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
      margin-bottom:6px;
    }
    .day-note-box{
      border-radius:12px;
      border:1px dashed var(--border);
      background:#fffdf6;
      padding:10px 12px;
      min-height:34px;
      white-space:pre-wrap;
      outline:none;
      line-height:1.45;
      font-size:14px;
      color:var(--brown);
    }
    .day-note-box[contenteditable]{ outline:none; }

    /* Undo floating */
    .undo-floating{
      position:fixed;
      left:10px;
      bottom:10px;
      z-index:50;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .undo-floating button{
      width:46px; height:46px;
      border-radius:50%;
      border:none;
      background:#ffcf8f;
      box-shadow:var(--shadow);
      font-size:22px;
      cursor:pointer;
    }
    .toast{
      position:fixed;
      right:12px;
      bottom:12px;
      background:rgba(90,53,30,.92);
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      opacity:0;
      transform:translateY(6px);
      transition: opacity .2s ease, transform .2s ease;
      z-index:60;
      pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateY(0); }

    /* Long press menu */
    .sheet-mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      z-index:80;
      display:none;
    }
    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-420px;
      background:#fffdf6;
      border-radius:18px 18px 0 0;
      box-shadow: 0 -8px 24px rgba(0,0,0,.18);
      padding:12px 12px 18px;
      z-index:81;
      transition: bottom .22s ease;
    }
    .sheet.show{ bottom:0; }
    .sheet-title{
      font-weight:900;
      color:var(--brown);
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .sheet-actions{
      display:flex; flex-direction:column; gap:10px;
    }
    .sheet-actions button{
      width:100%;
      border:none;
      border-radius:14px;
      padding:12px 12px;
      background:#ffe7bf;
      color:var(--brown);
      font-weight:900;
      box-shadow:var(--shadow);
      cursor:pointer;
      text-align:left;
    }
    .sheet-actions button.danger{
      background:#ffb0a6;
      color:#7a221b;
    }

    @media (max-width:600px){
      h1{ font-size:24px; }
      .day-card{ border-radius:24px; }
      .spot-card{ padding:12px 11px 10px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="title-row">
        <h1 contenteditable="true" id="titleText">Niji Trip 2026</h1>
        <span class="emoji">ğŸŒˆ</span>
      </div>

      <div class="desc" id="subtitleText" contenteditable="true">
        æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚Day å¯æ‹–æ‹‰æ’åºã€è¡Œç¨‹å¡å¯æ‹–æ‹‰/è¤‡è£½/åˆªé™¤ã€‚æ¯å¼µå¡å¯å­˜å‡ºç™¼åœ°/ç›®çš„åœ°/é€”ç¶“é»ï¼Œä¸¦ä¸€éµé–‹å•Ÿ Google Maps è·¯ç·šã€‚
      </div>

      <div class="btn-row">
        <button class="btn primary" id="addDayBtn" type="button">ï¼‹ æ–°å¢ä¸€å¤©</button>
        <button class="btn danger" id="removeLastDayBtn" type="button">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
        <button class="btn" id="exportBtn" type="button">åŒ¯å‡º JSON</button>
        <button class="btn" id="importBtn" type="button">åŒ¯å…¥ JSON</button>
        <button class="btn ghost" id="clearLocalBtn" type="button">æ¸…é™¤æœ¬æ©Ÿ</button>
        <span class="badge" id="authBadge">æœªç™»å…¥ï¼ˆåƒ…æœ¬æ©Ÿï¼‰</span>
      </div>

      <!-- è‡ªå®¶å¸³è™Ÿç™»å…¥ï¼ˆEmail/Passwordï¼‰ -->
      <div class="auth-panel">
        <input id="email" type="email" placeholder="Emailï¼ˆç”¨ä¾†åŒæ­¥ï¼‰" autocomplete="email" />
        <input id="password" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰" autocomplete="current-password" />
        <button class="btn" id="btnSignUp" type="button">è¨»å†Š</button>
        <button class="btn" id="btnLogin" type="button">ç™»å…¥</button>
        <button class="btn danger" id="btnLogout" type="button" style="display:none;">ç™»å‡º</button>
        <button class="btn" id="btnCloudPush" type="button" style="display:none;">å­˜åˆ°é›²ç«¯</button>
        <button class="btn" id="btnCloudPull" type="button" style="display:none;">å¾é›²ç«¯è¼‰å…¥</button>

        <div class="auth-hint">
          âœ… é€™è£¡ä¸ç”¨ Google ç™»å…¥ã€‚<br>
          åŒä¸€çµ„ Email/å¯†ç¢¼åœ¨ A/B è£ç½®ç™»å…¥å¾Œï¼Œå°±èƒ½çœ‹è¦‹ç›¸åŒè¡Œç¨‹ï¼ˆåŒæ­¥é  Firestoreï¼‰ã€‚<br>
          ä½ éœ€è¦åœ¨ Firebase Console é–‹å•Ÿï¼šAuthentication â†’ Email/Passwordï¼Œä»¥åŠ Firestore Databaseã€‚
        </div>
      </div>
    </header>

    <!-- ä¸Šæ–¹ Day chips -->
    <div class="day-nav" id="dayNav"></div>

    <!-- Days container -->
    <div id="daysRoot"></div>
  </div>

  <div class="undo-floating">
    <button id="undoBtn" title="ä¸Šä¸€æ­¥">â†©</button>
  </div>
  <div class="toast" id="toast">å·²å„²å­˜</div>

  <!-- Long press sheet -->
  <div class="sheet-mask" id="sheetMask"></div>
  <div class="sheet" id="sheet">
    <div class="sheet-title">
      <span id="sheetTitle">æ“ä½œ</span>
      <button class="btn-mini" id="sheetClose" type="button">é—œé–‰</button>
    </div>
    <div class="sheet-actions">
      <button type="button" id="sheetDup">è¤‡è£½æ­¤å¡ç‰‡</button>
      <button type="button" id="sheetUp">ä¸Šç§»</button>
      <button type="button" id="sheetDown">ä¸‹ç§»</button>
      <button type="button" class="danger" id="sheetDel">åˆªé™¤æ­¤å¡ç‰‡</button>
    </div>
  </div>

  <input id="importFile" type="file" accept="application/json" style="display:none" />

  <script>
    (function(){
      // ========== Local-only app state ==========
      const LS_KEY_DAYS = "days";
      const LS_KEY_SUBTITLE = "subtitle";
      const LS_KEY_TITLE = "title";
      const UNDO_LIMIT = 10;

      const HOTEL_NAME = "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰"; // ä½ æƒ³å›ºå®šçš„é£¯åº—ï¼Œå¯æ”¹æˆä½ çš„

      // state
      let state = {
        title: "Niji Trip 2026",
        subtitle: "",
        days: []
      };

      let undoStack = [];
      let isApplyingRemote = false;

      // drag
      let draggingChip = null;
      let draggingCard = null;

      // long press sheet target
      let sheetTarget = null;

      // elements
      const titleText = document.getElementById("titleText");
      const subtitleText = document.getElementById("subtitleText");
      const dayNav = document.getElementById("dayNav");
      const daysRoot = document.getElementById("daysRoot");
      const toastEl = document.getElementById("toast");

      const addDayBtn = document.getElementById("addDayBtn");
      const removeLastDayBtn = document.getElementById("removeLastDayBtn");
      const clearLocalBtn = document.getElementById("clearLocalBtn");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const importFile = document.getElementById("importFile");
      const undoBtn = document.getElementById("undoBtn");

      const sheetMask = document.getElementById("sheetMask");
      const sheet = document.getElementById("sheet");
      const sheetClose = document.getElementById("sheetClose");
      const sheetTitle = document.getElementById("sheetTitle");
      const sheetDup = document.getElementById("sheetDup");
      const sheetUp = document.getElementById("sheetUp");
      const sheetDown = document.getElementById("sheetDown");
      const sheetDel = document.getElementById("sheetDel");

      function uid(){ return Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36); }

      function toast(msg="å·²å„²å­˜"){
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(()=>toastEl.classList.remove("show"), 900);
      }

      function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

      function pushUndo(){
        const snap = deepClone(state);
        undoStack.push(snap);
        if(undoStack.length > UNDO_LIMIT) undoStack.shift();
      }

      function undo(){
        if(undoStack.length <= 0) return;
        const prev = undoStack.pop();
        if(!prev) return;
        state = prev;
        saveLocal(false);
        renderAll();
        toast("å·²å¾©åŸ");
      }

      function saveLocal(showToast=true){
        try{
          localStorage.setItem(LS_KEY_DAYS, JSON.stringify(state.days || []));
          localStorage.setItem(LS_KEY_SUBTITLE, state.subtitle || "");
          localStorage.setItem(LS_KEY_TITLE, state.title || "Niji Trip 2026");
          if(showToast) toast("å·²å„²å­˜");
        }catch(e){
          console.warn("localStorage å¯«å…¥å¤±æ•—", e);
        }
        // å¦‚æœæœ‰ç™»å…¥ä¸”ä¸æ˜¯ remote å¥—ç”¨ï¼Œå°±è§¸ç™¼é›²ç«¯æ’ç¨‹åŒæ­¥ï¼ˆç”± Firebase module æ¥æ‰‹ï¼‰
        if(!isApplyingRemote && window.__cloudSchedulePush){
          window.__cloudSchedulePush();
        }
      }

      function loadLocal(){
        try{
          const days = JSON.parse(localStorage.getItem(LS_KEY_DAYS) || "[]");
          const subtitle = localStorage.getItem(LS_KEY_SUBTITLE) || "";
          const title = localStorage.getItem(LS_KEY_TITLE) || "Niji Trip 2026";
          state.days = Array.isArray(days) ? days : [];
          state.subtitle = subtitle;
          state.title = title;
        }catch(e){
          console.warn("localStorage è®€å–å¤±æ•—", e);
        }
        migrateIfNeeded();
      }

      // ---- data model (supports advanced routing) ----
      // day: { id, label, date, header, items:[item], dayNote }
      // item: { id, title, time, origin, destination, waypoints:[...], note }
      function migrateIfNeeded(){
        // ensure basics
        if(!Array.isArray(state.days)) state.days = [];
        // if empty init 3 days example
        if(state.days.length === 0){
          state.days = [
            makeDay(1, "5/8", "ï¼ˆç¯„ä¾‹ï¼‰æˆç”°æ©Ÿå ´ãƒ»å…¥ä½ä¸Šé‡"),
            makeDay(2, "5/9", "ï¼ˆç¯„ä¾‹ï¼‰ä¸Šé‡ãƒ»æ·ºè‰æ•£æ­¥"),
            makeDay(3, "5/10", "ï¼ˆç¯„ä¾‹ï¼‰è‡ªç”±æ´»å‹•æ—¥")
          ];
          // add a sample card to day1/day2
          state.days[0].items.push(makeItem("ç¯„ä¾‹æ™¯é»", "10:30"));
          state.days[1].items.push(makeItem("ç¯„ä¾‹æ™¯é» 2", "11:00"));
          saveLocal(false);
        }

        state.days.forEach((d,idx)=>{
          d.id = d.id || uid();
          d.label = typeof d.label === "string" ? d.label : ("Day " + (idx+1));
          d.date = typeof d.date === "string" ? d.date : "";
          d.header = typeof d.header === "string" ? d.header : "";
          d.dayNote = typeof d.dayNote === "string" ? d.dayNote : "";
          if(!Array.isArray(d.items)) d.items = [];
          d.items.forEach(it=>{
            it.id = it.id || uid();
            it.title = (it.title ?? "").toString();
            it.time = (it.time ?? "").toString();
            it.origin = (it.origin ?? "").toString();
            it.destination = (it.destination ?? "").toString();
            if(!Array.isArray(it.waypoints)) it.waypoints = [];
            it.waypoints = it.waypoints.map(x => (x ?? "").toString());
            it.note = (it.note ?? "").toString();
          });
        });
      }

      function makeDay(n, date, header){
        return {
          id: uid(),
          label: "Day " + n,
          date: date || "",
          header: header || "",
          items: [],
          dayNote: ""
        };
      }
      function makeItem(title, time){
        return {
          id: uid(),
          title: title || "æ–°è¡Œç¨‹",
          time: time || "",
          origin: HOTEL_NAME,
          destination: "",
          waypoints: [],
          note: ""
        };
      }

      // ---- render ----
      function renderAll(){
        // header texts
        titleText.textContent = state.title || "Niji Trip 2026";
        subtitleText.textContent = state.subtitle || "";

        renderDayNav();
        renderDays();
        bindGlobalInputs();
      }

      function renderDayNav(){
        dayNav.innerHTML = "";
        state.days.forEach((d, idx)=>{
          const chip = document.createElement("div");
          chip.className = "day-chip" + (idx===0 ? " active" : "");
          chip.draggable = true;
          chip.dataset.dayId = d.id;

          chip.innerHTML = `
            <span class="day-chip-main" contenteditable="true">${escapeHTML(d.label || ("Day "+(idx+1)))}</span>
            <span class="day-chip-sub" contenteditable="true">${escapeHTML(d.date || "")}</span>
          `;
          // click scroll
          chip.addEventListener("click", ()=>{
            document.querySelectorAll(".day-chip").forEach(x=>x.classList.remove("active"));
            chip.classList.add("active");
            const sec = document.querySelector('.day-section[data-day-id="'+d.id+'"]');
            if(sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
          });

          // edit chip label/date
          const main = chip.querySelector(".day-chip-main");
          const sub = chip.querySelector(".day-chip-sub");
          main.addEventListener("input", ()=>{
            d.label = main.textContent.trim();
            saveLocal();
          });
          sub.addEventListener("input", ()=>{
            d.date = sub.textContent.trim();
            saveLocal();
          });

          // drag reorder
          chip.addEventListener("dragstart", (e)=>{
            draggingChip = chip;
            chip.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          });
          chip.addEventListener("dragend", ()=>{
            if(!draggingChip) return;
            draggingChip.classList.remove("dragging");
            draggingChip = null;

            // sync state order based on DOM order
            const ids = Array.from(dayNav.querySelectorAll(".day-chip")).map(x=>x.dataset.dayId);
            state.days.sort((a,b)=> ids.indexOf(a.id) - ids.indexOf(b.id));
            saveLocal();
            renderAll();
          });

          dayNav.appendChild(chip);
        });

        // container dragover logic
        dayNav.addEventListener("dragover", (e)=>{
          if(!draggingChip) return;
          e.preventDefault();
          const after = getAfterChip(dayNav, e.clientX);
          if(after == null) dayNav.appendChild(draggingChip);
          else dayNav.insertBefore(draggingChip, after);
        }, { passive:false });
      }

      function getAfterChip(container, x){
        const chips = [...container.querySelectorAll(".day-chip:not(.dragging)")];
        let closest = { offset: Number.NEGATIVE_INFINITY, el: null };
        chips.forEach(ch=>{
          const box = ch.getBoundingClientRect();
          const offset = x - (box.left + box.width/2);
          if(offset < 0 && offset > closest.offset){
            closest = { offset, el: ch };
          }
        });
        return closest.el;
      }

      function renderDays(){
        daysRoot.innerHTML = "";
        state.days.forEach((d, idx)=>{
          const sec = document.createElement("section");
          sec.className = "day-section";
          sec.dataset.dayId = d.id;

          const dayCard = document.createElement("div");
          dayCard.className = "day-card";

          dayCard.innerHTML = `
            <div class="day-header">
              <div class="day-header-main"><span contenteditable="true">${escapeHTML(d.label || ("Day "+(idx+1)))}</span></div>
              <div class="day-header-sub"><span contenteditable="true">${escapeHTML(d.header || "")}</span></div>
            </div>
            <div class="day-hint">
              æ—¥æœŸï¼š<span contenteditable="true">${escapeHTML(d.date || "")}</span>
              <span style="margin-left:6px; opacity:.9;" contenteditable="true">ï¼ˆå¯è‡ªç”±ä¿®æ”¹ï¼‰</span>
            </div>
            <div class="items"></div>
            <div class="add-spot-row">
              <button class="btn-mini" type="button" data-act="addCard">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</button>
            </div>
            <div class="day-note-card">
              <div class="day-note-head">
                <div>ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
              </div>
              <div class="day-note-box" contenteditable="true"></div>
            </div>
          `;

          const itemsEl = dayCard.querySelector(".items");
          // day header editable
          const dayLabelEl = dayCard.querySelector(".day-header-main span[contenteditable]");
          const dayHeaderEl = dayCard.querySelector(".day-header-sub span[contenteditable]");
          const dayDateEl = dayCard.querySelector(".day-hint span[contenteditable]");
          const dayNoteBox = dayCard.querySelector(".day-note-box");

          dayLabelEl.addEventListener("input", ()=>{ d.label = dayLabelEl.textContent.trim(); saveLocal(); });
          dayHeaderEl.addEventListener("input", ()=>{ d.header = dayHeaderEl.textContent.trim(); saveLocal(); });
          dayDateEl.addEventListener("input", ()=>{ d.date = dayDateEl.textContent.trim(); saveLocal(); });
          dayNoteBox.textContent = d.dayNote || "";
          dayNoteBox.addEventListener("input", ()=>{ d.dayNote = dayNoteBox.textContent; saveLocal(); });

          // render cards
          d.items.forEach((it)=>{
            itemsEl.appendChild(renderCard(d, it));
          });

          // add button
          dayCard.querySelector('[data-act="addCard"]').addEventListener("click", ()=>{
            pushUndo();
            const newIt = makeItem("æ–°è¡Œç¨‹", "");
            d.items.push(newIt);
            saveLocal();
            renderAll();
            // scroll to new item
            setTimeout(()=>{
              const card = document.querySelector('.spot-card[data-item-id="'+newIt.id+'"]');
              if(card) card.scrollIntoView({behavior:"smooth", block:"center"});
            }, 80);
          });

          // setup dropzone within day for cards drag reorder + auto scroll
          setupDayCardDnD(dayCard, d);

          sec.appendChild(dayCard);
          daysRoot.appendChild(sec);
        });
      }

      function renderCard(day, it){
        const card = document.createElement("article");
        card.className = "spot-card";
        card.draggable = true;
        card.dataset.itemId = it.id;

        card.innerHTML = `
          <div class="spot-title" contenteditable="true">${escapeHTML(it.title || "æ–°è¡Œç¨‹")}</div>

          <div class="form-row">
            <input class="field small it-time" placeholder="æ™‚é–“ 10:30" value="${escapeHTML(it.time || "")}">
            <input class="field wide it-origin" placeholder="å‡ºç™¼åœ° Originï¼ˆç•™ç©ºæœƒç”¨é£¯åº—ï¼‰" value="${escapeHTML(it.origin || "")}">
          </div>

          <div class="form-row">
            <input class="field wide it-dest" placeholder="ç›®çš„åœ° Destination" value="${escapeHTML(it.destination || "")}">
            <button class="btn-mini" type="button" data-iact="route">ä¸€éµå°èˆªè·¯ç·š</button>
            <button class="btn-mini" type="button" data-iact="search">åœ°åœ–æœå°‹</button>
          </div>

          <div class="form-row">
            <input class="field wide it-wp-input" placeholder="é€”ç¶“é» Waypointï¼ˆå¯ä¸å¡«ï¼‰">
            <button class="btn-mini" type="button" data-iact="addWp">ï¼‹ é€”ç¶“é»</button>
          </div>

          <div class="form-row it-wp-list"></div>

          <textarea class="note it-note" placeholder="å‚™è¨»ï¼ˆç¥¨åˆ¸/æ’éšŠ/åœ°å€/æé†’â€¦ï¼‰">${escapeHTML(it.note || "")}</textarea>

          <div class="chip-actions">
            <button class="btn-mini" type="button" data-iact="dup">è¤‡è£½</button>
            <button class="btn-mini del" type="button" data-iact="del">åˆªé™¤</button>
          </div>
        `;

        // editable
        const titleEl = card.querySelector(".spot-title");
        const timeEl = card.querySelector(".it-time");
        const originEl = card.querySelector(".it-origin");
        const destEl = card.querySelector(".it-dest");
        const noteEl = card.querySelector(".it-note");
        const wpInput = card.querySelector(".it-wp-input");
        const wpList = card.querySelector(".it-wp-list");

        function rerenderWp(){
          wpList.innerHTML = "";
          (it.waypoints || []).forEach((w, idx)=>{
            const pill = document.createElement("span");
            pill.className = "badge";
            pill.style.background = "#fff1d7";
            pill.style.fontWeight = "800";
            pill.style.cursor = "pointer";
            pill.textContent = "é€”ç¶“ï¼š" + (w || "(ç©º)") + " âœ•";
            pill.title = "é»æ“Šç§»é™¤é€™å€‹é€”ç¶“é»";
            pill.addEventListener("click", ()=>{
              pushUndo();
              it.waypoints.splice(idx,1);
              saveLocal();
              rerenderWp();
            });
            wpList.appendChild(pill);
          });
        }
        rerenderWp();

        const update = ()=>{
          it.title = titleEl.textContent.trim();
          it.time = timeEl.value;
          it.origin = originEl.value;
          it.destination = destEl.value;
          it.note = noteEl.value;
          saveLocal();
        };

        titleEl.addEventListener("input", update);
        timeEl.addEventListener("input", update);
        originEl.addEventListener("input", update);
        destEl.addEventListener("input", update);
        noteEl.addEventListener("input", update);

        // actions
        card.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(!btn) return;
          const act = btn.dataset.iact;
          if(!act) return;

          if(act === "addWp"){
            const v = (wpInput.value || "").trim();
            if(!v) return;
            pushUndo();
            it.waypoints = Array.isArray(it.waypoints) ? it.waypoints : [];
            it.waypoints.push(v);
            wpInput.value = "";
            saveLocal();
            rerenderWp();
            return;
          }

          if(act === "search"){
            const q = (destEl.value || titleEl.textContent || "").trim();
            if(!q) return alert("è«‹å…ˆå¡«ç›®çš„åœ°æˆ–æ¨™é¡Œ");
            const url = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(q);
            window.open(url, "_blank", "noopener");
            return;
          }

          if(act === "route"){
            // Build directions:
            // origin = originEl or HOTEL_NAME
            // destination = destEl
            // waypoints = it.waypoints joined by |
            const origin = (originEl.value || "").trim() || HOTEL_NAME;
            const destination = (destEl.value || "").trim();
            if(!destination) return alert("è«‹å…ˆå¡«ç›®çš„åœ° Destination");
            const wps = (it.waypoints || []).map(x=> (x||"").trim()).filter(Boolean);
            let url = "https://www.google.com/maps/dir/?api=1" +
              "&origin=" + encodeURIComponent(origin) +
              "&destination=" + encodeURIComponent(destination);
            if(wps.length){
              url += "&waypoints=" + encodeURIComponent(wps.join("|"));
            }
            url += "&travelmode=transit"; // ä½ ä¹Ÿå¯æ”¹ driving/walking
            window.open(url, "_blank", "noopener");
            return;
          }

          if(act === "dup"){
            pushUndo();
            const clone = deepClone(it);
            clone.id = uid();
            day.items.splice(day.items.indexOf(it)+1, 0, clone);
            saveLocal();
            renderAll();
            return;
          }

          if(act === "del"){
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return;
            pushUndo();
            day.items = day.items.filter(x=>x.id !== it.id);
            saveLocal();
            renderAll();
            return;
          }
        });

        // long press menu for mobile (delete/dup/move)
        attachLongPress(card, ()=>{
          sheetTarget = { dayId: day.id, itemId: it.id };
          sheetTitle.textContent = "å¡ç‰‡æ“ä½œ";
          openSheet();
        });

        // drag handlers set in setupDayCardDnD
        card.addEventListener("dragstart", (e)=>{
          draggingCard = card;
          card.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
        });
        card.addEventListener("dragend", ()=>{
          card.classList.remove("dragging");
          draggingCard = null;
          stopAutoScroll();
          saveLocal();
        });

        return card;
      }

      function setupDayCardDnD(dayCard, day){
        dayCard.addEventListener("dragover", (e)=>{
          if(!draggingCard) return;
          e.preventDefault();

          startAutoScroll(e.clientY);

          const itemsEl = dayCard.querySelector(".items");
          if(!itemsEl) return;
          const after = getAfterCard(itemsEl, e.clientY);
          if(after == null) itemsEl.appendChild(draggingCard);
          else itemsEl.insertBefore(draggingCard, after);
        }, { passive:false });

        dayCard.addEventListener("drop", ()=>{
          if(!draggingCard) return;
          // sync day.items order by DOM
          const ids = Array.from(dayCard.querySelectorAll(".spot-card")).map(x=>x.dataset.itemId);
          day.items.sort((a,b)=> ids.indexOf(a.id) - ids.indexOf(b.id));
          saveLocal();
        });
      }

      function getAfterCard(container, y){
        const cards = [...container.querySelectorAll(".spot-card:not(.dragging)")];
        let closest = { offset: Number.NEGATIVE_INFINITY, el: null };
        cards.forEach(c=>{
          const box = c.getBoundingClientRect();
          const offset = y - (box.top + box.height/2);
          if(offset < 0 && offset > closest.offset){
            closest = { offset, el: c };
          }
        });
        return closest.el;
      }

      function escapeHTML(s){
        return (s ?? "").toString()
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // ---- Long press sheet ----
      let lpTimer = null;
      function attachLongPress(el, onLongPress){
        el.addEventListener("pointerdown", (e)=>{
          // ignore when pressing inside inputs/textarea/buttons
          const t = e.target;
          if(t && (t.tagName==="INPUT" || t.tagName==="TEXTAREA" || t.tagName==="BUTTON")) return;
          if(lpTimer) clearTimeout(lpTimer);
          lpTimer = setTimeout(()=>{
            onLongPress();
          }, 520);
        });
        el.addEventListener("pointerup", ()=>{ if(lpTimer) clearTimeout(lpTimer); });
        el.addEventListener("pointercancel", ()=>{ if(lpTimer) clearTimeout(lpTimer); });
        el.addEventListener("pointermove", ()=>{ if(lpTimer) clearTimeout(lpTimer); });
      }

      function openSheet(){
        sheetMask.style.display = "block";
        sheet.classList.add("show");
      }
      function closeSheet(){
        sheetMask.style.display = "none";
        sheet.classList.remove("show");
        sheetTarget = null;
      }
      sheetClose.addEventListener("click", closeSheet);
      sheetMask.addEventListener("click", closeSheet);

      function getTargetRefs(){
        if(!sheetTarget) return null;
        const day = state.days.find(d=>d.id===sheetTarget.dayId);
        if(!day) return null;
        const idx = day.items.findIndex(x=>x.id===sheetTarget.itemId);
        if(idx < 0) return null;
        return { day, idx };
      }

      sheetDup.addEventListener("click", ()=>{
        const ref = getTargetRefs();
        if(!ref) return closeSheet();
        pushUndo();
        const it = ref.day.items[ref.idx];
        const clone = deepClone(it);
        clone.id = uid();
        ref.day.items.splice(ref.idx+1, 0, clone);
        saveLocal();
        renderAll();
        closeSheet();
      });
      sheetUp.addEventListener("click", ()=>{
        const ref = getTargetRefs();
        if(!ref) return closeSheet();
        if(ref.idx===0) return;
        pushUndo();
        const arr = ref.day.items;
        [arr[ref.idx-1], arr[ref.idx]] = [arr[ref.idx], arr[ref.idx-1]];
        saveLocal();
        renderAll();
        closeSheet();
      });
      sheetDown.addEventListener("click", ()=>{
        const ref = getTargetRefs();
        if(!ref) return closeSheet();
        const arr = ref.day.items;
        if(ref.idx >= arr.length-1) return;
        pushUndo();
        [arr[ref.idx+1], arr[ref.idx]] = [arr[ref.idx], arr[ref.idx+1]];
        saveLocal();
        renderAll();
        closeSheet();
      });
      sheetDel.addEventListener("click", ()=>{
        const ref = getTargetRefs();
        if(!ref) return closeSheet();
        if(!confirm("ç¢ºå®šåˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ")) return;
        pushUndo();
        ref.day.items.splice(ref.idx,1);
        saveLocal();
        renderAll();
        closeSheet();
      });

      // ---- Auto scroll while dragging ----
      let autoScrollRAF = null;
      let autoScrollDir = 0; // -1 up, 1 down
      function startAutoScroll(clientY){
        const padding = 80;
        const speed = 14;
        const vh = window.innerHeight;
        if(clientY < padding) autoScrollDir = -1;
        else if(clientY > vh - padding) autoScrollDir = 1;
        else autoScrollDir = 0;

        if(autoScrollDir !== 0 && !autoScrollRAF){
          const step = ()=>{
            if(autoScrollDir===0){ stopAutoScroll(); return; }
            window.scrollBy(0, autoScrollDir * speed);
            autoScrollRAF = requestAnimationFrame(step);
          };
          autoScrollRAF = requestAnimationFrame(step);
        }
      }
      function stopAutoScroll(){
        if(autoScrollRAF){
          cancelAnimationFrame(autoScrollRAF);
          autoScrollRAF = null;
        }
        autoScrollDir = 0;
      }

      // ---- global binds ----
      function bindGlobalInputs(){
        titleText.oninput = ()=>{
          state.title = titleText.textContent.trim() || "Niji Trip 2026";
          saveLocal();
        };
        subtitleText.oninput = ()=>{
          state.subtitle = subtitleText.textContent;
          saveLocal();
        };
      }

      // ---- buttons ----
      addDayBtn.addEventListener("click", ()=>{
        pushUndo();
        const next = state.days.length + 1;
        const d = makeDay(next, "", "ï¼ˆæ–°çš„ä¸€å¤©è¡Œç¨‹ï¼‰");
        d.items.push(makeItem("æ–°è¡Œç¨‹", ""));
        state.days.push(d);
        saveLocal();
        renderAll();
        toast("å·²æ–°å¢ä¸€å¤©");
      });

      removeLastDayBtn.addEventListener("click", ()=>{
        if(state.days.length<=1) return alert("è‡³å°‘ä¿ç•™ä¸€å¤©");
        if(!confirm("ç¢ºå®šåˆªé™¤æœ€å¾Œä¸€å¤©ï¼Ÿ")) return;
        pushUndo();
        state.days.pop();
        saveLocal();
        renderAll();
      });

      clearLocalBtn.addEventListener("click", ()=>{
        if(!confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆé›²ç«¯è³‡æ–™ä¸æœƒè¢«æ¸…æ‰ï¼Œé™¤éä½ ä¹Ÿå¦å¤–å­˜å›å»ï¼‰")) return;
        pushUndo();
        state.days = [ makeDay(1,"","ï¼ˆæ¸…ç©ºå¾Œçš„æ–° Dayï¼‰") ];
        state.days[0].items.push(makeItem("æ–°è¡Œç¨‹",""));
        state.subtitle = "";
        state.title = "Niji Trip 2026";
        try{
          localStorage.removeItem(LS_KEY_DAYS);
          localStorage.removeItem(LS_KEY_SUBTITLE);
          localStorage.removeItem(LS_KEY_TITLE);
        }catch(_){}
        saveLocal(false);
        renderAll();
        toast("å·²æ¸…é™¤æœ¬æ©Ÿ");
      });

      exportBtn.addEventListener("click", ()=>{
        const payload = {
          version: 1,
          exportedAt: new Date().toISOString(),
          state
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "NijiTrip_backup.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      importBtn.addEventListener("click", ()=>{
        importFile.value = "";
        importFile.click();
      });

      importFile.addEventListener("change", ()=>{
        const file = importFile.files && importFile.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = ()=>{
          try{
            const json = JSON.parse(r.result);
            if(!json || !json.state) return alert("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º");
            pushUndo();
            state = json.state;
            migrateIfNeeded();
            saveLocal();
            renderAll();
            toast("å·²åŒ¯å…¥");
          }catch(e){
            alert("åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º");
          }
        };
        r.readAsText(file, "utf-8");
      });

      undoBtn.addEventListener("click", undo);

      // ---- init ----
      loadLocal();
      pushUndo(); // baseline
      renderAll();

      // expose helpers to Firebase module
      window.__nijiGetState = ()=> deepClone(state);
      window.__nijiApplyRemoteState = (remoteState)=>{
        if(!remoteState) return;
        pushUndo();
        isApplyingRemote = true;
        state = remoteState;
        migrateIfNeeded();
        saveLocal(false);
        renderAll();
        isApplyingRemote = false;
        toast("å·²å¾é›²ç«¯æ›´æ–°");
      };
      window.__nijiToast = toast;
      window.__nijiSetApplyingRemote = (v)=>{ isApplyingRemote = !!v; };
    })();
  </script>

  <!-- Firebase (Email/Password) + Firestore Sync -->
  <script type="module">
    // âœ… ä½ æä¾›çš„ firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
      authDomain: "trip-db86d.firebaseapp.com",
      projectId: "trip-db86d",
      storageBucket: "trip-db86d.firebasestorage.app",
      messagingSenderId: "709795426974",
      appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
      measurementId: "G-FD0411E3XH"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authBadge = document.getElementById("authBadge");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const btnSignUp = document.getElementById("btnSignUp");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");
    const btnCloudPush = document.getElementById("btnCloudPush");
    const btnCloudPull = document.getElementById("btnCloudPull");

    let currentUid = null;
    let unsub = null;
    let pushingTimer = null;
    let lastRemoteUpdatedAt = 0;

    // Cloud doc path: users/{uid}/apps/nijiTrip2026
    function userDocRef(uid){
      return doc(db, "users", uid, "apps", "nijiTrip2026");
    }

    function setUILoggedOut(){
      authBadge.textContent = "æœªç™»å…¥ï¼ˆåƒ…æœ¬æ©Ÿï¼‰";
      btnLogout.style.display = "none";
      btnCloudPush.style.display = "none";
      btnCloudPull.style.display = "none";
      btnLogin.style.display = "inline-block";
      btnSignUp.style.display = "inline-block";
    }

    function setUILoggedIn(user){
      const name = user.email || "å·²ç™»å…¥";
      authBadge.textContent = "å·²ç™»å…¥ï¼š" + name;
      btnLogout.style.display = "inline-block";
      btnCloudPush.style.display = "inline-block";
      btnCloudPull.style.display = "inline-block";
      btnLogin.style.display = "none";
      btnSignUp.style.display = "none";
    }

    async function doSignUp(){
      const email = (emailEl.value || "").trim();
      const pass = (passEl.value || "").trim();
      if(!email || !pass) return alert("è«‹è¼¸å…¥ Email + å¯†ç¢¼");
      if(pass.length < 6) return alert("å¯†ç¢¼è‡³å°‘ 6 ç¢¼");
      await createUserWithEmailAndPassword(auth, email, pass);
    }

    async function doLogin(){
      const email = (emailEl.value || "").trim();
      const pass = (passEl.value || "").trim();
      if(!email || !pass) return alert("è«‹è¼¸å…¥ Email + å¯†ç¢¼");
      await signInWithEmailAndPassword(auth, email, pass);
    }

    async function doLogout(){
      await signOut(auth);
    }

    btnSignUp.addEventListener("click", ()=> doSignUp().catch(err=>{
      alert("è¨»å†Šå¤±æ•—ï¼š\n" + (err?.message || err));
    }));
    btnLogin.addEventListener("click", ()=> doLogin().catch(err=>{
      alert("ç™»å…¥å¤±æ•—ï¼š\n" + (err?.message || err));
    }));
    btnLogout.addEventListener("click", ()=> doLogout().catch(err=>{
      alert("ç™»å‡ºå¤±æ•—ï¼š\n" + (err?.message || err));
    }));

    // push/pull
    async function pushToCloud(){
      if(!currentUid) return alert("è«‹å…ˆç™»å…¥");
      const ref = userDocRef(currentUid);
      const state = window.__nijiGetState ? window.__nijiGetState() : null;
      if(!state) return;

      await setDoc(ref, {
        state,
        updatedAt: serverTimestamp()
      }, { merge: true });

      window.__nijiToast && window.__nijiToast("å·²å­˜åˆ°é›²ç«¯");
    }

    async function pullFromCloud(){
      if(!currentUid) return alert("è«‹å…ˆç™»å…¥");
      const ref = userDocRef(currentUid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        alert("é›²ç«¯é‚„æ²’æœ‰è³‡æ–™ï¼ˆä½ å¯ä»¥å…ˆæŒ‰ã€å­˜åˆ°é›²ç«¯ã€ï¼‰");
        return;
      }
      const data = snap.data();
      if(data?.state){
        window.__nijiApplyRemoteState && window.__nijiApplyRemoteState(data.state);
      }
    }

    btnCloudPush.addEventListener("click", ()=> pushToCloud().catch(err=>{
      alert("å­˜åˆ°é›²ç«¯å¤±æ•—ï¼š\n" + (err?.message || err));
    }));
    btnCloudPull.addEventListener("click", ()=> pullFromCloud().catch(err=>{
      alert("è¼‰å…¥é›²ç«¯å¤±æ•—ï¼š\n" + (err?.message || err));
    }));

    // Debounced auto push (called by local app save)
    window.__cloudSchedulePush = function(){
      if(!currentUid) return;
      if(pushingTimer) clearTimeout(pushingTimer);
      pushingTimer = setTimeout(()=>{
        pushToCloud().catch(()=>{});
      }, 900);
    };

    function attachRealtimeListener(uid){
      if(unsub) unsub();
      const ref = userDocRef(uid);
      unsub = onSnapshot(ref, (snap)=>{
        if(!snap.exists()) return;
        const data = snap.data();
        const state = data?.state;
        const updatedAt = data?.updatedAt?.toMillis ? data.updatedAt.toMillis() : 0;

        // avoid applying older remote
        if(updatedAt && updatedAt <= lastRemoteUpdatedAt) return;
        lastRemoteUpdatedAt = updatedAt || Date.now();

        // apply remote state
        if(state && window.__nijiApplyRemoteState){
          window.__nijiSetApplyingRemote && window.__nijiSetApplyingRemote(true);
          window.__nijiApplyRemoteState(state);
          window.__nijiSetApplyingRemote && window.__nijiSetApplyingRemote(false);
        }
      });
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        currentUid = null;
        if(unsub){ unsub(); unsub = null; }
        setUILoggedOut();
        return;
      }
      currentUid = user.uid;
      setUILoggedIn(user);
      attachRealtimeListener(currentUid);

      // ç¬¬ä¸€æ¬¡ç™»å…¥ï¼šå¦‚æœé›²ç«¯æœ‰å°±æ‹‰ä¸‹ä¾†ï¼›æ²’æœ‰å°±æŠŠæœ¬æ©Ÿæ¨ä¸Šå»ï¼ˆé¿å…ç©ºç©ºï¼‰
      try{
        const ref = userDocRef(currentUid);
        const snap = await getDoc(ref);
        if(snap.exists() && snap.data()?.state){
          window.__nijiApplyRemoteState && window.__nijiApplyRemoteState(snap.data().state);
        }else{
          await pushToCloud();
        }
      }catch(_){}
    });

    setUILoggedOut();
  </script>
</body>
</html>

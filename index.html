<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Niji Trip Planner ğŸŒˆ</title>
  <meta name="theme-color" content="#ffcf8f"/>

  <style>
    :root{
      --bg0:#fff6e8;
      --bg1:#ffe7c2;
      --bg2:#ffd6a1;
      --card:#ffffffcc;
      --stroke:#ffffff88;
      --text:#2a2a2a;
      --muted:#6b6b6b;
      --shadow: 0 12px 30px rgba(0,0,0,.08);
      --shadow2: 0 8px 18px rgba(0,0,0,.06);
      --radius: 18px;
      --radius2: 14px;
      --focus: 0 0 0 3px rgba(255, 153, 66, .25);
      --chip:#fff;
      --chipStroke:#00000014;

      --c-spot: #ff8a65;
      --c-food: #ffb74d;
      --c-hotel:#64b5f6;
      --c-traffic:#81c784;
      --c-shop:#ba68c8;
      --c-other:#90a4ae;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, var(--bg2), transparent 55%),
                  radial-gradient(900px 700px at 80% 20%, #ffd1dc, transparent 55%),
                  radial-gradient(900px 700px at 50% 90%, #d9f7ff, transparent 55%),
                  linear-gradient(180deg, var(--bg0), #fff);
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    a{color:inherit}
    button, input, textarea, select{font:inherit}
    .wrap{max-width: 1200px; margin: 0 auto; padding: 18px 16px 28px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom: 14px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.35));
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .brand .logo{
      width:38px; height:38px; border-radius: 14px;
      background: conic-gradient(from 180deg, #ffb74d, #ff8a65, #ba68c8, #64b5f6, #81c784, #ffb74d);
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
    }
    .brand .title{line-height:1.15}
    .brand .title b{font-size:14px}
    .brand .title small{display:block; color:var(--muted); font-size:12px; margin-top:2px}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.7);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      cursor:pointer;
      transition: transform .06s ease, filter .15s ease;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn:hover{filter: brightness(1.02)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(255, 207, 143, .95), rgba(255, 207, 143, .70));
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255, 138, 101, .18), rgba(255,255,255,.65));
      border-color: rgba(255, 138, 101, .25);
    }
    .btn .icon{width:18px;height:18px; display:inline-block}
    .btn.small{padding:8px 10px; font-size:13px}

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
    }

    .panel{
      background: rgba(255,255,255,.55);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(0,0,0,.05);
      display:flex;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .panel .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .panel .hd p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:12px;
    }
    .panel .bd{padding: 12px 14px 14px}

    .field{
      display:grid;
      gap:8px;
      margin-bottom:10px;
    }
    .field label{font-size:12px; color:var(--muted)}
    .input, .textarea, .select{
      width:100%;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.82);
      border-radius: 14px;
      padding: 10px 12px;
      outline: none;
    }
    .textarea{min-height: 80px; resize: vertical}
    .input:focus, .textarea:focus, .select:focus{box-shadow: var(--focus); border-color: rgba(255,153,66,.35)}

    .row{display:flex; gap:10px; align-items:center}
    .row > *{flex:1}
    .row .fit{flex:0 0 auto}

    .days{
      display:flex; flex-direction:column; gap:10px;
      padding-bottom:8px;
    }
    .day{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 10px 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,.05);
      cursor:pointer;
      transition: transform .06s ease, background .12s ease;
    }
    .day:hover{filter: brightness(1.01)}
    .day:active{transform: translateY(1px)}
    .day.active{
      background: linear-gradient(180deg, rgba(255, 214, 161, .70), rgba(255,255,255,.80));
      border-color: rgba(255,153,66,.22);
      box-shadow: 0 14px 28px rgba(0,0,0,.08);
    }
    .day .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .day .name{
      font-weight: 700;
      font-size: 13px;
      display:flex; align-items:center; gap:8px;
      min-width: 0;
    }
    .badge{
      width:9px; height:9px; border-radius:999px; background:#ffb74d;
      box-shadow: 0 0 0 3px rgba(255,183,77,.18);
      flex: 0 0 auto;
    }
    .day .meta{color:var(--muted); font-size:12px; margin-top:6px}
    .count{
      font-size:12px; color:var(--muted);
      background: rgba(0,0,0,.04);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.04);
      flex: 0 0 auto;
    }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 12px 14px 12px;
      border-bottom: 1px solid rgba(0,0,0,.05);
      align-items:center;
      justify-content:space-between;
    }
    .toolbar .left, .toolbar .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border: 1px solid var(--chipStroke);
      background: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
      display:flex; gap:8px; align-items:center;
    }
    .chip.active{
      background: rgba(255, 214, 161, .75);
      border-color: rgba(255,153,66,.22);
    }
    .dot{width:10px;height:10px;border-radius:999px;flex:0 0 auto}
    .dot.spot{background:var(--c-spot)}
    .dot.food{background:var(--c-food)}
    .dot.hotel{background:var(--c-hotel)}
    .dot.traffic{background:var(--c-traffic)}
    .dot.shop{background:var(--c-shop)}
    .dot.other{background:var(--c-other)}

    .list{
      padding: 12px 14px 18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 220px;
    }
    .empty{
      color:var(--muted);
      font-size:13px;
      padding: 24px 14px;
      text-align:center;
      border: 1px dashed rgba(0,0,0,.12);
      border-radius: 16px;
      background: rgba(255,255,255,.55);
    }

    .item{
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
    }
    .item.dragging{opacity:.65}
    .item .main{min-width:0}
    .item .t{
      display:flex; align-items:center; gap:10px;
      font-weight: 800; font-size:14px; margin:0 0 6px;
      min-width:0;
    }
    .item .t .catPill{
      font-size:11px; font-weight:700;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.9);
      flex:0 0 auto;
    }
    .item .sub{
      display:flex; flex-wrap:wrap; gap:8px;
      color:var(--muted); font-size:12px;
    }
    .kv{
      display:inline-flex; gap:6px; align-items:center;
      padding: 6px 8px; border-radius: 999px;
      background: rgba(0,0,0,.035);
      border:1px solid rgba(0,0,0,.04);
    }
    .kv b{color:#333; font-weight:700}
    .item .notes{
      margin-top:8px;
      font-size:13px;
      line-height:1.45;
      color:#333;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .item .controls{
      display:flex; flex-direction:column; gap:8px; align-items:flex-end;
    }
    .handle{
      cursor:grab;
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.8);
      border-radius: 12px;
      padding: 8px 10px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .handle:active{cursor:grabbing}
    .miniBtns{display:flex; gap:8px}
    .mini{
      border: 1px solid rgba(0,0,0,.07);
      background: rgba(255,255,255,.8);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .mini:hover{filter:brightness(1.02)}
    .mini.danger{
      border-color: rgba(255, 138, 101, .25);
      background: rgba(255, 138, 101, .10);
    }

    dialog{
      border:none;
      border-radius: 20px;
      box-shadow: var(--shadow);
      width: min(520px, calc(100vw - 24px));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
    }
    dialog::backdrop{
      background: rgba(20,20,20,.35);
      backdrop-filter: blur(4px);
    }
    .dlgHd{
      padding: 14px 14px 0;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .dlgHd h3{margin:0; font-size:14px}
    .dlgBd{padding: 12px 14px 14px}
    .dlgFt{
      padding: 0 14px 14px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .hint{font-size:12px;color:var(--muted); margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" role="banner" aria-label="Niji Trip Planner">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Niji Trip Planner ğŸŒˆ</b>
          <small>æš–è‰²ç³»è¡Œç¨‹ç®¡ç†ï½œè‡ªå‹•ä¿å­˜ï½œæ‹–æ›³æ’åºï½œåŒ¯å‡ºå‚™ä»½</small>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnExport" title="åŒ¯å‡º JSON">
          <span class="icon" aria-hidden="true">â¤“</span><span>åŒ¯å‡º</span>
        </button>
        <button class="btn" id="btnImport" title="åŒ¯å…¥ JSON">
          <span class="icon" aria-hidden="true">â¤’</span><span>åŒ¯å…¥</span>
        </button>
        <button class="btn danger" id="btnReset" title="æ¸…ç©ºå…¨éƒ¨è³‡æ–™">
          <span class="icon" aria-hidden="true">ğŸ§¹</span><span>æ¸…ç©º</span>
        </button>
        <button class="btn primary" id="btnAddDay" title="æ–°å¢ä¸€å¤©">
          <span class="icon" aria-hidden="true">ï¼‹</span><span>æ–°å¢å¤©</span>
        </button>
      </div>
    </div>

    <div class="grid" role="main">
      <!-- Left: days -->
      <section class="panel" aria-label="å¤©æ•¸æ¸…å–®">
        <div class="hd">
          <div>
            <h2>å¤©æ•¸</h2>
            <p>é»é¸ä¸€å¤© â†’ å³å´ç®¡ç†è©²å¤©è¡Œç¨‹</p>
          </div>
          <div class="count" id="daysCount">0 å¤©</div>
        </div>
        <div class="bd">
          <div class="field">
            <label for="tripName">æ—…ç¨‹åç¨±</label>
            <input class="input" id="tripName" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ 8 å¤©è‡ªç”±è¡Œ" />
          </div>

          <div class="field">
            <label for="tripNote">æ—…ç¨‹å‚™è¨»</label>
            <textarea class="textarea" id="tripNote" placeholder="ä¾‹å¦‚ï¼šä½å®¿ã€æ›åŒ¯ã€æ³¨æ„äº‹é …..."></textarea>
          </div>

          <div class="days" id="days"></div>

          <div class="hint">
            å°æŠ€å·§ï¼šæ‹–æ›³æ’åºåªåœ¨å³å´ã€ŒåŒä¸€å¤©ã€å…§ç”Ÿæ•ˆï¼›è³‡æ–™æœƒè‡ªå‹•ä¿å­˜åˆ°æœ¬æ©Ÿã€‚
          </div>
        </div>
      </section>

      <!-- Right: items -->
      <section class="panel" aria-label="è¡Œç¨‹ç®¡ç†">
        <div class="toolbar">
          <div class="left">
            <div>
              <div style="font-weight:800; font-size:14px" id="activeDayTitle">è«‹å…ˆé¸æ“‡ä¸€å¤©</div>
              <div style="color:var(--muted); font-size:12px" id="activeDayMeta">â€”</div>
            </div>
          </div>
          <div class="right">
            <button class="btn primary" id="btnAddItem" disabled>
              <span class="icon" aria-hidden="true">ï¼‹</span><span>æ–°å¢è¡Œç¨‹</span>
            </button>
          </div>
        </div>

        <div class="toolbar" style="border-bottom: 1px solid rgba(0,0,0,.05);">
          <div class="left" style="flex:1; min-width: 240px;">
            <input class="input" id="search" placeholder="æœå°‹ï¼šæ¨™é¡Œ / åœ°é» / å‚™è¨»" disabled />
          </div>
          <div class="right chips" id="chips" aria-label="é¡åˆ¥ç¯©é¸">
            <div class="chip active" data-filter="all"><span class="dot other"></span>å…¨éƒ¨</div>
            <div class="chip" data-filter="spot"><span class="dot spot"></span>æ™¯é»</div>
            <div class="chip" data-filter="food"><span class="dot food"></span>é¤é£²</div>
            <div class="chip" data-filter="hotel"><span class="dot hotel"></span>ä½å®¿</div>
            <div class="chip" data-filter="traffic"><span class="dot traffic"></span>äº¤é€š</div>
            <div class="chip" data-filter="shop"><span class="dot shop"></span>è³¼ç‰©</div>
            <div class="chip" data-filter="other"><span class="dot other"></span>å…¶ä»–</div>
          </div>
        </div>

        <div class="list" id="list"></div>
      </section>
    </div>
  </div>

  <!-- Item Dialog -->
  <dialog id="dlgItem">
    <form method="dialog" id="itemForm">
      <div class="dlgHd">
        <h3 id="dlgTitle">æ–°å¢è¡Œç¨‹</h3>
        <button class="mini" value="cancel" aria-label="é—œé–‰">âœ•</button>
      </div>
      <div class="dlgBd">
        <input type="hidden" id="editId" />

        <div class="row">
          <div class="field">
            <label for="itemTime">æ™‚é–“</label>
            <input class="input" id="itemTime" placeholder="ä¾‹å¦‚ï¼š09:30 / æ—©ä¸Š / æ™šä¸Š" />
          </div>
          <div class="field">
            <label for="itemCat">é¡åˆ¥</label>
            <select class="select" id="itemCat">
              <option value="spot">æ™¯é»</option>
              <option value="food">é¤é£²</option>
              <option value="hotel">ä½å®¿</option>
              <option value="traffic">äº¤é€š</option>
              <option value="shop">è³¼ç‰©</option>
              <option value="other">å…¶ä»–</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="itemTitle">æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰</label>
          <input class="input" id="itemTitle" required placeholder="ä¾‹å¦‚ï¼šæ·ºè‰å¯º / è¿ªå£«å°¼ / æ©Ÿå ´åˆ°å¸‚å€" />
        </div>

        <div class="field">
          <label for="itemPlace">åœ°é» / åœ°å€ï¼ˆå¯ç©ºï¼‰</label>
          <input class="input" id="itemPlace" placeholder="ä¾‹å¦‚ï¼šAsakusa / 1 Chome-1-2 Oshiage..." />
          <div class="hint">å¡«äº†åœ°é»å°±æœƒå‡ºç¾ã€Œé–‹åœ°åœ–ã€æŒ‰éˆ•ã€‚</div>
        </div>

        <div class="field">
          <label for="itemCost">é ç®—ï¼ˆå¯ç©ºï¼‰</label>
          <input class="input" id="itemCost" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼šÂ¥1800 / NT$300 / å…" />
        </div>

        <div class="field">
          <label for="itemNote">å‚™è¨»</label>
          <textarea class="textarea" id="itemNote" placeholder="ä¾‹å¦‚ï¼šé–€ç¥¨ã€æ’éšŠã€æ³¨æ„äº‹é …ã€æƒ³è²·çš„æ±è¥¿..."></textarea>
        </div>

        <div class="hint kbd">æ‹–æ›³æ’åºï¼šåœ¨å¡ç‰‡å³å´æŠ“ä½ã€Œâ†• æ‹–æ›³ã€å³å¯ã€‚</div>
      </div>
      <div class="dlgFt">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="btnSaveItem" value="default">å„²å­˜</button>
      </div>
    </form>
  </dialog>

  <!-- Import Dialog -->
  <dialog id="dlgImport">
    <form method="dialog" id="importForm">
      <div class="dlgHd">
        <h3>åŒ¯å…¥ JSON</h3>
        <button class="mini" value="cancel" aria-label="é—œé–‰">âœ•</button>
      </div>
      <div class="dlgBd">
        <div class="field">
          <label for="importText">è²¼ä¸ŠåŒ¯å‡ºçš„ JSON</label>
          <textarea class="textarea" id="importText" placeholder="åœ¨é€™è£¡è²¼ä¸Š JSON..."></textarea>
        </div>
        <div class="hint">åŒ¯å…¥æœƒè¦†è“‹ç›®å‰è³‡æ–™ï¼ˆå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ï¼‰ã€‚</div>
      </div>
      <div class="dlgFt">
        <button class="btn" value="cancel">å–æ¶ˆ</button>
        <button class="btn primary" id="btnDoImport" value="default">ç¢ºèªåŒ¯å…¥</button>
      </div>
    </form>
  </dialog>

  <script>
    /**************
     * Data Model *
     **************/
    const STORAGE_KEY = "niji_trip_planner_v1";

    /** @type {{trip:{name:string,note:string}, days:Array<{id:string,name:string,date:string,items:Array<Item>}> , ui:{activeDayId:string|null, filter:string, search:string}}} */
    let state = loadState();

    /** @typedef {{id:string,time:string,cat:string,title:string,place:string,cost:string,note:string,createdAt:number}} Item */

    function uid(prefix="id"){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function defaultState(){
      const d1 = { id: uid("day"), name:"Day 1", date:"", items:[] };
      return {
        trip: { name: "æˆ‘çš„æ—…ç¨‹", note: "" },
        days: [d1],
        ui: { activeDayId: d1.id, filter:"all", search:"" }
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const parsed = JSON.parse(raw);
        // basic sanity
        if(!parsed || !Array.isArray(parsed.days)) return defaultState();
        if(!parsed.ui) parsed.ui = { activeDayId: parsed.days[0]?.id ?? null, filter:"all", search:"" };
        if(!parsed.trip) parsed.trip = { name:"æˆ‘çš„æ—…ç¨‹", note:"" };
        if(parsed.days.length === 0){
          const d = { id: uid("day"), name:"Day 1", date:"", items:[] };
          parsed.days = [d];
          parsed.ui.activeDayId = d.id;
        }
        return parsed;
      }catch(e){
        return defaultState();
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    /*****************
     * DOM Utilities *
     *****************/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function escapeHtml(s=""){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function catLabel(cat){
      switch(cat){
        case "spot": return "æ™¯é»";
        case "food": return "é¤é£²";
        case "hotel": return "ä½å®¿";
        case "traffic": return "äº¤é€š";
        case "shop": return "è³¼ç‰©";
        default: return "å…¶ä»–";
      }
    }

    function catDotClass(cat){
      return ["spot","food","hotel","traffic","shop","other"].includes(cat) ? cat : "other";
    }

    function buildMapUrl(place){
      const q = encodeURIComponent(place.trim());
      return "https://www.google.com/maps/search/?api=1&query=" + q;
    }

    function activeDay(){
      return state.days.find(d => d.id === state.ui.activeDayId) || null;
    }

    /***************
     * Render Days *
     ***************/
    function renderDays(){
      const daysEl = $("#days");
      daysEl.innerHTML = "";

      $("#daysCount").textContent = `${state.days.length} å¤©`;

      state.days.forEach((d, idx) => {
        const isActive = d.id === state.ui.activeDayId;
        const el = document.createElement("div");
        el.className = "day" + (isActive ? " active" : "");
        el.dataset.dayId = d.id;

        const itemCount = d.items?.length ?? 0;
        const dateText = d.date ? `ğŸ“… ${escapeHtml(d.date)}` : "ğŸ“… æœªè¨­å®šæ—¥æœŸ";
        el.innerHTML = `
          <div class="top">
            <div class="name" title="${escapeHtml(d.name)}">
              <span class="badge" aria-hidden="true"></span>
              <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(d.name || ("Day " + (idx+1)))}</span>
            </div>
            <div class="count">${itemCount} é …</div>
          </div>
          <div class="meta">${dateText}</div>
        `;
        daysEl.appendChild(el);
      });
    }

    function renderActiveDayHeader(){
      const d = activeDay();
      const hasDay = !!d;
      $("#btnAddItem").disabled = !hasDay;
      $("#search").disabled = !hasDay;

      if(!hasDay){
        $("#activeDayTitle").textContent = "è«‹å…ˆé¸æ“‡ä¸€å¤©";
        $("#activeDayMeta").textContent = "â€”";
        return;
      }
      $("#activeDayTitle").textContent = d.name || "æœªå‘½å";
      $("#activeDayMeta").textContent = d.date ? `æ—¥æœŸï¼š${d.date}` : "æ—¥æœŸï¼šæœªè¨­å®š";
    }

    /****************
     * Render Items *
     ****************/
    function itemMatches(item, filter, search){
      if(filter && filter !== "all" && item.cat !== filter) return false;
      if(search){
        const s = search.trim().toLowerCase();
        if(!s) return true;
        const hay = (item.title + " " + item.place + " " + item.note).toLowerCase();
        return hay.includes(s);
      }
      return true;
    }

    function renderItems(){
      const list = $("#list");
      const d = activeDay();
      list.innerHTML = "";

      if(!d){
        list.innerHTML = `<div class="empty">å…ˆåœ¨å·¦å´é¸ä¸€å¤©ï¼Œæˆ–æ–°å¢ä¸€å¤©é–‹å§‹è¦åŠƒã€‚</div>`;
        return;
      }

      const filter = state.ui.filter;
      const search = state.ui.search;

      const items = (d.items || []).filter(it => itemMatches(it, filter, search));

      if(items.length === 0){
        list.innerHTML = `
          <div class="empty">
            ç›®å‰æ²’æœ‰ç¬¦åˆçš„è¡Œç¨‹ã€‚<br/>
            ä½ å¯ä»¥æŒ‰å³ä¸Šè§’ã€Œæ–°å¢è¡Œç¨‹ã€é–‹å§‹åŠ å…¥ã€‚
          </div>`;
        return;
      }

      items.forEach((it) => {
        const el = document.createElement("div");
        el.className = "item";
        el.draggable = true;
        el.dataset.itemId = it.id;

        const time = it.time ? escapeHtml(it.time) : "æœªå¡«";
        const place = it.place ? escapeHtml(it.place) : "";
        const cost = it.cost ? escapeHtml(it.cost) : "";
        const note = it.note ? escapeHtml(it.note) : "";
        const showMap = !!it.place?.trim();

        el.innerHTML = `
          <div class="main">
            <div class="t">
              <span class="dot ${catDotClass(it.cat)}" aria-hidden="true"></span>
              <span style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${escapeHtml(it.title)}
              </span>
              <span class="catPill">${catLabel(it.cat)}</span>
            </div>

            <div class="sub">
              <span class="kv">ğŸ•’ <b>${time}</b></span>
              ${place ? `<span class="kv">ğŸ“ <b>${place}</b></span>` : ``}
              ${cost ? `<span class="kv">ğŸ’° <b>${cost}</b></span>` : ``}
            </div>

            ${note ? `<div class="notes">${note}</div>` : ``}
          </div>

          <div class="controls">
            <div class="handle" title="æ‹–æ›³æ’åº">â†• æ‹–æ›³</div>
            <div class="miniBtns">
              ${showMap ? `<button class="mini" data-act="map" title="ç”¨ Google Maps é–‹å•Ÿ">ğŸ—ºï¸</button>` : ``}
              <button class="mini" data-act="edit" title="ç·¨è¼¯">âœï¸</button>
              <button class="mini danger" data-act="del" title="åˆªé™¤">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;
        list.appendChild(el);
      });
    }

    /**********************
     * Init / Event Hooks *
     **********************/
    function hydrateTripFields(){
      $("#tripName").value = state.trip?.name ?? "";
      $("#tripNote").value = state.trip?.note ?? "";
    }

    function init(){
      hydrateTripFields();
      syncChipsUI();
      renderDays();
      renderActiveDayHeader();
      renderItems();
      saveState();
    }

    // Avoid re-render while typing in inputs by only saving (no DOM rebuild)
    $("#tripName").addEventListener("input", (e) => {
      state.trip.name = e.target.value;
      saveState();
    });
    $("#tripNote").addEventListener("input", (e) => {
      state.trip.note = e.target.value;
      saveState();
    });

    // Select day
    $("#days").addEventListener("click", (e) => {
      const dayEl = e.target.closest(".day");
      if(!dayEl) return;
      const id = dayEl.dataset.dayId;
      state.ui.activeDayId = id;
      saveState();
      renderDays();
      renderActiveDayHeader();
      renderItems();
    });

    // Add day
    $("#btnAddDay").addEventListener("click", () => {
      const n = state.days.length + 1;
      const d = { id: uid("day"), name: `Day ${n}`, date:"", items:[] };
      state.days.push(d);
      state.ui.activeDayId = d.id;
      saveState();
      renderDays();
      renderActiveDayHeader();
      renderItems();
    });

    // Reset
    $("#btnReset").addEventListener("click", () => {
      const ok = confirm("ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨è³‡æ–™å—ï¼Ÿï¼ˆæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ï¼‰");
      if(!ok) return;
      state = defaultState();
      saveState();
      hydrateTripFields();
      syncChipsUI(true);
      renderDays();
      renderActiveDayHeader();
      renderItems();
    });

    // Chips filter
    function syncChipsUI(reset=false){
      if(reset) state.ui.filter = "all";
      $$("#chips .chip").forEach(ch => {
        ch.classList.toggle("active", ch.dataset.filter === state.ui.filter);
      });
    }

    $("#chips").addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if(!chip) return;
      state.ui.filter = chip.dataset.filter;
      saveState();
      syncChipsUI();
      renderItems();
    });

    // Search
    $("#search").addEventListener("input", (e) => {
      state.ui.search = e.target.value;
      saveState();
      renderItems();
    });

    /*****************
     * Item Dialog   *
     *****************/
    const dlgItem = $("#dlgItem");
    const itemForm = $("#itemForm");

    function openItemDialog(mode, item=null){
      const d = activeDay();
      if(!d) return;

      $("#dlgTitle").textContent = mode === "edit" ? "ç·¨è¼¯è¡Œç¨‹" : "æ–°å¢è¡Œç¨‹";
      $("#editId").value = item?.id ?? "";
      $("#itemTime").value = item?.time ?? "";
      $("#itemCat").value = item?.cat ?? "spot";
      $("#itemTitle").value = item?.title ?? "";
      $("#itemPlace").value = item?.place ?? "";
      $("#itemCost").value = item?.cost ?? "";
      $("#itemNote").value = item?.note ?? "";

      // show modal
      dlgItem.showModal();
      // focus title for quick input (micro delay helps Android)
      setTimeout(() => $("#itemTitle").focus(), 50);
    }

    $("#btnAddItem").addEventListener("click", () => openItemDialog("add"));

    // Save item
    itemForm.addEventListener("submit", (e) => {
      e.preventDefault(); // we will close manually
      const d = activeDay();
      if(!d) return;

      const editId = $("#editId").value.trim();
      const item = {
        id: editId || uid("it"),
        time: $("#itemTime").value.trim(),
        cat: $("#itemCat").value,
        title: $("#itemTitle").value.trim(),
        place: $("#itemPlace").value.trim(),
        cost: $("#itemCost").value.trim(),
        note: $("#itemNote").value.trim(),
        createdAt: Date.now()
      };

      if(!item.title){
        alert("æ¨™é¡Œç‚ºå¿…å¡«ã€‚");
        $("#itemTitle").focus();
        return;
      }

      const idx = d.items.findIndex(x => x.id === item.id);
      if(idx >= 0){
        // keep createdAt if exists
        item.createdAt = d.items[idx].createdAt || item.createdAt;
        d.items[idx] = item;
      }else{
        d.items.push(item);
      }

      saveState();
      dlgItem.close();
      renderDays();
      renderItems();
      renderActiveDayHeader();
    });

    /*****************
     * Item Actions  *
     *****************/
    $("#list").addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;

      const act = btn.dataset.act;
      const itemEl = e.target.closest(".item");
      if(!itemEl) return;

      const d = activeDay();
      if(!d) return;

      const id = itemEl.dataset.itemId;
      const it = d.items.find(x => x.id === id);
      if(!it) return;

      if(act === "edit"){
        openItemDialog("edit", it);
      }else if(act === "del"){
        const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ");
        if(!ok) return;
        d.items = d.items.filter(x => x.id !== id);
        saveState();
        renderDays();
        renderItems();
      }else if(act === "map"){
        if(it.place?.trim()){
          window.open(buildMapUrl(it.place), "_blank", "noopener,noreferrer");
        }
      }
    });

    /*****************
     * Drag & Drop   *
     *****************/
    let dragId = null;

    $("#list").addEventListener("dragstart", (e) => {
      const itemEl = e.target.closest(".item");
      if(!itemEl) return;
      dragId = itemEl.dataset.itemId;
      itemEl.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      try{ e.dataTransfer.setData("text/plain", dragId); }catch(_){}
    });

    $("#list").addEventListener("dragend", (e) => {
      const itemEl = e.target.closest(".item");
      if(itemEl) itemEl.classList.remove("dragging");
      dragId = null;
    });

    $("#list").addEventListener("dragover", (e) => {
      e.preventDefault();
      const over = e.target.closest(".item");
      if(!over || !dragId) return;

      const d = activeDay();
      if(!d) return;

      const overId = over.dataset.itemId;
      if(overId === dragId) return;

      // Visual hint: reorder on the fly (stable + simple)
      const items = d.items;
      const from = items.findIndex(x => x.id === dragId);
      const to = items.findIndex(x => x.id === overId);
      if(from < 0 || to < 0) return;

      // move
      const [m] = items.splice(from, 1);
      items.splice(to, 0, m);

      saveState();
      renderDays();
      renderItems();
    });

    /*****************
     * Export/Import *
     *****************/
    $("#btnExport").addEventListener("click", () => {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const safeName = (state.trip?.name || "trip").replace(/[\\/:*?"<>|]+/g, "_");
      a.href = url;
      a.download = `${safeName}_backup.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    });

    const dlgImport = $("#dlgImport");
    $("#btnImport").addEventListener("click", () => {
      $("#importText").value = "";
      dlgImport.showModal();
      setTimeout(()=>$("#importText").focus(), 50);
    });

    $("#importForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const text = $("#importText").value.trim();
      if(!text){
        alert("è«‹å…ˆè²¼ä¸Š JSONã€‚");
        return;
      }
      try{
        const parsed = JSON.parse(text);
        if(!parsed || !Array.isArray(parsed.days)) throw new Error("æ ¼å¼ä¸æ­£ç¢º");
        state = parsed;
        // ensure ui
        if(!state.ui) state.ui = { activeDayId: state.days[0]?.id ?? null, filter:"all", search:"" };
        if(!state.trip) state.trip = { name:"æˆ‘çš„æ—…ç¨‹", note:"" };
        if(!state.ui.activeDayId && state.days[0]) state.ui.activeDayId = state.days[0].id;

        saveState();
        dlgImport.close();
        hydrateTripFields();
        syncChipsUI();
        $("#search").value = state.ui.search || "";
        renderDays();
        renderActiveDayHeader();
        renderItems();
      }catch(err){
        alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚");
      }
    });

    /*****************
     * Inline Day Edit (simple)
     *****************/
    // Long-press / double click to edit day name & date quickly
    $("#days").addEventListener("dblclick", (e) => {
      const dayEl = e.target.closest(".day");
      if(!dayEl) return;
      const id = dayEl.dataset.dayId;
      const d = state.days.find(x => x.id === id);
      if(!d) return;

      const newName = prompt("ä¿®æ”¹å¤©æ•¸åç¨±ï¼ˆä¾‹å¦‚ï¼šDay 2ï½œè¿ªå£«å°¼æ—¥ï¼‰", d.name || "");
      if(newName === null) return;
      d.name = newName.trim() || d.name;

      const newDate = prompt("è¨­å®šæ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2026-05-10ï¼Œå¯ç•™ç©ºï¼‰", d.date || "");
      if(newDate === null) return;
      d.date = newDate.trim();

      saveState();
      renderDays();
      renderActiveDayHeader();
    });

    // Delete day (context menu / long press)
    $("#days").addEventListener("contextmenu", (e) => {
      e.preventDefault();
      const dayEl = e.target.closest(".day");
      if(!dayEl) return;

      const id = dayEl.dataset.dayId;
      if(state.days.length <= 1){
        alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©ã€‚");
        return;
      }
      const d = state.days.find(x => x.id === id);
      const ok = confirm(`è¦åˆªé™¤ã€Œ${d?.name || "é€™ä¸€å¤©"}ã€å—ï¼Ÿï¼ˆè©²å¤©è¡Œç¨‹æœƒä¸€èµ·åˆªé™¤ï¼‰`);
      if(!ok) return;

      state.days = state.days.filter(x => x.id !== id);
      if(state.ui.activeDayId === id){
        state.ui.activeDayId = state.days[0]?.id ?? null;
      }
      saveState();
      renderDays();
      renderActiveDayHeader();
      renderItems();
    });

    // Set search input to state on init
    $("#search").value = state.ui.search || "";

    init();
  </script>
</body>
</html>

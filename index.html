<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Niji Trip 2026 ğŸŒˆ</title>
  <meta name="theme-color" content="#ffcf8f"/>

  <style>
    :root{
      --bg:#fce0b3;
      --card:#fff7e8;
      --soft:#eaf6ff;
      --chip:#fff6e5;
      --chipOn:#ffffff;

      --brown:#7a4a26;
      --brown2:#a26b3a;
      --border:rgba(186, 140, 91, 0.35);
      --shadow:0 2px 8px rgba(0,0,0,0.08);

      --r1:18px;
      --r2:24px;
      --pill:999px;

      --btn:#ffd59a;
      --btn2:#ffb85c;
      --danger:#ffb0a6;

      --focus: rgba(255,184,92,0.85);
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC",sans-serif;background:var(--bg);color:var(--brown);}
    body{min-height:100vh;}

    .page{max-width:980px;margin:0 auto;padding:14px 12px 96px;}

    header{
      background:var(--card);
      border-radius:26px;
      padding:16px 14px 14px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }

    .titleRow{display:flex;align-items:center;gap:10px;}
    .titleRow h1{margin:0;font-size:26px;font-weight:1000;letter-spacing:.02em}
    .titleRow .emoji{font-size:24px}

    .desc{margin:8px 0 10px;color:var(--brown2);line-height:1.6;font-size:14px;}
    .desc textarea{
      width:100%;
      border:1px dashed rgba(122,74,38,0.22);
      background:#fffdf6;
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      color:var(--brown);
      outline:none;
      resize:vertical;
      min-height:52px;
    }
    .desc textarea:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18);}

    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
    .btn{
      border:none;border-radius:var(--pill);
      padding:9px 14px;
      font-size:14px;
      font-weight:900;
      background:var(--btn);
      color:#5a351e;
      box-shadow:var(--shadow);
      cursor:pointer;
      white-space:nowrap;
    }
    .btn.primary{background:var(--btn2);}
    .btn.danger{background:var(--danger);color:#7a221b;}
    .btn.ghost{background:#fff3da;}
    .btn.small{padding:7px 11px;font-size:13px;box-shadow:none;}
    .btn:active{transform:translateY(1px); box-shadow:0 1px 3px rgba(0,0,0,.18);}
    .btn:disabled{opacity:.6;cursor:default;transform:none;}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:7px 11px;border-radius:var(--pill);
      background:#fff3c5;border:1px solid rgba(122,74,38,0.10);
      font-size:13px;font-weight:1000;color:#5c3a1c;
    }
    .badge.soft{background:#eaf6ff;}
    .badge.ok{background:#dff7ea;}
    .badge.warn{background:#ffb0a6;color:#7a221b;}
    .muted{color:var(--brown2);font-size:13px;line-height:1.55;}

    /* Auth */
    .auth{
      margin-top:10px;
      padding:10px;
      border-radius:18px;
      background:#fffdf6;
      border:1px dashed rgba(122,74,38,0.20);
    }
    .authGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
    @media (max-width:640px){ .authGrid{grid-template-columns:1fr;} }

    .inp{
      width:100%;
      border:none;
      background:#fff;
      border-radius:var(--pill);
      padding:12px 14px;
      font-size:14px;
      font-weight:800;
      color:#5a351e;
      box-shadow:var(--shadow);
      outline:none;
      border:1px solid rgba(122,74,38,0.10);
    }
    .inp:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18), var(--shadow);}

    /* Sticky Day Nav */
    .sticky{
      position:sticky;top:0;z-index:30;
      padding-top:10px;
      background:linear-gradient(to bottom, rgba(252,224,179,0.97), rgba(252,224,179,0.74), rgba(252,224,179,0));
      backdrop-filter: blur(6px);
    }
    .dayNav{
      background:var(--soft);
      border-radius:24px;
      padding:10px 10px;
      display:flex;gap:10px;
      overflow-x:auto;
      box-shadow:var(--shadow);
    }
    .dayChip{
      flex:0 0 auto;
      min-width:92px;
      background:var(--chip);
      border-radius:var(--r2);
      padding:8px 10px;
      box-shadow:var(--shadow);
      border:1px solid transparent;
      cursor:pointer;
      user-select:none;
    }
    .dayChip.active{background:var(--chipOn);border-color:rgba(122,74,38,0.22);}

    /* âœ… Day chip editable inputs (æ¨™è¨˜4) */
    .chipInp{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      padding:0;
      margin:0;
      font-weight:1000;
      color:var(--brown);
    }
    .chipInp.t{
      font-size:15px;
      line-height:1.15;
    }
    .chipInp.s{
      font-size:12px;
      line-height:1.15;
      color:var(--brown2);
      margin-top:2px;
      font-weight:900;
    }
    .dayChip:focus-within{
      border-color:rgba(122,74,38,0.22);
      box-shadow:0 0 0 3px rgba(255,184,92,.12), var(--shadow);
    }

    /* Day */
    .daySection{margin-top:12px;margin-bottom:16px;}
    .dayCard{
      background:var(--soft);
      border-radius:28px;
      padding:12px 12px 14px;
      box-shadow:var(--shadow);
    }
    .dayHead{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      padding:2px 6px 0;margin-bottom:8px;
    }
    .pill{
      background:#fff;border-radius:var(--pill);
      padding:8px 14px;
      box-shadow:var(--shadow);
      font-size:18px;font-weight:1000;
      color:#5c3a1c;
    }
    .pill input{
      border:none;outline:none;background:transparent;
      font-size:18px;font-weight:1000;color:#5c3a1c;min-width:120px;
    }
    .sub input{
      border:none;outline:none;background:#fff;
      border-radius:var(--pill);
      padding:9px 12px;
      box-shadow:var(--shadow);
      font-weight:800;color:var(--brown);
      min-width:min(460px, 100%);
      width: min(460px, 100%);
    }

    .meta{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      padding:0 6px 8px;
      color:var(--brown2);font-size:13px;
    }
    .meta .miniPill{
      background:#fff;border-radius:var(--pill);
      padding:7px 12px;box-shadow:var(--shadow);
      border:1px solid rgba(122,74,38,0.10);
      display:flex;gap:8px;align-items:center;
    }
    .meta .miniPill span{font-weight:1000;color:var(--brown2);font-size:12px;}
    .meta .miniPill input{
      width:110px;border:none;outline:none;background:transparent;
      font-weight:1000;color:#5c3a1c;
    }

    /* Tickets */
    .tickets{
      background:rgba(255,255,255,0.70);
      border-radius:16px;
      padding:10px 10px 8px;
      border:1px solid rgba(122,74,38,0.10);
      margin:10px 6px 0;
    }
    .ticketsHead{display:flex;justify-content:space-between;gap:10px;align-items:center;font-weight:1000;color:#5c3a1c;}
    .tickets textarea{
      width:100%;
      margin-top:8px;
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      resize:vertical;
      min-height:44px;
      color:#5c3a1c;
    }
    .tickets textarea:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18);}
    .photoStrip{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
    .thumb{
      width:66px;height:66px;border-radius:12px;object-fit:cover;
      border:1px solid rgba(122,74,38,0.12);
      box-shadow:var(--shadow);
      cursor:pointer;
    }
    .thumb:active{transform:scale(.98);}

    /* Sections */
    .sections{display:grid;grid-template-columns:1fr;gap:10px;padding:10px 6px 6px;}
    .sec{
      background:rgba(255,255,255,0.55);
      border-radius:18px;
      padding:10px 10px 12px;
      border:1px solid rgba(122,74,38,0.10);
    }
    .secHead{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;}
    .secTitle{font-weight:1000;font-size:14px;color:#5c3a1c;display:flex;align-items:center;gap:7px;}
    .dot{width:9px;height:9px;border-radius:50%;background:#ffb85c;box-shadow:var(--shadow);}
    .secActions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
    .secActions .btn{background:#ffe7bf;}

    /* Card */
    .card{
      background:var(--card);
      border-radius:var(--r1);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      margin:0 0 10px;
      position:relative;
    }
    .cardTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}

    /* âœ… æ¨™è¨˜1ï¼šé¡å‹æ”¹ä¸‹æ‹‰ */
    .typeSelect{
      font-size:12px;font-weight:1000;
      padding:6px 10px;border-radius:var(--pill);
      background:#fff3da;border:1px solid rgba(122,74,38,0.10);
      color:#5c3a1c;white-space:nowrap;
      outline:none;
      box-shadow:var(--shadow);
      cursor:pointer;
    }
    .typeSelect:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18), var(--shadow);}
    .typePill{
      display:flex;flex-direction:column;gap:6px;align-items:flex-end;
    }

    .titleInp{width:100%;border:none;outline:none;background:#fff;border-radius:14px;
      padding:10px 12px;font-size:15px;font-weight:1000;color:#5c3a1c;box-shadow:var(--shadow);
      border:1px solid rgba(122,74,38,0.10);
    }
    .titleInp:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18), var(--shadow);}

    .miniInp{
      width:100%;border:none;outline:none;background:#fff;border-radius:14px;
      padding:9px 12px;font-size:13px;font-weight:800;color:#5c3a1c;box-shadow:var(--shadow);
      border:1px solid rgba(122,74,38,0.10);
    }
    .miniInp:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18), var(--shadow);}

    .cardBtns{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 8px;}
    .locBox{
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
      padding:8px 9px;
      margin-top:8px;
    }
    .locLine{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0;}
    .locLabel{font-size:12px;font-weight:1000;color:var(--brown2);width:54px;}
    .locInp{
      flex:1 1 180px;border:none;outline:none;
      padding:9px 12px;border-radius:999px;background:#fff3da;
      font-weight:900;color:#5a351e;border:1px solid rgba(122,74,38,0.10);
    }
    .locInp:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18);}

    /* âœ… æ¨™è¨˜2ï¼šé€”ç¶“æ”¹è‡ªç”±æ–‡å­—ï¼ˆtextareaï¼‰ */
    .routeBox{
      margin-top:8px;
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fff;
      padding:8px 9px;
    }
    .routeHead{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      font-weight:1000;color:var(--brown2);font-size:12px;
    }
    .routeBox textarea{
      width:100%;
      margin-top:8px;
      border-radius:14px;
      border:1px dashed rgba(122,74,38,0.18);
      background:#fffdf6;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      resize:vertical;
      min-height:46px;
      color:#5c3a1c;
    }
    .routeBox textarea:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18);}

    .expense{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-top:10px;
      padding:8px 9px;
      border-radius:14px;
      background:#fff3da;
      border:1px solid rgba(122,74,38,0.10);
    }
    .expense .lab{font-size:12px;font-weight:1000;color:var(--brown2);}
    .expense input{
      width:130px;border:none;outline:none;background:#fff;border-radius:999px;
      padding:8px 10px;font-weight:1000;color:#5c3a1c;box-shadow:var(--shadow);
      border:1px solid rgba(122,74,38,0.10);
    }
    .expense input:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18), var(--shadow);}
    .expense .calc{font-size:12px;font-weight:1000;color:#5c3a1c;}

    /* âœ… æ¨™è¨˜3ï¼šå‚™è¨»ï¼‹åœ–ç‰‡åŒä¸€å€å¡Š + textarea è‡ªå‹•æ’é«˜ */
    .note{
      border-radius:14px;border:1px dashed var(--border);
      background:#fffdf6;
      padding:8px 9px;margin-top:10px;
    }
    .noteHead{display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:1000;color:var(--brown2);font-size:12px;}
    .note textarea{
      width:100%;
      margin-top:8px;
      border-radius:14px;
      border:1px dashed rgba(122,74,38,0.18);
      background:#fff;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      resize:none;              /* auto-grow ç”¨ */
      min-height:44px;
      color:#5c3a1c;
      overflow:hidden;          /* auto-grow ç”¨ */
    }
    .note textarea:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18);}
    .note .photoStrip{
      margin-top:8px;
      padding-top:8px;
      border-top:1px dashed rgba(122,74,38,0.16);
    }

    /* Day Note bottom */
    .dayNoteCard{
      background:var(--card);
      border-radius:var(--r1);
      padding:12px 12px 10px;
      box-shadow:var(--shadow);
      margin:12px 6px 0;
    }
    .dayNoteHead{display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:1000;}
    .dayNoteCard textarea{
      width:100%;
      margin-top:8px;
      border-radius:14px;
      border:1px dashed var(--border);
      background:#fffdf6;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      resize:vertical;
      min-height:54px;
      color:#5c3a1c;
    }
    .dayNoteCard textarea:focus{border-color:var(--focus); box-shadow:0 0 0 3px rgba(255,184,92,.18);}

    /* Modal */
    .modal{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;padding:16px;}
    .modal.show{display:flex;}
    .modalCard{width:min(900px,100%);height:min(560px,80vh);background:#fff;border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.22);overflow:hidden;display:flex;flex-direction:column;}
    .modalBar{padding:10px 12px;background:#fff3da;display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .modalBar .t{font-weight:1000;color:#5c3a1c;}
    .modalBody{flex:1;}
    .modalBody iframe{width:100%;height:100%;border:0;}

    /* Floating */
    .floating{position:fixed;right:10px;bottom:12px;z-index:60;display:flex;flex-direction:column;gap:8px;align-items:flex-end;}
    .fab{border:none;border-radius:999px;padding:10px 12px;background:#ffcf8f;box-shadow:var(--shadow);font-weight:1000;cursor:pointer;}
    .fab:disabled{opacity:.55;cursor:default;}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:70;background:rgba(90,53,30,0.92);color:#fff;padding:7px 12px;border-radius:999px;font-size:12px;opacity:0;transition:opacity .2s ease;pointer-events:none;}
    .toast.show{opacity:1;}

    /* Context menu */
    .menu{
      position:fixed;z-index:120;min-width:220px;background:#fff;border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.22);padding:8px;display:none;
    }
    .menu.show{display:block;}
    .menu .mTitle{font-size:12px;color:var(--brown2);padding:6px 8px 4px;font-weight:1000;}
    .menu button{
      width:100%;text-align:left;border:none;border-radius:12px;padding:10px 10px;
      background:#fff3da;font-weight:1000;color:#5c3a1c;cursor:pointer;margin:4px 0;
    }
    .menu button.danger{background:#ffb0a6;color:#7a221b;}
    .menu button.secondary{background:#eaf6ff;}

    /* Search */
    .search{
      margin-top:10px;padding-top:10px;border-top:1px dashed rgba(122,74,38,0.20);
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .search input{flex:1 1 220px;}
  </style>
</head>

<body>
  <div class="page" id="appRoot">
    <header>
      <div class="titleRow">
        <h1 id="appTitleText">Niji Trip 2026</h1>
        <span class="emoji">ğŸŒˆ</span>
      </div>

      <div class="desc">
        <textarea id="appDesc" placeholder="è¡Œç¨‹æè¿°ï¼ˆå¯è‡ªç”±ç·¨è¼¯ï¼‰"></textarea>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn" id="btnAddDay" type="button">ï¼‹ æ–°å¢ä¸€å¤©</button>
        <button class="btn danger" id="btnRemoveDay" type="button">ï¼ åˆªé™¤æœ€å¾Œä¸€å¤©</button>
        <button class="btn" id="btnExport" type="button">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
        <button class="btn" id="btnImport" type="button">åŒ¯å…¥å‚™ä»½</button>
        <button class="btn ghost" id="btnClear" type="button">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
        <button class="btn ghost" id="btnCloudPull" type="button">å¾é›²ç«¯è¦†è“‹è¼‰å…¥</button>
        <button class="btn ghost" id="btnCloudPush" type="button">æŠŠæœ¬æ©Ÿæ¨åˆ°é›²ç«¯</button>
        <span class="badge soft" id="syncBadge">é›¢ç·šå¯ç”¨ï¼šå·²è‡ªå‹•ä¿å­˜</span>
      </div>

      <div class="search">
        <input class="inp" id="searchInput" placeholder="ğŸ” æœå°‹ï¼šæ¨™é¡Œ/åœ°å€/å‚™è¨»/ç¥¨åˆ¸ï¼ˆæŒ‰ Enterï¼‰" />
        <button class="btn" id="btnSearch" type="button">æœå°‹</button>
        <span class="badge soft" id="searchResult">å°šæœªæœå°‹</span>
      </div>

      <div class="auth">
        <div class="row" style="justify-content:space-between;">
          <span class="badge soft" id="authStatus">å°šæœªç™»å…¥ï¼ˆå¯é›¢ç·šä½¿ç”¨ï¼‰</span>
          <span class="badge" id="cloudStatus">é›²ç«¯ï¼šæœªé€£ç·š</span>
        </div>

        <div class="authGrid" style="margin-top:10px;">
          <input class="inp" id="email" placeholder="Emailï¼ˆç™»å…¥/è¨»å†Šï¼‰" autocomplete="email" />
          <input class="inp" id="password" placeholder="Password" type="password" autocomplete="current-password" />
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnEmailSignIn" type="button">Email ç™»å…¥</button>
          <button class="btn" id="btnEmailSignUp" type="button">è¨»å†Šå¸³è™Ÿ</button>
          <button class="btn danger" id="btnSignOut" type="button" disabled>ç™»å‡º</button>
          <span class="muted" id="authHint">æç¤ºï¼šç™»å…¥å¾Œæœƒè‡ªå‹•å¾é›²ç«¯è¼‰å…¥ï¼Œä¸¦è·¨è£ç½®åŒæ­¥ã€‚</span>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        âœ… äº¤é€š/è³¼ç‰©æœƒæ–°å¢åœ¨åŸæœ¬åˆ†å€å…§ï¼ˆä¸æœƒè·³å‡ºå¦ä¸€å¼µç¨ç«‹å¡ç‰‡ï¼‰ã€‚<br>
        âœ… æ‰“å­—æ™‚ä¸æœƒå› é›²ç«¯åŒæ­¥è€Œè·³ç„¦é»ï¼ˆå·²ä¿®å¥½ï¼‰ã€‚<br>
        âœ… Day1 æ—¥æœŸå¯ç·¨è¼¯ï¼›æ–°å¢/åˆªé™¤å¤©æ•¸æœƒè‡ªå‹•æ¥çºŒæ—¥æœŸã€‚<br>
        âœ… é•·æŒ‰å¡ç‰‡å¯åˆªé™¤/è¤‡è£½/ç½®é ‚/ç§»å‹•/ä¸Šç§»ä¸‹ç§»ã€‚åœ–ç‰‡é»ä¸€ä¸‹ç›´æ¥åˆªé™¤ã€‚ä½å®¿å¡å›ºå®šï¼ˆä¸å¯åˆªï¼‰ã€‚<br>
        âœ… Day ä¸Šæ–¹ Chipï¼ˆDay 2 / 5/9ï¼‰ç¾åœ¨ä¹Ÿå¯ç›´æ¥ç·¨è¼¯æ–‡å­—ã€‚<br>
      </div>
    </header>

    <div class="sticky">
      <div class="dayNav" id="dayNav"></div>
    </div>

    <div id="daysContainer"></div>
  </div>

  <!-- modal -->
  <div class="modal" id="mapModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalBar">
        <div class="t" id="modalTitle">åœ°åœ–é è¦½</div>
        <button class="btn" id="btnCloseModal" type="button">é—œé–‰</button>
      </div>
      <div class="modalBody">
        <iframe id="modalFrame" title="map"></iframe>
      </div>
    </div>
  </div>

  <!-- context menu -->
  <div class="menu" id="ctxMenu">
    <div class="mTitle" id="ctxTitle">å¡ç‰‡æ“ä½œ</div>
    <button id="mUp" class="secondary" type="button">â¬† ä¸Šç§»</button>
    <button id="mDown" class="secondary" type="button">â¬‡ ä¸‹ç§»</button>
    <button id="mCopy" type="button">ğŸ“„ è¤‡è£½æ­¤å¡ç‰‡</button>
    <button id="mPin" type="button">ğŸ“Œ ç½®é ‚ï¼ˆæœ¬åˆ†å€ï¼‰</button>
    <button id="mMove" type="button">â¡ï¸ ç§»åˆ°å…¶ä»–å¤©/åˆ†å€â€¦</button>
    <button id="mDelete" class="danger" type="button">ğŸ—‘ï¸ åˆªé™¤</button>
  </div>

  <!-- floating -->
  <div class="floating">
    <button class="fab" id="btnUndo" type="button" disabled>â†© Undo</button>
    <button class="fab" id="btnJumpActive" type="button">â¬† å›åˆ°ç›®å‰ Day</button>
  </div>
  <div class="toast" id="saveToast">å·²å„²å­˜</div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />
  <input type="file" id="photoPicker" accept="image/*" style="display:none" />

<script>
(() => {
  /* =========================
     Config
  ========================== */
  const STORAGE_KEY = "niji_trip_2026_A_v5_mark_1234";
  const UNDO_LIMIT = 10;
  const TRIP_ID = "main";

  // âœ… é—œéµï¼šé›²ç«¯å„²å­˜å»¶é²ï¼ˆé¿å…æ¯æ‰“ 1 å­—å°±ä¸Šé›²ï¼‰
  const CLOUD_SAVE_DEBOUNCE_MS = 1500;
  // âœ… é—œéµï¼šè¼¸å…¥å¾Œå¤šä¹…ç®—ã€Œé‚„åœ¨æ‰“å­—ä¸­ã€
  const TYPING_GRACE_MS = 1200;

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  /* =========================
     UI helpers
  ========================== */
  function toast(msg="å·²å„²å­˜"){
    const t = $("#saveToast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 650);
  }
  function setSyncBadge(text){
    $("#syncBadge").textContent = text;
  }
  function setCloudStatus(text, kind="soft"){
    const el = $("#cloudStatus");
    el.textContent = text;
    el.classList.remove("ok","warn","soft");
    el.classList.add(kind);
  }
  function setAuthStatus(text){
    $("#authStatus").textContent = text;
  }

  function autoGrow(ta){
    if (!ta) return;
    ta.style.height = "auto";
    ta.style.height = Math.max(ta.scrollHeight, 44) + "px";
  }

  /* =========================
     State
  ========================== */
  let state = null;
  let undoStack = [];
  let activeDayId = null;

  // âœ… æ‰“å­—/ç„¦é»ä¿è­·
  let lastTypingAt = 0;
  let pendingRemote = null;
  let applyingRemote = false;

  function isEditingNow(){
    const ae = document.activeElement;
    if (!ae) return false;
    const tag = (ae.tagName||"").toLowerCase();
    const editable = tag==="input" || tag==="textarea" || ae.isContentEditable;
    if (!editable) return false;
    if (!$("#appRoot").contains(ae)) return false;
    return (Date.now() - lastTypingAt) < TYPING_GRACE_MS;
  }

  function markTyping(){
    lastTypingAt = Date.now();
  }

  function defaultState(){
    return {
      settings:{
        year: 2026,
        rate: 0.22,
        hotelName: "VESSEL INN ä¸Šé‡å…¥è°·ç«™ é£¯åº—",
        hotelNameJP: "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰",
      },
      appTitle: "Niji Trip 2026",
      appDesc: "æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚æ”¯æ´æ‹–æ‹‰æ’åºã€å¡ç‰‡æ¨¡æ¿ã€å¤šåœ°é»è·¯ç·šã€ä¸€éµå°èˆªã€åœ–ç‰‡/ç¥¨åˆ¸æ”¶ç´ã€æ—¥å¹£æ›ç®—ã€é ç®—æé†’ã€æœå°‹ã€Undoï¼ˆ10æ­¥ï¼‰ã€‚",
      days: []
    };
  }

  function newCard(type="spot"){
    return {
      id: `c_${Date.now()}_${Math.random().toString(16).slice(2)}`,
      type, // spot/restaurant/transport/shopping/lodging
      title: type==="lodging" ? `ä½å®¿ï¼š${state?.settings?.hotelName||"ä½å®¿"}`
            : type==="restaurant" ? "æ–°é¤å»³"
            : type==="transport" ? "æ–°äº¤é€š"
            : type==="shopping" ? "æ–°è³¼ç‰©"
            : "æ–°æ™¯é»",
      ja: "",
      meta: "",
      origin: "",
      destination: "",
      // âœ… v5ï¼šé€”ç¶“æ”¹è‡ªç”±æ–‡å­—
      routeText: "",
      note: "",
      photos: [],
      jpy: "",
      twd: "",
      pinned: (type==="lodging")
    };
  }

  function newDay(i){
    const d = {
      id: `d_${Date.now()}_${Math.random().toString(16).slice(2)}`,
      autoDayLabel: true,
      dayLabel: `Day ${i}`,
      subtitle: i===1 ? "ï¼ˆç¯„ä¾‹ï¼‰æˆç”°æ©Ÿå ´ãƒ»å…¥ä½ä¸Šé‡" : "ï¼ˆå¯ç·¨è¼¯ï¼šä»Šå¤©ä¸»é¡Œï¼‰",
      dateText: i===1 ? "5/8" : "",
      budgetJPY: "",
      tickets: { text:"", photos:[] },
      sections: { morning:[], afternoon:[], night:[] },
      dayNote: { text:"", photos:[] }
    };
    const lod = newCard("lodging");
    lod.meta = "ä½å®¿åœ°é»ï¼ˆå›ºå®šåœ¨ç•¶æ—¥å‚™è¨»ä¸Šæ–¹ï¼‰";
    d.sections.night.push(lod);
    return d;
  }

  /* =========================
     Local Storage + Undo
  ========================== */
  function pushUndo(){
    const snap = JSON.stringify(state);
    undoStack.push(snap);
    if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    $("#btnUndo").disabled = undoStack.length <= 1;
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }

  function saveLocal(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){
      console.warn("local save failed", e);
    }
  }

  function clearLocal(){
    localStorage.removeItem(STORAGE_KEY);
  }

  /* =========================
     Date helpers
  ========================== */
  function parseMD(s){
    const m = String(s||"").match(/(\d{1,2})\s*\/\s*(\d{1,2})/);
    if (!m) return null;
    const mm = parseInt(m[1],10), dd = parseInt(m[2],10);
    if (!mm || !dd) return null;
    return { mm, dd };
  }
  function toMD(dateObj){
    const mm = dateObj.getMonth()+1;
    const dd = dateObj.getDate();
    return `${mm}/${dd}`;
  }
  function ensureDatesFromDay1(){
    if (!state.days?.length) return;
    const first = state.days[0];
    const md = parseMD(first.dateText);
    let base = md ? new Date(state.settings.year, md.mm-1, md.dd) : new Date(state.settings.year, 4, 8);
    state.days.forEach((d, idx) => {
      const dt = new Date(base);
      dt.setDate(dt.getDate() + idx);
      d.dateText = toMD(dt);
      if (d.autoDayLabel) d.dayLabel = `Day ${idx+1}`;
    });
  }

  /* =========================
     Cloud
  ========================== */
  let cloud = {
    user:null,
    uid:null,
    unsub:null,
    autoLoaded:false,
  };

  function canCloud(){
    return !!window.CloudSync && !!cloud.uid;
  }

  async function cloudLoad(overwrite=true){
    if (!canCloud()) return false;
    try{
      setCloudStatus("é›²ç«¯ï¼šè¼‰å…¥ä¸­â€¦", "soft");
      const remote = await window.CloudSync.load(cloud.uid, TRIP_ID);
      if (remote && typeof remote === "object"){
        if (overwrite){
          state = remote;
          normalizeState();
          pushUndo();
          saveLocal();
          render(true);
          toast("å·²å¾é›²ç«¯è¼‰å…¥");
        }
        setCloudStatus("é›²ç«¯ï¼šå·²é€£ç·š âœ…", "ok");
        return true;
      }else{
        setCloudStatus("é›²ç«¯ï¼šå°šç„¡è³‡æ–™", "soft");
        return false;
      }
    }catch(e){
      console.warn("cloud load failed", e);
      setCloudStatus("é›²ç«¯ï¼šè¼‰å…¥å¤±æ•— âŒ", "warn");
      return false;
    }
  }

  let cloudSaveTimer = null;
  function cloudSaveDebounced(){
    if (!canCloud()) return;
    if (applyingRemote) return;

    clearTimeout(cloudSaveTimer);
    cloudSaveTimer = setTimeout(async () => {
      try{
        await window.CloudSync.save(cloud.uid, TRIP_ID, state);
        setCloudStatus("é›²ç«¯ï¼šå·²åŒæ­¥ âœ…", "ok");
      }catch(e){
        console.warn("cloud save failed", e);
        setCloudStatus("é›²ç«¯ï¼šåŒæ­¥å¤±æ•— âŒ", "warn");
      }
    }, CLOUD_SAVE_DEBOUNCE_MS);
  }

  function cloudSubscribe(){
    if (!canCloud()) return;
    if (cloud.unsub) cloud.unsub();

    cloud.unsub = window.CloudSync.subscribe(cloud.uid, TRIP_ID, (remote) => {
      if (!remote) return;
      const remoteStr = JSON.stringify(remote);
      const localStr  = JSON.stringify(state);
      if (remoteStr === localStr) return;

      if (isEditingNow()){
        pendingRemote = remote;
        setCloudStatus("é›²ç«¯ï¼šæœ‰æ›´æ–°ï¼ˆä½ åœ¨ç·¨è¼¯ä¸­ï¼Œç¨å¾Œå¥—ç”¨ï¼‰", "soft");
        return;
      }

      applyRemoteNow(remote);
    });
  }

  function applyRemoteNow(remote){
    applyingRemote = true;
    try{
      state = remote;
      normalizeState();
      saveLocal();
      render(true);
      toast("å·²åŒæ­¥é›²ç«¯è®Šæ›´");
      setCloudStatus("é›²ç«¯ï¼šå·²é€£ç·š âœ…", "ok");
    }finally{
      applyingRemote = false;
      pendingRemote = null;
    }
  }

  function maybeApplyPendingRemote(){
    if (!pendingRemote) return;
    if (isEditingNow()) return;
    applyRemoteNow(pendingRemote);
  }

  document.addEventListener("focusout", () => {
    setTimeout(maybeApplyPendingRemote, 60);
  });

  async function autoLoadFromCloudOnce(){
    if (!canCloud()) return;
    if (cloud.autoLoaded) return;
    cloud.autoLoaded = true;

    await cloudLoad(true);
    cloudSubscribe();
  }

  /* =========================
     Normalize
  ========================== */
  function normalizeState(){
    if (!state) state = defaultState();
    if (!state.settings) state.settings = defaultState().settings;
    if (!state.settings.year) state.settings.year = 2026;
    if (!state.settings.rate) state.settings.rate = 0.22;
    if (!state.settings.hotelName) state.settings.hotelName = "VESSEL INN ä¸Šé‡å…¥è°·ç«™ é£¯åº—";
    if (!state.settings.hotelNameJP) state.settings.hotelNameJP = "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰";
    if (!Array.isArray(state.days)) state.days = [];
    if (!state.appTitle) state.appTitle = "Niji Trip 2026";
    if (typeof state.appDesc !== "string") state.appDesc = "";

    state.days.forEach((d, idx) => {
      if (!d.sections){
        d.sections = { morning:[], afternoon:[], night:[] };
      }else{
        if (d.sections.noon && !d.sections.afternoon){
          d.sections.afternoon = d.sections.noon;
          delete d.sections.noon;
        }
        if (d.sections.transport){
          d.sections.afternoon = (d.sections.afternoon||[]).concat(d.sections.transport);
          delete d.sections.transport;
        }
        if (d.sections.shopping){
          d.sections.afternoon = (d.sections.afternoon||[]).concat(d.sections.shopping);
          delete d.sections.shopping;
        }
        if (!d.sections.morning) d.sections.morning = [];
        if (!d.sections.afternoon) d.sections.afternoon = [];
        if (!d.sections.night) d.sections.night = [];
      }

      if (!d.tickets) d.tickets = { text:"", photos:[] };
      if (!d.dayNote) d.dayNote = { text:"", photos:[] };
      if (!d.dateText) d.dateText = idx===0 ? "5/8" : "";
      if (!d.dayLabel) d.dayLabel = `Day ${idx+1}`;
      if (typeof d.autoDayLabel !== "boolean") d.autoDayLabel = true;

      // âœ… Card normalize (v5: routeText)
      ["morning","afternoon","night"].forEach(k=>{
        (d.sections[k]||[]).forEach(c=>{
          if (!c) return;
          if (!c.type) c.type = "spot";
          if (!("routeText" in c)){
            c.routeText = "";
          }
          // èˆŠç‰ˆ vias â†’ routeTextï¼ˆä¿ç•™æ–‡å­—ï¼‰
          if (Array.isArray(c.vias) && c.vias.length && (!c.routeText || !String(c.routeText).trim())){
            c.routeText = c.vias.map(x=>String(x||"").trim()).filter(Boolean).join("\n");
          }
          // æ¸…æ‰èˆŠæ¬„ä½ï¼Œé¿å…ç¹¼çºŒè¢«å°èˆªç”¨åˆ°
          if ("vias" in c) delete c.vias;

          if (!Array.isArray(c.photos)) c.photos = [];
        });
      });

      // Ensure lodging exists in night section, last
      const night = d.sections.night;
      const lodIdx = night.findIndex(c=>c && c.type==="lodging");
      if (lodIdx < 0){
        const lod = newCard("lodging");
        lod.meta = "ä½å®¿åœ°é»ï¼ˆå›ºå®šåœ¨ç•¶æ—¥å‚™è¨»ä¸Šæ–¹ï¼‰";
        night.push(lod);
      }
      const lodIdx2 = night.findIndex(c=>c && c.type==="lodging");
      if (lodIdx2 >= 0 && lodIdx2 !== night.length-1){
        const [lod] = night.splice(lodIdx2,1);
        night.push(lod);
      }
    });

    if (!state.days.length){
      state.days = [newDay(1), newDay(2), newDay(3)];
      ensureDatesFromDay1();
    }else{
      ensureDatesFromDay1();
    }
  }

  /* =========================
     Focus/Caret preserve (for render(true))
  ========================== */
  function captureFocus(){
    const ae = document.activeElement;
    if (!ae) return null;
    const tag = (ae.tagName||"").toLowerCase();
    if (!(tag==="input" || tag==="textarea" || tag==="select")) return null;
    if (!$("#appRoot").contains(ae)) return null;

    const info = {
      tag,
      id: ae.id || "",
      cls: ae.className || "",
      dataDay: ae.closest(".daySection")?.dataset?.id || "",
      dataCard: ae.closest(".card")?.dataset?.cardId || "",
      dataSec: ae.closest(".card")?.dataset?.secKey || "",
      selStart: (typeof ae.selectionStart==="number") ? ae.selectionStart : null,
      selEnd: (typeof ae.selectionEnd==="number") ? ae.selectionEnd : null,
      value: (tag==="select") ? ae.value : null
    };
    return info;
  }

  function restoreFocus(info){
    if (!info) return;
    let el = null;

    if (info.id) el = document.getElementById(info.id);

    if (!el && info.dataDay && info.dataCard){
      const daySec = document.querySelector(`.daySection[data-id="${info.dataDay}"]`);
      if (daySec){
        const card = daySec.querySelector(`.card[data-card-id="${info.dataCard}"]`);
        if (card){
          const clsSel = info.cls ? `.${info.cls.split(" ").filter(Boolean).join(".")}` : null;
          if (clsSel) el = card.querySelector(clsSel);
        }
      }
    }

    if (!el && info.dataDay){
      const daySec = document.querySelector(`.daySection[data-id="${info.dataDay}"]`);
      if (daySec){
        const clsSel = info.cls ? `.${info.cls.split(" ").filter(Boolean).join(".")}` : null;
        if (clsSel) el = daySec.querySelector(clsSel);
      }
    }

    if (!el) return;
    if (typeof el.focus === "function") el.focus({preventScroll:true});
    if (info.tag==="select" && info.value!=null) el.value = info.value;
    if (info.selStart!=null && typeof el.setSelectionRange==="function"){
      try{ el.setSelectionRange(info.selStart, info.selEnd ?? info.selStart); }catch(e){}
    }
  }

  /* =========================
     Save scheduling
  ========================== */
  let saveTimer = null;
  function scheduleSave(){
    markTyping();
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      saveLocal();
      pushUndo();
      recalcTotalsUI();
      setSyncBadge(buildTotalText());
      toast("å·²å„²å­˜");
      cloudSaveDebounced();
      setTimeout(maybeApplyPendingRemote, 20);
    }, 220);
  }

  /* =========================
     Rendering
  ========================== */
  function render(full=false){
    const focusInfo = captureFocus();

    $("#appTitleText").textContent = state.appTitle || "Niji Trip 2026";
    $("#appDesc").value = state.appDesc || "";

    renderDayNav();
    renderDays();

    if (!activeDayId && state.days[0]) activeDayId = state.days[0].id;
    setActiveChip(activeDayId);

    setSyncBadge(buildTotalText());
    recalcTotalsUI();

    restoreFocus(focusInfo);
  }

  /* âœ… æ¨™è¨˜4ï¼šday chip å…§å¯ç·¨è¼¯ */
  function renderDayNav(){
    const nav = $("#dayNav");
    nav.innerHTML = "";

    state.days.forEach((d, idx) => {
      const chip = document.createElement("div");
      chip.className = "dayChip";
      chip.dataset.id = d.id;

      chip.innerHTML = `
        <input class="chipInp t" data-kind="label" value="" />
        <input class="chipInp s" data-kind="date" value="" inputmode="numeric" placeholder="5/8" />
      `;

      const inpLabel = chip.querySelector('[data-kind="label"]');
      const inpDate  = chip.querySelector('[data-kind="date"]');

      inpLabel.value = d.dayLabel || `Day ${idx+1}`;
      inpDate.value  = d.dateText || "";

      // é» chipï¼ˆéè¼¸å…¥ï¼‰ï¼è·³è½‰
      chip.addEventListener("click", (e) => {
        if (e.target === inpLabel || e.target === inpDate) return;
        activeDayId = d.id;
        setActiveChip(d.id);
        const sec = document.querySelector(`.daySection[data-id="${d.id}"]`);
        if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
      });

      // é˜²æ­¢é» input ä¹Ÿè§¸ç™¼ chip click
      [inpLabel, inpDate].forEach(inp=>{
        inp.addEventListener("click", (e)=>e.stopPropagation());
        inp.addEventListener("focus", (e)=>{ e.stopPropagation(); markTyping(); });
      });

      inpLabel.addEventListener("input", () => {
        d.dayLabel = inpLabel.value.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;

        // åŒæ­¥åˆ° Day å…§å®¹å€çš„ dayLabelInpï¼ˆä¸ rerenderï¼‰
        const daySec = document.querySelector(`.daySection[data-id="${d.id}"]`);
        const dl = daySec?.querySelector(".dayLabelInp");
        if (dl) dl.value = d.dayLabel;

        scheduleSave();
      });

      inpDate.addEventListener("change", () => {
        d.dateText = inpDate.value.trim() || d.dateText;

        const dayIndex = state.days.findIndex(x=>x.id===d.id);
        if (dayIndex === 0){
          ensureDatesFromDay1();
          scheduleSave();
          render(true);
        }else{
          // åŒæ­¥åˆ° Day å…§å®¹å€ dateInp
          const daySec = document.querySelector(`.daySection[data-id="${d.id}"]`);
          const di = daySec?.querySelector(".dateInp");
          if (di) di.value = d.dateText;
          scheduleSave();
        }
      });

      nav.appendChild(chip);
    });
  }

  function setActiveChip(id){
    $$(".dayChip").forEach(c=>c.classList.toggle("active", c.dataset.id===id));
  }

  function dotColor(key){
    if (key==="morning") return "#ffb85c";
    if (key==="afternoon") return "#ffd59a";
    return "#a9e2ff";
  }
  function secLabel(key){
    return key==="morning" ? "â˜€ï¸ æ—©ä¸Š" : key==="afternoon" ? "ğŸŒ¤ï¸ ä¸‹åˆ" : "ğŸŒ™ æ™šä¸Š";
  }

  function renderDays(){
    const wrap = $("#daysContainer");
    wrap.innerHTML = "";

    state.days.forEach((d, idx) => {
      const sec = document.createElement("section");
      sec.className = "daySection";
      sec.dataset.id = d.id;

      sec.innerHTML = `
        <div class="dayCard">
          <div class="dayHead">
            <div class="pill"><input class="dayLabelInp" /></div>
            <div class="sub"><input class="daySubInp" /></div>
          </div>

          <div class="meta">
            <div class="miniPill" title="Day1 æ—¥æœŸå¯æ”¹ï¼Œæœƒè‡ªå‹•å»¶ä¼¸å¾ŒçºŒæ—¥æœŸ">
              <span>æ—¥æœŸ</span>
              <input class="dateInp" inputmode="numeric" placeholder="ä¾‹å¦‚ 5/8" />
            </div>

            <div class="miniPill" title="ç•¶å¤©é ç®—ï¼ˆJPYï¼‰ï¼Œè¶…éæœƒæé†’">
              <span>é ç®—JPY</span>
              <input class="budgetInp" inputmode="numeric" placeholder="ä¾‹å¦‚ 12000" />
            </div>

            <div class="miniPill" title="åŒ¯ç‡è¨­å®šï¼ˆ1 JPY = ? TWDï¼‰">
              <span>åŒ¯ç‡</span>
              <input class="rateInp" inputmode="decimal" />
            </div>

            <span class="badge soft dayTotalBadge">ç•¶æ—¥åˆè¨ˆï¼š0 JPY / 0 TWD</span>
            <button class="btn small btnDayRoute" type="button">ğŸ§­ ç•¶å¤©è·¯ç·šç¸½è¦½</button>
          </div>

          <div class="tickets">
            <div class="ticketsHead">
              <div>ğŸ« ç¥¨åˆ¸ / QR æ”¶ç´ï¼ˆå¯è²¼æ–‡å­—ï¼‹åŠ åœ–ç‰‡ï¼‰</div>
              <button class="btn small btnTicketPhoto" type="button">ğŸ“· åŠ åœ–ç‰‡</button>
            </div>
            <textarea class="ticketText" placeholder="ï¼ˆå¯æ”¾ç¥¨åˆ¸/QR/è¨‚ä½è³‡è¨Šï¼‰"></textarea>
            <div class="photoStrip ticketPhotos"></div>
          </div>

          <div class="sections">
            ${renderSectionHTML("morning")}
            ${renderSectionHTML("afternoon")}
            ${renderSectionHTML("night")}
          </div>

          <div class="dayNoteCard">
            <div class="dayNoteHead">
              <div>ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»ï¼ˆå›ºå®šåœ¨æœ€ä¸‹æ–¹ï¼‰</div>
              <button class="btn small btnDayNotePhoto" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
            </div>
            <textarea class="dayNoteText" placeholder="ä¾‹ï¼šé¤é£² xxxã€äº¤é€š xxxã€è³¼ç‰© xxxã€å¿ƒå¾—â€¦"></textarea>
            <div class="photoStrip dayNotePhotos"></div>
          </div>
        </div>
      `;

      // bind day header inputs (NO rerender while typing)
      const dayLabelInp = sec.querySelector(".dayLabelInp");
      dayLabelInp.value = d.dayLabel || `Day ${idx+1}`;
      dayLabelInp.addEventListener("input", () => {
        d.dayLabel = dayLabelInp.value.trim() || `Day ${idx+1}`;
        d.autoDayLabel = false;

        // åŒæ­¥ä¸Šæ–¹ chip labelï¼ˆä¸ rerenderï¼‰
        const chip = document.querySelector(`.dayChip[data-id="${d.id}"] [data-kind="label"]`);
        if (chip) chip.value = d.dayLabel;

        scheduleSave();
      });

      const daySubInp = sec.querySelector(".daySubInp");
      daySubInp.value = d.subtitle || "";
      daySubInp.addEventListener("input", () => {
        d.subtitle = daySubInp.value;
        scheduleSave();
      });

      const dateInp = sec.querySelector(".dateInp");
      dateInp.value = d.dateText || "";
      dateInp.addEventListener("change", () => {
        d.dateText = dateInp.value.trim() || d.dateText;

        // åŒæ­¥ä¸Šæ–¹ chip dateï¼ˆä¸ rerenderï¼‰
        const chipD = document.querySelector(`.dayChip[data-id="${d.id}"] [data-kind="date"]`);
        if (chipD) chipD.value = d.dateText;

        if (idx===0){
          ensureDatesFromDay1();
          scheduleSave();
          render(true);
        }else{
          scheduleSave();
        }
      });

      const budgetInp = sec.querySelector(".budgetInp");
      budgetInp.value = d.budgetJPY || "";
      budgetInp.addEventListener("input", () => {
        d.budgetJPY = budgetInp.value;
        scheduleSave();
      });

      const rateInp = sec.querySelector(".rateInp");
      rateInp.value = String(state.settings.rate ?? 0.22);
      rateInp.addEventListener("input", () => {
        const v = parseFloat(rateInp.value);
        if (!isNaN(v) && v>0){
          state.settings.rate = v;
          scheduleSave();
        }
      });

      // tickets
      const ticketText = sec.querySelector(".ticketText");
      ticketText.value = d.tickets?.text || "";
      ticketText.addEventListener("input", () => {
        d.tickets.text = ticketText.value;
        scheduleSave();
      });

      const ticketPhotos = sec.querySelector(".ticketPhotos");
      renderPhotoStrip(ticketPhotos, d.tickets.photos, () => scheduleSave());

      sec.querySelector(".btnTicketPhoto").addEventListener("click", async () => {
        const url = await pickPhoto();
        if (!url) return;
        d.tickets.photos.push(url);
        renderPhotoStrip(ticketPhotos, d.tickets.photos, () => scheduleSave());
        scheduleSave();
      });

      // day note
      const dayNoteText = sec.querySelector(".dayNoteText");
      dayNoteText.value = d.dayNote?.text || "";
      dayNoteText.addEventListener("input", () => {
        d.dayNote.text = dayNoteText.value;
        scheduleSave();
      });

      const dayNotePhotos = sec.querySelector(".dayNotePhotos");
      renderPhotoStrip(dayNotePhotos, d.dayNote.photos, () => scheduleSave());
      sec.querySelector(".btnDayNotePhoto").addEventListener("click", async () => {
        const url = await pickPhoto();
        if (!url) return;
        d.dayNote.photos.push(url);
        renderPhotoStrip(dayNotePhotos, d.dayNote.photos, () => scheduleSave());
        scheduleSave();
      });

      // route overview
      sec.querySelector(".btnDayRoute").addEventListener("click", () => openDayRoute(d));

      // render cards for each section
      ["morning","afternoon","night"].forEach(key=>{
        const body = sec.querySelector(`.sec[data-sec="${key}"] .secBody`);
        body.innerHTML = "";

        // ensure lodging last in night
        if (key==="night"){
          const list = d.sections.night || [];
          const lodIdx = list.findIndex(c=>c.type==="lodging");
          if (lodIdx >= 0 && lodIdx !== list.length-1){
            const [lod] = list.splice(lodIdx,1);
            list.push(lod);
          }
        }
        (d.sections[key]||[]).forEach(card => body.appendChild(renderCard(card, d, key)));
      });

      // add buttons
      $$("[data-add]", sec).forEach(btn=>{
        btn.addEventListener("click", () => {
          const secKey = btn.dataset.add;
          const type = btn.dataset.type;
          addCard(d.id, secKey, type);
        });
      });

      wrap.appendChild(sec);
    });
  }

  function renderSectionHTML(key){
    return `
      <div class="sec" data-sec="${key}">
        <div class="secHead">
          <div class="secTitle">
            <span class="dot" style="background:${dotColor(key)}"></span>
            <span>${secLabel(key)}</span>
          </div>
          <div class="secActions">
            <button class="btn small" data-add="${key}" data-type="spot" type="button">ï¼‹ æ™¯é»</button>
            <button class="btn small" data-add="${key}" data-type="restaurant" type="button">ï¼‹ é¤å»³</button>
            <button class="btn small" data-add="${key}" data-type="transport" type="button">ï¼‹ äº¤é€š</button>
            <button class="btn small" data-add="${key}" data-type="shopping" type="button">ï¼‹ è³¼ç‰©</button>
          </div>
        </div>
        <div class="secBody"></div>
      </div>
    `;
  }

  function typeLabel(t){
    return t==="restaurant" ? "é¤å»³" : t==="transport" ? "äº¤é€š" : t==="shopping" ? "è³¼ç‰©" : t==="lodging" ? "ä½å®¿" : "æ™¯é»";
  }

  function typeOptionsHTML(current){
    const opts = [
      {v:"spot", t:"æ™¯é»"},
      {v:"restaurant", t:"é¤å»³"},
      {v:"transport", t:"äº¤é€š"},
      {v:"shopping", t:"è³¼ç‰©"},
    ];
    return opts.map(o=>`<option value="${o.v}" ${o.v===current?"selected":""}>${o.t}</option>`).join("");
  }

  function renderCard(card, dayObj, secKey){
    const el = document.createElement("article");
    el.className = "card";
    el.dataset.cardId = card.id;
    el.dataset.dayId = dayObj.id;
    el.dataset.secKey = secKey;

    const isLodging = card.type==="lodging";

    el.innerHTML = `
      <div class="cardTop">
        <div style="flex:1;min-width:0;display:flex;flex-direction:column;gap:8px;">
          <input class="titleInp" placeholder="æ¨™é¡Œï¼ˆä¾‹å¦‚ï¼šMILK SHOP LUCK é…ª ç§‹è‘‰åŸåº—ï¼‰" />
          <input class="miniInp jaInp" placeholder="æ—¥æ–‡åç¨± / åœ°å€ï¼ˆå»ºè­°å¡«æ—¥æ–‡æˆ–åœ°å€ï¼‰" />
          <input class="miniInp metaInp" placeholder="åœ°å€ãƒ»èªªæ˜ï¼ˆä¾‹å¦‚ï¼šç§‹è‘‰åŸã€æ³¨æ„äº‹é …â€¦ï¼‰" />
        </div>
        <div class="typePill">
          ${
            isLodging
              ? `<span class="badge soft">ä½å®¿å¡</span>`
              : `<select class="typeSelect" title="é¡å‹ï¼ˆå¯åˆ‡æ›ï¼‰">${typeOptionsHTML(card.type)}</select>`
          }
        </div>
      </div>

      <div class="cardBtns">
        <button class="btn small btnPreview" type="button">åœ°åœ–é è¦½</button>
        <button class="btn small btnSearch" type="button">åœ¨åœ°åœ–ä¸Šæœå°‹</button>
        <button class="btn small btnRoute" type="button">ä¸€éµå°èˆªè·¯ç·š</button>
        <button class="btn small btnNearby" type="button">é™„è¿‘æœå°‹</button>
      </div>

      <div class="locBox">
        <div class="locLine">
          <div class="locLabel">å‡ºç™¼</div>
          <input class="locInp originInp" placeholder="å‡ºç™¼åœ°ï¼ˆå¯ç©ºï¼‰" />
        </div>
        <div class="locLine">
          <div class="locLabel">ç›®çš„</div>
          <input class="locInp destInp" placeholder="ç›®çš„åœ° / åœ°å€ï¼ˆå»ºè­°å¡«æ—¥æ–‡æˆ–åœ°å€ï¼‰" />
        </div>

        <div class="routeBox">
          <div class="routeHead">
            <span>é€”ç¶“ / è·¯ç·šç­†è¨˜ï¼ˆè‡ªç”±è¼¸å…¥ï¼‰</span>
            <span class="muted" style="font-size:12px;">ä¾‹ï¼šå…¥è°· â†’ ç§‹è‘‰åŸ â†’ ä¸Šé‡</span>
          </div>
          <textarea class="routeText" placeholder="å¯å¯«ï¼šèµ°æ³•ã€è½‰ä¹˜ã€è¦æ­å“ªæ¢ç·šã€å‚™é¸è·¯ç·šâ€¦"></textarea>
        </div>
      </div>

      <div class="expense">
        <span class="lab">èŠ±è²» JPY</span>
        <input class="jpyInp" inputmode="numeric" placeholder="ä¾‹å¦‚ 1200" />
        <span class="calc">â†’ TWDï¼š<span class="twdText">0</span></span>
      </div>

      <div class="note">
        <div class="noteHead">
          <span>å‚™è¨»</span>
          <button class="btn small btnNotePhoto" type="button">ğŸ“·</button>
        </div>
        <textarea class="noteText" placeholder="å¯å¯«ï¼šæ’éšŠã€æ³¨æ„äº‹é …ã€é †éŠã€è¨‚ä½â€¦"></textarea>
        <div class="photoStrip notePhotos"></div>
      </div>
    `;

    const titleInp = el.querySelector(".titleInp");
    const jaInp = el.querySelector(".jaInp");
    const metaInp = el.querySelector(".metaInp");
    const originInp = el.querySelector(".originInp");
    const destInp = el.querySelector(".destInp");
    const routeText = el.querySelector(".routeText");
    const jpyInp = el.querySelector(".jpyInp");
    const twdText = el.querySelector(".twdText");
    const noteText = el.querySelector(".noteText");
    const notePhotos = el.querySelector(".notePhotos");

    titleInp.value = card.title || "";
    jaInp.value = card.ja || "";
    metaInp.value = card.meta || "";
    originInp.value = card.origin || "";
    destInp.value = (card.destination || card.ja || "") || "";
    routeText.value = card.routeText || "";
    jpyInp.value = card.jpy || "";
    noteText.value = card.note || "";

    // auto-grow init
    autoGrow(noteText);
    autoGrow(routeText);

    renderPhotoStrip(notePhotos, card.photos, () => scheduleSave());

    function updateTwd(){
      const rate = Number(state.settings.rate||0.22);
      const j = parseFloat(card.jpy||"");
      const t = (!isNaN(j) ? Math.round(j*rate) : 0);
      card.twd = String(t);
      twdText.textContent = String(t);
    }
    updateTwd();

    const bindInput = (node, fn, opts={}) => {
      node.addEventListener("input", () => {
        markTyping();
        fn();
        if (opts.autoGrow) autoGrow(node);
        scheduleSave();
      });
      node.addEventListener("focus", markTyping);
    };

    bindInput(titleInp, () => { card.title = titleInp.value; });
    bindInput(jaInp, () => {
      card.ja = jaInp.value;
      if (!card.destination){
        card.destination = jaInp.value;
        destInp.value = card.destination;
      }
    });
    bindInput(metaInp, () => { card.meta = metaInp.value; });
    bindInput(originInp, () => { card.origin = originInp.value; });
    bindInput(destInp, () => { card.destination = destInp.value; });

    bindInput(routeText, () => { card.routeText = routeText.value; }, {autoGrow:true});

    bindInput(jpyInp, () => { card.jpy = jpyInp.value; updateTwd(); });
    bindInput(noteText, () => { card.note = noteText.value; }, {autoGrow:true});

    // âœ… æ¨™è¨˜1ï¼šé¡å‹ä¸‹æ‹‰åˆ‡æ›ï¼ˆlodging ä¸é¡¯ç¤ºï¼‰
    const typeSel = el.querySelector(".typeSelect");
    if (typeSel){
      typeSel.value = card.type || "spot";
      typeSel.addEventListener("change", () => {
        const v = typeSel.value;
        if (v === "lodging") return; // ä¿éšª
        card.type = v;
        scheduleSave();
      });
    }

    // note photos
    el.querySelector(".btnNotePhoto").addEventListener("click", async () => {
      const url = await pickPhoto();
      if (!url) return;
      card.photos.push(url);
      renderPhotoStrip(notePhotos, card.photos, () => scheduleSave());
      scheduleSave();
    });

    // map actions
    el.querySelector(".btnPreview").addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      openMapPreview(q);
    });
    el.querySelector(".btnSearch").addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, "_blank");
    });
    el.querySelector(".btnRoute").addEventListener("click", () => openCardRoute(card));
    el.querySelector(".btnNearby").addEventListener("click", () => {
      const q = (card.destination || card.ja || card.title || "").trim();
      if (!q) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€æˆ–ã€æ—¥æ–‡åç¨±ã€");
      openNearbyMenu(q);
    });

    attachLongPress(el, card);
    return el;
  }

  function addCard(dayId, secKey, type){
    const d = state.days.find(x=>x.id===dayId);
    if (!d) return;
    if (type==="lodging") return;

    pushUndo();
    const c = newCard(type);

    if (secKey==="night"){
      const list = d.sections.night || [];
      const lodIdx = list.findIndex(x=>x.type==="lodging");
      if (lodIdx >= 0) list.splice(lodIdx,0,c);
      else list.push(c);
    }else{
      d.sections[secKey].push(c);
    }

    saveLocal();
    cloudSaveDebounced();
    render(true);
    toast("å·²æ–°å¢");
  }

  /* =========================
     Photos
  ========================== */
  const photoPicker = $("#photoPicker");
  let photoResolve = null;

  function pickPhoto(){
    return new Promise((resolve) => {
      photoResolve = resolve;
      photoPicker.value = "";
      photoPicker.click();
    });
  }

  photoPicker.addEventListener("change", () => {
    const file = photoPicker.files && photoPicker.files[0];
    if (!file){
      if (photoResolve) photoResolve(null);
      photoResolve = null;
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      if (photoResolve) photoResolve(String(e.target.result || ""));
      photoResolve = null;
    };
    reader.readAsDataURL(file);
  });

  function renderPhotoStrip(container, list, onChanged){
    container.innerHTML = "";
    (list||[]).forEach((url, idx) => {
      const img = document.createElement("img");
      img.className = "thumb";
      img.src = url;
      img.alt = "photo";
      img.title = "é»ä¸€ä¸‹ç›´æ¥åˆªé™¤";
      img.addEventListener("click", () => {
        list.splice(idx,1);
        renderPhotoStrip(container, list, onChanged);
        onChanged && onChanged();
      });
      container.appendChild(img);
    });
  }

  /* =========================
     Modal map
  ========================== */
  const modal = $("#mapModal");
  const modalFrame = $("#modalFrame");
  $("#btnCloseModal").addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if (e.target===modal) closeModal(); });

  function openMapPreview(query){
    $("#modalTitle").textContent = `åœ°åœ–é è¦½ï¼š${query}`;
    modalFrame.src = `https://www.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
    modalFrame.src = "about:blank";
  }

  function openCardRoute(card){
    const origin = (card.origin||"").trim();
    const dest = (card.destination || card.ja || card.title || "").trim();
    if (!dest) return alert("è«‹å…ˆå¡«ã€ç›®çš„åœ°/åœ°å€ã€");

    const ori = origin || state.settings.hotelNameJP || state.settings.hotelName || "ä¸Šé‡";
    let url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(ori)}&destination=${encodeURIComponent(dest)}`;
    // âœ… v5ï¼šä¸å†ç”¨çµæ§‹åŒ– waypointsï¼ˆé€”ç¶“æ”¹è‡ªç”±æ–‡å­—ï¼‰
    window.open(url, "_blank");
  }

  function flattenDayCards(dayObj){
    return ["morning","afternoon","night"].flatMap(k => (dayObj.sections[k]||[]));
  }

  function openDayRoute(dayObj){
    const cards = flattenDayCards(dayObj).filter(c=>c.type!=="lodging");
    const points = [];
    cards.forEach(c=>{
      const q = (c.destination || c.ja || c.title || "").trim();
      if (q) points.push(q);
    });
    if (!points.length) return alert("é€™å¤©æ²’æœ‰å¯å°èˆªçš„ç›®çš„åœ°ï¼ˆè«‹å¡«ç›®çš„åœ°/åœ°å€ï¼‰");

    const origin = state.settings.hotelNameJP || state.settings.hotelName || "ä¸Šé‡";
    const destination = points[points.length-1];
    const mids = points.slice(0, points.length-1).slice(0, 9);

    let url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
    if (mids.length) url += `&waypoints=${encodeURIComponent(mids.join("|"))}`;
    window.open(url, "_blank");
  }

  function openNearbyMenu(baseQuery){
    const options = [
      {k:"è¶…å•†", q:`${baseQuery} é™„è¿‘ ä¾¿åˆ©å•†åº—`},
      {k:"è—¥å¦", q:`${baseQuery} é™„è¿‘ è—¥å¦åº—`},
      {k:"è»Šç«™", q:`${baseQuery} é™„è¿‘ è»Šç«™`},
      {k:"å»æ‰€", q:`${baseQuery} é™„è¿‘ ãƒˆã‚¤ãƒ¬`},
      {k:"é¤å»³", q:`${baseQuery} é™„è¿‘ é¤å»³`},
    ];
    const pick = prompt("é™„è¿‘æœå°‹ï¼šè¼¸å…¥ 1-5\n1 è¶…å•†\n2 è—¥å¦\n3 è»Šç«™\n4 å»æ‰€\n5 é¤å»³", "2");
    const n = parseInt(pick||"", 10);
    if (!n || n<1 || n>5) return;
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(options[n-1].q)}`, "_blank");
  }

  /* =========================
     Totals / budget UI
  ========================== */
  function buildTotalText(){
    const rate = Number(state.settings.rate||0.22);
    let tripJPY = 0;

    state.days.forEach(d=>{
      flattenDayCards(d).forEach(c=>{
        const j = parseFloat(c.jpy||"");
        if (!isNaN(j)) tripJPY += j;
      });
    });
    const tripTWD = Math.round(tripJPY * rate);
    return `å…¨æ—…ç¨‹åˆè¨ˆï¼š${Math.round(tripJPY)} JPY / ${tripTWD} TWDï¼ˆé›¢ç·šå¯ç”¨ï¼šå·²è‡ªå‹•ä¿å­˜ï¼‰`;
  }

  function recalcTotalsUI(){
    const rate = Number(state.settings.rate||0.22);
    state.days.forEach(d=>{
      let dayJPY = 0;
      flattenDayCards(d).forEach(c=>{
        const j = parseFloat(c.jpy||"");
        if (!isNaN(j)) dayJPY += j;
        c.twd = (!isNaN(j) ? String(Math.round(j*rate)) : "0");
      });
      const dayTWD = Math.round(dayJPY * rate);

      const sec = document.querySelector(`.daySection[data-id="${d.id}"]`);
      if (sec){
        const badge = sec.querySelector(".dayTotalBadge");
        if (badge){
          badge.textContent = `ç•¶æ—¥åˆè¨ˆï¼š${Math.round(dayJPY)} JPY / ${dayTWD} TWD`;
          badge.classList.remove("warn");
          const bud = parseFloat(d.budgetJPY||"");
          if (!isNaN(bud) && bud>0 && dayJPY>bud){
            badge.classList.add("warn");
            badge.textContent += "ï¼ˆè¶…å‡ºé ç®—âš ï¸ï¼‰";
          }
        }
      }
    });
  }

  /* =========================
     Day add/remove
  ========================== */
  function addDay(){
    pushUndo();
    const i = state.days.length + 1;
    const d = newDay(i);
    state.days.push(d);
    ensureDatesFromDay1();
    saveLocal();
    cloudSaveDebounced();
    render(true);
    toast("å·²æ–°å¢ä¸€å¤©");
  }

  function removeLastDay(){
    if (state.days.length <= 1) return alert("è‡³å°‘è¦ä¿ç•™ä¸€å¤©");
    pushUndo();
    state.days.pop();
    ensureDatesFromDay1();
    saveLocal();
    cloudSaveDebounced();
    render(true);
    toast("å·²åˆªé™¤æœ€å¾Œä¸€å¤©");
  }

  /* =========================
     Import / Export
  ========================== */
  $("#btnExport").addEventListener("click", () => {
    const data = { savedAt: new Date().toISOString(), state };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "NijiTrip2026_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("#btnImport").addEventListener("click", () => $("#importFile").click());
  $("#importFile").addEventListener("change", () => {
    const file = $("#importFile").files && $("#importFile").files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try{
        const data = JSON.parse(String(e.target.result||"{}"));
        if (data && data.state){
          pushUndo();
          state = data.state;
          normalizeState();
          saveLocal();
          cloudSaveDebounced();
          render(true);
          toast("åŒ¯å…¥æˆåŠŸ");
        }else{
          alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸å°");
        }
      }catch(err){
        alert("åŒ¯å…¥å¤±æ•—ï¼šJSON è§£æéŒ¯èª¤");
      }
    };
    reader.readAsText(file, "utf-8");
    $("#importFile").value = "";
  });

  $("#btnClear").addEventListener("click", () => {
    if (!confirm("ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿæ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰")) return;
    clearLocal();
    undoStack = [];
    state = defaultState();
    normalizeState();
    saveLocal();
    pushUndo();
    render(true);
    toast("å·²æ¸…é™¤");
  });

  /* =========================
     Cloud buttons
  ========================== */
  $("#btnCloudPull").addEventListener("click", async () => {
    if (!canCloud()) return alert("è«‹å…ˆç™»å…¥ï¼Œæ‰èƒ½å¾é›²ç«¯è¼‰å…¥ã€‚");
    if (!confirm("ç¢ºå®šè¦ç”¨ã€é›²ç«¯è³‡æ–™ã€è¦†è“‹ç›®å‰ç•«é¢ï¼Ÿï¼ˆæœ¬æ©ŸæœªåŒæ­¥çš„å…§å®¹æœƒè¢«è¦†è“‹ï¼‰")) return;
    await cloudLoad(true);
    cloudSubscribe();
  });

  $("#btnCloudPush").addEventListener("click", async () => {
    if (!canCloud()) return alert("è«‹å…ˆç™»å…¥ï¼Œæ‰èƒ½æ¨é€åˆ°é›²ç«¯ã€‚");
    if (!confirm("ç¢ºå®šè¦æŠŠã€æœ¬æ©Ÿè³‡æ–™ã€æ¨åˆ°é›²ç«¯ï¼Ÿï¼ˆæœƒè¦†è“‹é›²ç«¯åŒä¸€ä»½è¡Œç¨‹ï¼‰")) return;
    cloudSaveDebounced();
    toast("å·²æ’ç¨‹æ¨é€åˆ°é›²ç«¯");
  });

  /* =========================
     Undo
  ========================== */
  $("#btnUndo").addEventListener("click", () => {
    if (undoStack.length <= 1) return;
    undoStack.pop();
    const prev = undoStack[undoStack.length-1];
    if (!prev) return;
    try{
      state = JSON.parse(prev);
      normalizeState();
      saveLocal();
      render(true);
      $("#btnUndo").disabled = undoStack.length <= 1;
      toast("å·² Undo");
      cloudSaveDebounced();
    }catch(e){}
  });

  /* =========================
     Jump to active day
  ========================== */
  $("#btnJumpActive").addEventListener("click", () => {
    if (!activeDayId) return;
    const sec = document.querySelector(`.daySection[data-id="${activeDayId}"]`);
    if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
  });

  /* =========================
     Search
  ========================== */
  function doSearch(){
    const q = $("#searchInput").value.trim();
    if (!q){
      $("#searchResult").textContent = "è«‹è¼¸å…¥é—œéµå­—";
      return;
    }
    const hits = [];
    state.days.forEach(d=>{
      if ((d.tickets?.text||"").includes(q)) hits.push({day:d, where:"ç¥¨åˆ¸æ–‡å­—"});
      if ((d.dayNote?.text||"").includes(q)) hits.push({day:d, where:"ç•¶æ—¥å‚™è¨»"});
      flattenDayCards(d).forEach(c=>{
        const blob = `${c.title||""} ${c.ja||""} ${c.meta||""} ${c.note||""} ${c.origin||""} ${c.destination||""} ${c.routeText||""}`;
        if (blob.includes(q)) hits.push({day:d, card:c, where:"è¡Œç¨‹å¡"});
      });
    });

    $("#searchResult").textContent = hits.length ? `æ‰¾åˆ° ${hits.length} ç­†` : "æ‰¾ä¸åˆ°";
    if (!hits.length) return;

    const first = hits[0];
    activeDayId = first.day.id;
    setActiveChip(activeDayId);
    const sec = document.querySelector(`.daySection[data-id="${first.day.id}"]`);
    if (sec) sec.scrollIntoView({behavior:"smooth", block:"start"});
  }
  $("#btnSearch").addEventListener("click", doSearch);
  $("#searchInput").addEventListener("keydown", (e) => {
    if (e.key==="Enter"){
      e.preventDefault();
      doSearch();
    }
  });

  /* =========================
     App desc
  ========================== */
  $("#appDesc").addEventListener("input", () => {
    markTyping();
    state.appDesc = $("#appDesc").value;
    scheduleSave();
  });

  /* =========================
     Buttons add/remove day
  ========================== */
  $("#btnAddDay").addEventListener("click", addDay);
  $("#btnRemoveDay").addEventListener("click", removeLastDay);

  /* =========================
     Long press menu
  ========================== */
  const menu = $("#ctxMenu");
  let menuCtx = null;
  let pressTimer = null;
  let pressStart = null;

  function attachLongPress(cardEl, card){
    const onDown = (e) => {
      if (e.type==="mousedown" && e.button !== 0) return;
      pressStart = { x: e.clientX, y: e.clientY };
      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => openMenu(cardEl, e.clientX, e.clientY, card), 520);
    };
    const onMove = (e) => {
      if (!pressStart) return;
      const dx = Math.abs(e.clientX - pressStart.x);
      const dy = Math.abs(e.clientY - pressStart.y);
      if (dx > 12 || dy > 12) clearTimeout(pressTimer);
    };
    const onUp = () => { clearTimeout(pressTimer); pressStart = null; };

    cardEl.addEventListener("touchstart", (e) => {
      const t = e.touches[0];
      onDown({type:"touchstart", clientX:t.clientX, clientY:t.clientY});
    }, {passive:true});
    cardEl.addEventListener("touchmove", (e) => {
      const t = e.touches[0];
      onMove({clientX:t.clientX, clientY:t.clientY});
    }, {passive:true});
    cardEl.addEventListener("touchend", onUp);

    cardEl.addEventListener("mousedown", onDown);
    cardEl.addEventListener("mousemove", onMove);
    cardEl.addEventListener("mouseup", onUp);
    cardEl.addEventListener("mouseleave", onUp);
  }

  function openMenu(cardEl, x, y, card){
    const dayId = cardEl.dataset.dayId;
    const secKey = cardEl.dataset.secKey;
    const cardId = cardEl.dataset.cardId;

    menuCtx = {dayId, secKey, cardId};
    $("#ctxTitle").textContent = `å¡ç‰‡ï¼š${(card.title||"").slice(0, 28)}`;

    menu.style.left = Math.min(x, window.innerWidth - 240) + "px";
    menu.style.top  = Math.min(y, window.innerHeight - 280) + "px";
    menu.classList.add("show");
  }
  function closeMenu(){
    menu.classList.remove("show");
    menuCtx = null;
  }
  document.addEventListener("click", (e) => {
    if (menu.classList.contains("show") && !menu.contains(e.target)) closeMenu();
  });

  function findCard(dayId, secKey, cardId){
    const d = state.days.find(x=>x.id===dayId);
    if (!d) return null;
    const list = d.sections[secKey]||[];
    const idx = list.findIndex(c=>c.id===cardId);
    if (idx<0) return null;
    return {d, list, idx, card:list[idx]};
  }

  $("#mUp").addEventListener("click", () => {
    if (!menuCtx) return;
    const found = findCard(menuCtx.dayId, menuCtx.secKey, menuCtx.cardId);
    if (!found) return closeMenu();
    const {list, idx, card} = found;
    if (card.type==="lodging") return alert("ä½å®¿å¡å›ºå®šåœ¨åº•éƒ¨");
    if (idx<=0) return closeMenu();
    pushUndo();
    list.splice(idx,1);
    list.splice(idx-1,0,card);
    saveLocal(); cloudSaveDebounced();
    render(true);
    closeMenu();
  });

  $("#mDown").addEventListener("click", () => {
    if (!menuCtx) return;
    const found = findCard(menuCtx.dayId, menuCtx.secKey, menuCtx.cardId);
    if (!found) return closeMenu();
    const {list, idx, card} = found;
    if (card.type==="lodging") return alert("ä½å®¿å¡å›ºå®šåœ¨åº•éƒ¨");
    if (idx>=list.length-1) return closeMenu();
    pushUndo();
    list.splice(idx,1);
    list.splice(idx+1,0,card);
    saveLocal(); cloudSaveDebounced();
    render(true);
    closeMenu();
  });

  $("#mDelete").addEventListener("click", () => {
    if (!menuCtx) return;
    const found = findCard(menuCtx.dayId, menuCtx.secKey, menuCtx.cardId);
    if (!found) return closeMenu();
    const {list, idx, card} = found;
    if (card.type==="lodging") return alert("ä½å®¿å¡å›ºå®šï¼ˆä¸èƒ½åˆªé™¤ï¼‰");
    pushUndo();
    list.splice(idx,1);
    saveLocal(); cloudSaveDebounced();
    render(true);
    closeMenu();
  });

  $("#mCopy").addEventListener("click", () => {
    if (!menuCtx) return;
    const found = findCard(menuCtx.dayId, menuCtx.secKey, menuCtx.cardId);
    if (!found) return closeMenu();
    const {list, idx, card} = found;
    if (card.type==="lodging") return alert("ä½å®¿å¡å›ºå®šï¼ˆä¸æ”¯æ´è¤‡è£½ï¼‰");
    pushUndo();
    const clone = JSON.parse(JSON.stringify(card));
    clone.id = `c_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    list.splice(idx+1,0,clone);
    saveLocal(); cloudSaveDebounced();
    render(true);
    closeMenu();
  });

  $("#mPin").addEventListener("click", () => {
    if (!menuCtx) return;
    const found = findCard(menuCtx.dayId, menuCtx.secKey, menuCtx.cardId);
    if (!found) return closeMenu();
    const {list, idx, card} = found;
    if (card.type==="lodging") return alert("ä½å®¿å¡å·²å›ºå®šåœ¨åº•éƒ¨");
    pushUndo();
    list.splice(idx,1);
    list.unshift(card);
    saveLocal(); cloudSaveDebounced();
    render(true);
    closeMenu();
  });

  $("#mMove").addEventListener("click", () => {
    if (!menuCtx) return;
    const found = findCard(menuCtx.dayId, menuCtx.secKey, menuCtx.cardId);
    if (!found) return closeMenu();
    const {list, idx, card} = found;
    if (card.type==="lodging") return alert("ä½å®¿å¡å›ºå®šï¼ˆä¸èƒ½ç§»å‹•ï¼‰");

    const labels = state.days.map((dd,i)=> `${i+1}. ${dd.dayLabel} (${dd.dateText})`).join("\n");
    const pick = prompt("ç§»åˆ°å“ªä¸€å¤©ï¼Ÿè¼¸å…¥åºè™Ÿï¼š\n" + labels, "2");
    const n = parseInt(pick||"", 10);
    if (!n || n<1 || n>state.days.length) return closeMenu();
    const toDay = state.days[n-1];

    const secPick = prompt("ç§»åˆ°å“ªå€‹åˆ†å€ï¼Ÿè¼¸å…¥ï¼šmorning / afternoon / night", "morning");
    const targetSec = ["morning","afternoon","night"].includes(secPick) ? secPick : "morning";

    pushUndo();
    list.splice(idx,1);
    toDay.sections[targetSec] = toDay.sections[targetSec] || [];
    if (targetSec==="night"){
      const lodIdx = toDay.sections.night.findIndex(x=>x.type==="lodging");
      if (lodIdx>=0) toDay.sections.night.splice(lodIdx,0,card);
      else toDay.sections.night.push(card);
    }else{
      toDay.sections[targetSec].push(card);
    }
    saveLocal(); cloudSaveDebounced();
    render(true);
    closeMenu();
  });

  /* =========================
     Init local
  ========================== */
  function init(){
    const s = loadLocal();
    state = s || defaultState();
    normalizeState();

    undoStack = [];
    pushUndo();
    $("#btnUndo").disabled = true;

    $("#appDesc").value = state.appDesc || "";
    render(true);
  }
  init();

  /* =========================
     Hook auth & cloud signals
  ========================== */
  window.NijiApp = {
    onAuthState(user){
      cloud.user = user || null;
      cloud.uid = user ? user.uid : null;
      cloud.autoLoaded = false;

      if (user){
        setAuthStatus(`å·²ç™»å…¥ï¼š${user.email || "(unknown)"}`);
        $("#btnSignOut").disabled = false;
        setCloudStatus("é›²ç«¯ï¼šæº–å‚™ä¸­â€¦", "soft");
        $("#btnCloudPull").disabled = false;
        $("#btnCloudPush").disabled = false;

        autoLoadFromCloudOnce().then(()=>{
          setCloudStatus("é›²ç«¯ï¼šå·²é€£ç·š âœ…", "ok");
        });
      }else{
        setAuthStatus("å°šæœªç™»å…¥ï¼ˆå¯é›¢ç·šä½¿ç”¨ï¼‰");
        $("#btnSignOut").disabled = true;
        $("#btnCloudPull").disabled = true;
        $("#btnCloudPush").disabled = true;
        if (cloud.unsub){ cloud.unsub(); cloud.unsub = null; }
        setCloudStatus("é›²ç«¯ï¼šæœªé€£ç·š", "soft");
      }
    }
  };
})();
</script>

<script type="module">
  // ====== Firebase Auth + Firestore CloudSync (Email/Password) ======
  import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // CloudSync API: users/{uid}/trips/{tripId}
  window.CloudSync = {
    _ref(uid, tripId){
      return doc(db, "users", uid, "trips", tripId);
    },
    async load(uid, tripId){
      const ref = this._ref(uid, tripId);
      const snap = await getDoc(ref);
      return snap.exists() ? (snap.data()?.state ?? null) : null;
    },
    async save(uid, tripId, state){
      const ref = this._ref(uid, tripId);
      await setDoc(ref, { state, updatedAt: serverTimestamp() }, { merge: true });
    },
    subscribe(uid, tripId, onState){
      const ref = this._ref(uid, tripId);
      return onSnapshot(ref, (snap) => {
        if (!snap.exists()) return;
        const remote = snap.data()?.state ?? null;
        if (remote) onState(remote);
      });
    }
  };

  // --- UI wiring ---
  const $ = (s)=>document.querySelector(s);
  const email = $("#email");
  const pw = $("#password");

  $("#btnEmailSignUp").addEventListener("click", async () => {
    try{
      if (!email.value || !pw.value) return alert("è«‹è¼¸å…¥ Email èˆ‡ Password");
      await createUserWithEmailAndPassword(auth, email.value.trim(), pw.value);
      alert("è¨»å†ŠæˆåŠŸ âœ…");
    }catch(e){
      console.error(e);
      alert("è¨»å†Šå¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  $("#btnEmailSignIn").addEventListener("click", async () => {
    try{
      if (!email.value || !pw.value) return alert("è«‹è¼¸å…¥ Email èˆ‡ Password");
      await signInWithEmailAndPassword(auth, email.value.trim(), pw.value);
    }catch(e){
      console.error(e);
      alert("ç™»å…¥å¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  $("#btnSignOut").addEventListener("click", async () => {
    try{
      await signOut(auth);
    }catch(e){
      console.error(e);
      alert("ç™»å‡ºå¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  onAuthStateChanged(auth, (user) => {
    if (window.NijiApp && typeof window.NijiApp.onAuthState === "function"){
      window.NijiApp.onAuthState(user);
    }
  });

  console.log("[Firebase] ready");
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Niji Trip 2026 Â· è¡Œç¨‹è¡¨ï¼ˆé‡ç½®ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #ffe4b8;
      --bg-card: #fff7e8;
      --bg-daychip: #fff6e5;
      --brown-main: #7a4a26;
      --brown-soft: #a26b3a;
      --border-soft: rgba(186, 140, 91, 0.4);
      --shadow-soft: 0 2px 4px rgba(0, 0, 0, 0.08);
      --radius-big: 22px;
      --radius-card: 20px;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC", "PingFang TC", sans-serif;
      background: #fce0b3;
      color: var(--brown-main);
    }
    body { min-height: 100vh; }
    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    header.app-header {
      background: var(--bg-card);
      border-radius: 26px;
      padding: 20px 18px 18px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 16px;
    }
    .app-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .app-title-row h1 {
      font-size: 26px;
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.04em;
    }
    .app-title-row span.emoji { font-size: 24px; }
    .app-desc {
      margin: 6px 0 10px;
      line-height: 1.6;
      font-size: 14px;
      color: var(--brown-soft);
    }
    .app-note {
      font-size: 13px;
      color: var(--brown-soft);
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 10px;
    }
    .app-note span.emoji {
      font-size: 16px;
      line-height: 1.2;
      margin-top: 2px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      background: #ffd59a;
      color: var(--brown-main);
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      white-space: nowrap;
    }
    .btn.primary {
      background: #ffb85c;
      color: #5a351e;
      font-weight: 600;
    }
    .btn.danger {
      background: #ffb0a6;
      color: #7a221b;
      font-weight: 600;
    }
    .btn.small {
      padding: 6px 12px;
      font-size: 13px;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    /* Day chips */
    .day-nav {
      background: #e3f2ff;
      border-radius: 24px;
      padding: 8px 8px 10px;
      margin: 0 -4px 10px;
      overflow-x: auto;
      display: flex;
      gap: 10px;
    }
    .day-chip {
      flex: 0 0 auto;
      min-width: 86px;
      background: var(--bg-daychip);
      border-radius: var(--radius-big);
      padding: 6px 10px 4px;
      text-align: center;
      box-shadow: var(--shadow-soft);
      border: 1px solid transparent;
      cursor: pointer;
    }
    .day-chip.active {
      background: #ffffff;
      border-color: rgba(122, 74, 38, 0.2);
    }
    .day-chip-main,
    .day-chip-sub {
      display: block;
    }
    .day-chip-main {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 2px;
    }
    .day-chip-sub {
      font-size: 12px;
      color: var(--brown-soft);
    }

    /* Day section */
    .day-section {
      margin-top: 8px;
      margin-bottom: 14px;
    }
    .day-card {
      background: #e5f4ff;
      border-radius: 24px;
      padding: 14px 10px 16px;
      box-shadow: var(--shadow-soft);
    }
    .day-header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
      padding: 0 6px;
    }
    .day-header-main {
      background: #ffffff;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 16px;
      font-weight: 700;
      box-shadow: var(--shadow-soft);
    }
    .day-header-sub {
      font-size: 14px;
      color: var(--brown-soft);
    }
    .day-hint {
      font-size: 12px;
      color: var(--brown-soft);
      margin: 2px 6px 10px;
    }

    /* Spot card */
    .spot-card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 12px 12px 10px;
      box-shadow: var(--shadow-soft);
      margin: 0 4px 8px;
      cursor: grab;
    }
    .spot-card.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }
    .spot-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 15px;
    }
    .spot-name-ja {
      font-size: 13px;
      color: var(--brown-soft);
      margin-bottom: 3px;
    }
    .spot-meta {
      font-size: 13px;
      color: var(--brown-soft);
      margin-bottom: 6px;
    }
    .btn-row-spot {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }
    .spot-note {
      border-radius: 12px;
      border: 1px dashed var(--border-soft);
      background: #fffdf6;
      padding: 7px 8px;
      font-size: 12px;
    }
    .spot-note-title {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      color: var(--brown-soft);
    }
    .spot-note-body {
      min-height: 20px;
      white-space: pre-wrap;
    }
    .spot-note-photos {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .spot-photo {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
    }

    .add-spot-card {
      margin: 4px 4px 0;
      padding: 4px 4px 0;
    }

    /* Day note */
    .day-note-card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      padding: 10px 10px 8px;
      box-shadow: var(--shadow-soft);
      margin: 8px 4px 0;
    }
    .day-note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .day-note-box {
      border-radius: 12px;
      border: 1px dashed var(--border-soft);
      background: #fffdf6;
      padding: 8px 9px;
      font-size: 13px;
      min-height: 32px;
      white-space: pre-wrap;
    }
    .day-note-photos {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }
    .day-note-photo {
      width: 64px;
      height: 64px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
    }

    /* Undo button */
    .undo-floating {
      position: fixed;
      left: 10px;
      bottom: 10px;
      z-index: 20;
    }
    .undo-floating button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: none;
      background: #ffcf8f;
      box-shadow: var(--shadow-soft);
      font-size: 22px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .app-title-row h1 { font-size: 22px; }
      .day-card { border-radius: 20px; }
      .spot-card { padding: 10px 9px 8px; }
    }
  </style>
</head>
<body>
<div class="page" id="pageRoot">
  <header class="app-header">
    <div class="app-title-row">
      <h1 contenteditable="true">Niji Trip 2026</h1>
      <span class="emoji">ğŸŒˆ</span>
    </div>
    <p class="app-desc" contenteditable="true">
      æ±äº¬è¡Œç¨‹ãƒ»æš–è‰²ä¸»é¡Œã€‚å¯è‡ªç”±ç·¨è¼¯è¡Œç¨‹ã€æ‹–æ‹‰æ’åºã€åŠ å…¥å‚™è¨»èˆ‡ç…§ç‰‡ï¼Œä¸¦è‡ªå‹•å„²å­˜ã€‚
    </p>
    <div class="app-note">
      <span class="emoji">âœï¸</span>
      <div contenteditable="true">
        è‹¥ç‰ˆé¢æœ‰èª¿æ•´ï¼Œå¯ä»¥éš¨æ™‚åŒ¯å‡º JSON å‚™ä»½ï¼›å¦‚æœ‰éœ€è¦ä¹Ÿå¯åŒ¯å…¥é‚„åŸã€‚
      </div>
    </div>
    <div class="btn-row">
      <button class="btn" type="button" id="exportBtn">åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</button>
      <button class="btn" type="button" id="importBtn">åŒ¯å…¥å‚™ä»½</button>
      <button class="btn danger" type="button" id="clearBtn">æ¸…é™¤æœ¬æ©Ÿå„²å­˜</button>
    </div>
  </header>

  <div class="day-nav" id="dayNav">
    <div class="day-chip active" data-id="day-1">
      <span class="day-chip-main">Day 1</span>
      <span class="day-chip-sub">5/8</span>
    </div>
    <div class="day-chip" data-id="day-2">
      <span class="day-chip-main">Day 2</span>
      <span class="day-chip-sub">5/9</span>
    </div>
    <div class="day-chip" data-id="day-3">
      <span class="day-chip-main">Day 3</span>
      <span class="day-chip-sub">5/10</span>
    </div>
  </div>

  <!-- Day 1 -->
  <section class="day-section" data-id="day-1">
    <div class="day-card">
      <div class="day-header">
        <div class="day-header-main"><span contenteditable="true">Day 1</span></div>
        <div class="day-header-sub"><span contenteditable="true">æˆç”°æ©Ÿå ´ãƒ»å…¥ä½ä¸Šé‡</span></div>
      </div>
      <div class="day-hint">æ—¥æœŸï¼š<span contenteditable="true">5/8</span></div>

      <article class="spot-card">
        <div class="spot-title" contenteditable="true">ç¯„ä¾‹æ™¯é»ï¼šæˆç”°æ©Ÿå ´</div>
        <div class="spot-name-ja" contenteditable="true">æˆç”°ç©ºæ¸¯</div>
        <div class="spot-meta" contenteditable="true">æŠµé”æ—¥æœ¬ãƒ»å‰å¾€é£¯åº—</div>
        <div class="btn-row-spot">
          <button class="btn small map-preview-btn" type="button">åœ°åœ–æœå°‹</button>
          <button class="btn small map-from-hotel-btn" type="button">å¾é£¯åº—å°èˆª</button>
          <button class="btn small spot-photo-btn" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="spot-note">
          <div class="spot-note-title">
            <span>å‚™è¨»</span>
          </div>
          <div class="spot-note-body" contenteditable="true">
å¯åœ¨é€™è£¡å¯«æŠµé”æ™‚é–“ã€å…¥å¢ƒæ’éšŠæƒ…æ³ã€æ›éŒ¢åœ°é»â€¦â€¦
          </div>
          <div class="spot-note-photos"></div>
        </div>
      </article>

      <div class="add-spot-card">
        <button type="button" class="btn small add-spot-btn">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</button>
      </div>

      <div class="day-note-card">
        <div class="day-note-header">
          <div class="day-note-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
          <button class="btn small day-note-photo-btn" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="day-note-box" contenteditable="true">
ä¾‹ï¼šé¤é£² xxx å…ƒã€äº¤é€š xxx å…ƒã€è³¼ç‰© xxx å…ƒã€å…¶ä»–å¿ƒå¾—â€¦â€¦
        </div>
        <div class="day-note-photos"></div>
      </div>
    </div>
  </section>

  <!-- Day 2 -->
  <section class="day-section" data-id="day-2">
    <div class="day-card">
      <div class="day-header">
        <div class="day-header-main"><span contenteditable="true">Day 2</span></div>
        <div class="day-header-sub"><span contenteditable="true">ä¸Šé‡ãƒ»æ·ºè‰æ•£æ­¥</span></div>
      </div>
      <div class="day-hint">æ—¥æœŸï¼š<span contenteditable="true">5/9</span></div>

      <article class="spot-card">
        <div class="spot-title" contenteditable="true">ç¯„ä¾‹æ™¯é»ï¼šæ·ºè‰å¯º</div>
        <div class="spot-name-ja" contenteditable="true">æµ…è‰å¯º</div>
        <div class="spot-meta" contenteditable="true">é›·é–€ãƒ»ä»²è¦‹ä¸–é€š</div>
        <div class="btn-row-spot">
          <button class="btn small map-preview-btn" type="button">åœ°åœ–æœå°‹</button>
          <button class="btn small map-from-hotel-btn" type="button">å¾é£¯åº—å°èˆª</button>
          <button class="btn small spot-photo-btn" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="spot-note">
          <div class="spot-note-title"><span>å‚™è¨»</span></div>
          <div class="spot-note-body" contenteditable="true">
é€™è£¡å¯ä»¥è¨˜éŒ„æ’éšŠæ™‚é–“ã€å¿…åƒå°åƒç­‰ã€‚
          </div>
          <div class="spot-note-photos"></div>
        </div>
      </article>

      <div class="add-spot-card">
        <button type="button" class="btn small add-spot-btn">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</button>
      </div>

      <div class="day-note-card">
        <div class="day-note-header">
          <div class="day-note-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
          <button class="btn small day-note-photo-btn" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="day-note-box" contenteditable="true"></div>
        <div class="day-note-photos"></div>
      </div>
    </div>
  </section>

  <!-- Day 3 -->
  <section class="day-section" data-id="day-3">
    <div class="day-card">
      <div class="day-header">
        <div class="day-header-main"><span contenteditable="true">Day 3</span></div>
        <div class="day-header-sub"><span contenteditable="true">è‡ªç”±æ´»å‹•æ—¥ï¼ˆå¯è‡ªè¡Œå®‰æ’ï¼‰</span></div>
      </div>
      <div class="day-hint">æ—¥æœŸï¼š<span contenteditable="true">5/10</span></div>

      <div class="add-spot-card">
        <button type="button" class="btn small add-spot-btn">ï¼‹ æ–°å¢è¡Œç¨‹å¡ç‰‡</button>
      </div>

      <div class="day-note-card">
        <div class="day-note-header">
          <div class="day-note-title">ç•¶æ—¥å‚™è¨»ï¼èŠ±è²»</div>
          <button class="btn small day-note-photo-btn" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
        </div>
        <div class="day-note-box" contenteditable="true"></div>
        <div class="day-note-photos"></div>
      </div>
    </div>
  </section>

</div>

<div class="undo-floating">
  <button id="undoBtn" title="ä¸Šä¸€æ­¥">â†©</button>
</div>
<input type="file" id="importFile" accept="application/json" style="display:none" />
<script>
(function () {
  const STORAGE_KEY = "niji_trip_2026_reset_v1";
  const UNDO_LIMIT = 10;
  const HOTEL_NAME = "ãƒ™ãƒƒã‚»ãƒ«ã‚¤ãƒ³ä¸Šé‡å…¥è°·é§…å‰";

  let undoStack = [];
  let isRestoring = false;
  let photoInput = null;
  let currentPhotoTarget = null;

  // ---- Undo & Save ----
  function saveSnapshot(pushToStack = true) {
    if (isRestoring) return;
    const root = document.getElementById("pageRoot");
    if (!root) return;
    const html = root.innerHTML;
    if (pushToStack) {
      undoStack.push(html);
      if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    }
    try {
      localStorage.setItem(STORAGE_KEY, html);
    } catch (e) {
      console.warn("localStorage å„²å­˜å¤±æ•—", e);
    }
  }

  function undo() {
    if (undoStack.length <= 1) return;
    undoStack.pop();
    const prev = undoStack[undoStack.length - 1];
    if (!prev) return;
    isRestoring = true;
    const root = document.getElementById("pageRoot");
    root.innerHTML = prev;
    try {
      localStorage.setItem(STORAGE_KEY, prev);
    } catch (e) {}
    attachAllHandlers();
    isRestoring = false;
  }

  // ---- Photo input ----
  function ensurePhotoInput() {
    if (photoInput) return;
    photoInput = document.createElement("input");
    photoInput.type = "file";
    photoInput.accept = "image/*";
    photoInput.style.display = "none";
    document.body.appendChild(photoInput);

    photoInput.addEventListener("change", () => {
      const file = photoInput.files?.[0];
      if (!file || !currentPhotoTarget) return;
      const reader = new FileReader();
      reader.onload = e => {
        const img = document.createElement("img");
        img.src = e.target.result;
        img.alt = "ç…§ç‰‡";
        img.className = currentPhotoTarget.classList.contains("day-note-photos")
          ? "day-note-photo"
          : "spot-photo";
        img.addEventListener("click", () => {
          img.remove();
          saveSnapshot();
        });
        currentPhotoTarget.appendChild(img);
        saveSnapshot();
      };
      reader.readAsDataURL(file);
      photoInput.value = "";
    });
  }

  // ---- Add spot card ----
  function createSpotCard() {
    const card = document.createElement("article");
    card.className = "spot-card";
    card.innerHTML = `
      <div class="spot-title" contenteditable="true">æ–°è¡Œç¨‹</div>
      <div class="spot-name-ja" contenteditable="true">æ—¥æ–‡åç¨±æˆ–åœ°å€</div>
      <div class="spot-meta" contenteditable="true">å¯åœ¨é€™è£¡å¯«åœ°å€ã€åº—å®¶é¡å‹ã€æ™‚é–“ç­‰ã€‚</div>
      <div class="btn-row-spot">
        <button class="btn small map-preview-btn" type="button">åœ°åœ–æœå°‹</button>
        <button class="btn small map-from-hotel-btn" type="button">å¾é£¯åº—å°èˆª</button>
        <button class="btn small spot-photo-btn" type="button">ğŸ“· æ–°å¢åœ–ç‰‡</button>
      </div>
      <div class="spot-note">
        <div class="spot-note-title"><span>å‚™è¨»</span></div>
        <div class="spot-note-body" contenteditable="true"></div>
        <div class="spot-note-photos"></div>
      </div>
    `;
    return card;
  }

  // ---- Drag & Drop (spot cards + day-note-card) ----
  let draggingEl = null;
  let autoScrollTimer = null;

  function setupDraggable(el) {
    if (!el) return;
    el.draggable = true;

    el.addEventListener("dragstart", e => {
      draggingEl = el;
      el.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });

    el.addEventListener("dragend", () => {
      if (!draggingEl) return;
      draggingEl.classList.remove("dragging");
      draggingEl = null;
      stopAutoScroll();
      saveSnapshot();
    });
  }

  function setupDropZones() {
    const dayCards = document.querySelectorAll(".day-card");
    dayCards.forEach(card => {
      card.addEventListener("dragover", e => {
        if (!draggingEl) return;
        e.preventDefault();
        startAutoScroll(e.clientY);

        // åªåœ¨åŒä¸€å¤©ä¸­æ’åº
        const items = [...card.querySelectorAll(".spot-card, .day-note-card")];
        const after = getDragAfterElement(items, e.clientY);
        if (!after) {
          card.appendChild(draggingEl);
        } else {
          card.insertBefore(draggingEl, after);
        }
      });
    });
  }

  function getDragAfterElement(items, y) {
    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
    items
      .filter(item => !item.classList.contains("dragging"))
      .forEach(item => {
        const box = item.getBoundingClientRect();
        const offset = y - (box.top + box.height / 2);
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: item };
        }
      });
    return closest.element;
  }

  function startAutoScroll(clientY) {
    if (autoScrollTimer) return;
    autoScrollTimer = setInterval(() => {
      const topZone = 60;
      const bottomZone = window.innerHeight - 60;
      if (clientY < topZone) {
        window.scrollBy(0, -12);
      } else if (clientY > bottomZone) {
        window.scrollBy(0, 12);
      }
    }, 50);
  }

  function stopAutoScroll() {
    clearInterval(autoScrollTimer);
    autoScrollTimer = null;
  }

  // ---- Buttons & actions ----
  function attachButtonHandlers() {
    // æ—¥ç±¤é»æ“Šæ²å‹•
    const dayChips = document.querySelectorAll(".day-chip");
    dayChips.forEach(chip => {
      chip.onclick = () => {
        dayChips.forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        const id = chip.dataset.id;
        const sec = document.querySelector('.day-section[data-id="' + id + '"]');
        if (sec) sec.scrollIntoView({ behavior: "smooth", block: "start" });
      };
    });

    // æ–°å¢è¡Œç¨‹å¡ç‰‡
    document.querySelectorAll(".add-spot-btn").forEach(btn => {
      btn.onclick = () => {
        const dayCard = btn.closest(".day-card");
        if (!dayCard) return;
        const card = createSpotCard();
        dayCard.insertBefore(card, btn.closest(".add-spot-card"));
        setupDraggable(card);
        attachContentEditable(card);
        attachSpotButtons(card);
        saveSnapshot();
      };
    });

    // åŒ¯å‡º
    const exportBtn = document.getElementById("exportBtn");
    if (exportBtn) {
      exportBtn.onclick = () => {
        const html = document.getElementById("pageRoot").innerHTML;
        const data = { html, time: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "NijiTrip_backup.json";
        a.click();
      };
    }

    // åŒ¯å…¥
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");
    if (importBtn && importFile) {
      importBtn.onclick = () => importFile.click();
      importFile.onchange = () => {
        const file = importFile.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = JSON.parse(e.target.result);
            if (data.html) {
              isRestoring = true;
              const root = document.getElementById("pageRoot");
              root.innerHTML = data.html;
              localStorage.setItem(STORAGE_KEY, data.html);
              attachAllHandlers();
              isRestoring = false;
              undoStack = [data.html];
            }
          } catch {
            alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚");
          }
        };
        reader.readAsText(file);
        importFile.value = "";
      };
    }

    // æ¸…é™¤æœ¬æ©Ÿå„²å­˜
    const clearBtn = document.getElementById("clearBtn");
    if (clearBtn) {
      clearBtn.onclick = () => {
        if (!confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿå„²å­˜çš„è¡Œç¨‹è³‡æ–™å—ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰")) return;
        localStorage.removeItem(STORAGE_KEY);
        alert("å·²æ¸…é™¤æœ¬æ©Ÿå„²å­˜ï¼Œé‡æ–°æ•´ç†é é¢å³æœƒå›åˆ°é è¨­ç¯„ä¾‹ã€‚");
      };
    }

    // Undo
    const undoBtn = document.getElementById("undoBtn");
    if (undoBtn) undoBtn.onclick = undo;
  }

  function attachSpotButtons(root) {
    root.querySelectorAll(".spot-card").forEach(card => {
      const mapBtn = card.querySelector(".map-preview-btn");
      const navBtn = card.querySelector(".map-from-hotel-btn");
      const photoBtn = card.querySelector(".spot-photo-btn");
      const nameJaEl = card.querySelector(".spot-name-ja");
      const titleEl = card.querySelector(".spot-title");

      if (mapBtn) {
        mapBtn.onclick = () => {
          const dest =
            (nameJaEl?.textContent.trim()) ||
            (titleEl?.textContent.trim()) ||
            "";
          if (!dest) {
            alert("è«‹å…ˆå¡«å¯«åœ°é»åç¨±æˆ–åœ°å€ã€‚");
            return;
          }
          const url = "https://www.google.com/maps/search/?api=1&query=" +
                      encodeURIComponent(dest);
          window.open(url, "_blank");
        };
      }

      if (navBtn) {
        navBtn.onclick = () => {
          const dest =
            (nameJaEl?.textContent.trim()) ||
            (titleEl?.textContent.trim()) ||
            "";
          if (!dest) {
            alert("è«‹å…ˆå¡«å¯«åœ°é»åç¨±æˆ–åœ°å€ã€‚");
            return;
          }
          const url =
            "https://www.google.com/maps/dir/?api=1" +
            "&origin=" + encodeURIComponent(HOTEL_NAME) +
            "&destination=" + encodeURIComponent(dest);
          window.open(url, "_blank");
        };
      }

      if (photoBtn) {
        photoBtn.onclick = () => {
          ensurePhotoInput();
          const photoBox = card.querySelector(".spot-note-photos") || card;
          currentPhotoTarget = photoBox;
          photoInput.click();
        };
      }
    });

    // Day note ç…§ç‰‡
    root.querySelectorAll(".day-note-card").forEach(card => {
      const btn = card.querySelector(".day-note-photo-btn");
      if (!btn) return;
      btn.onclick = () => {
        ensurePhotoInput();
        const box = card.querySelector(".day-note-photos") || card;
        currentPhotoTarget = box;
        photoInput.click();
      };
    });
  }

  function attachContentEditable(root) {
    root.querySelectorAll("[contenteditable]").forEach(el => {
      el.addEventListener("input", () => saveSnapshot());
    });
  }

  function attachAllHandlers() {
    attachButtonHandlers();
    attachSpotButtons(document);
    attachContentEditable(document);

    // å¯æ‹–æ‹‰çš„å…ƒç´ ï¼šæ‰€æœ‰ spot-card + day-note-card
    document.querySelectorAll(".spot-card, .day-note-card").forEach(el => setupDraggable(el));
    setupDropZones();
  }

  document.addEventListener("DOMContentLoaded", () => {
    const root = document.getElementById("pageRoot");
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      root.innerHTML = saved;
    }
    attachAllHandlers();
    saveSnapshot(); // åˆå§‹åŒ–ç¬¬ä¸€å€‹ç‹€æ…‹
  });
})();
</script>
</body>
</html>

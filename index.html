<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Niji Trip 2026</title>

<style>
:root{
  --bg-main:#ffe4b8;
  --bg-card:#fff7e8;
  --brown:#7a4a26;
  --radius:20px;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
  background:var(--bg-main);
}
header{
  padding:16px;
  background:#fff3da;
  border-radius:0 0 var(--radius) var(--radius);
}
h1{ margin:0 0 6px; color:var(--brown); }
.btn-row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
  align-items:center;
}
button{
  border:none;
  padding:8px 14px;
  border-radius:999px;
  background:#ffd89a;
  color:#5c3a1c;
  font-weight:700;
}
.badge{
  display:inline-block;
  padding:8px 12px;
  border-radius:999px;
  background:#fff3c5;
  color:#5c3a1c;
  font-weight:700;
}
.hint{
  margin-top:10px;
  font-size:13px;
  color:#6b4a2c;
  opacity:.9;
}
main{ padding:16px; }
.day{
  background:#eaf6ff;
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
}
.card{
  background:var(--bg-card);
  border-radius:16px;
  padding:12px;
  margin-top:10px;
}
[contenteditable]{ outline:none; }
</style>
</head>

<body>

<header>
  <h1>Niji Trip 2026 ğŸŒˆ</h1>
  <div contenteditable="true">æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚</div>

  <div class="btn-row">
    <button id="addDayBtn">ï¼‹ æ–°å¢ä¸€å¤©</button>
    <button id="clearBtn">æ¸…é™¤å„²å­˜</button>

    <!-- âœ… ä½ è¦çš„é¡¯ç¤ºæ–‡å­—ï¼šGoogle ç™»å…¥ -->
    <button id="btnGoogleLogin" type="button">Google ç™»å…¥</button>

    <!-- âœ… ç™»å…¥ç‹€æ…‹é¡¯ç¤º -->
    <span id="authStatus" class="badge">æœªç™»å…¥</span>
  </div>

  <div class="hint">
    æç¤ºï¼šæ‰‹æ©Ÿç™»å…¥ç”¨ Redirectï¼Œé»ã€ŒGoogle ç™»å…¥ã€æœƒè·³åˆ° Googleï¼Œå®Œæˆå¾Œæœƒå›åˆ°æ­¤é ä¸¦é¡¯ç¤ºå·²ç™»å…¥ã€‚
  </div>
</header>

<main id="days"></main>

<!-- âœ… ä½ çš„è¡Œç¨‹ï¼ˆä¿ç•™ localStorage åŠŸèƒ½ï¼‰ -->
<script>
const daysEl = document.getElementById("days");
const addDayBtn = document.getElementById("addDayBtn");
const clearBtn = document.getElementById("clearBtn");

let days = JSON.parse(localStorage.getItem("days") || "[]");

function save(){ localStorage.setItem("days", JSON.stringify(days)); }

function render(){
  daysEl.innerHTML = "";
  days.forEach((d,i)=>{
    const el = document.createElement("div");
    el.className = "day";
    el.innerHTML = `
      <strong>Day ${i+1}</strong>
      <div class="card" contenteditable="true">${d.text || ""}</div>
    `;
    el.querySelector(".card").oninput = e=>{
      days[i].text = e.target.innerText;
      save();
    };
    daysEl.appendChild(el);
  });
}

addDayBtn.onclick = ()=>{
  days.push({ text:"æ–°å¢è¡Œç¨‹å…§å®¹â€¦" });
  save();
  render();
};

clearBtn.onclick = ()=>{
  if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")){
    localStorage.removeItem("days");
    days = [];
    render();
  }
};

render();
</script>

<!-- âœ… Firebase Authï¼ˆåªä¿ç•™ä¸€å¥—é‚è¼¯ï¼šRedirectï¼‰ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const btn = document.getElementById("btnGoogleLogin");
  const statusEl = document.getElementById("authStatus");

  // âœ… åœ¨ header åº•ä¸‹åŠ ä¸€å€‹ã€Œè¨ºæ–·å€ã€
  const diag = document.createElement("div");
  diag.style.marginTop = "10px";
  diag.style.fontSize = "12px";
  diag.style.lineHeight = "1.4";
  diag.style.color = "#6b4a2c";
  diag.style.whiteSpace = "pre-wrap";
  diag.style.wordBreak = "break-word";
  diag.textContent = `Firebase init OK: ${app?.options?.projectId || "(unknown)"}\n`;
  // æ’åˆ° header æœ€å¾Œ
  document.querySelector("header")?.appendChild(diag);

  const log = (msg) => {
    diag.textContent += msg + "\n";
  };

  // âœ… å…ˆé è¨­æŒ‰éˆ•è¡Œç‚ºï¼šç™»å…¥
  const setLoggedOutUI = () => {
    statusEl.textContent = "æœªç™»å…¥";
    btn.textContent = "Google ç™»å…¥";
    btn.onclick = async () => {
      log("Click login -> signInWithRedirect()");
      await signInWithRedirect(auth, provider);
    };
  };

  const setLoggedInUI = (user) => {
    const name = user.email || user.displayName || "Google ä½¿ç”¨è€…";
    statusEl.textContent = "å·²ç™»å…¥ï¼š" + name;
    btn.textContent = "ç™»å‡º";
    btn.onclick = async () => {
      log("Click logout -> signOut()");
      await signOut(auth);
    };
  };

  setLoggedOutUI();

  // âœ… 1) å…ˆå– Redirect çµæœï¼ˆæˆåŠŸ/å¤±æ•—éƒ½å°å‡ºä¾†ï¼‰
  try {
    log("getRedirectResult() ...");
    const res = await getRedirectResult(auth);
    if (res?.user) {
      log("RedirectResult: SUCCESS âœ… " + (res.user.email || res.user.displayName || ""));
    } else {
      log("RedirectResult: (no user returned)");
    }
  } catch (e) {
    log("RedirectResult: ERROR âŒ");
    log("code: " + (e?.code || "(none)"));
    log("message: " + (e?.message || "(none)"));
  }

  // âœ… 2) å†ç›£è½ç™»å…¥ç‹€æ…‹ï¼ˆé€™è£¡æ˜¯æœ€å¾Œçš„çœŸç›¸ï¼‰
  onAuthStateChanged(auth, (user) => {
    if (user) {
      log("onAuthStateChanged: logged IN âœ…");
      setLoggedInUI(user);
    } else {
      log("onAuthStateChanged: logged OUT âŒ");
      setLoggedOutUI();
    }
  });
</script>

</body>
</html>

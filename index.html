<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Niji Trip 2026</title>

  <style>
    :root{
      --bg-main:#ffe4b8;
      --bg-card:#fff7e8;
      --bg-head:#fff3da;
      --blue-soft:#eaf6ff;
      --brown:#7a4a26;
      --brown-soft:#a26b3a;
      --radius:20px;
      --shadow:0 6px 14px rgba(0,0,0,.08);
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      background:var(--bg-main);
      color:#3b2a1e;
    }
    header{
      padding:16px;
      background:var(--bg-head);
      border-radius:0 0 var(--radius) var(--radius);
      box-shadow:var(--shadow);
    }
    h1{
      margin:0 0 6px;
      color:var(--brown);
      font-size:34px;
      letter-spacing:.3px;
    }
    .sub{
      margin:0;
      color:#6b4a31;
      line-height:1.4;
    }
    .btn-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:12px;
    }
    button{
      border:none;
      padding:10px 14px;
      border-radius:999px;
      background:#ffd89a;
      color:#5c3a1c;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,.08);
    }
    button:active{ transform: translateY(1px); }
    .btn-danger{
      background:#f5a6a6;
      color:#5a1f1f;
    }
    .btn-ghost{
      background:#ffe9c5;
      color:#5c3a1c;
    }
    .status{
      display:inline-block;
      font-size:13px;
      font-weight:700;
      color:var(--brown);
      background:#fff3cd;
      padding:7px 10px;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      margin-left:auto;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    main{ padding:16px; }

    .day{
      background:var(--blue-soft);
      border-radius:var(--radius);
      padding:14px;
      margin-bottom:14px;
      box-shadow:var(--shadow);
    }
    .day-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:800;
      color:#3e2a1a;
      margin-bottom:10px;
    }
    .card{
      background:var(--bg-card);
      border-radius:16px;
      padding:12px;
      margin-top:10px;
      border:1px dashed rgba(122,74,38,.25);
      min-height:56px;
      line-height:1.6;
    }
    [contenteditable]{ outline:none; }
    .hint{
      font-size:12px;
      color:#6b4a31;
      opacity:.9;
      margin-top:8px;
    }
    .err{
      margin-top:10px;
      color:#b42318;
      font-weight:700;
      font-size:13px;
      display:none;
    }
  </style>
</head>

<body>

<header>
  <h1>Niji Trip 2026 ğŸŒˆ</h1>

  <div class="sub" contenteditable="true" id="headerDesc">
    æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚
  </div>

  <div class="btn-row">
    <button id="addDayBtn">ï¼‹ æ–°å¢ä¸€å¤©</button>
    <button id="clearBtn" class="btn-ghost">æ¸…é™¤å„²å­˜</button>

    <!-- âœ… ä½ æŒ‡å®šçš„æŒ‰éˆ•æ–‡å­— -->
    <button id="btnGoogleLogin">Google ç™»å…¥</button>
    <button id="btnLogout" class="btn-danger" style="display:none;">ç™»å‡º</button>

    <!-- âœ… å³å´ç™»å…¥ç‹€æ…‹ -->
    <span id="authStatus" class="status">æœªç™»å…¥</span>
  </div>

  <div id="errBox" class="err"></div>
  <div class="hint">æç¤ºï¼šæ‰‹æ©Ÿç™»å…¥ç”¨ Redirectï¼Œé»ã€ŒGoogle ç™»å…¥ã€æœƒè·³è½‰åˆ° Googleï¼Œå®Œæˆå¾Œæœƒå›åˆ°æ­¤é ã€‚</div>
</header>

<main id="days"></main>

<script>
/* ========= æœ¬æ©Ÿå„²å­˜ + å…§å®¹ç·¨è¼¯ ========= */
const daysEl = document.getElementById("days");
const addDayBtn = document.getElementById("addDayBtn");
const clearBtn = document.getElementById("clearBtn");
const headerDesc = document.getElementById("headerDesc");

let days = JSON.parse(localStorage.getItem("days") || "[]");
let headerText = localStorage.getItem("headerDesc") || headerDesc.innerText;

headerDesc.innerText = headerText;

function saveLocal(){
  localStorage.setItem("days", JSON.stringify(days));
  localStorage.setItem("headerDesc", headerDesc.innerText);
}

function render(){
  daysEl.innerHTML = "";
  days.forEach((d,i)=>{
    const wrap = document.createElement("div");
    wrap.className = "day";
    wrap.innerHTML = `
      <div class="day-title">
        <span>Day ${i+1}</span>
        <button data-del="${i}" class="btn-danger" style="padding:8px 12px;">åˆªé™¤</button>
      </div>
      <div class="card" contenteditable="true">${escapeHtml(d.text || "")}</div>
    `;

    wrap.querySelector(".card").addEventListener("input", (e)=>{
      days[i].text = e.target.innerText;
      saveLocal();
    });

    wrap.querySelector("[data-del]").addEventListener("click", ()=>{
      days.splice(i,1);
      saveLocal();
      render();
    });

    daysEl.appendChild(wrap);
  });
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

addDayBtn.onclick = ()=>{
  days.push({ text:"æ–°å¢è¡Œç¨‹å…§å®¹â€¦" });
  saveLocal();
  render();
};

clearBtn.onclick = ()=>{
  if(confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ˆåŒ…å«æ¨™é¡Œä¸‹é‚£æ®µæ–‡å­— + æ‰€æœ‰å¤©æ•¸å…§å®¹ï¼‰ï¼Ÿ")){
    localStorage.removeItem("days");
    localStorage.removeItem("headerDesc");
    days = [];
    headerDesc.innerText = "æ±äº¬è¡Œç¨‹ï¼Œå¯è‡ªç”±ç·¨è¼¯ã€‚";
    saveLocal();
    render();
  }
};

headerDesc.addEventListener("input", saveLocal);

render();
</script>

<script type="module">
  /* ========= Firebase Auth (Redirect) ========= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ğŸ”‘ ä½ çš„ Firebase è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyAkFpjZVwRDA92YLK-JfDPeoHJ3hbgKVXM",
    authDomain: "trip-db86d.firebaseapp.com",
    projectId: "trip-db86d",
    storageBucket: "trip-db86d.firebasestorage.app",
    messagingSenderId: "709795426974",
    appId: "1:709795426974:web:ec3e2f03f2116b68c1418f",
    measurementId: "G-FD0411E3XH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // UI elements
  const btnLogin = document.getElementById("btnGoogleLogin");
  const btnLogout = document.getElementById("btnLogout");
  const authStatus = document.getElementById("authStatus");
  const errBox = document.getElementById("errBox");

  function showErr(msg){
    if(!msg) return;
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  // 1) é»ç™»å…¥ => redirect
  btnLogin.addEventListener("click", async ()=>{
    clearErr();
    try{
      await signInWithRedirect(auth, provider);
      // é€™è¡Œé€šå¸¸ä¸æœƒè·‘åˆ°ï¼ˆå› ç‚ºæœƒç«‹åˆ»è·³è½‰ï¼‰
    }catch(e){
      showErr("ç™»å…¥å•Ÿå‹•å¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  // 2) é»ç™»å‡º
  btnLogout.addEventListener("click", async ()=>{
    clearErr();
    try{
      await signOut(auth);
    }catch(e){
      showErr("ç™»å‡ºå¤±æ•—ï¼š" + (e?.message || e));
    }
  });

  // 3) é‡è¦ï¼šå›ä¾†å¾Œå…ˆæŠ“ redirect resultï¼ˆæœ‰äº›æ‰‹æ©Ÿéœ€è¦é€™æ­¥æ‰æœƒå®Œæˆç‹€æ…‹ï¼‰
  //    âœ… æŠ“åˆ°å°±ä»£è¡¨ redirect ç™»å…¥æµç¨‹å®Œæˆï¼ˆæˆåŠŸæˆ–å¤±æ•—ï¼‰
  try{
    await getRedirectResult(auth);
  }catch(e){
    // å¸¸è¦‹ï¼šä½¿ç”¨è€…å–æ¶ˆã€æˆ–ç€è¦½å™¨é˜»æ“‹
    // ä¸è¦ç”¨ alert è½Ÿç‚¸ï¼Œæ”¹é¡¯ç¤ºéŒ¯èª¤æ–‡å­—å³å¯
    if(e?.code && e.code !== "auth/no-auth-event"){
      showErr("Redirect å›ä¾†å¾Œè™•ç†å¤±æ•—ï¼š" + (e?.message || e));
    }
  }

  // 4) ç›£è½ç™»å…¥ç‹€æ…‹ï¼ˆé€™å€‹æ‰æ˜¯æœ€çµ‚åˆ¤å®šï¼‰
  onAuthStateChanged(auth, (user)=>{
    clearErr();
    if(user){
      const name = user.displayName || user.email || "Google ä½¿ç”¨è€…";
      authStatus.textContent = "å·²ç™»å…¥ï¼š" + name;
      btnLogin.style.display = "none";
      btnLogout.style.display = "inline-block";
    }else{
      authStatus.textContent = "æœªç™»å…¥";
      btnLogin.style.display = "inline-block";
      btnLogout.style.display = "none";
    }
  });
</script>

</body>
</html>
